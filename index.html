<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtÃ¶lye Ãœretim & Finans Takibi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase v8 SDK - Tam uyumlu -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
    <script>
        // Firebase konfigÃ¼rasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyChaqhVjyVBtqmhAX-CVlwyaTPKqS-t47E",
            authDomain: "dofistudios-3b1d4.firebaseapp.com",
            projectId: "dofistudios-3b1d4",
            storageBucket: "dofistudios-3b1d4.firebasestorage.app",
            messagingSenderId: "339459217344",
            appId: "1:339459217344:web:4c88d30186d4cc0df99a25",
            measurementId: "G-5VJGPYW0KK"
        };

        // Firebase baÅŸlatma fonksiyonu
        function initializeFirebase() {
            try {
                console.log('ğŸ”¥ Firebase baÅŸlatÄ±lÄ±yor...');
                console.log('Config:', firebaseConfig);
                
                // Firebase SDK'larÄ±nÄ±n yÃ¼klenmesini bekle
                if (typeof firebase !== 'undefined') {
                    // Firebase zaten baÅŸlatÄ±lmÄ±ÅŸ mÄ± kontrol et
                    let app;
                    try {
                        app = firebase.app();
                        console.log('âœ… Firebase zaten baÅŸlatÄ±lmÄ±ÅŸ, mevcut app kullanÄ±lÄ±yor');
                    } catch (error) {
                        // Firebase baÅŸlatÄ±lmamÄ±ÅŸ, yeni baÅŸlat
                        app = firebase.initializeApp(firebaseConfig);
                        console.log('âœ… Firebase yeni baÅŸlatÄ±ldÄ±');
                    }
                    
                    const database = firebase.database();
                    const analytics = firebase.analytics();
                    
                    // Global olarak eriÅŸilebilir yap
                    window.firebaseApp = app;
                    window.firebaseDatabase = database;
                    window.firebaseRef = (path) => database.ref(path);
                    window.firebaseSet = (ref, data) => ref.set(data);
                    window.firebaseGet = (ref) => ref.once('value');
                    window.firebasePush = (ref, data) => ref.push(data);
                    window.firebaseRemove = (ref) => ref.remove();
                    window.firebaseUpdate = (ref, data) => ref.update(data);
                    window.firebaseOn = (ref, callback) => ref.on('value', callback);
                    window.firebaseOff = (ref, callback) => ref.off('value', callback);
                    window.firebaseAnalytics = analytics;
                    
                    console.log('âœ… Firebase baÅŸarÄ±yla hazÄ±rlandÄ±');
                    console.log('âœ… Database:', database);
                    console.log('âœ… Analytics:', analytics);
                    
                    firebaseInitialized = true;
                    return true;
                } else {
                    console.error('âŒ Firebase SDK yÃ¼klenemedi');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Firebase baÅŸlatma hatasÄ±:', error);
                console.error('Hata detayÄ±:', error.message);
                console.error('Hata kodu:', error.code);
                return false;
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .tab-button { padding: 12px 24px; border-radius: 8px 8px 0 0; font-weight: 600; cursor: grab; transition: all 0.2s ease-in-out; background-color: #e5e7eb; color: #4b5563; }
        .tab-button.active { background-color: #ffffff; color: #1f2937; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .tab-button.dragging { opacity: 0.5; }
        .tab-button.drag-over { border-bottom: 2px solid #3B82F6; }
        .tab-content { background-color: #ffffff; padding: 24px; border-radius: 0 8px 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 600px; overflow-x: auto; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; min-width: 800px; }
        th, td { padding: 12px 8px; border: 1px solid #e5e7eb; text-align: left; word-wrap: break-word; position: relative; white-space: nowrap; font-size: 14px; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; position: sticky; top: 0; z-index: 5; }
        .resizer { position: absolute; top: 0; right: -3px; width: 6px; height: 100%; cursor: col-resize; user-select: none; z-index: 10; }
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .tab-content { padding: 16px; min-height: 400px; }
            .tab-button { padding: 8px 16px; font-size: 14px; }
            table { min-width: 600px; font-size: 12px; }
            th, td { padding: 8px 4px; }
            .grid { gap: 12px; }
            .p-6 { padding: 16px; }
            .text-3xl { font-size: 1.5rem; }
            .text-lg { font-size: 1rem; }
            .flex-wrap { flex-wrap: wrap; }
            .space-x-3 > * + * { margin-left: 8px; }
            .space-x-4 > * + * { margin-left: 12px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 8px; }
            .tab-content { padding: 12px; }
            .tab-button { padding: 6px 12px; font-size: 12px; }
            table { min-width: 500px; font-size: 11px; }
            th, td { padding: 6px 3px; }
            .grid { gap: 8px; }
            .p-6 { padding: 12px; }
            .text-3xl { font-size: 1.25rem; }
            .text-lg { font-size: 0.9rem; }
            .flex { flex-direction: column; }
            .space-x-3 > * + * { margin-left: 0; margin-top: 8px; }
            .space-x-4 > * + * { margin-left: 0; margin-top: 12px; }
        }
        tbody tr:hover { background-color: #f8fafc; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:nth-child(even):hover { background-color: #f1f5f9; }
        input, select, button { border-radius: 6px; }
        input, select { border: 1px solid #d1d5db; padding: 8px; width: 100%; box-sizing: border-box; background-color: #ffffff; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal { background-color: white; padding: 24px; border-radius: 8px; z-index: 50; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="max-w-md w-full space-y-8 p-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ” AtÃ¶lye YÃ¶netim Sistemi</h1>
                <p class="text-gray-600">GÃ¼venli eriÅŸim iÃ§in ÅŸifrenizi girin</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” Åifre</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Åifrenizi girin">
                    </div>
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        ğŸ”“ Sisteme GiriÅŸ Yap
                    </button>
                </form>
                <div class="mt-6 text-center">
                    <div class="text-xs text-gray-500">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden by default) -->
    <div id="mainApp" class="hidden">
    <div class="container bg-white rounded-lg shadow-xl p-8">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 space-y-4 lg:space-y-0">
            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">AtÃ¶lye Ãœretim & Finans Takibi</h1>
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="saveData(true, true)" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-sm">ğŸ’¾ Veri Kaydet</button>
                <button onclick="importData()" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">ğŸ“¥ Ä°Ã§e Aktar</button>
                <button onclick="exportData()" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 text-sm">ğŸ“¤ DÄ±ÅŸa Aktar</button>
                <button onclick="testFirebaseConnection()" class="bg-cyan-600 text-white px-3 py-2 rounded-md hover:bg-cyan-700 text-sm">ğŸ”¥ Firebase</button>
                <button onclick="checkDataLoadingStatus()" class="bg-yellow-600 text-white px-3 py-2 rounded-md hover:bg-yellow-700 text-sm">ğŸ› Debug</button>
                <button onclick="handleClearAllData()" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 text-sm">ğŸ—‘ï¸ Temizle</button>
                <button onclick="logout()" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700 text-sm">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div id="tabContainer" class="flex flex-wrap border-b border-gray-200 mb-6">
            <!-- Tabs will be dynamically generated here -->
        </div>

        <!-- All Tab Contents -->
        <div id="dashboard" class="tab-content"></div>
        <div id="cashFlow" class="tab-content hidden"></div>
        <div id="expenses" class="tab-content hidden"></div>
        <div id="suppliers" class="tab-content hidden"></div>
        <div id="customers" class="tab-content hidden"></div>
        <div id="rawMaterials" class="tab-content hidden"></div>
        <div id="materials" class="tab-content hidden"></div>
        <div id="products" class="tab-content hidden"></div>
        <div id="productionLog" class="tab-content hidden"></div>
        <div id="productionPlanning" class="tab-content hidden"></div>
        <div id="stock" class="tab-content hidden"></div>
        <div id="failedPrints" class="tab-content hidden"></div>
        <div id="sales" class="tab-content hidden"></div>
        <div id="parameters" class="tab-content hidden"></div>
    </div>

    <!-- Modals -->
    <div id="addMaterialModal" class="modal-backdrop hidden"></div>
    <div id="updateStockModal" class="modal-backdrop hidden"></div>
    <div id="addSaleModal" class="modal-backdrop hidden"></div>
    <div id="quickSaleModal" class="modal-backdrop hidden"></div>
    <div id="addFailedPrintModal" class="modal-backdrop hidden"></div>
    <div id="accountModal" class="modal-backdrop hidden"></div>
    <div id="customParamModal" class="modal-backdrop hidden"></div>
    <div id="addPaymentModal" class="modal-backdrop hidden"></div>
    <div id="accountDetailModal" class="modal-backdrop hidden"></div>
    <div id="editTransactionModal" class="modal-backdrop hidden"></div>
    <div id="addExpenseModal" class="modal-backdrop hidden"></div>
    <div id="addMoneyModal" class="modal-backdrop hidden"></div>
    <div id="addMaterialItemModal" class="modal-backdrop hidden"></div>
    <div id="addProductionPlanModal" class="modal-backdrop hidden"></div>
    <div id="editProductionPlanModal" class="modal-backdrop hidden"></div>
    <div id="sendToProductionModal" class="modal-backdrop hidden"></div>
    </div> <!-- mainApp kapanÄ±ÅŸ -->
    <div id="messageModal" class="modal-backdrop hidden">
        <div class="modal max-w-sm">
            <h3 id="messageModalTitle" class="text-xl font-semibold mb-4">UyarÄ±</h3>
            <p id="messageModalText" class="text-gray-700"></p>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('messageModal')" class="bg-blue-600 text-white px-4 py-2 rounded-md">Tamam</button>
            </div>
        </div>
    </div>
     <div id="confirmModal" class="modal-backdrop hidden">
        <div class="modal max-w-sm">
            <h3 id="confirmModalTitle" class="text-xl font-semibold mb-4">Onay</h3>
            <p id="confirmModalText" class="text-gray-700"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirmModalCancel" class="bg-gray-300 px-4 py-2 rounded-md">Ä°ptal</button>
                <button id="confirmModalConfirm" class="bg-red-600 text-white px-4 py-2 rounded-md">Onayla</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleFileSelect(event)">


    <script>
        // --- FIREBASE CONFIGURATION ---
        // Firebase konfigÃ¼rasyonu yukarÄ±da module olarak yÃ¼klendi
        
        // --- GLOBAL DATA STORES ---
        let suppliers = [], customers = [], rawMaterials = [], materials = [], products = [], recipes = [], productionLog = [], salesLog = [], accounts = [], payments = [], expenses = [], productionPlans = [], failedPrints = [];
        let parameters = {}; // Will hold core parameters and tabOrder
        let customParameters = []; // Will hold user-defined cost parameters
        
        // Security variables
        let isLoggedIn = false;
        const APP_PASSWORD = 'Dofi1234';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 saat
        
        // Firebase variables
        let firebaseInitialized = false;
        
        // --- SECURITY FUNCTIONS ---
        async function checkLoginStatus() {
            const sessionData = localStorage.getItem('appSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const now = new Date().getTime();
                
                if (now - session.loginTime < SESSION_DURATION) {
                    isLoggedIn = true;
                    showMainApp();
                    return true;
                } else {
                    logout();
                }
            }
            return false;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function logout() {
            isLoggedIn = false;
            localStorage.removeItem('appSession');
            showLoginScreen();
            showNotification('Oturum sonlandÄ±rÄ±ldÄ±.', 'info', 3000);
        }

        function authenticateUser(password) {
            return password === APP_PASSWORD;
        }

        function requireLogin() {
            if (!isLoggedIn) {
                showLoginScreen();
                showNotification('Bu iÅŸlem iÃ§in giriÅŸ yapmanÄ±z gerekiyor!', 'warning', 3000);
                return false;
            }
            return true;
        }

        // Firebase baÄŸlantÄ± fonksiyonu
        
        let charts = {}; // To hold chart instances
        let currentOpenAccountId = null; // To track which account detail modal is open
        let draggedTabId = null;
        let currentProductPage = 1; // Current page for product listing
        let productsPerPage = 10; // Products per page
        let expandedProductId = null; // Currently expanded product ID
        
        const LOCAL_DATA_KEY = 'atolyeTracker_local_v30'; // Version incremented
        const BACKUP_DATA_KEY = 'atolyeTracker_backup_v30';
        const AUTO_BACKUP_INTERVAL = 30 * 1000; // 30 saniyede bir otomatik yedekleme
        let lastSaveTime = 0;
        let pendingChanges = false;
        let autoBackupTimer = null;

        const ALL_TABS = [
            { id: 'dashboard', title: 'GÃ¶sterge Paneli', renderFunc: renderDashboard },
            { id: 'cashFlow', title: 'Kasa', renderFunc: renderCashFlow },
            { id: 'expenses', title: 'Giderler', renderFunc: renderExpenses },
            { id: 'suppliers', title: 'TedarikÃ§iler', renderFunc: renderSuppliers },
            { id: 'customers', title: 'Cariler', renderFunc: renderCustomers },
            { id: 'rawMaterials', title: 'Hammaddeler', renderFunc: renderRawMaterials },
            { id: 'materials', title: 'Malzemeler', renderFunc: renderMaterials },
            { id: 'products', title: 'ÃœrÃ¼nler', renderFunc: renderProducts },
            { id: 'productionLog', title: 'Ãœretim KaydÄ±', renderFunc: renderProductionLog },
            { id: 'productionPlanning', title: 'Planlama SÃ¼reci', renderFunc: renderProductionPlanning },
            { id: 'stock', title: 'Stok Takip', renderFunc: renderStockStatus },
            { id: 'failedPrints', title: 'BaskÄ± HatalarÄ±', renderFunc: renderFailedPrints },
            { id: 'sales', title: 'SatÄ±ÅŸ KaydÄ±', renderFunc: renderSalesLog },
            { id: 'parameters', title: 'Parametreler', renderFunc: renderParameters }
        ];

        // --- DATA PERSISTENCE ---
        function saveData(silent = false, force = false) {
            if (!requireLogin()) return;
            const now = Date.now();
            
            // Son kaydetme Ã¼zerinden 30 saniye geÃ§memiÅŸse ve zorla kaydetme deÄŸilse atla
            if (!force && (now - lastSaveTime) < 30000) {
                pendingChanges = true;
                return;
            }
            
            try {
                const appData = { 
                    suppliers, 
                    customers, 
                    rawMaterials, 
                    products, 
                    recipes, 
                    productionLog, 
                    salesLog, 
                    accounts, 
                    parameters, 
                    customParameters, 
                    payments, 
                    expenses, 
                    materials, 
                    productionPlans, 
                    failedPrints,
                    // Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in export bilgisi
                    lastSaved: new Date().toISOString(),
                    version: "v30"
                };
                
                // Local storage'a kaydet
            localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify(appData));
            
            // Firebase'e kaydet
            saveDataToFirebase(appData);
            
            // Otomatik yedekleme
            createAutoBackup();
            
            lastSaveTime = now;
            pendingChanges = false;
            
            // Sessiz kaydetme deÄŸilse bildirim gÃ¶ster
            if (!silent) {
                showNotification('ğŸ’¾ Veriler kaydedildi', 'success', 2000);
                }
            } catch (error) {
                console.error('Veri kaydetme hatasÄ±:', error);
                if (!silent) {
                    showNotification('âŒ Veri kaydetme hatasÄ±: ' + error.message, 'error', 5000);
                }
            }
        }
        
        // AkÄ±llÄ± kaydetme sistemi
        function smartSave() {
            if (pendingChanges) {
                saveData(true, true); // Sessiz ve zorla kaydet
            } else {
                // Her durumda Firebase'e gÃ¶nder
                saveDataToFirebase({
                    suppliers, customers, rawMaterials, products, recipes, 
                    productionLog, salesLog, accounts, parameters, customParameters, 
                    payments, expenses, materials, productionPlans, failedPrints
                });
            }
        }

        // Firebase veri kaydetme
        function saveDataToFirebase(data) {
            try {
                if (window.firebaseDatabase) {
                    // Her zaman gÃ¼ncel timestamp ekle
                    const dataWithTimestamp = {
                        ...data,
                        lastSaved: new Date().toISOString(),
                        version: "v30"
                    };
                    
                    const dataRef = window.firebaseDatabase.ref('workshopData');
                    dataRef.set(dataWithTimestamp)
                        .then(() => {
                            console.log('Veriler Firebase\'e kaydedildi - Timestamp:', dataWithTimestamp.lastSaved);
                        })
                        .catch((error) => {
                            console.error('Firebase kaydetme hatasÄ±:', error);
                        });
                }
            } catch (error) {
                console.error('Firebase baÄŸlantÄ± hatasÄ±:', error);
            }
        }

        // Firebase'den veri yÃ¼kleme
        function loadDataFromFirebase() {
            try {
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseDatabase.ref('workshopData');
                    dataRef.once('value').then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            console.log('Firebase\'den veri yÃ¼klendi:', data);
                            
                            // Local storage'daki veri ile karÅŸÄ±laÅŸtÄ±r
                            const localData = localStorage.getItem(LOCAL_DATA_KEY);
                            if (localData) {
                                try {
                                    const parsedLocalData = JSON.parse(localData);
                                    const localTimestamp = parsedLocalData.lastSaved ? new Date(parsedLocalData.lastSaved).getTime() : 0;
                                    const firebaseTimestamp = data.lastSaved ? new Date(data.lastSaved).getTime() : 0;
                                    
                                    console.log('Local timestamp:', localTimestamp, 'Firebase timestamp:', firebaseTimestamp);
                                    
                                    // Sadece Firebase verisi daha yeniyse yÃ¼kle
                                    if (firebaseTimestamp > localTimestamp) {
                                        console.log('Firebase verisi daha gÃ¼ncel, yÃ¼kleniyor');
                                        applyState(data);
                                        // Sadece aktif tab'Ä± render et
                                        const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId;
                                        if (activeTabId) {
                                            const tabInfo = ALL_TABS.find(t => t.id === activeTabId);
                                            if (tabInfo && tabInfo.renderFunc) {
                                                tabInfo.renderFunc();
                                            }
                                        }
                                        console.log('Veriler Firebase\'den baÅŸarÄ±yla yÃ¼klendi');
                                    } else {
                                        console.log('Local veri daha gÃ¼ncel veya eÅŸit, Firebase verisi yÃ¼klenmedi');
                                    }
                                } catch (e) {
                                    console.error('Local veri parse hatasÄ±:', e);
                                    // Hata varsa Firebase verisini yÃ¼kle
                                    applyState(data);
                                }
                            } else {
                                // Local veri yoksa Firebase verisini yÃ¼kle
                                applyState(data);
                                // Sadece aktif tab'Ä± render et
                                const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId;
                                if (activeTabId) {
                                    const tabInfo = ALL_TABS.find(t => t.id === activeTabId);
                                    if (tabInfo && tabInfo.renderFunc) {
                                        tabInfo.renderFunc();
                                    }
                                }
                                console.log('Veriler Firebase\'den baÅŸarÄ±yla yÃ¼klendi');
                            }
                        } else {
                            console.log('Firebase\'de veri bulunamadÄ±, local veri yÃ¼kleniyor');
                            loadData();
                        }
                    }).catch((error) => {
                        console.error('Firebase veri yÃ¼kleme hatasÄ±:', error);
                        loadData();
                    });
                } else {
                    console.log('Firebase baÄŸlantÄ±sÄ± yok, local veri yÃ¼kleniyor');
                    loadData();
                }
            } catch (error) {
                console.error('Firebase yÃ¼kleme hatasÄ±:', error);
                loadData();
            }
        }

        // Firebase'den veri Ã§ek
        function downloadFromFirebase() {
            if (!window.firebaseDatabase) {
                showMessageModal("Hata", "Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen Ã¶nce Firebase Test butonuna tÄ±klayÄ±n.");
                return;
            }

            try {
                const dataRef = window.firebaseDatabase.ref('workshopData');
                dataRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // Veriyi local storage'a kaydet
                            localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify(data));
                            
                            // Veriyi uygulamaya yÃ¼kle
                            applyState(data);
                            renderAllTabsAndModals();
                            
                            showMessageModal("BaÅŸarÄ±lÄ±", "Veriler Firebase'den baÅŸarÄ±yla Ã§ekildi ve uygulamaya yÃ¼klendi!");
                        } else {
                            showMessageModal("Bilgi", "Firebase'de veri bulunamadÄ±.");
                        }
                    })
                    .catch((error) => {
                        console.error('Firebase veri Ã§ekme hatasÄ±:', error);
                        showMessageModal("Hata", "Firebase'den veri Ã§ekilemedi: " + error.message);
                    });
            } catch (error) {
                console.error('Firebase baÄŸlantÄ± hatasÄ±:', error);
                showMessageModal("Hata", "Firebase baÄŸlantÄ± hatasÄ±: " + error.message);
            }
        }

        // Firebase'e veri yÃ¼kle
        function uploadToFirebase() {
            if (!window.firebaseDatabase) {
                showMessageModal("Hata", "Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen Ã¶nce Firebase Test butonuna tÄ±klayÄ±n.");
                return;
            }

            try {
                const appData = { 
                    suppliers, 
                    customers, 
                    rawMaterials, 
                    products, 
                    recipes, 
                    productionLog, 
                    salesLog, 
                    accounts, 
                    parameters, 
                    customParameters, 
                    payments, 
                    expenses, 
                    materials, 
                    productionPlans,
                    failedPrints
                };
                
                const dataRef = window.firebaseDatabase.ref('workshopData');
                dataRef.set(appData)
                    .then(() => {
                        showMessageModal("BaÅŸarÄ±lÄ±", "Veriler Firebase'e baÅŸarÄ±yla yÃ¼klendi!");
                        console.log('Veriler Firebase\'e yÃ¼klendi');
                    })
                    .catch((error) => {
                        console.error('Firebase veri yÃ¼kleme hatasÄ±:', error);
                        showMessageModal("Hata", "Firebase'e veri yÃ¼klenemedi: " + error.message);
                    });
            } catch (error) {
                console.error('Firebase baÄŸlantÄ± hatasÄ±:', error);
                showMessageModal("Hata", "Firebase baÄŸlantÄ± hatasÄ±: " + error.message);
            }
        }

        // Firebase baÄŸlantÄ±sÄ±nÄ± test et
        function testFirebaseConnection() {
            // Ã–nce Firebase'i baÅŸlatmayÄ± dene
            if (!window.firebaseDatabase) {
                console.log('Firebase baÅŸlatÄ±lmamÄ±ÅŸ, baÅŸlatÄ±lÄ±yor...');
                initializeFirebase();
            }
            
            if (window.firebaseDatabase) {
                console.log('Firebase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!');
                showMessageModal("BaÅŸarÄ±lÄ±", "Firebase baÄŸlantÄ±sÄ± kuruldu! Verileriniz artÄ±k cloud'da saklanÄ±yor.");
                return true;
            } else {
                console.log('Firebase baÄŸlantÄ±sÄ± kurulamadÄ±!');
                showMessageModal("Hata", "Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
                return false;
            }
        }

        // TarayÄ±cÄ± uyumluluÄŸunu kontrol et
        function checkBrowserCompatibility() {
            const userAgent = navigator.userAgent;
            const isEdge = userAgent.includes('Edg/');
            const isChrome = userAgent.includes('Chrome/');
            const isFirefox = userAgent.includes('Firefox/');
            
            console.log('TarayÄ±cÄ±:', userAgent);
            console.log('Edge:', isEdge);
            console.log('Chrome:', isChrome);
            console.log('Firefox:', isFirefox);
            
            if (isEdge) {
                console.log('Edge tarayÄ±cÄ±sÄ± tespit edildi - uyumluluk modu aktif');
            }
        }

        // Veri yÃ¼kleme durumunu kontrol et
        function checkDataLoadingStatus() {
            console.log('Veri yÃ¼kleme durumu:');
            console.log('- Suppliers:', suppliers.length);
            console.log('- Customers:', customers.length);
            console.log('- Products:', products.length);
            console.log('- Production Plans:', productionPlans.length);
            console.log('- Firebase Database:', window.firebaseDatabase ? 'Mevcut' : 'Yok');
        }

        function createAutoBackup() {
            const appData = { suppliers, customers, rawMaterials, products, recipes, productionLog, salesLog, accounts, parameters, customParameters, payments, expenses, materials, productionPlans, failedPrints };
            const backupData = {
                ...appData,
                backupDate: new Date().toISOString(),
                version: 'v30'
            };
            localStorage.setItem(BACKUP_DATA_KEY, JSON.stringify(backupData));
        }

        function startAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
            }
            autoBackupTimer = setInterval(() => {
                smartSave(); // AkÄ±llÄ± kaydetme
                createAutoBackup();
                console.log('Otomatik yedekleme tamamlandÄ±:', new Date().toLocaleString('tr-TR'));
            }, AUTO_BACKUP_INTERVAL);
        }

        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
        }


        function loadData() {
            // Ã–nce local veriyi yÃ¼kle (Edge uyumluluÄŸu iÃ§in)
            const savedData = localStorage.getItem(LOCAL_DATA_KEY);
            if(savedData) {
                try {
                applyState(JSON.parse(savedData));
                    console.log('Local veriler yÃ¼klendi');
                } catch (error) {
                    console.error('Local veri yÃ¼kleme hatasÄ±:', error);
                    loadDefaultData();
                }
            } else {
                loadDefaultData();
            }
            
            // Sonra Firebase'den yÃ¼klemeyi dene (eÄŸer varsa)
            setTimeout(() => {
                loadDataFromFirebase();
            }, 1000);
        }

        function loadDefaultData() {
            const defaultData = { 
                "suppliers": [], 
                "customers": [], 
                "rawMaterials": [], 
                "products": [], 
                "recipes": [], 
                "productionLog": [], 
                "salesLog": [], 
                "payments": [], 
                "expenses": [], 
                "materials": [], 
                "productionPlans": [], 
                "failedPrints": [],
                "customParameters": [],
                "parameters": { 
                    "machineKw": 0.095, 
                    "electricityKwhPrice": 0.48, 
                    "machineInitialCost": 20000, 
                    "machineLifespanHours": 10000, 
                    "laborCostPerProduct": 0, 
                    "failedPrintRate": 3, 
                    "profitMargin": 0,
                    "tabOrder": ALL_TABS.map(t => t.id)
                } 
            };
                if (!defaultData.accounts || defaultData.accounts.length === 0) {
                    defaultData.accounts = [{ id: 'cash-default', type: 'nakit', name: 'Nakit Kasa', initialBalance: 0 }];
                }
                applyState(defaultData);
                saveData(); 
        }
        
        function applyState(appData) {
            console.log('Veri yÃ¼kleniyor:', appData);
            
            suppliers = appData.suppliers || [];
            customers = appData.customers || [];
            rawMaterials = appData.rawMaterials || [];
            materials = appData.materials || [];
            products = appData.products || [];
            recipes = appData.recipes || []; // Kept for migration
            productionLog = appData.productionLog || [];
            salesLog = appData.salesLog || [];
            accounts = appData.accounts || [];
            payments = appData.payments || [];
            expenses = appData.expenses || [];
            productionPlans = appData.productionPlans || [];
            failedPrints = appData.failedPrints || [];
            parameters = appData.parameters || {};
            customParameters = appData.customParameters || [];
            
            // tabOrder iÃ§in gÃ¼venli eriÅŸim
            if (!parameters.tabOrder || parameters.tabOrder.length === 0) {
                parameters.tabOrder = ALL_TABS.map(t => t.id);
            }
            
            console.log('Yeni renk sistemi ile products:', products);

            if (!parameters.tabOrder) {
                parameters.tabOrder = ALL_TABS.map(t => t.id);
            }
            
            // BaÅŸarÄ±sÄ±z baskÄ± oranÄ±nÄ± %3 olarak gÃ¼ncelle
            if (parameters.failedPrintRate === 20) {
                parameters.failedPrintRate = 3;
            }
            
            // --- DATA MIGRATION from older versions ---
            products.forEach(p => {
                if (p.hasOwnProperty('printTime') || p.hasOwnProperty('filamentUsage')) { 
                    if (!p.variants || p.variants.length === 0) {
                        p.variants = [{ id: crypto.randomUUID(), name: 'Ana ParÃ§a', printTime: p.printTime || 0, filamentUsage: p.filamentUsage || 0 }];
                    }
                    delete p.printTime;
                    delete p.filamentUsage;
                }
                
                // Migrate variants to new color system
                if (p.variants) {
                    p.variants.forEach(variant => {
                        // EÄŸer variant'ta colors array'i yoksa oluÅŸtur
                        if (!variant.colors) {
                            variant.colors = [];
                        }
                        
                        // Eski filamentOption'larÄ± colors'a migrate et
                        for (let i = 1; i <= 5; i++) {
                            const filamentOptionId = `filamentOption${i}`;
                            if (variant[filamentOptionId]) {
                                const filament = rawMaterials.find(rm => rm.id === variant[filamentOptionId]);
                                if (filament && !variant.colors.find(c => c.filamentId === variant[filamentOptionId])) {
                                    variant.colors.push({
                                        name: `Renk ${i}`,
                                        filamentId: variant[filamentOptionId],
                                        gram: 0 // Default gram deÄŸeri
                                    });
                                }
                                delete variant[filamentOptionId];
                            }
                        }
                    });
                }
                
                // Migrate recipes to product.extraMaterials
                const productRecipe = recipes.find(r => r.productId === p.id);
                if (productRecipe && !p.extraMaterials) {
                    p.extraMaterials = productRecipe.materials.map(m => ({...m}));
                }
            });
            
            console.log('Migration sonrasÄ± products:', products);
            // After migration, we can potentially clear the old recipes array
            // recipes = []; 

            productionLog.forEach(entry => { 
                // MIGRATION: Ensure older production logs have a variantId
                if (!entry.variantId) {
                    const product = products.find(p => p.id === entry.productId);
                    if (product && product.variants && product.variants.length > 0) {
                        entry.variantId = product.variants[0].id; // Default to the first variant
                    }
                }

                if (!entry.customValues) entry.customValues = {}; 
                // Migrate materialAssignments to filamentOverrideId
                if(entry.materialAssignments && !entry.filamentOverrideId){
                    const firstFilament = entry.materialAssignments[0];
                    if(firstFilament) entry.filamentOverrideId = firstFilament.rawMaterialId;
                    delete entry.materialAssignments;
                }
                 if (!entry.filamentOverrideId) entry.filamentOverrideId = '';
            });

            rawMaterials.forEach(rm => {
                if (rm.stockHistory) {
                    rm.stockHistory.forEach(h => {
                        if (!h.id) h.id = crypto.randomUUID();
                    });
                }
                // Fix minStock data type
                if (typeof rm.minStock === 'string') {
                    rm.minStock = parseFloat(rm.minStock) || 0;
                }
            });
            
            // Ensure accounts have transactions array
            accounts.forEach(account => {
                if (!account.transactions) {
                    account.transactions = [];
                    console.log('ğŸ” Hesap transaction array\'i oluÅŸturuldu:', account.name);
                }
            });
            
            // Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼
            validateDataIntegrity();
        }

        // Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼
        function validateDataIntegrity() {
            console.log('ğŸ” Veri BÃ¼tÃ¼nlÃ¼ÄŸÃ¼ KontrolÃ¼:');
            
            // TÃ¼m gerekli array'lerin var olduÄŸunu kontrol et
            const dataArrays = {
                suppliers, customers, rawMaterials, materials, 
                products, productionLog, salesLog, accounts, 
                payments, expenses, productionPlans, failedPrints
            };
            
            Object.entries(dataArrays).forEach(([arrayName, arrayValue]) => {
                if (!arrayValue) {
                    console.warn(`âš ï¸ ${arrayName} array'i bulunamadÄ±!`);
                } else if (!Array.isArray(arrayValue)) {
                    console.warn(`âš ï¸ ${arrayName} array deÄŸil!`);
                } else {
                    console.log(`âœ… ${arrayName}: ${arrayValue.length} kayÄ±t`);
                }
            });
            
            // Hesap transaction'larÄ±nÄ± kontrol et
            if (accounts && Array.isArray(accounts)) {
                accounts.forEach(account => {
                    if (!account.transactions) {
                        console.warn(`âš ï¸ ${account.name} hesabÄ±nda transaction array'i yok!`);
                        account.transactions = [];
                    }
                });
            }
            
            // ÃœrÃ¼n varyantlarÄ±nÄ± kontrol et
            if (products && Array.isArray(products)) {
                products.forEach(product => {
                    if (!product.variants) {
                        console.warn(`âš ï¸ ${product.name} Ã¼rÃ¼nÃ¼nde variants array'i yok!`);
                        product.variants = [];
                    }
                });
            }
            
            console.log('ğŸ” Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼ tamamlandÄ±.');
        }

        function handleClearAllData() {
            if (!requireLogin()) return;
            showConfirmModal(
                "TÃ¼m Verileri Sil",
                "Emin misiniz? Bu tarayÄ±cÄ±daki TÃœM VERÄ°LER kalÄ±cÄ± olarak silinecek. Bu iÅŸlem geri alÄ±namaz.",
                () => {
                    localStorage.removeItem(LOCAL_DATA_KEY);
                    location.reload();
                }
            );
        }
        
        function showMessageModal(title, message) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalText').textContent = message;
            showModal('messageModal');
        }
        
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = message;
            
            const confirmBtn = document.getElementById('confirmModalConfirm');
            const cancelBtn = document.getElementById('confirmModalCancel');

            // Clone and replace to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };

            cancelBtn.onclick = () => closeModal('confirmModal');

            showModal('confirmModal');
        }



        // --- AUTOCOMPLETE SYSTEM ---
        function createAutocomplete(inputElement, dataSource, displayField = 'name', valueField = 'id') {
            let currentFocus = -1;
            let suggestions = [];
            
            // Autocomplete container
            const container = document.createElement('div');
            container.className = 'autocomplete-container relative';
            inputElement.parentNode.insertBefore(container, inputElement);
            container.appendChild(inputElement);
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'autocomplete-suggestions hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-y-auto';
            container.appendChild(suggestionsDiv);
            
            inputElement.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                suggestions = dataSource.filter(item => 
                    item[displayField].toLowerCase().includes(value)
                ).slice(0, 10); // Max 10 Ã¶neri
                
                currentFocus = -1;
                showSuggestions();
            });
            
            inputElement.addEventListener('keydown', function(e) {
                if (!suggestionsDiv.classList.contains('hidden')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        currentFocus = Math.min(currentFocus + 1, suggestions.length - 1);
                        updateActiveSuggestion();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        currentFocus = Math.max(currentFocus - 1, -1);
                        updateActiveSuggestion();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (currentFocus >= 0) {
                            selectSuggestion(suggestions[currentFocus]);
                        }
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                }
            });
            
            // Input dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda Ã¶nerileri gizle
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    hideSuggestions();
                }
            });
            
            function showSuggestions() {
                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                suggestionsDiv.innerHTML = suggestions.map((item, index) => 
                    `<div class="suggestion-item px-3 py-2 cursor-pointer hover:bg-gray-100 ${index === currentFocus ? 'bg-blue-100' : ''}" 
                         data-index="${index}" data-value="${item[valueField]}">
                        ${item[displayField]}
                    </div>`
                ).join('');
                
                // Click events
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selectSuggestion(suggestions[index]);
                    });
                });
                
                suggestionsDiv.classList.remove('hidden');
            }
            
            function hideSuggestions() {
                suggestionsDiv.classList.add('hidden');
                currentFocus = -1;
            }
            
            function updateActiveSuggestion() {
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
                    item.classList.toggle('bg-blue-100', index === currentFocus);
                });
            }
            
            function selectSuggestion(item) {
                inputElement.value = item[displayField];
                inputElement.dataset.selectedValue = item[valueField];
                hideSuggestions();
                
                // Custom event dispatch
                inputElement.dispatchEvent(new CustomEvent('autocomplete-select', {
                    detail: { selectedItem: item }
                }));
            }
        }

        // --- NOTIFICATION SYSTEM ---
        function showNotification(message, type = 'info', duration = 4000) {
            // Mevcut bildirimleri kaldÄ±r
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm transition-all duration-300 transform translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-black',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-lg leading-none opacity-70 hover:opacity-100">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animasyon iÃ§in timeout
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Otomatik kapatma
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        // --- IMPORT / EXPORT ---
        function exportData() {
            if (!requireLogin()) return;
            // Debug: Hesap bilgilerini kontrol et
            console.log('Export Ã¶ncesi hesap bilgileri:');
            accounts.forEach(account => {
                console.log(`Hesap: ${account.name}, Transactions: ${account.transactions?.length || 0}`);
                if (account.transactions) {
                    account.transactions.forEach(tx => {
                        console.log(`  - ${tx.type}: ${tx.amount} TL (${tx.description})`);
                    });
                }
            });
            
            const appData = { 
                suppliers, 
                customers, 
                rawMaterials, 
                products, 
                recipes, // recipes eksikti!
                productionLog, 
                salesLog, 
                accounts, 
                parameters, 
                customParameters, 
                payments, 
                expenses, 
                materials, 
                productionPlans, 
                failedPrints, // BaskÄ± hatalarÄ± eklendi
                // Yeni eklenen veri tÃ¼rleri
                variants: products.flatMap(p => p.variants || []),
                colors: products.flatMap(p => p.variants?.flatMap(v => v.colors || []) || []),
                // Export tarihi ve versiyon bilgisi
                exportInfo: {
                    timestamp: new Date().toISOString(),
                    version: "v30",
                    totalProducts: products.length,
                    totalVariants: products.reduce((sum, p) => sum + (p.variants?.length || 0), 0),
                    totalColors: products.reduce((sum, p) => sum + (p.variants?.reduce((vSum, v) => vSum + (v.colors?.length || 0), 0) || 0), 0),
                    totalAccounts: accounts.length,
                    totalAccountTransactions: accounts.reduce((sum, a) => sum + (a.transactions?.length || 0), 0),
                    totalPayments: payments.length,
                    totalExpenses: expenses.length,
                    totalSales: salesLog.length,
                    totalProductionLog: productionLog.length,
                    totalFailedPrints: failedPrints.length // BaskÄ± hatalarÄ± sayÄ±sÄ± eklendi
                }
            };
            const dataStr = JSON.stringify(appData, null, 2);
            const now = new Date();
            const timestamp = `${now.getFullYear().toString().padStart(4, '0')}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            const filename = `atolye_verileri_${timestamp}.json`;
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            // BaÅŸarÄ±lÄ± export bildirimi
            showNotification(`Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!<br>
                ğŸ“Š ${appData.exportInfo.totalProducts} Ã¼rÃ¼n<br>
                ğŸ”§ ${appData.exportInfo.totalVariants} varyant<br>
                ğŸ¨ ${appData.exportInfo.totalColors} renk<br>
                ğŸ’° ${appData.exportInfo.totalAccounts} hesap<br>
                ğŸ“‹ ${appData.exportInfo.totalAccountTransactions} hesap hareketi<br>
                ğŸ’¸ ${appData.exportInfo.totalPayments} tahsilat<br>
                ğŸ“‰ ${appData.exportInfo.totalExpenses} gider<br>
                ğŸ›’ ${appData.exportInfo.totalSales} satÄ±ÅŸ<br>
                ğŸ­ ${appData.exportInfo.totalProductionLog} Ã¼retim kaydÄ±<br>
                ğŸ’¾ Dosya: ${filename}`, 'success');
        }

        function importData() {
            if (!requireLogin()) return;
            document.getElementById('importFile').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object' && importedData.parameters) {
                        showConfirmModal(
                            "Verileri Ä°Ã§e Aktar",
                            "Mevcut veriler, yÃ¼klediÄŸiniz dosyadaki verilerle deÄŸiÅŸtirilecektir. OnaylÄ±yor musunuz?",
                            () => {
                                // Debug: Import Ã¶ncesi hesap bilgilerini kontrol et
                                console.log('Import Ã¶ncesi hesap bilgileri:');
                                if (importedData.accounts) {
                                    importedData.accounts.forEach(account => {
                                        console.log(`Import - Hesap: ${account.name}, Transactions: ${account.transactions?.length || 0}`);
                                        if (account.transactions) {
                                            account.transactions.forEach(tx => {
                                                console.log(`  - ${tx.type}: ${tx.amount} TL (${tx.description})`);
                                            });
                                        }
                                    });
                                }
                                
                                applyState(importedData);
                                saveData(true, true); // Zorla Firebase'e gÃ¶nder
                                renderAllTabsAndModals();
                                
                                // Import bilgilerini gÃ¶ster
                                const importInfo = importedData.exportInfo || {};
                                showNotification(`Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!<br>
                                    ğŸ“Š ${importInfo.totalProducts || 'Bilinmiyor'} Ã¼rÃ¼n<br>
                                    ğŸ”§ ${importInfo.totalVariants || 'Bilinmiyor'} varyant<br>
                                    ğŸ¨ ${importInfo.totalColors || 'Bilinmiyor'} renk<br>
                                    ğŸ’° ${importInfo.totalAccounts || 'Bilinmiyor'} hesap<br>
                                    ğŸ“‹ ${importInfo.totalAccountTransactions || 'Bilinmiyor'} hesap hareketi<br>
                                    ğŸ’¸ ${importInfo.totalPayments || 'Bilinmiyor'} tahsilat<br>
                                    ğŸ“‰ ${importInfo.totalExpenses || 'Bilinmiyor'} gider<br>
                                    ğŸ›’ ${importInfo.totalSales || 'Bilinmiyor'} satÄ±ÅŸ<br>
                                    ğŸ­ ${importInfo.totalProductionLog || 'Bilinmiyor'} Ã¼retim kaydÄ±<br>
                                    ğŸ“… ${importInfo.timestamp ? new Date(importInfo.timestamp).toLocaleString('tr-TR') : 'Bilinmiyor'}`, 'success');
                            }
                        );
                    } else {
                        showMessageModal("Hata", "GeÃ§ersiz dosya formatÄ±.");
                    }
                } catch (error) {
                    showMessageModal("Hata", "Dosya okunurken bir hata oluÅŸtu: " + error.message);
                } finally {
                    document.getElementById('importFile').value = '';
                }
            };
            reader.readAsText(file);
        }


        // --- RENDER FUNCTIONS ---
        function getAccountHTML(account) { return `<div class="card removable" data-id="${account.id}"><div class="card-header"><input type="text" value="${account.name}" onchange="updateAccountName('${account.id}', this.value)" class="text-lg font-semibold border-none w-1/2 p-0"><button onclick="openEditAccountModal('${account.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">DÃ¼zenle</button><button onclick="removeElement(this, 'account')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></div><p class="text-2xl font-bold">${calculateAccountSummary(account.id).currentBalance.toFixed(2)} TL</p><div class="flex space-x-2 mt-2"><button onclick="openAddMoneyModal('${account.id}')" class="bg-green-600 text-white px-3 py-1 text-xs rounded-md hover:bg-green-700">ğŸ’° Para Ekle</button><button onclick="renderAccountDetails('${account.id}')" class="bg-blue-500 text-white px-2 py-1 text-xs rounded-md">Detaylar</button></div></div>`; }
        function getSupplierHTML(supplier) {
            let materialsHTML = (supplier.materials || []).map(mat => {
                const filamentTypeOptions = ['PLA', 'PETG', 'ABS'].map(type => 
                    `<option value="${type}" ${mat.type === type ? 'selected' : ''}>${type}</option>`
                ).join('');
                
                return `
                <tr class="removable" data-id="${mat.id}">
                    <td><input type="text" value="${mat.name || 'Filament'}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'name', this.value)" tabindex="1"></td>
                    <td><input type="text" value="${mat.brand}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'brand', this.value)" tabindex="2"></td>
                    <td><input type="text" value="${mat.color}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'color', this.value)" tabindex="3"></td>
                    <td>
                        <select onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'type', this.value)" tabindex="4">
                            <option value="PLA" ${mat.type === 'PLA' ? 'selected' : ''}>PLA</option>
                            <option value="PETG" ${mat.type === 'PETG' ? 'selected' : ''}>PETG</option>
                            <option value="ABS" ${mat.type === 'ABS' ? 'selected' : ''}>ABS</option>
                        </select>
                    </td>
                    <td><input type="text" value="${mat.unit}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'unit', this.value)" tabindex="5"></td>
                    <td><input type="number" step="0.01" value="${mat.price}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'price', this.value)" tabindex="6"></td>
                    <td><button onclick="removeElement(this, 'supplierMaterial', '${supplier.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="7">Sil</button></td>
                </tr>
            `;
            }).join('');
            
            return `
                <div class="card removable" data-id="${supplier.id}">
                    <div class="card-header">
                        <h3 class="text-xl font-bold">${supplier.name}</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleSupplierDetails('${supplier.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm" tabindex="15">Bilgiler</button>
                            <button onclick="removeElement(this.closest('.removable'), 'supplier')" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm" tabindex="16">Sil</button>
                        </div>
                    </div>
                    <div id="supplier-details-${supplier.id}" class="hidden space-y-2 text-sm mt-4 pt-4 border-t border-gray-200">
                        <input type="text" value="${supplier.name}" onchange="updateSupplierField('${supplier.id}', 'name', this.value)" placeholder="TedarikÃ§i AdÄ±" tabindex="8">
                        <input type="text" value="${supplier.contactPerson || ''}" onchange="updateSupplierField('${supplier.id}', 'contactPerson', this.value)" placeholder="Muhatap AdÄ±" tabindex="9">
                        <input type="text" value="${supplier.phone || ''}" onchange="updateSupplierField('${supplier.id}', 'phone', this.value)" placeholder="Telefon" tabindex="10">
                        <input type="text" value="${supplier.email || ''}" onchange="updateSupplierField('${supplier.id}', 'email', this.value)" placeholder="E-posta" tabindex="11">
                        <input type="text" value="${supplier.website || ''}" onchange="updateSupplierField('${supplier.id}', 'website', this.value)" placeholder="Web Sitesi" tabindex="12">
                        <input type="text" value="${supplier.city || ''}" onchange="updateSupplierField('${supplier.id}', 'city', this.value)" placeholder="Åehir" tabindex="13">
                        <input type="text" value="${supplier.iban || ''}" onchange="updateSupplierField('${supplier.id}', 'iban', this.value)" placeholder="IBAN" tabindex="14">
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">ÃœrÃ¼n KataloÄŸu</h4>
                        <table class="resizable-table w-full">
                            <thead>
                                <tr>
                                    <th>AdÄ±</th>
                                    <th>Marka</th>
                                    <th>Renk</th>
                                    <th>TÃ¼r</th>
                                    <th>Birim</th>
                                    <th>Fiyat (TL)</th>
                                    <th>Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${materialsHTML}
                            </tbody>
                        </table>
                        <button onclick="addMaterialToSupplier('${supplier.id}')" class="mt-2 bg-green-600 text-white px-3 py-1 text-sm rounded-md">ÃœrÃ¼n Ekle</button>
                    </div>
                </div>
            `;
        }
        function getCustomerHTML(customer) {
            const balance = calculateCustomerBalance(customer.id);
            const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-600';
            return `
                <div class="card removable" data-id="${customer.id}">
                    <details>
                        <summary class="cursor-pointer">
                            <div class="card-header">
                                <input type="text" value="${customer.name}" onchange="updateCustomerField('${customer.id}', 'name', this.value)" class="text-lg font-bold" placeholder="Firma / MÃ¼ÅŸteri AdÄ±">
                                <button onclick="removeElement(this.closest('.removable'), 'customer')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                            </div>
                            <div class="space-y-2 text-sm">
                                <input type="text" value="${customer.contactPerson || ''}" onchange="updateCustomerField('${customer.id}', 'contactPerson', this.value)" placeholder="Muhatap AdÄ±">
                                <input type="text" value="${customer.phone || ''}" onchange="updateCustomerField('${customer.id}', 'phone', this.value)" placeholder="Telefon">
                                <input type="text" value="${customer.address || ''}" onchange="updateCustomerField('${customer.id}', 'address', this.value)" placeholder="Adres">
                                <p class="font-semibold pt-2">Bakiye: <span class="${balanceColor}">${balance.toFixed(2)} TL</span></p>
                            </div>
                        </summary>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                             <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold">SatÄ±lan ÃœrÃ¼nler</h4>
                                <div>
                                    <button onclick="openAddPaymentModal('${customer.id}')" class="bg-green-600 text-white px-3 py-1 text-sm rounded-md mr-2">Ã–deme Al</button>
                                    <button onclick="generateDeliveryNote('${customer.id}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md">Ä°rsaliye YazdÄ±r</button>
                                </div>
                            </div>
                            ${getCustomerSalesHTML(customer.id)}
                        </div>
                    </details>
                </div>`;
        }
        function getRawMaterialHTML(mat) { 
            const currentStock = mat.currentStock || 0;
            const isLowStock = currentStock < 1000;
            const rowClass = isLowStock ? 'removable bg-red-50 border-l-4 border-red-400' : 'removable';
            const stockCellClass = isLowStock ? 'text-red-600 font-bold' : '';
            
            return `<tr class="${rowClass}" data-id="${mat.id}">
                <td>${mat.name}</td>
                <td>${mat.brand}</td>
                <td>${mat.color}</td>
                <td>${mat.type}</td>
                <td><input type="number" value="${mat.minStock}" onchange="updateRawMaterialField('${mat.id}', 'minStock', this.value)"></td>
                <td class="${stockCellClass}">${currentStock.toFixed(3)} ${isLowStock ? 'âš ï¸' : ''}</td>
                <td>${mat.unit}</td>
                <td>${(mat.averageCost || 0).toFixed(2)}</td>
                <td class="flex space-x-2">
                    <button onclick="openUpdateStockModal('${mat.id}')" class="bg-green-500 text-white px-3 py-1 text-sm rounded-md">Stok GÃ¼ncelle</button>
                    <button onclick="removeElement(this, 'rawMaterial')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-md">Sil</button>
                </td>
            </tr>`; 
        }
        function getSimpleProductHTML(product) {
            const totals = calculateProductTotals(product);
            const isExpanded = expandedProductId === product.id;
            
            // ÃœrÃ¼nÃ¼n toplam maliyetini hesapla
            let totalCost = 0;
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => {
                    const variantCost = calculateProductUnitCost(product.id, variant.id, 0, {}, '');
                    totalCost += variantCost;
                });
            }
            
            return `<div class="card hover:shadow-lg transition-shadow removable" data-id="${product.id}">
                <div class="card-header cursor-pointer" onclick="toggleProductExpansion('${product.id}')">
                    <div class="flex items-center justify-between">
                        <input type="text" value="${product.name}" 
                               onchange="updateProductField('${product.id}', 'name', this.value)" 
                               onclick="event.stopPropagation()"
                               class="text-lg font-semibold bg-transparent border-none p-0 focus:bg-white focus:border focus:border-gray-300 focus:px-2 focus:py-1 focus:rounded"
                               tabindex="1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${totals.totalPrintTime.toFixed(2)} saat</span>
                            <span class="text-sm text-gray-600">${totals.totalFilamentUsage.toFixed(2)} gr</span>
                            <span class="text-sm text-red-600 font-semibold">${totalCost.toFixed(2)} TL</span>
                            <span class="text-xs text-gray-500">${(product.variants || []).length} varyant</span>
                            ${isExpanded ? '<span class="text-xs">â–¼</span>' : '<span class="text-xs">â–¶</span>'}
                        </div>
                    </div>
                </div>
                ${isExpanded ? getProductDetailsHTML(product) : ''}
            </div>`;
        }
        
        function getProductDetailsHTML(product) {
            const totals = calculateProductTotals(product);
            
            // Get all filament materials for dropdown
            const filamentMaterials = (rawMaterials || []).filter(rm => rm.name && rm.name.toLowerCase().includes('filament'));
            const filamentOptions = filamentMaterials.map(fil => 
                `<option value="${fil.id}">${fil.brand} - ${fil.color} (${fil.type})</option>`
            ).join('');
            
            const variantRows = (product.variants || []).map(v => {
                // Renk seÃ§enekleri iÃ§in alanlar
                const colors = v.colors || [];
                const colorRows = colors.map((color, index) => {
                    const colorOptions = filamentMaterials.map(fil => 
                        `<option value="${fil.id}" ${color.filamentId === fil.id ? 'selected' : ''}>${fil.brand} - ${fil.color} (${fil.type})</option>`
                    ).join('');
                    
                    return `
                        <tr class="text-xs">
                            <td class="px-2 py-1">
                                <input type="text" value="${color.name}" placeholder="Renk adÄ±" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'name', this.value)" 
                                       class="w-20 text-xs" tabindex="7">
                            </td>
                            <td class="px-2 py-1">
                                <select onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'filamentId', this.value)" class="text-xs" tabindex="8">
                                    <option value="">Filament SeÃ§in</option>
                                    ${colorOptions}
                                </select>
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" step="0.01" value="${color.gram}" placeholder="Gram" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'gram', this.value)" 
                                       class="w-16 text-xs" tabindex="9">
                            </td>
                            <td class="px-2 py-1">
                                <button onclick="removeVariantColor('${product.id}', '${v.id}', ${index})" 
                                        class="bg-red-500 text-white px-1 py-0.5 text-xs rounded" tabindex="10">Sil</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                return `<tr class="removable" data-id="${v.id}">
                    <td><input type="text" value="${v.name}" onchange="updateProductVariant('${product.id}', '${v.id}', 'name', this.value)" tabindex="4"></td>
                    <td><input type="number" step="0.01" value="${v.printTime}" onchange="updateProductVariant('${product.id}', '${v.id}', 'printTime', this.value)" tabindex="5"></td>
                    <td colspan="3">
                        <div class="mb-2">
                            <button onclick="addVariantColor('${product.id}', '${v.id}')" 
                                    class="bg-blue-500 text-white px-2 py-1 text-xs rounded" tabindex="6">Renk Ekle</button>
                        </div>
                        <table class="w-full text-xs border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 py-1">Renk AdÄ±</th>
                                    <th class="px-2 py-1">Filament</th>
                                    <th class="px-2 py-1">Gram</th>
                                    <th class="px-2 py-1">Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${colorRows}
                            </tbody>
                        </table>
                    </td>
                    <td><button onclick="removeElement(this, 'productVariant', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="11">Sil</button></td>
                </tr>`;
            }).join('');
            let extraMaterialsHTML = '';
            if (product.extraMaterials) {
                const extraMaterialRows = product.extraMaterials.map(mat => { const materialOptions = (rawMaterials || []).map(rm => `<option value="${rm.id}" ${mat.rawMaterialId === rm.id ? 'selected' : ''}>${rm.name} - ${rm.brand} (${rm.color})</option>`).join(''); return `<tr class="removable" data-id="${mat.id}"><td><select onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'rawMaterialId', this.value)">${materialOptions}</select></td><td><input type="number" step="0.01" value="${mat.quantity}" onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'quantity', this.value)"></td><td><button onclick="removeElement(this, 'productExtraMaterial', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td></tr>`; }).join('');
                extraMaterialsHTML = `<h4 class="text-md font-semibold text-gray-700 mt-6 mb-2">Ek Hammaddeler (BaskÄ± DÄ±ÅŸÄ±)</h4><table class="resizable-table w-full text-sm"><thead><tr><th>Hammadde</th><th>Miktar</th><th>Eylem</th></tr></thead><tbody>${extraMaterialRows}</tbody></table><button onclick="addProductExtraMaterial('${product.id}')" class="mt-3 bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700">Ek Hammadde Ekle</button>`;
            } else {
                extraMaterialsHTML = `<div class="mt-4"><button onclick="enableExtraMaterials('${product.id}')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">Ek Hammadde AlanÄ±nÄ± Aktif Et</button></div>`;
            }
            return `<div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-end items-center mb-4">
                    <button onclick="removeElement(this, 'product')" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" tabindex="2">ÃœrÃ¼nÃ¼ Sil</button>
                </div>
                <h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Varyantlar (BasÄ±lan ParÃ§alar)</h4>
                <table class="resizable-table w-full">
                    <thead>
                        <tr>
                            <th>Varyant AdÄ±</th>
                            <th>BaskÄ± SÃ¼resi (saat)</th>
                            <th>Renk SeÃ§enekleri</th>
                            <th>Eylem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${variantRows}
                    </tbody>
                </table>
                <button onclick="addProductVariant('${product.id}')" class="mt-3 bg-green-600 text-white px-3 py-1 text-sm rounded-md hover:bg-green-700" tabindex="3">Varyant Ekle</button>
                ${extraMaterialsHTML}
            </div>`;
        }
        
        function getProductHTML(product) {
            const totals = calculateProductTotals(product);
            
            // Get all filament materials for dropdown
            const filamentMaterials = (rawMaterials || []).filter(rm => rm.name && rm.name.toLowerCase().includes('filament'));
            const filamentOptions = filamentMaterials.map(fil => 
                `<option value="${fil.id}">${fil.brand} - ${fil.color} (${fil.type})</option>`
            ).join('');
            
            const variantRows = (product.variants || []).map(v => {
                // Renk seÃ§enekleri iÃ§in alanlar
                const colors = v.colors || [];
                const colorRows = colors.map((color, index) => {
                    const colorOptions = filamentMaterials.map(fil => 
                        `<option value="${fil.id}" ${color.filamentId === fil.id ? 'selected' : ''}>${fil.brand} - ${fil.color} (${fil.type})</option>`
                    ).join('');
                    
                    return `
                        <tr class="text-xs">
                            <td class="px-2 py-1">
                                <input type="text" value="${color.name}" placeholder="Renk adÄ±" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'name', this.value)" 
                                       class="w-20 text-xs" tabindex="7">
                            </td>
                            <td class="px-2 py-1">
                                <select onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'filamentId', this.value)" class="text-xs" tabindex="8">
                                    <option value="">Filament SeÃ§in</option>
                                    ${colorOptions}
                                </select>
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" step="0.01" value="${color.gram}" placeholder="Gram" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'gram', this.value)" 
                                       class="w-16 text-xs" tabindex="9">
                            </td>
                            <td class="px-2 py-1">
                                <button onclick="removeVariantColor('${product.id}', '${v.id}', ${index})" 
                                        class="bg-red-500 text-white px-1 py-0.5 text-xs rounded" tabindex="10">Sil</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                return `<tr class="removable" data-id="${v.id}">
                    <td><input type="text" value="${v.name}" onchange="updateProductVariant('${product.id}', '${v.id}', 'name', this.value)" tabindex="4"></td>
                    <td><input type="number" step="0.01" value="${v.printTime}" onchange="updateProductVariant('${product.id}', '${v.id}', 'printTime', this.value)" tabindex="5"></td>
                    <td colspan="3">
                        <div class="mb-2">
                            <button onclick="addVariantColor('${product.id}', '${v.id}')" 
                                    class="bg-blue-500 text-white px-2 py-1 text-xs rounded" tabindex="6">Renk Ekle</button>
                        </div>
                        <table class="w-full text-xs border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 py-1">Renk AdÄ±</th>
                                    <th class="px-2 py-1">Filament</th>
                                    <th class="px-2 py-1">Gram</th>
                                    <th class="px-2 py-1">Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${colorRows}
                            </tbody>
                        </table>
                    </td>
                    <td><button onclick="removeElement(this, 'productVariant', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="11">Sil</button></td>
                </tr>`;
            }).join('');
            let extraMaterialsHTML = '';
            if (product.extraMaterials) {
                const extraMaterialRows = product.extraMaterials.map(mat => { const materialOptions = (rawMaterials || []).map(rm => `<option value="${rm.id}" ${mat.rawMaterialId === rm.id ? 'selected' : ''}>${rm.name} - ${rm.brand} (${rm.color})</option>`).join(''); return `<tr class="removable" data-id="${mat.id}"><td><select onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'rawMaterialId', this.value)">${materialOptions}</select></td><td><input type="number" step="0.01" value="${mat.quantity}" onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'quantity', this.value)"></td><td><button onclick="removeElement(this, 'productExtraMaterial', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td></tr>`; }).join('');
                extraMaterialsHTML = `<h4 class="text-md font-semibold text-gray-700 mt-6 mb-2">Ek Hammaddeler (BaskÄ± DÄ±ÅŸÄ±)</h4><table class="resizable-table w-full text-sm"><thead><tr><th>Hammadde</th><th>Miktar</th><th>Eylem</th></tr></thead><tbody>${extraMaterialRows}</tbody></table><button onclick="addProductExtraMaterial('${product.id}')" class="mt-3 bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700">Ek Hammadde Ekle</button>`;
            } else {
                extraMaterialsHTML = `<div class="mt-4"><button onclick="enableExtraMaterials('${product.id}')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">Ek Hammadde AlanÄ±nÄ± Aktif Et</button></div>`;
            }
            return `<div class="card removable" data-id="${product.id}"><div class="card-header"><input type="text" value="${product.name}" onchange="updateProductField('${product.id}', 'name', this.value)" class="text-xl font-bold w-1/2 p-2 border-2 border-transparent focus:border-indigo-500 rounded-md" tabindex="1"><div class="flex items-center space-x-4 text-sm text-gray-600"><span><strong>Toplam SÃ¼re:</strong> ${totals.totalPrintTime.toFixed(2)} saat</span><span><strong>Toplam BaskÄ± Hammaddesi:</strong> ${totals.totalFilamentUsage.toFixed(2)} gr</span><button onclick="removeElement(this, 'product')" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" tabindex="2">ÃœrÃ¼nÃ¼ Sil</button></div></div><h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Varyantlar (BasÄ±lan ParÃ§alar)</h4><table class="resizable-table w-full"><thead><tr><th>Varyant AdÄ±</th><th>BaskÄ± SÃ¼resi (saat)</th><th>Renk SeÃ§enekleri</th><th>Eylem</th></tr></thead><tbody>${variantRows}</tbody></table><button onclick="addProductVariant('${product.id}')" class="mt-3 bg-green-600 text-white px-3 py-1 text-sm rounded-md hover:bg-green-700" tabindex="3">Varyant Ekle</button>${extraMaterialsHTML}</div>`;
        }
        function getProductionLogHTML(entry, costs = {}) { 
            const customInputCells = customParameters.map((p, index) => `<td class="px-6 py-4 whitespace-nowrap"><input type="number" step="0.01" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="${entry.customValues[p.id] || 0}" onchange="updateProductionCustomValue('${entry.id}', '${p.id}', this.value)" tabindex="${8 + index}"></td>`).join(''); 
            const customCostHeaders = customParameters.map(p => `<th>${p.name} (Maliyet)</th>`).join('');
            const customCostCells = customParameters.map(p => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">${(costs.customCosts[p.id] || 0).toFixed(2)} â‚º</span></td>`).join(''); 
            const productOptions = (products || []).map(p => `<option value="${p.id}" ${entry.productId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            const product = products.find(p => p.id === entry.productId);
            const variant = product?.variants?.find(v => v.id === entry.variantId);
            const variantOptions = (product?.variants || []).map(v => `<option value="${v.id}" ${entry.variantId === v.id ? 'selected' : ''}>${v.name}</option>`).join('');

            // Calculate total gramage - sum of all colors
            let totalGramage = 0;
            let colorBreakdown = '';
            
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * entry.quantity;
                    totalGramage += colorGram;
                    
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentName = filament ? `${filament.brand} - ${filament.color} (${filament.type})` : 'Filament bulunamadÄ±';
                    
                    colorBreakdown += `<div class="text-xs">${color.name}: ${colorGram.toFixed(2)} gr (${filamentName})</div>`;
                });
            }
            
            // Toplam gramaj bilgisi
            const totalGramageHTML = `
                <div class="text-xs">
                    <div class="font-semibold text-gray-800">Toplam: ${totalGramage.toFixed(2)} gr</div>
                    <div class="text-gray-600 mt-1">${colorBreakdown}</div>
                </div>
            `;

            return `<tr class="removable hover:bg-gray-50 transition-colors duration-200" data-id="${entry.id}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" value="${entry.date}" onchange="updateProductionField('${entry.id}', 'date', this.value)" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" tabindex="1">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col space-y-2">
                        <select onchange="handleProductChangeInLog(this, '${entry.id}')" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" tabindex="2">
                            ${productOptions}
                        </select>
                        <select onchange="updateProductionField('${entry.id}', 'variantId', this.value)" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                                id="variant-select-${entry.id}" tabindex="3">
                            ${variantOptions}
                        </select>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" value="${entry.quantity}" onchange="updateProductionField('${entry.id}', 'quantity', this.value)" 
                           class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm text-center" tabindex="4">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${totalGramageHTML}
                </td>
                <td class="px-6 py-4 whitespace-nowrap" id="material-usage-${entry.id}">
                    <!-- Material usage will be rendered here -->
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" step="0.01" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                           value="${entry.laborCost}" onchange="updateProductionField('${entry.id}', 'laborCost', this.value)" tabindex="5">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" step="0.1" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                           value="${entry.profitMargin}" onchange="updateProductionField('${entry.id}', 'profitMargin', this.value)" tabindex="6">
                </td>
                ${customInputCells}
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${(costs.materialCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        ${(costs.electricityCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        ${(costs.amortizationCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ${(costs.laborCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        ${(costs.failedPrintCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                ${customCostCells}
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                        ${(costs.totalCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        ${(costs.unitCost || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-emerald-100 text-emerald-800">
                        ${(costs.recommendedUnitPrice || 0).toFixed(2)} â‚º
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="removeElement(this, 'productionLog')" 
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" 
                            tabindex="7">
                        ğŸ—‘ï¸ Sil
                    </button>
                </td>
            </tr>`; 
        }
        function getSaleHTML(sale) { 
            let channelInfo = ''; 
            if (sale.channel === 'cari') { 
                const customer = (customers || []).find(c => c.id === sale.customerId); 
                channelInfo = customer ? customer.name : 'SilinmiÅŸ MÃ¼ÅŸteri'; 
            } else if (sale.channel === 'platform') { 
                channelInfo = sale.platformName; 
            } else { 
                channelInfo = 'Bireysel SatÄ±ÅŸ'; 
            } 
            
            // HÄ±zlÄ± satÄ±ÅŸ mÄ± kontrol et
            let productName, variantName = '';
            let totalCost;
            
            if (sale.isQuickSale) {
                // HÄ±zlÄ± satÄ±ÅŸ - direkt productName kullan
                productName = sale.productName || 'HÄ±zlÄ± SatÄ±ÅŸ';
                totalCost = sale.totalCost || 0;
            } else {
                // Normal satÄ±ÅŸ - Ã¼rÃ¼n sisteminden al
                const product = (products || []).find(p => p.id === sale.productId);
                productName = product?.name || 'Bilinmeyen ÃœrÃ¼n';
                
                if (sale.variantId && product) {
                    const variant = product.variants?.find(v => v.id === sale.variantId);
                    variantName = variant ? ` - ${variant.name}` : '';
                }
                
                // SatÄ±ÅŸÄ±n toplam maliyetini hesapla
                const averageUnitCost = getAverageUnitCostForProduct(sale.productId, sale.variantId);
                totalCost = averageUnitCost * sale.quantity;
            }
            
            return `<tr class="removable" data-id="${sale.id}">
                <td>${sale.date}</td>
                <td>${productName}${variantName}</td>
                <td>${sale.quantity}</td>
                <td>${channelInfo}</td>
                <td>${sale.paymentMethod}</td>
                <td class="text-red-600 font-medium">${totalCost.toFixed(2)} TL</td>
                <td class="text-green-600 font-medium">${(sale.realizedProfit || 0).toFixed(2)} TL</td>
                <td class="text-blue-600 font-medium">${(sale.totalAmount || 0).toFixed(2)} TL</td>
                <td><button onclick="removeElement(this, 'sale')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td>
            </tr>`; 
        }
        function getAddMaterialModalHTML(){ 
            const accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); 
            return `<div class="modal">
                <h3 class="text-xl font-semibold mb-4">TedarikÃ§iden Malzeme Ekle</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">TedarikÃ§i SeÃ§in</label>
                        <select id="supplierSelect" onchange="populateSupplierMaterials(this.value)" class="mt-1 w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Malzeme SeÃ§in</label>
                        <select id="materialSelect" class="mt-1 w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">AlÄ±nan Miktar</label>
                        <input type="number" id="initialStock" value="1" class="mt-1 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Minimum Stok Seviyesi</label>
                        <input type="number" id="minStock" value="0" placeholder="UyarÄ± iÃ§in minimum stok" class="mt-1 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ã–deme YapÄ±lan Hesap</label>
                        <select id="addMaterialPaymentAccountId" class="mt-1 w-full">
                            <option value="">Hesap SeÃ§in</option>
                            ${accountOptions}
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeModal('addMaterialModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button>
                    <button onclick="addRawMaterialFromSupplier()" class="bg-blue-600 text-white px-4 py-2 rounded-md">Envantere Ekle</button>
                </div>
            </div>`; 
        }
        function getUpdateStockModalHTML() { const accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><h3 class="text-xl font-semibold mb-4">Stok GÃ¼ncelle</h3><input type="hidden" id="updateStockMaterialId"><div class="space-y-4"><div><label class="block text-sm font-medium">Yenileme Tarihi</label><input type="date" id="replenishDate" class="mt-1"></div><div><label class="block text-sm font-medium">Eklenen Stok MiktarÄ±</label><input type="number" id="addedStock" placeholder="Ã–rn: 2.5" class="mt-1"></div><div><label class="block text-sm font-medium">Yeni Birim Fiyat (TL)</label><input type="number" step="0.01" id="newPrice" placeholder="Ã–rn: 550.75" class="mt-1"></div><div><label class="block text-sm font-medium">Ã–deme YapÄ±lan Hesap</label><select id="paymentAccountId" class="mt-1"><option value="">Hesap SeÃ§in</option>${accountOptions}</select></div></div><div class="mt-6 flex justify-end space-x-3"><button onclick="closeModal('updateStockModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button onclick="handleStockUpdate()" class="bg-green-600 text-white px-4 py-2 rounded-md">StoÄŸu GÃ¼ncelle</button></div></div>`; }
        function getAddSaleModalHTML() { 
            const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); 
            return `<div class="modal"><h3 class="text-xl font-semibold mb-4">Yeni SatÄ±ÅŸ KaydÄ±</h3><form id="saleForm" onsubmit="event.preventDefault(); addSale();"><div class="grid grid-cols-2 gap-4"><input type="date" name="saleDate" required><select name="saleProductSelect" onchange="updateSalePrice(this.value); handleProductChangeInSale(this.value)" required></select><div id="variantSelectDiv" class="hidden col-span-2"><label class="block text-sm font-medium">Varyant SeÃ§in (AnahtarlÄ±k gibi Ã¼rÃ¼nler iÃ§in)</label><select name="saleVariantSelect" onchange="updateSalePrice(document.querySelector('[name=saleProductSelect]').value)" required></select></div><input type="number" name="saleQuantity" placeholder="Adet" onchange="updateSaleCostAndProfit()" required><input type="number" step="0.01" name="saleUnitPrice" placeholder="Birim Fiyat (KDV HariÃ§)" onchange="updateSaleCostAndProfit()" required><input type="number" name="saleVatRate" value="20" placeholder="KDV OranÄ± (%)" onchange="updateSaleCostAndProfit()" required><select name="saleChannel" id="saleChannel" onchange="handleSaleChannelChange(this)"><option value="bireysel">Bireysel SatÄ±ÅŸ</option><option value="platform">Platform</option><option value="cari">Cari MÃ¼ÅŸteri</option></select><div id="customerSelectDiv" class="hidden col-span-2"><input type="text" name="saleCustomerSelect" id="saleCustomerSelect" placeholder="MÃ¼ÅŸteri adÄ± yazÄ±n..." autocomplete="off"></div><div id="platformInputDiv" class="hidden col-span-2"><input type="text" name="salePlatformName" id="salePlatformName" placeholder="Platform AdÄ±"></div><select name="salePaymentMethod" onchange="togglePaymentAccount(this.value)" class="col-span-2"><option value="nakit">Nakit</option><option value="havale">EFT</option><option value="kredikarti">Kredi KartÄ±</option><option value="cariye">Cariye Ä°ÅŸle</option></select><div id="paymentAccountDiv" class="col-span-2"><label class="block text-sm font-medium">Ã–demenin AlÄ±ndÄ±ÄŸÄ± Hesap</label><select name="paymentAccountId">${accountOptions}</select></div></div><div id="saleCostInfo" class="mt-4 p-3 bg-gray-50 rounded-md hidden"><div class="grid grid-cols-2 gap-4 text-sm"><div><span class="font-medium text-gray-700">Birim Maliyet:</span> <span id="unitCostDisplay" class="text-red-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Toplam Maliyet:</span> <span id="totalCostDisplay" class="text-red-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Tahmini Kar:</span> <span id="profitDisplay" class="text-green-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Toplam Tutar:</span> <span id="totalAmountDisplay" class="text-blue-600 font-semibold">0.00 TL</span></div></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addSaleModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Kaydet</button></div></form></div>`; 
        }

        function getQuickSaleModalHTML() {
            const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">âš¡ HÄ±zlÄ± SatÄ±ÅŸ (Sistem DÄ±ÅŸÄ± ÃœrÃ¼n)</h3>
                    <form id="quickSaleForm" onsubmit="event.preventDefault(); addQuickSale();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                                <input type="date" name="quickSaleDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÃœrÃ¼n AdÄ±</label>
                                <input type="text" name="quickProductName" placeholder="Ã–rn: Ã–zel TasarÄ±m Heykel" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Adet</label>
                                <input type="number" name="quickQuantity" placeholder="Adet" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gramaj (Opsiyonel)</label>
                                <input type="number" name="quickGramage" placeholder="Gram cinsinden" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat (KDV HariÃ§)</label>
                                <input type="number" step="0.01" name="quickUnitPrice" placeholder="Birim fiyat" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">KDV OranÄ± (%)</label>
                                <input type="number" name="quickVatRate" value="0" min="0" max="100" placeholder="KDV oranÄ±" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">MÃ¼ÅŸteri/Kanal</label>
                                <select name="quickChannel" onchange="handleQuickSaleChannelChange(this)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="bireysel">Bireysel SatÄ±ÅŸ</option>
                                    <option value="platform">Platform</option>
                                    <option value="cari">Cari MÃ¼ÅŸteri</option>
                                </select>
                            </div>
                            <div id="quickCustomerDiv" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">MÃ¼ÅŸteri SeÃ§in</label>
                                <select name="quickCustomerId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">MÃ¼ÅŸteri seÃ§in...</option>
                                </select>
                                <div class="mt-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Yeni MÃ¼ÅŸteri Ekle</label>
                                    <input type="text" name="quickCustomerName" placeholder="Yeni mÃ¼ÅŸteri adÄ±" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <div id="quickPlatformDiv" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Platform AdÄ±</label>
                                <input type="text" name="quickPlatformName" placeholder="Platform adÄ±" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ã–deme YÃ¶ntemi</label>
                                <select name="quickPaymentMethod" onchange="toggleQuickPaymentAccount(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="nakit">Nakit</option>
                                    <option value="havale">EFT</option>
                                    <option value="kredikarti">Kredi KartÄ±</option>
                                    <option value="cariye">Cariye Ä°ÅŸle</option>
                                </select>
                            </div>
                            <div id="quickPaymentAccountDiv" class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ã–demenin AlÄ±ndÄ±ÄŸÄ± Hesap</label>
                                <select name="quickPaymentAccountId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    ${accountOptions}
                                </select>
                            </div>
                            <div class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notlar (Opsiyonel)</label>
                                <textarea name="quickNotes" rows="2" placeholder="Ek notlar..." class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                        <div id="quickSaleSummary" class="mt-4 p-4 bg-green-50 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">ğŸ“Š SatÄ±ÅŸ Ã–zeti</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-700">Toplam Tutar (KDV Dahil):</span></div>
                                <div><span id="quickTotalAmount" class="font-bold text-green-700">0.00 TL</span></div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('quickSaleModal')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                                Ä°ptal
                            </button>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                âš¡ HÄ±zlÄ± SatÄ±ÅŸ Yap
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getAddFailedPrintModalHTML() {
            const productOptions = (products || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            return `<div class="modal">
                <h3 class="text-xl font-semibold mb-4">Yeni BaskÄ± HatasÄ± KaydÄ±</h3>
                <form id="failedPrintForm" onsubmit="event.preventDefault(); addFailedPrint();">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium">Tarih</label>
                            <input type="date" name="failedPrintDate" required class="mt-1 w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">ÃœrÃ¼n SeÃ§in</label>
                            <select name="failedPrintProductSelect" onchange="handleProductChangeInFailedPrint(this.value)" required class="mt-1 w-full">
                                <option value="">ÃœrÃ¼n SeÃ§in</option>
                                ${productOptions}
                            </select>
                        </div>
                        <div id="failedPrintVariantSelectDiv" class="hidden">
                            <label class="block text-sm font-medium">Varyant SeÃ§in</label>
                            <select name="failedPrintVariantSelect" class="mt-1 w-full">
                                <option value="">Varyant SeÃ§in</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">HatalÄ± Adet</label>
                            <input type="number" name="failedPrintQuantity" placeholder="Adet" onchange="calculateFailedPrintCost()" required class="mt-1 w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Hata Sebebi</label>
                            <select name="failedPrintReason" class="mt-1 w-full">
                                <option value="BaskÄ± HatasÄ±">BaskÄ± HatasÄ±</option>
                                <option value="Malzeme HatasÄ±">Malzeme HatasÄ±</option>
                                <option value="Makine ArÄ±zasÄ±">Makine ArÄ±zasÄ±</option>
                                <option value="Kalite Kontrol">Kalite Kontrol</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</label>
                            <textarea name="failedPrintDescription" placeholder="Hata detaylarÄ±..." class="mt-1 w-full" rows="3"></textarea>
                        </div>
                    </div>
                    <div id="failedPrintCostInfo" class="mt-4 p-3 bg-red-50 rounded-md hidden">
                        <h4 class="font-medium text-red-700 mb-2">Maliyet Bilgileri</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Hammadde KaybÄ±:</span> 
                                <span id="materialLossDisplay" class="text-red-600 font-semibold">0.00 TL</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Toplam Maliyet:</span> 
                                <span id="totalFailedCostDisplay" class="text-red-600 font-semibold">0.00 TL</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('addFailedPrintModal')" class="bg-gray-200 px-4 py-2 rounded-md">
                            Ä°ptal
                        </button>
                        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">
                            Kaydet ve Stoktan DÃ¼ÅŸ
                        </button>
                    </div>
                </form>
            </div>`;
        }
        function getAccountModalHTML() { const bankAccountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><form id="accountForm" onsubmit="event.preventDefault(); handleAccountFormSubmit();"><h3 id="accountModalTitle" class="text-xl font-semibold mb-4"></h3><input type="hidden" name="accountId"><input type="hidden" name="accountType"><div class="space-y-4"><div><label>Hesap AdÄ±</label><input type="text" name="accountName" required></div><div id="initialBalanceDiv"><label>BaÅŸlangÄ±Ã§ Bakiyesi</label><input type="number" step="0.01" name="initialBalance" value="0"></div><div id="bankDetailsDiv" class="hidden space-y-4"><div><label>Banka AdÄ±</label><input type="text" name="bankName"></div><div><label>IBAN</label><input type="text" name="iban"></div></div><div id="creditCardDetailsDiv" class="hidden space-y-4"><div><label>Kart Limiti</label><input type="number" step="0.01" name="creditCardLimit"></div><div><label>BaÄŸlÄ± Banka HesabÄ±</label><select name="linkedAccountId">${bankAccountOptions}</select></div></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('accountModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button id="accountModalSubmitBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md"></button></div></form></div>`; }
        function getCustomParamModalHTML() { return `<div class="modal"><form id="customParamForm" onsubmit="event.preventDefault(); handleCustomParamFormSubmit();"><h3 id="customParamModalTitle" class="text-xl font-semibold mb-4"></h3><input type="hidden" name="paramId"><div class="space-y-4"><div><label>Parametre AdÄ±</label><input type="text" name="paramName" required></div><div><label>TÃ¼rÃ¼</label><select name="paramType" required><option value="parasal">Parasal DeÄŸer (TL)</option><option value="saatlik">Saatlik Ãœcret (TL)</option><option value="yuzdelik">YÃ¼zdelik (%)</option></select></div><div><label>VarsayÄ±lan DeÄŸer</label><input type="number" step="0.01" name="paramValue" required></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('customParamModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button id="customParamModalSubmitBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md"></button></div></form></div>`; }
        function getAddPaymentModalHTML() { const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><form id="paymentForm" onsubmit="event.preventDefault(); addPayment();"><h3 class="text-xl font-semibold mb-4">MÃ¼ÅŸteri Ã–demesi Al</h3><input type="hidden" name="paymentCustomerId"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="paymentDate" required></div><div><label>Tutar (TL)</label><input type="number" step="0.01" name="paymentAmount" required></div><div><label>Ã–demenin AlÄ±ndÄ±ÄŸÄ± Hesap</label><select name="paymentAccountId" required>${accountOptions}</select></div><div><label>AÃ§Ä±klama</label><input type="text" name="paymentNotes"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addPaymentModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Ã–demeyi Kaydet</button></div></form></div>`; }
        function getAccountDetailModalHTML() { return `<div class="modal" id="accountDetailModalContent"></div>`; }
        function getEditTransactionModalHTML() { return `<div class="modal"><form id="editTransactionForm" onsubmit="event.preventDefault(); handleTransactionUpdate();"><h3 class="text-xl font-semibold mb-4">Ä°ÅŸlemi DÃ¼zenle</h3><input type="hidden" name="txId"><input type="hidden" name="txType"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="txDate" required></div><div id="txAmountDiv"><label>Tutar (TL)</label><input type="number" step="0.01" name="txAmount" required></div><div id="txPurchaseDiv" class="hidden grid grid-cols-2 gap-4"><div><label>Miktar</label><input type="number" step="0.01" name="txQuantity"></div><div><label>Birim Fiyat</label><input type="number" step="0.01" name="txPrice"></div></div><div><label>Hesap</label><select name="txAccountId" required></select></div><div id="txNotesDiv"><label>AÃ§Ä±klama</label><input type="text" name="txNotes"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('editTransactionModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">GÃ¼ncelle</button></div></form></div>`; }
        function getAddMoneyModalHTML() { return `<div class="modal"><form id="addMoneyForm" onsubmit="event.preventDefault(); addMoneyToAccount();"><h3 class="text-xl font-semibold mb-4">ğŸ’° Hesaba Para Ekle</h3><input type="hidden" name="accountId"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="moneyDate" required></div><div><label>Tutar (TL)</label><input type="number" step="0.01" name="moneyAmount" placeholder="Eklenen tutar" required></div><div><label>AÃ§Ä±klama</label><input type="text" name="moneyDescription" placeholder="Ã–rn: DÄ±ÅŸ kaynaktan gelen Ã¶deme" required></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addMoneyModal')" class="bg-gray-200 px-4 py-2 rounded-md">Ä°ptal</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">ğŸ’° Para Ekle</button></div></form></div>`; }


        function renderDashboard() {
            const container = document.getElementById('dashboard');
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentSales = (salesLog || []).filter(s => new Date(s.date) >= thirtyDaysAgo);
            const recentProductions = (productionLog || []).filter(p => new Date(p.date) >= thirtyDaysAgo);
            const totalTurnover = recentSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const productionCosts = calculateAllProductionCosts();
            const totalCost = recentProductions.reduce((sum, p) => sum + (productionCosts[p.id]?.totalCost || 0), 0);
            const netProfit = recentSales.reduce((sum, s) => sum + (s.realizedProfit || 0), 0);
            const costSums = recentProductions.reduce((acc, p) => { const costs = productionCosts[p.id] || {}; acc.material += costs.materialCost || 0; acc.electricity += costs.electricityCost || 0; acc.amortization += costs.amortizationCost || 0; acc.labor += costs.laborCost || 0; acc.failedPrint += costs.failedPrintCost || 0; return acc; }, { material: 0, electricity: 0, amortization: 0, labor: 0, failedPrint: 0 });
            const totalProdCostSum = Object.values(costSums).reduce((a, b) => a + b, 0);
            
            const totalReceivables = calculateTotalReceivables();
            const { cashBalance, bankBalance, creditCardDebt } = calculateAccountSummary();
            const totalAssets = cashBalance + bankBalance + totalReceivables;
            
            // Gider hesaplamalarÄ±
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const thisMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                const now = new Date();
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            }).reduce((sum, exp) => sum + exp.amount, 0);
            
            // Yedekleme durumu
            const backupData = localStorage.getItem(BACKUP_DATA_KEY);
            const backupInfo = backupData ? JSON.parse(backupData) : null;
            const lastBackupTime = backupInfo ? new Date(backupInfo.backupDate) : null;
            const backupStatus = lastBackupTime ? 
                `Son yedekleme: ${lastBackupTime.toLocaleString('tr-TR')}` : 
                'Yedekleme bulunamadÄ±';

            // Firebase baÄŸlantÄ± durumu
            const firebaseStatus = window.firebaseDatabase ? 'ğŸŸ¢ Firebase BaÄŸlÄ±' : 'ğŸ”´ Firebase BaÄŸlantÄ±sÄ± Yok';

            // Aktif Ã¼retim planlarÄ±
            const activePlans = productionPlans.filter(plan => plan.status === 'active');
            const totalActivePlans = activePlans.length;
            const totalPlannedQuantity = activePlans.reduce((sum, plan) => sum + (plan.orderQuantity || 0), 0);
            const totalPlannedDays = activePlans.reduce((sum, plan) => sum + (plan.totalDays || 0), 0);

            // Aktif iÅŸler (Ã¼retim log'da devam eden iÅŸler)
            const activeJobs = productionLog.filter(job => {
                const jobDate = new Date(job.date);
                const today = new Date();
                const daysDiff = Math.floor((today - jobDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 7; // Son 7 gÃ¼n iÃ§indeki iÅŸler
            });
            const totalActiveJobs = activeJobs.length;
            const activeJobsValue = activeJobs.reduce((sum, job) => {
                const costs = productionCosts[job.id] || {};
                return sum + (costs.totalCost || 0);
            }, 0);

            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">GÃ¶sterge Paneli</h2> 
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"> 
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-indigo-700">Toplam Ciro (Son 30 GÃ¼n)</h3><p class="text-3xl font-bold text-indigo-800 mt-2">${totalTurnover.toFixed(2)} TL</p></div> 
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-green-700">Net KazanÃ§ (Son 30 GÃ¼n)</h3><p class="text-3xl font-bold text-green-800 mt-2">${netProfit.toFixed(2)} TL</p></div> 
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-red-700">Toplam Maliyet (Son 30 GÃ¼n)</h3><p class="text-3xl font-bold text-red-800 mt-2">${totalCost.toFixed(2)} TL</p></div> 
                    <div class="bg-cyan-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-cyan-700">Toplam Cari Alacak</h3><p class="text-3xl font-bold text-cyan-800 mt-2">${totalReceivables.toFixed(2)} TL</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-yellow-700">Toplam VarlÄ±klar</h3><p class="text-3xl font-bold text-yellow-800 mt-2">${totalAssets.toFixed(2)} TL</p></div> 
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-orange-700">Toplam Giderler</h3><p class="text-3xl font-bold text-orange-800 mt-2">${totalExpenses.toFixed(2)} TL</p></div>
                    <div class="bg-pink-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-pink-700">Bu Ay Giderler</h3><p class="text-3xl font-bold text-pink-800 mt-2">${thisMonthExpenses.toFixed(2)} TL</p></div>
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-purple-700">Yedekleme Durumu</h3><p class="text-sm text-purple-800 mt-2">${backupStatus}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-emerald-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-emerald-700">Firebase Durumu</h3><p class="text-lg font-bold text-emerald-800 mt-2">${firebaseStatus}</p></div>
                    <div class="bg-slate-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-slate-700">Veri Senkronizasyonu</h3><p class="text-lg font-bold text-slate-800 mt-2">${window.firebaseDatabase ? 'Aktif' : 'Pasif'}</p></div>
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-indigo-700">Ortak Ã‡alÄ±ÅŸma</h3><p class="text-lg font-bold text-indigo-800 mt-2">${window.firebaseDatabase ? 'HazÄ±r' : 'Offline'}</p></div>
                    <div class="bg-cyan-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-cyan-700">GÃ¼venlik</h3><p class="text-lg font-bold text-cyan-800 mt-2">${window.firebaseDatabase ? 'GÃ¼venli' : 'Local'}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-blue-700">Aktif Ãœretim PlanlarÄ±</h3><p class="text-3xl font-bold text-blue-800 mt-2">${totalActivePlans}</p></div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-green-700">Planlanan Toplam Adet</h3><p class="text-3xl font-bold text-green-800 mt-2">${totalPlannedQuantity.toLocaleString()}</p></div>
                    <div class="bg-teal-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-teal-700">Toplam Planlanan GÃ¼n</h3><p class="text-3xl font-bold text-teal-800 mt-2">${totalPlannedDays.toFixed(1)}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-amber-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-amber-700">Aktif Ä°ÅŸler (Son 7 GÃ¼n)</h3><p class="text-3xl font-bold text-amber-800 mt-2">${totalActiveJobs}</p></div>
                    <div class="bg-rose-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-rose-700">Aktif Ä°ÅŸler DeÄŸeri</h3><p class="text-3xl font-bold text-rose-800 mt-2">${activeJobsValue.toFixed(2)} TL</p></div>
                    <div class="bg-violet-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-violet-700">Ortalama Ä°ÅŸ DeÄŸeri</h3><p class="text-3xl font-bold text-violet-800 mt-2">${totalActiveJobs > 0 ? (activeJobsValue / totalActiveJobs).toFixed(2) : '0.00'} TL</p></div>
                </div> 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Maliyet DaÄŸÄ±lÄ±mÄ±</h3><div id="cost-breakdown-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="costChart"></canvas></div></div> 
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Kasa Durumu</h3><div id="cash-summary-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="cashChart"></canvas></div></div> 
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Gider DaÄŸÄ±lÄ±mÄ±</h3><div id="expense-breakdown-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="expenseChart"></canvas></div></div>
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">AylÄ±k Gider Trendi</h3><div id="expense-trend-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="expenseTrendChart"></canvas></div></div>
                </div>`;
            if (charts.costChart) charts.costChart.destroy();
            if (totalProdCostSum > 0) { document.getElementById('cost-breakdown-text').innerHTML = `<p>Hammadde: <span>${(costSums.material / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Elektrik: <span>${(costSums.electricity / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Amortisman: <span>${(costSums.amortization / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Ä°ÅŸÃ§ilik: <span>${(costSums.labor / totalProdCostSum * 100).toFixed(1)}%</span></p><p>BaÅŸarÄ±sÄ±z BaskÄ±: <span>${(costSums.failedPrint / totalProdCostSum * 100).toFixed(1)}%</span></p>`; const costCtx = document.getElementById('costChart').getContext('2d'); charts.costChart = new Chart(costCtx, { type: 'doughnut', data: { labels: ['Hammadde', 'Elektrik', 'Amortisman', 'Ä°ÅŸÃ§ilik', 'BaÅŸarÄ±sÄ±z BaskÄ±'], datasets: [{ data: [costSums.material, costSums.electricity, costSums.amortization, costSums.labor, costSums.failedPrint], backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            if (charts.cashChart) charts.cashChart.destroy();
            document.getElementById('cash-summary-text').innerHTML = `<p>Nakit: <span class="font-semibold">${cashBalance.toFixed(2)} TL</span></p><p>Banka: <span class="font-semibold">${bankBalance.toFixed(2)} TL</span></p><p>Kredi KartÄ± Borcu: <span class="font-semibold text-red-600">${creditCardDebt.toFixed(2)} TL</span></p>`;
            if (totalAssets > 0 || creditCardDebt > 0) { const cashCtx = document.getElementById('cashChart').getContext('2d'); charts.cashChart = new Chart(cashCtx, { type: 'doughnut', data: { labels: ['Nakit', 'Banka', 'K. KartÄ± Borcu'], datasets: [{ data: [cashBalance, bankBalance, creditCardDebt], backgroundColor: ['#10B981', '#3B82F6', '#EF4444'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            
            // Gider daÄŸÄ±lÄ±mÄ± grafiÄŸi
            if (charts.expenseChart) charts.expenseChart.destroy();
            if (totalExpenses > 0) {
                const expenseCategories = {};
                expenses.forEach(exp => {
                    expenseCategories[exp.category] = (expenseCategories[exp.category] || 0) + exp.amount;
                });
                const categoryLabels = Object.keys(expenseCategories);
                const categoryValues = Object.values(expenseCategories);
                const categoryColors = ['#EF4444', '#F97316', '#EAB308', '#22C55E', '#06B6D4', '#8B5CF6', '#EC4899', '#84CC16', '#F59E0B', '#6366F1'];
                
                document.getElementById('expense-breakdown-text').innerHTML = categoryLabels.map((cat, i) => 
                    `<p>${cat}: <span>${(categoryValues[i] / totalExpenses * 100).toFixed(1)}%</span></p>`
                ).join('');
                
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                charts.expenseChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryColors.slice(0, categoryLabels.length),
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // AylÄ±k gider trendi grafiÄŸi
            if (charts.expenseTrendChart) charts.expenseTrendChart.destroy();
            const last6Months = [];
            const monthlyExpenses = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthName = date.toLocaleDateString('tr-TR', { month: 'short' });
                last6Months.push(monthName);
                
                const monthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() === date.getMonth() && expDate.getFullYear() === date.getFullYear();
                }).reduce((sum, exp) => sum + exp.amount, 0);
                monthlyExpenses.push(monthExpenses);
            }
            
            document.getElementById('expense-trend-text').innerHTML = `<p>Son 6 ay gider trendi</p><p>Bu ay: <span class="font-semibold">${thisMonthExpenses.toFixed(2)} TL</span></p>`;
            
            const trendCtx = document.getElementById('expenseTrendChart').getContext('2d');
            charts.expenseTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: 'AylÄ±k Giderler',
                        data: monthlyExpenses,
                        borderColor: '#F97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' TL';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCashFlow() { const container = document.getElementById('cashFlow'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Kasa ve Hesap YÃ¶netimi</h2><div class="mb-6"><button onclick="openAddAccountModal('nakit')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Nakit Hesap Ekle</button><button onclick="openAddAccountModal('banka')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 ml-2">Banka HesabÄ± Ekle</button><button onclick="openAddAccountModal('kredikarti')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 ml-2">Kredi KartÄ± Ekle</button></div><div id="accountsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${accounts.map(getAccountHTML).join('')}</div>`; }
        function renderStockStatus() {
            const container = document.getElementById('stock');
            const { productStock, rawMaterialStock, productStockValue, rawMaterialStockValue } = calculateAllStocks();
            const totalStockValue = productStockValue + rawMaterialStockValue;
            // ÃœrÃ¼n stok durumu - ana Ã¼rÃ¼n + varyantlarÄ±
            const productStockHTML = productStock.map(p => {
                const variantHTML = p.variants.map(v => 
                    `<li class="ml-4 text-xs text-gray-500">â””â”€ ${v.name}: <strong>${v.stock}</strong> adet</li>`
                ).join('');
                
                return `<li class="font-medium">${p.name}: <strong>${p.stock}</strong> adet
                    ${variantHTML}
                </li>`;
            }).join('');
            
            container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Stok Takip</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card"><h3 class="text-lg font-medium text-purple-700 mb-2">Stok DeÄŸeri</h3><p>ÃœrÃ¼n StoÄŸu DeÄŸeri: <strong class="font-semibold">${productStockValue.toFixed(2)} TL</strong></p><p>Hammadde StoÄŸu DeÄŸeri: <strong class="font-semibold">${rawMaterialStockValue.toFixed(2)} TL</strong></p><p class="mt-2 text-xl">Toplam Stok DeÄŸeri: <strong class="font-bold">${totalStockValue.toFixed(2)} TL</strong></p></div><div class="card flex items-center justify-center" style="min-height: 250px;"><canvas id="stockChart"></canvas></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6"><div class="card"><h3 class="text-lg font-medium text-purple-700 mb-2">ÃœrÃ¼n Stok Durumu</h3><ul class="list-disc pl-5 text-gray-600 text-sm">${productStockHTML || '<li>ÃœrÃ¼n bilgisi yok</li>'}</ul></div><div class="card"><h3 class="text-lg font-medium text-blue-700 mb-2">Hammadde Stok Durumu</h3><ul class="list-disc pl-5 text-gray-600 text-sm">${rawMaterialStock.map(f => `<li>${f.name} (${f.brand}, ${f.color}): <strong>${f.currentStock.toFixed(3)}</strong> ${f.unit}</li>`).join('') || '<li>Hammadde bilgisi yok.</li>'}</ul></div></div>`;
            if (charts.stockChart) charts.stockChart.destroy();
            if (totalStockValue > 0) { const stockCtx = document.getElementById('stockChart').getContext('2d'); charts.stockChart = new Chart(stockCtx, { type: 'pie', data: { labels: ['ÃœrÃ¼n StoÄŸu', 'Hammadde StoÄŸu'], datasets: [{ data: [productStockValue, rawMaterialStockValue], backgroundColor: ['#4338CA', '#16A34A'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }); }
        }

        function renderFailedPrints() {
            const container = document.getElementById('failedPrints');
            const totalFailedValue = failedPrints.reduce((sum, fp) => sum + (fp.totalCost || 0), 0);
            const totalFailedQuantity = failedPrints.reduce((sum, fp) => sum + fp.quantity, 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">BaskÄ± HatalarÄ± YÃ¶netimi</h2>
                <p class="text-gray-600 mb-4">BaskÄ± hatalÄ± olan Ã¼rÃ¼nleri stoktan dÃ¼ÅŸÃ¼rÃ¼n ve maliyetlerini takip edin.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">Toplam HatalÄ± ÃœrÃ¼n</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${totalFailedQuantity} adet</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Toplam KayÄ±p Maliyet</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${totalFailedValue.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Hata KaydÄ± SayÄ±sÄ±</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${failedPrints.length}</p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">BaskÄ± HatalarÄ±</h3>
                    <button onclick="openAddFailedPrintModal()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        Yeni BaskÄ± HatasÄ± Ekle
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>ÃœrÃ¼n / Varyant</th>
                                <th>HatalÄ± Adet</th>
                                <th>Hata Sebebi</th>
                                <th>Hammadde KaybÄ±</th>
                                <th>Toplam Maliyet</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(failedPrints || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map(getFailedPrintHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function getFailedPrintHTML(failedPrint) {
            const product = products.find(p => p.id === failedPrint.productId);
            const variant = product?.variants?.find(v => v.id === failedPrint.variantId);
            const productName = product?.name || 'Bilinmeyen ÃœrÃ¼n';
            const variantName = variant ? ` - ${variant.name}` : '';
            
            // Hammadde kaybÄ± hesaplama
            let materialLoss = '';
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * failedPrint.quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentName = filament ? `${filament.brand} - ${filament.color}` : 'Bilinmeyen';
                    materialLoss += `<div class="text-xs">${color.name}: ${colorGram.toFixed(2)} gr (${filamentName})</div>`;
                });
            }
            
            return `<tr class="removable" data-id="${failedPrint.id}">
                <td>${failedPrint.date}</td>
                <td>${productName}${variantName}</td>
                <td class="text-red-600 font-semibold">${failedPrint.quantity} adet</td>
                <td>${failedPrint.reason || 'BelirtilmemiÅŸ'}</td>
                <td>
                    <div class="text-xs">
                        ${materialLoss || 'Hammadde bilgisi yok'}
                    </div>
                </td>
                <td class="text-red-600 font-semibold">${(failedPrint.totalCost || 0).toFixed(2)} TL</td>
                <td>
                    <button onclick="removeElement(this, 'failedPrint')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">
                        Sil
                    </button>
                </td>
            </tr>`;
        }

        function renderSuppliers() { const container = document.getElementById('suppliers'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">TedarikÃ§i ve ÃœrÃ¼n YÃ¶netimi</h2><p class="text-gray-600 mb-4">Hammaddelerinizi aldÄ±ÄŸÄ±nÄ±z tedarikÃ§ileri ve onlarÄ±n Ã¼rÃ¼n kataloglarÄ±nÄ± buraya ekleyin.</p><button onclick="addSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni TedarikÃ§i Ekle</button><div id="suppliersContainer" class="mt-4 space-y-6">${(suppliers || []).map(getSupplierHTML).join('')}</div>`; makeTablesResizable();}
        function renderCustomers() { const container = document.getElementById('customers'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Cari MÃ¼ÅŸteri YÃ¶netimi</h2><p class="text-gray-600 mb-4">Sabit mÃ¼ÅŸterilerinizi ve bakiyelerini buradan takip edin.</p><button onclick="addCustomer()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni MÃ¼ÅŸteri Ekle</button><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${(customers || []).map(getCustomerHTML).join('')}</div>`; }
        function renderRawMaterials() { 
            const container = document.getElementById('rawMaterials'); 
            const calculatedMaterials = getCalculatedRawMaterialStocks(); 
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Hammadde Envanteri</h2>
                <p class="text-gray-600 mb-4">TedarikÃ§ilerden gelen Ã¼rÃ¼nleri envanterinize ekleyin ve mevcut stoklarÄ± gÃ¼ncelleyin.</p>
                <button onclick="openAddMaterialFromSupplierModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">TedarikÃ§iden Yeni Malzeme Ekle</button>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Malzeme AdÄ±</th>
                                <th>Marka</th>
                                <th>Renk</th>
                                <th>TÃ¼r</th>
                                <th>Min Stok (Birim)</th>
                                <th>Mevcut Stok (Birim)</th>
                                <th>Birim</th>
                                <th>Ortalama Maliyet (TL/Birim)</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody id="rawMaterialsTableBody">
                            ${calculatedMaterials.map(getRawMaterialHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `; 
            makeTablesResizable();
        }
        function toggleProductExpansion(productId) {
            expandedProductId = expandedProductId === productId ? null : productId;
            renderProducts();
        }
        
        function renderProducts() { 
            const container = document.getElementById('products'); 
            const startIndex = (currentProductPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const currentProducts = (products || []).slice(startIndex, endIndex);
            const totalPages = Math.ceil((products || []).length / productsPerPage);
            
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="flex justify-center items-center space-x-2 mt-6">
                        <button onclick="changeProductPage(${currentProductPage - 1})" 
                                ${currentProductPage <= 1 ? 'disabled' : ''} 
                                class="px-3 py-1 bg-gray-300 text-gray-700 rounded-md ${currentProductPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-400'}">Ã–nceki</button>
                        <span class="px-3 py-1 bg-blue-500 text-white rounded-md">${currentProductPage} / ${totalPages}</span>
                        <button onclick="changeProductPage(${currentProductPage + 1})" 
                                ${currentProductPage >= totalPages ? 'disabled' : ''} 
                                class="px-3 py-1 bg-gray-300 text-gray-700 rounded-md ${currentProductPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-400'}">Sonraki</button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">ÃœrÃ¼n TanÄ±mlarÄ± ve VaryantlarÄ±</h2>
                <p class="text-gray-600 mb-4">ÃœrÃ¼nlerinizi ve bu Ã¼rÃ¼nleri oluÅŸturan parÃ§alarÄ± (varyantlarÄ±) buradan yÃ¶netin. Bir Ã¼rÃ¼nÃ¼n toplam maliyeti, iÃ§erdiÄŸi varyantlarÄ±n toplamÄ±ndan hesaplanÄ±r.</p>
                <button onclick="addProduct()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni ÃœrÃ¼n Ekle</button>
                <div id="productsContainer" class="space-y-4">${currentProducts.map(getSimpleProductHTML).join('')}</div>
                ${paginationHTML}
            `; 
            makeTablesResizable();
        }
        
        function changeProductPage(page) {
            const totalPages = Math.ceil((products || []).length / productsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentProductPage = page;
                renderProducts();
            }
        }
        function renderProductionLog() { 
            try {
            const container = document.getElementById('productionLog'); 
                if (!container) {
                    console.error('productionLog container bulunamadÄ±');
                    return;
                }
                
            const costData = calculateAllProductionCosts(); 
                const customHeaders = (customParameters || []).map(p => `<th>${p.name} (Girdi)</th>`).join('');
                const customCostHeaders = (customParameters || []).map(p => `<th>${p.name} (Maliyet)</th>`).join('');
                
                const productionLogData = (productionLog || []).slice(); // Array'in kopyasÄ±nÄ± al
                // Tarihe gÃ¶re sÄ±rala (en yeni en baÅŸta)
                productionLogData.sort((a, b) => new Date(b.date) - new Date(a.date));
                const productionLogHTML = productionLogData.map(entry => {
                    try {
                        return getProductionLogHTML(entry, costData[entry.id] || {});
                    } catch (error) {
                        console.error('Hata getProductionLogHTML:', entry.id, error);
                        return `<tr><td colspan="17">Hata: ${entry.id}</td></tr>`;
                    }
                }).join('');
                
                // Ä°statistikler
                const totalEntries = productionLogData.length;
                const totalQuantity = productionLogData.reduce((sum, entry) => sum + entry.quantity, 0);
                const totalCost = productionLogData.reduce((sum, entry) => sum + (costData[entry.id]?.totalCost || 0), 0);
                const avgUnitCost = totalQuantity > 0 ? totalCost / totalQuantity : 0;
                
                container.innerHTML = `
                    <!-- Header Section -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-lg mb-6">
                        <div class="px-6 py-8">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-2">ğŸ­ Ãœretim KaydÄ±</h2>
                                    <p class="text-indigo-100">Ãœretim sÃ¼reÃ§lerinizi takip edin ve maliyetlerinizi analiz edin</p>
                                </div>
                                <button class="bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-indigo-50 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1" 
                                        id="addProductionBtn">
                                    â• Yeni Ãœretim KaydÄ±
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam KayÄ±t</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalEntries}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam Ãœretim</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalQuantity.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-full">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam Maliyet</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalCost.toLocaleString('tr-TR', {minimumFractionDigits: 2})} â‚º</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ortalama Birim Maliyet</p>
                                    <p class="text-2xl font-bold text-gray-900">${avgUnitCost.toLocaleString('tr-TR', {minimumFractionDigits: 2})} â‚º</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="bg-white rounded-xl shadow-lg mb-6">
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ” Arama ve Filtreleme</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ·ï¸ ÃœrÃ¼n AdÄ±</label>
                                    <input type="text" id="productionSearchProduct" placeholder="ÃœrÃ¼n adÄ± ara..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”§ Varyant AdÄ±</label>
                                    <input type="text" id="productionSearchVariant" placeholder="Varyant adÄ± ara..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Tarih AralÄ±ÄŸÄ±</label>
                                    <div class="flex space-x-2">
                                        <input type="date" id="productionSearchDateFrom" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <input type="date" id="productionSearchDateTo" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“¦ Miktar AralÄ±ÄŸÄ±</label>
                                    <div class="flex space-x-2">
                                        <input type="number" id="productionSearchQuantityMin" placeholder="Min" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <input type="number" id="productionSearchQuantityMax" placeholder="Max" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button onclick="filterProductionLog()" 
                                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200">
                                    ğŸ” Filtrele
                                </button>
                                <button onclick="clearProductionFilters()" 
                                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200">
                                    ğŸ—‘ï¸ Temizle
                                </button>
                                <button onclick="exportProductionLog()" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors duration-200">
                                    ğŸ“Š Excel'e Aktar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Production Log Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ“Š Ãœretim KayÄ±tlarÄ±</h3>
                            <p class="text-sm text-gray-600">TÃ¼m Ã¼retim kayÄ±tlarÄ±nÄ±zÄ± detaylÄ± olarak gÃ¶rÃ¼ntÃ¼leyin</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“… Tarih</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ·ï¸ ÃœrÃ¼n / Varyant</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“¦ Adet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">âš–ï¸ Toplam Gramaj</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ”§ Malzeme KullanÄ±mÄ±</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ‘· Ä°ÅŸÃ§ilik Ãœcreti</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“ˆ KazanÃ§ OranÄ±</th>
                                        ${customHeaders}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ§± Hammadde</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">âš¡ Elektrik</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ­ Amortisman</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ’° Toplam Ä°ÅŸÃ§ilik</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">âŒ BaÅŸarÄ±sÄ±z BaskÄ±</th>
                                        ${customCostHeaders}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ’¸ Toplam Maliyet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“Š Birim Maliyet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ’¡ Ã–nerilen Fiyat</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">âš™ï¸ Eylemler</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${productionLogHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Buton event listener'Ä±nÄ± manuel olarak ekle
                const addBtn = document.getElementById('addProductionBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Buton tÄ±klandÄ±');
                        addProductionEntry();
                    });
                } 
                
                productionLogData.forEach(entry => {
                    try {
                renderMaterialUsageForEntry(entry.id);
                    } catch (error) {
                        console.error('Hata renderMaterialUsageForEntry:', entry.id, error);
                    }
            }); 
                
            makeTablesResizable();
                
                // Arama input'larÄ±na event listener ekle
                const searchProduct = document.getElementById('productionSearchProduct');
                const searchVariant = document.getElementById('productionSearchVariant');
                const searchDateFrom = document.getElementById('productionSearchDateFrom');
                const searchDateTo = document.getElementById('productionSearchDateTo');
                const searchQuantityMin = document.getElementById('productionSearchQuantityMin');
                const searchQuantityMax = document.getElementById('productionSearchQuantityMax');
                
                if (searchProduct) {
                    searchProduct.addEventListener('input', filterProductionLog);
                }
                if (searchVariant) {
                    searchVariant.addEventListener('input', filterProductionLog);
                }
                if (searchDateFrom) {
                    searchDateFrom.addEventListener('change', filterProductionLog);
                }
                if (searchDateTo) {
                    searchDateTo.addEventListener('change', filterProductionLog);
                }
                if (searchQuantityMin) {
                    searchQuantityMin.addEventListener('input', filterProductionLog);
                }
                if (searchQuantityMax) {
                    searchQuantityMax.addEventListener('input', filterProductionLog);
                }
                
            } catch (error) {
                console.error('Hata renderProductionLog:', error);
                const container = document.getElementById('productionLog');
                if (container) {
                    container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Ãœretim KaydÄ±</h2><p class="text-red-600">Hata: ${error.message}</p>`;
                }
            }
        }

        // Ãœretim kaydÄ± arama ve filtreleme fonksiyonlarÄ±
        function filterProductionLog() {
            const searchProduct = document.getElementById('productionSearchProduct')?.value.toLowerCase() || '';
            const searchVariant = document.getElementById('productionSearchVariant')?.value.toLowerCase() || '';
            const searchDateFrom = document.getElementById('productionSearchDateFrom')?.value || '';
            const searchDateTo = document.getElementById('productionSearchDateTo')?.value || '';
            const searchQuantityMin = parseFloat(document.getElementById('productionSearchQuantityMin')?.value) || 0;
            const searchQuantityMax = parseFloat(document.getElementById('productionSearchQuantityMax')?.value) || Infinity;
            
            const costData = calculateAllProductionCosts();
            const customHeaders = (customParameters || []).map(p => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${p.name} (Girdi)</th>`).join('');
            const customCostHeaders = (customParameters || []).map(p => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${p.name} (Maliyet)</th>`).join('');
            
            // Filtreleme
            let filteredData = (productionLog || []).slice();
            
            if (searchProduct) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    return product && product.name.toLowerCase().includes(searchProduct);
                });
            }
            
            if (searchVariant) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    const variant = product?.variants?.find(v => v.id === entry.variantId);
                    return variant && variant.name.toLowerCase().includes(searchVariant);
                });
            }
            
            if (searchDateFrom) {
                filteredData = filteredData.filter(entry => entry.date >= searchDateFrom);
            }
            
            if (searchDateTo) {
                filteredData = filteredData.filter(entry => entry.date <= searchDateTo);
            }
            
            if (searchQuantityMin > 0) {
                filteredData = filteredData.filter(entry => entry.quantity >= searchQuantityMin);
            }
            
            if (searchQuantityMax < Infinity) {
                filteredData = filteredData.filter(entry => entry.quantity <= searchQuantityMax);
            }
            
            // Tarihe gÃ¶re sÄ±rala (en yeni en baÅŸta)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const productionLogHTML = filteredData.map(entry => {
                try {
                    return getProductionLogHTML(entry, costData[entry.id] || {});
                } catch (error) {
                    console.error('Hata getProductionLogHTML:', entry.id, error);
                    return `<tr class="bg-red-50"><td colspan="17" class="px-6 py-4 text-center text-red-600">Hata: ${entry.id}</td></tr>`;
                }
            }).join('');
            
            // Tabloyu gÃ¼ncelle
            const tbody = document.querySelector('#productionLog tbody');
            if (tbody) {
                tbody.innerHTML = productionLogHTML;
                
                // Material usage'larÄ± render et
                filteredData.forEach(entry => {
                    try {
                        renderMaterialUsageForEntry(entry.id);
                    } catch (error) {
                        console.error('Hata renderMaterialUsageForEntry:', entry.id, error);
                    }
                });
            }
            
            // SonuÃ§ sayÄ±sÄ±nÄ± gÃ¶ster
            const resultCount = document.getElementById('productionResultCount');
            if (resultCount) {
                resultCount.textContent = `${filteredData.length} kayÄ±t bulundu`;
            } else {
                // SonuÃ§ sayÄ±sÄ±nÄ± gÃ¶ster
                const tableHeader = document.querySelector('#productionLog .px-6.py-4.bg-gray-50');
                if (tableHeader) {
                    const existingCount = tableHeader.querySelector('#productionResultCount');
                    if (existingCount) {
                        existingCount.remove();
                    }
                    const countElement = document.createElement('div');
                    countElement.id = 'productionResultCount';
                    countElement.className = 'text-sm text-indigo-600 font-medium';
                    countElement.textContent = `${filteredData.length} kayÄ±t bulundu`;
                    tableHeader.appendChild(countElement);
                }
            }
        }

        function clearProductionFilters() {
            document.getElementById('productionSearchProduct').value = '';
            document.getElementById('productionSearchVariant').value = '';
            document.getElementById('productionSearchDateFrom').value = '';
            document.getElementById('productionSearchDateTo').value = '';
            document.getElementById('productionSearchQuantityMin').value = '';
            document.getElementById('productionSearchQuantityMax').value = '';
            
            // TÃ¼m kayÄ±tlarÄ± gÃ¶ster
            renderProductionLog();
        }

        function exportProductionLog() {
            const searchProduct = document.getElementById('productionSearchProduct')?.value.toLowerCase() || '';
            const searchVariant = document.getElementById('productionSearchVariant')?.value.toLowerCase() || '';
            const searchDateFrom = document.getElementById('productionSearchDateFrom')?.value || '';
            const searchDateTo = document.getElementById('productionSearchDateTo')?.value || '';
            const searchQuantityMin = parseFloat(document.getElementById('productionSearchQuantityMin')?.value) || 0;
            const searchQuantityMax = parseFloat(document.getElementById('productionSearchQuantityMax')?.value) || Infinity;
            
            // Filtreleme (filterProductionLog ile aynÄ± mantÄ±k)
            let filteredData = (productionLog || []).slice();
            
            if (searchProduct) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    return product && product.name.toLowerCase().includes(searchProduct);
                });
            }
            
            if (searchVariant) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    const variant = product?.variants?.find(v => v.id === entry.variantId);
                    return variant && variant.name.toLowerCase().includes(searchVariant);
                });
            }
            
            if (searchDateFrom) {
                filteredData = filteredData.filter(entry => entry.date >= searchDateFrom);
            }
            
            if (searchDateTo) {
                filteredData = filteredData.filter(entry => entry.date <= searchDateTo);
            }
            
            if (searchQuantityMin > 0) {
                filteredData = filteredData.filter(entry => entry.quantity >= searchQuantityMin);
            }
            
            if (searchQuantityMax < Infinity) {
                filteredData = filteredData.filter(entry => entry.quantity <= searchQuantityMax);
            }
            
            // CSV oluÅŸtur
            const costData = calculateAllProductionCosts();
            const headers = ['Tarih', 'ÃœrÃ¼n', 'Varyant', 'Adet', 'Ä°ÅŸÃ§ilik Ãœcreti', 'KazanÃ§ OranÄ±', 'Toplam Maliyet', 'Birim Maliyet', 'Ã–nerilen Fiyat'];
            const rows = filteredData.map(entry => {
                const product = products.find(p => p.id === entry.productId);
                const variant = product?.variants?.find(v => v.id === entry.variantId);
                const costs = costData[entry.id] || {};
                
                return [
                    entry.date,
                    product?.name || '',
                    variant?.name || '',
                    entry.quantity,
                    entry.laborCost,
                    entry.profitMargin,
                    costs.totalCost || 0,
                    costs.unitCost || 0,
                    costs.recommendedUnitPrice || 0
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            // DosyayÄ± indir
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `uretim_kayitlari_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ğŸ“Š Ãœretim kayÄ±tlarÄ± Excel formatÄ±nda indirildi!', 'success', 3000);
        }

        function renderSalesLog() { 
            const salesData = (salesLog || []).slice(); // Array'in kopyasÄ±nÄ± al
            // Tarihe gÃ¶re sÄ±rala (en yeni en baÅŸta)
            salesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('sales'); 
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">SatÄ±ÅŸ KaydÄ±</h2>
                <p class="text-gray-600 mb-4">YapÄ±lan satÄ±ÅŸlarÄ± ve Ã¶deme durumlarÄ±nÄ± buradan yÃ¶netin.</p>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button onclick="openSaleModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        ğŸ“¦ Sistemdeki ÃœrÃ¼nlerden SatÄ±ÅŸ
                    </button>
                    <button onclick="openQuickSaleModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        âš¡ HÄ±zlÄ± SatÄ±ÅŸ (Sistem DÄ±ÅŸÄ± ÃœrÃ¼n)
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>ÃœrÃ¼n AdÄ±</th>
                                <th>Adet</th>
                                <th>MÃ¼ÅŸteri/Kanal</th>
                                <th>Ã–deme YÃ¶ntemi</th>
                                <th>Toplam Maliyet</th>
                                <th>GerÃ§ekleÅŸen Kar</th>
                                <th>Toplam Tutar (KDV Dahil)</th>
                                <th>Eylem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesData.map(getSaleHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `; 
            makeTablesResizable();
        }
        function renderParameters() { const container = document.getElementById('parameters'); const coreParamsHTML = `<h3 class="text-xl font-semibold text-gray-700 mt-6 mb-2">Ã‡ekirdek Parametreler</h3><div class="table-container"><table id="parametersTable" class="resizable-table"><thead><tr><th>Parametre AdÄ±</th><th>DeÄŸer</th><th>Birim</th></tr></thead><tbody><tr><td>Makine Ortalama kW</td><td><input type="number" step="0.01" value="${parameters.machineKw || 0}" onchange="updateParameter('machineKw', this.value)"></td><td>kW/saat</td></tr><tr><td>Elektrik kWh FiyatÄ±</td><td><input type="number" step="0.01" value="${parameters.electricityKwhPrice || 0}" onchange="updateParameter('electricityKwhPrice', this.value)"></td><td>TL/kWh</td></tr><tr><td>Makine Ä°lk Maliyeti</td><td><input type="number" value="${parameters.machineInitialCost || 0}" onchange="updateParameter('machineInitialCost', this.value)"></td><td>TL</td></tr><tr><td>Makine Tahmini Ã–mrÃ¼</td><td><input type="number" value="${parameters.machineLifespanHours || 1}" onchange="updateParameter('machineLifespanHours', this.value)"></td><td>saat</td></tr></tbody></table></div>`; const customParamsHTML = `<div class="flex justify-between items-center mt-8 mb-2"><h3 class="text-xl font-semibold text-gray-700">Ã–zel Maliyet Parametreleri</h3><button onclick="openCustomParamModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Yeni Ã–zel Parametre Ekle</button></div><div class="table-container"><table id="customParametersTable" class="resizable-table"><thead><tr><th>Parametre AdÄ±</th><th>TÃ¼rÃ¼</th><th>VarsayÄ±lan DeÄŸer</th><th>Eylemler</th></tr></thead><tbody>${customParameters.map(p => `<tr class="removable" data-id="${p.id}"><td>${p.name}</td><td>${p.type === 'parasal' ? 'Parasal DeÄŸer (TL)' : p.type === 'saatlik' ? 'Saatlik Ãœcret (TL)' : 'YÃ¼zdelik (%)'}</td><td>${p.value}</td><td><button onclick="openCustomParamModal('${p.id}')" class="bg-yellow-500 text-white px-3 py-1 text-sm rounded-md mr-2">DÃ¼zenle</button><button onclick="removeElement(this, 'customParameter')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-md">Sil</button></td></tr>`).join('')}</tbody></table></div>`; container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Parametre YÃ¶netimi</h2><p class="text-gray-600 mb-4">Ãœretim ve satÄ±ÅŸ hesaplamalarÄ±nda kullanÄ±lacak temel ve Ã¶zel deÄŸerleri buradan yÃ¶netin.</p>${coreParamsHTML}${customParamsHTML}`; makeTablesResizable();}
        function renderExpenses() {
            const container = document.getElementById('expenses');
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const thisMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                const now = new Date();
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            }).reduce((sum, exp) => sum + exp.amount, 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gider YÃ¶netimi</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">Toplam Giderler</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${totalExpenses.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Bu Ay Giderler</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${thisMonthExpenses.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Gider SayÄ±sÄ±</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${expenses.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Gider Listesi</h3>
                    <button onclick="openAddExpenseModal()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        Yeni Gider Ekle
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Gider TÃ¼rÃ¼</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Tutar</th>
                                <th>Hesap</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(expenses || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map(getExpenseHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function renderMaterials() {
            const container = document.getElementById('materials');
            const totalValue = materials.reduce((sum, mat) => sum + (mat.quantity * mat.unitPrice), 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Malzeme Envanteri</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-700">Toplam Malzeme DeÄŸeri</h3>
                        <p class="text-3xl font-bold text-purple-800 mt-2">${totalValue.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-indigo-700">Malzeme Ã‡eÅŸidi</h3>
                        <p class="text-3xl font-bold text-indigo-800 mt-2">${materials.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Malzeme Listesi</h3>
                    <button onclick="openAddMaterialItemModal()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        Yeni Malzeme Ekle
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Malzeme AdÄ±</th>
                                <th>Kategori</th>
                                <th>Miktar</th>
                                <th>Birim</th>
                                <th>Birim Fiyat</th>
                                <th>Toplam DeÄŸer</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materials.map(getMaterialHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function calculateTotalExpectedSales() {
            return productionPlans.reduce((sum, plan) => {
                const salePrice = plan.salePrice || 0;
                return sum + (salePrice * plan.orderQuantity);
            }, 0);
        }

        function calculateTotalExpectedCost() {
            return productionPlans.reduce((sum, plan) => {
                // Plan iÃ§in maliyet hesaplama (basit yaklaÅŸÄ±m)
                const unitTime = plan.unitTime || 0;
                const orderQuantity = plan.orderQuantity || 0;
                const machineCount = plan.machineCount || 1;
                
                // Elektrik maliyeti
                const electricityCost = unitTime * orderQuantity * parameters.machineKw * parameters.electricityKwhPrice;
                
                // Amortisman maliyeti
                const amortizationCost = (unitTime * orderQuantity * parameters.machineInitialCost) / parameters.machineLifespanHours;
                
                // Ä°ÅŸÃ§ilik maliyeti
                const laborCost = unitTime * orderQuantity * parameters.laborCostPerProduct;
                
                return sum + electricityCost + amortizationCost + laborCost;
            }, 0);
        }

        function calculateTotalExpectedProfit() {
            const totalSales = calculateTotalExpectedSales();
            const totalCost = calculateTotalExpectedCost();
            return totalSales - totalCost;
        }

        function renderProductionPlanning() {
            const container = document.getElementById('productionPlanning');
            const totalPlannedItems = productionPlans.reduce((sum, plan) => sum + plan.orderQuantity, 0);
            const totalPlannedDays = productionPlans.reduce((sum, plan) => sum + plan.totalDays, 0);
            const activePlans = productionPlans.filter(plan => plan.status === 'active').length;
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Ãœretim Planlama SÃ¼reci</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Toplam Planlanan Adet</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${totalPlannedItems}</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-green-700">Toplam Planlanan GÃ¼n</h3>
                        <p class="text-3xl font-bold text-green-800 mt-2">${totalPlannedDays.toFixed(1)}</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Aktif Planlar</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${activePlans}</p>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-700">Toplam Plan SayÄ±sÄ±</h3>
                        <p class="text-3xl font-bold text-purple-800 mt-2">${productionPlans.length}</p>
                    </div>
                    <div class="bg-emerald-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-emerald-700">ğŸ’° Beklenen SatÄ±ÅŸ</h3>
                        <p class="text-3xl font-bold text-emerald-800 mt-2">${calculateTotalExpectedSales().toFixed(0)} â‚º</p>
                    </div>
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">ğŸ’¸ Toplam Maliyet</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${calculateTotalExpectedCost().toFixed(0)} â‚º</p>
                    </div>
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-yellow-700">ğŸ“ˆ Beklenen Kar</h3>
                        <p class="text-3xl font-bold text-yellow-800 mt-2">${calculateTotalExpectedProfit().toFixed(0)} â‚º</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Ãœretim PlanlarÄ±</h3>
                    <button onclick="openAddProductionPlanModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Yeni Plan Ekle
                    </button>
                </div>
                <!-- Desktop Table View -->
                <div class="hidden lg:block bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ·ï¸ ÃœrÃ¼n AdÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">â±ï¸ Birim SÃ¼re</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ­ Makine SayÄ±sÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“Š GÃ¼nlÃ¼k Kapasite</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“¦ SipariÅŸ Adedi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“… Toplam GÃ¼n</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">â° Toplam Saat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ¨ Filament DetaylarÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ’° SatÄ±ÅŸ FiyatÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ’µ Toplam SatÄ±ÅŸ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“… BaÅŸlangÄ±Ã§ Tarihi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ Beklenen BitiÅŸ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“‹ SÃ¶zleÅŸme Tarihi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ“Š Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">âš™ï¸ Eylemler</th>
                            </tr>
                        </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            ${productionPlans.map(getProductionPlanHTML).join('')}
                        </tbody>
                    </table>
                    </div>
                </div>

                <!-- Mobile Card View -->
                <div class="lg:hidden space-y-4">
                    ${productionPlans.map(getProductionPlanMobileHTML).join('')}
                </div>
            `;
            makeTablesResizable();
        }

        function renderModals() { 
            document.getElementById('addMaterialModal').innerHTML = getAddMaterialModalHTML(); 
            document.getElementById('updateStockModal').innerHTML = getUpdateStockModalHTML(); 
            document.getElementById('addSaleModal').innerHTML = getAddSaleModalHTML(); 
            document.getElementById('quickSaleModal').innerHTML = getQuickSaleModalHTML();
            document.getElementById('addFailedPrintModal').innerHTML = getAddFailedPrintModalHTML();
            document.getElementById('accountModal').innerHTML = getAccountModalHTML(); 
            document.getElementById('customParamModal').innerHTML = getCustomParamModalHTML(); 
            document.getElementById('addPaymentModal').innerHTML = getAddPaymentModalHTML(); 
            document.getElementById('accountDetailModal').innerHTML = getAccountDetailModalHTML(); 
            document.getElementById('editTransactionModal').innerHTML = getEditTransactionModalHTML();
            document.getElementById('addExpenseModal').innerHTML = getAddExpenseModalHTML();
            document.getElementById('addMoneyModal').innerHTML = getAddMoneyModalHTML();
            document.getElementById('addMaterialItemModal').innerHTML = getAddMaterialItemModalHTML();
            document.getElementById('addProductionPlanModal').innerHTML = getAddProductionPlanModalHTML();
            document.getElementById('editProductionPlanModal').innerHTML = getEditProductionPlanModalHTML();
        }


        // --- TAB & MODAL VISIBILITY ---
        function renderAllTabsAndModals() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            renderTabs();
            renderModals();
            const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId || parameters.tabOrder[0];
            showTab(activeTabId, false); // don't re-render tabs
            
            // Ä°lk sekmenin otomatik aÃ§Ä±k olmasÄ±nÄ± saÄŸla
            setTimeout(() => {
                const firstTab = document.querySelector('.tab-button');
                if (firstTab && !document.querySelector('.tab-button.active')) {
                    firstTab.click();
                }
            }, 100);
        }
        
        function showTab(tabId, shouldRenderTabs = true) {
            if (shouldRenderTabs) renderTabs();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const activeContent = document.getElementById(tabId);
            if(activeContent) activeContent.classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => button.classList.toggle('active', button.dataset.tabId === tabId));
            
            // Call the specific render function for the active tab
            const tabInfo = ALL_TABS.find(t => t.id === tabId);
            if (tabInfo && tabInfo.renderFunc) {
                tabInfo.renderFunc();
            }
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        
        let draggedTabElement = null;

        function renderTabs() {
            const tabContainer = document.getElementById('tabContainer'); tabContainer.innerHTML = '';
            parameters.tabOrder = parameters.tabOrder.filter(id => ALL_TABS.some(t => t.id === id));
            ALL_TABS.forEach(tabInfo => {
                 if (!parameters.tabOrder.includes(tabInfo.id)) {
                    parameters.tabOrder.push(tabInfo.id);
                }
            });

            parameters.tabOrder.forEach(tabId => {
                const tabInfo = ALL_TABS.find(t => t.id === tabId);
                if (tabInfo) {
                    const button = document.createElement('button');
                    button.className = 'tab-button'; button.textContent = tabInfo.title; button.dataset.tabId = tabId; button.draggable = true;
                    button.addEventListener('click', () => showTab(tabId));
                    button.addEventListener('dragstart', (e) => { draggedTabElement = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
                    button.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                    button.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('drag-over'); });
                    button.addEventListener('dragleave', (e) => e.target.classList.remove('drag-over'));
                    button.addEventListener('drop', (e) => {
                        e.preventDefault(); e.target.classList.remove('drag-over');
                        if (!draggedTabElement) return;
                        const draggedTabId = draggedTabElement.dataset.tabId;
                        const targetTabId = e.target.dataset.tabId;
                        if (draggedTabId && draggedTabId !== targetTabId) {
                            const oldIndex = parameters.tabOrder.indexOf(draggedTabId); const newIndex = parameters.tabOrder.indexOf(targetTabId);
                            parameters.tabOrder.splice(oldIndex, 1); parameters.tabOrder.splice(newIndex, 0, draggedTabId);
                            saveData(); renderTabs();
                        }
                    });
                    tabContainer.appendChild(button);
                }
            });
            const activeTab = document.querySelector('.tab-content:not(.hidden)');
            if (activeTab) { const activeBtn = tabContainer.querySelector(`[data-tab-id="${activeTab.id}"]`); if (activeBtn) activeBtn.classList.add('active'); } 
            else if (parameters.tabOrder.length > 0) { tabContainer.querySelector(`[data-tab-id="${parameters.tabOrder[0]}"]`)?.classList.add('active'); document.getElementById(parameters.tabOrder[0]).classList.remove('hidden'); }
        }


        // --- LOGIC FUNCTIONS ---
        function addSupplier() { suppliers.push({ id: crypto.randomUUID(), name: "Yeni TedarikÃ§i", materials: [] }); renderSuppliers(); saveData(); }
        function addMaterialToSupplier(supplierId) { const s = suppliers.find(s => s.id === supplierId); if(s) { if(!s.materials) s.materials = []; s.materials.push({ id: crypto.randomUUID(), name: "Filament", brand: "", color: "", type: "PLA", unit: "1000", price: 0 });} renderSuppliers(); saveData(); }
        function addCustomer() { customers.push({ id: crypto.randomUUID(), name: "Yeni MÃ¼ÅŸteri", contactPerson: "", phone: "", address: "", balance: 0 }); renderCustomers(); saveData(); }
        function addProduct() { 
            const newProduct = { id: crypto.randomUUID(), name: "Yeni ÃœrÃ¼n", variants: [] };
            products.push(newProduct); 
            expandedProductId = newProduct.id; // Yeni Ã¼rÃ¼nÃ¼ otomatik geniÅŸlet
            renderProducts(); 
            saveData(); 
        }
        function addProductVariant(productId) { const p = products.find(p => p.id === productId); if (p) { if (!p.variants) p.variants = []; p.variants.push({ id: crypto.randomUUID(), name: "Yeni ParÃ§a", printTime: 0, colors: [] }); renderProducts(); saveData(); } }
        function enableExtraMaterials(productId) { const p = products.find(p => p.id === productId); if (p && !p.extraMaterials) { p.extraMaterials = []; renderProducts(); saveData(); } }
        function addProductExtraMaterial(productId) { if((rawMaterials || []).length === 0) { showMessageModal("Hata", "Ã–nce hammadde eklemelisiniz."); return; } const p = products.find(p => p.id === productId); if(p) { if(!p.extraMaterials) p.extraMaterials = []; p.extraMaterials.push({ id: crypto.randomUUID(), rawMaterialId: rawMaterials[0].id, quantity: 1 });} renderProducts(); saveData(); }
        function addProductionEntry() { 
            try {
                console.log('addProductionEntry Ã§aÄŸrÄ±ldÄ±');
                
            if((products || []).length === 0) { 
                showMessageModal("Hata", "Ãœretim kaydÄ± eklemek iÃ§in Ã¶nce 'ÃœrÃ¼nler' sekmesinden bir Ã¼rÃ¼n eklemelisiniz."); 
                return; 
            }
                
            const firstProduct = products[0];
                console.log('Ä°lk Ã¼rÃ¼n:', firstProduct);
                
            if(!firstProduct.variants || firstProduct.variants.length === 0) {
                 showMessageModal("Hata", "Ãœretim kaydÄ± eklemek iÃ§in Ã¶nce 'ÃœrÃ¼nler' sekmesindeki Ã¼rÃ¼ne en az bir varyant (parÃ§a) eklemelisiniz.");
                 return;
            }

            const firstVariant = firstProduct.variants[0];
                console.log('Ä°lk varyant:', firstVariant);

            const newEntry = { 
                id: crypto.randomUUID(), 
                date: new Date().toISOString().slice(0, 10), 
                productId: firstProduct.id, 
                variantId: firstVariant.id,
                quantity: 1, 
                laborCost: 0, 
                profitMargin: 0, 
                customValues: {}, 
                filamentOverrideId: '',
                materialUsage: [] // Malzeme kullanÄ±mÄ± iÃ§in
            }; 
                
                console.log('Yeni entry oluÅŸturuldu:', newEntry);
                
                // Custom parameters'larÄ± ekle
                (customParameters || []).forEach(p => { 
                    newEntry.customValues[p.id] = p.value; 
                }); 
                
            productionLog.push(newEntry); 
                console.log('Entry productionLog\'a eklendi. Toplam entry sayÄ±sÄ±:', productionLog.length);
                
            renderProductionLog(); 
            saveData(true, true); // Zorla Firebase'e gÃ¶nder 
                
                console.log('addProductionEntry tamamlandÄ±');
            } catch (error) {
                console.error('addProductionEntry hatasÄ±:', error);
                showMessageModal("Hata", "Ãœretim kaydÄ± eklenirken bir hata oluÅŸtu: " + error.message);
            }
        }
        function openAddAccountModal(type) { document.getElementById('accountModal').innerHTML = getAccountModalHTML(); const form = document.getElementById('accountForm'); form.reset(); document.getElementById('accountModalTitle').textContent = 'Yeni Hesap Ekle'; document.getElementById('accountModalSubmitBtn').textContent = 'Hesap OluÅŸtur'; form.accountId.value = ''; form.accountType.value = type; document.getElementById('bankDetailsDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.add('hidden'); document.getElementById('initialBalanceDiv').classList.remove('hidden'); if (type === 'banka') { document.getElementById('bankDetailsDiv').classList.remove('hidden'); } else if (type === 'kredikarti') { document.getElementById('initialBalanceDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.remove('hidden'); } showModal('accountModal'); }
        function openEditAccountModal(accountId) { document.getElementById('accountModal').innerHTML = getAccountModalHTML(); const account = accounts.find(a => a.id === accountId); if (!account) return; const form = document.getElementById('accountForm'); form.reset(); document.getElementById('accountModalTitle').textContent = 'HesabÄ± DÃ¼zenle'; document.getElementById('accountModalSubmitBtn').textContent = 'GÃ¼ncelle'; form.accountId.value = account.id; form.accountType.value = account.type; form.accountName.value = account.name; document.getElementById('bankDetailsDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.add('hidden'); document.getElementById('initialBalanceDiv').classList.remove('hidden'); if (account.type === 'nakit' || account.type === 'banka') { form.initialBalance.value = account.initialBalance || 0; } if (account.type === 'banka') { document.getElementById('bankDetailsDiv').classList.remove('hidden'); form.bankName.value = account.bankName || ''; form.iban.value = account.iban || ''; } else if (account.type === 'kredikarti') { document.getElementById('initialBalanceDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.remove('hidden'); form.creditCardLimit.value = account.limit || 0; form.linkedAccountId.value = account.linkedAccountId || ''; } showModal('accountModal'); }
        function handleAccountFormSubmit() { 
            const form = document.getElementById('accountForm'); 
            const accountId = form.accountId.value; 
            
            if (accountId) { 
                // Hesap dÃ¼zenleme
                const account = accounts.find(a => a.id === accountId); 
                if(account) { 
                    account.name = form.accountName.value; 
                    if (account.type === 'nakit' || account.type === 'banka') { 
                        account.initialBalance = parseFloat(form.initialBalance.value) || 0; 
                    } 
                    if (account.type === 'banka') { 
                        account.bankName = form.bankName.value; 
                        account.iban = form.iban.value; 
                    } else if (account.type === 'kredikarti') { 
                        account.limit = parseFloat(form.creditCardLimit.value) || 0; 
                        account.linkedAccountId = form.linkedAccountId.value; 
                    } 
                } 
            } else { 
                // Yeni hesap oluÅŸturma
                const newAccount = { 
                    id: crypto.randomUUID(), 
                    type: form.accountType.value, 
                    name: form.accountName.value, 
                    initialBalance: parseFloat(form.initialBalance.value) || 0,
                    transactions: [] // Transaction array'ini baÅŸlat
                }; 
                
                if (newAccount.type === 'banka') { 
                    newAccount.bankName = form.bankName.value; 
                    newAccount.iban = form.iban.value; 
                } else if (newAccount.type === 'kredikarti') { 
                    newAccount.limit = parseFloat(form.creditCardLimit.value) || 0; 
                    newAccount.linkedAccountId = form.linkedAccountId.value; 
                } 
                
                accounts.push(newAccount);
                console.log('ğŸ” Yeni Hesap OluÅŸturuldu:', newAccount);
            } 
            
            renderCashFlow(); 
            saveData(); 
            closeModal('accountModal'); 
        }
        function openCustomParamModal(paramId = null) { const form = document.getElementById('customParamForm'); form.reset(); if(paramId) { const param = customParameters.find(p => p.id === paramId); if(param) { document.getElementById('customParamModalTitle').textContent = 'Parametreyi DÃ¼zenle'; document.getElementById('customParamModalSubmitBtn').textContent = 'GÃ¼ncelle'; form.paramId.value = param.id; form.paramName.value = param.name; form.paramType.value = param.type; form.paramValue.value = param.value; } } else { document.getElementById('customParamModalTitle').textContent = 'Yeni Ã–zel Parametre Ekle'; document.getElementById('customParamModalSubmitBtn').textContent = 'Ekle'; form.paramId.value = ''; } showModal('customParamModal'); }
        function handleCustomParamFormSubmit() { const form = document.getElementById('customParamForm'); const paramId = form.paramId.value; const paramData = { name: form.paramName.value, type: form.paramType.value, value: parseFloat(form.paramValue.value) || 0 }; if(paramId) { const index = customParameters.findIndex(p => p.id === paramId); if(index > -1) { customParameters[index] = {...customParameters[index], ...paramData}; } } else { customParameters.push({ id: crypto.randomUUID(), ...paramData}); } renderParameters(); saveData(); closeModal('customParamModal'); }
        function updateSupplierField(id, field, value) { const s = suppliers.find(s => s.id === id); if(s) s[field] = value; saveData(); }
        function updateSupplierMaterialField(supplierId, matId, field, value) { const s = suppliers.find(s => s.id === supplierId); const m = s?.materials.find(m => m.id === matId); if(m) m[field] = (field === 'price') ? (parseFloat(value) || 0) : value; saveData(); }
        function updateCustomerField(id, field, value) { const c = customers.find(c => c.id === id); if (c) c[field] = value; saveData(); }
        function updateRawMaterialField(id, field, value) { const m = rawMaterials.find(m => m.id === id); if (m) m[field] = parseFloat(value) || 0; saveData(); renderRawMaterials(); }
        function updateProductField(id, field, value) { const p = products.find(p => p.id === id); if (p && field === 'name') p[field] = value; saveData(); }
        function updateProductVariant(productId, variantId, field, value) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v) { v[field] = ['printTime', 'filamentUsage'].includes(field) ? (parseFloat(value) || 0) : value; } renderProducts(); renderProductionLog(); saveData(); }
        function addVariantColor(productId, variantId) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v) { if (!v.colors) v.colors = []; v.colors.push({ name: '', filamentId: '', gram: 0 }); renderProducts(); saveData(); } }
        function updateVariantColor(productId, variantId, colorIndex, field, value) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v && v.colors && v.colors[colorIndex]) { v.colors[colorIndex][field] = field === 'gram' ? (parseFloat(value) || 0) : value; } renderProducts(); renderProductionLog(); saveData(); }
        function removeVariantColor(productId, variantId, colorIndex) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v && v.colors && v.colors[colorIndex]) { v.colors.splice(colorIndex, 1); renderProducts(); saveData(); } }
        function updateProductExtraMaterial(productId, matId, field, value) { const p = products.find(p => p.id === productId); const m = p?.extraMaterials.find(m => m.id === matId); if(m) m[field] = field === 'quantity' ? (parseFloat(value) || 0) : value; renderProducts(); saveData(); }
        function handleProductChangeInLog(selectElement, entryId) {
            const newProductId = selectElement.value;
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;

            const product = products.find(p => p.id === newProductId);
            // Update the variant dropdown with new options
            const variantSelect = document.getElementById(`variant-select-${entryId}`);
            if (product && product.variants) {
                variantSelect.innerHTML = product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                const firstVariantId = product.variants[0]?.id || null;
                entry.variantId = firstVariantId;
            } else {
                variantSelect.innerHTML = '';
                entry.variantId = null;
            }

            entry.productId = newProductId;
            
            // Rerender the material selector for the new variant and update costs
            renderProductionLog();
            saveData();
        }
        function updateProductionField(id, field, value) { 
            const p = productionLog.find(p => p.id === id); 
            if(p) { 
                if (['quantity', 'laborCost', 'profitMargin'].includes(field)) { 
                    p[field] = parseFloat(value) || 0; 
                } else { 
                    p[field] = value; 
                } 
            } 
            renderProductionLog(); 
            saveData(); 
        }
        function updateProductionFilamentOverride(entryId, selectedFilamentId) { const entry = productionLog.find(e => e.id === entryId); if (entry) { entry.filamentOverrideId = selectedFilamentId; renderProductionLog(); saveData(); } }
        function updateProductionCustomValue(entryId, paramId, value) { const entry = productionLog.find(e => e.id === entryId); if(entry && entry.customValues) { entry.customValues[paramId] = parseFloat(value) || 0; } renderProductionLog(); saveData(); }

        // Malzeme kullanÄ±mÄ± iÃ§in fonksiyonlar
        function renderMaterialUsageForEntry(entryId) {
            const container = document.getElementById(`material-usage-${entryId}`);
            if (!container) return;
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;
            
            const materialUsage = entry.materialUsage || [];
            const materialOptions = materials.map(m => 
                `<option value="${m.id}">${m.name} (Stok: ${m.quantity} ${m.unit})</option>`
            ).join('');
            
            let html = '<div class="space-y-1">';
            
            // Mevcut malzeme kullanÄ±mlarÄ±nÄ± gÃ¶ster
            materialUsage.forEach((usage, index) => {
                const material = materials.find(m => m.id === usage.materialId);
                if (material) {
                    html += `
                        <div class="flex items-center space-x-1 text-xs">
                            <span>${material.name}:</span>
                            <input type="number" step="0.01" value="${usage.quantity}" 
                                   onchange="updateMaterialUsage('${entryId}', ${index}, 'quantity', this.value)" 
                                   class="w-16 text-xs">
                            <span>${material.unit}</span>
                            <button onclick="removeMaterialUsage('${entryId}', ${index})" 
                                    class="bg-red-500 text-white px-1 py-0.5 text-xs rounded">Ã—</button>
                        </div>
                    `;
                }
            });
            
            // Yeni malzeme ekleme
            html += `
                <div class="flex items-center space-x-1 text-xs">
                    <select onchange="addMaterialUsage('${entryId}', this.value)" class="text-xs">
                        <option value="">Malzeme SeÃ§</option>
                        ${materialOptions}
                    </select>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function addMaterialUsage(entryId, materialId) {
            if (!materialId) return;
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;
            
            if (!entry.materialUsage) {
                entry.materialUsage = [];
            }
            
            // Zaten eklenmiÅŸ mi kontrol et
            if (entry.materialUsage.find(u => u.materialId === materialId)) {
                return;
            }
            
            entry.materialUsage.push({
                materialId: materialId,
                quantity: 0
            });
            
            renderProductionLog();
            saveData();
        }

        function updateMaterialUsage(entryId, index, field, value) {
            console.log('updateMaterialUsage Ã§aÄŸrÄ±ldÄ±:', entryId, index, field, value);
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry || !entry.materialUsage) {
                console.error('Entry veya materialUsage bulunamadÄ±:', entryId);
                return;
            }
            
            if (entry.materialUsage[index]) {
                const oldQuantity = entry.materialUsage[index].quantity;
                const newQuantity = parseFloat(value) || 0;
                
                console.log('Malzeme kullanÄ±mÄ± gÃ¼ncelleniyor:');
                console.log('- Entry ID:', entryId);
                console.log('- Index:', index);
                console.log('- Old Quantity:', oldQuantity);
                console.log('- New Quantity:', newQuantity);
                console.log('- Entry Quantity:', entry.quantity);
                
                // Eski miktarÄ± geri yÃ¼kle, yeni miktarÄ± Ã§Ä±kar
                // Malzeme kullanÄ±mÄ± = birim miktar * Ã¼retim adedi
                const totalOldQuantity = oldQuantity * entry.quantity;
                const totalNewQuantity = newQuantity * entry.quantity;
                
                console.log('- Total Old Quantity:', totalOldQuantity);
                console.log('- Total New Quantity:', totalNewQuantity);
                console.log('- Quantity Change:', totalOldQuantity - totalNewQuantity);
                
                // Malzeme bilgisini al
                const material = materials.find(m => m.id === entry.materialUsage[index].materialId);
                const materialName = material ? material.name : 'Bilinmeyen Malzeme';
                
                console.log('- Material ID:', entry.materialUsage[index].materialId);
                console.log('- Material Name:', materialName);
                
                updateMaterialStock(entry.materialUsage[index].materialId, totalOldQuantity - totalNewQuantity);
                
                entry.materialUsage[index][field] = newQuantity;
                
                console.log(`Malzeme kullanÄ±mÄ± gÃ¼ncellendi: ${materialName} - ${oldQuantity} -> ${newQuantity} (${entry.quantity} adet iÃ§in toplam: ${totalNewQuantity})`);
                
                // KullanÄ±cÄ±ya bildirim gÃ¶ster
                if (totalNewQuantity > 0) {
                    showNotification(`ğŸ“¦ ${materialName}: ${totalNewQuantity} adet stoktan dÃ¼ÅŸÃ¼ldÃ¼`, 'info', 3000);
                } else if (totalOldQuantity > 0) {
                    showNotification(`ğŸ“¦ ${materialName}: ${totalOldQuantity} adet stok geri yÃ¼klendi`, 'success', 3000);
                }
                
                renderProductionLog();
                renderMaterials(); // Malzeme listesini gÃ¼ncelle
                saveData();
            }
        }

        function removeMaterialUsage(entryId, index) {
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry || !entry.materialUsage) return;
            
            const usage = entry.materialUsage[index];
            if (usage) {
                // Malzeme bilgisini al
                const material = materials.find(m => m.id === usage.materialId);
                const materialName = material ? material.name : 'Bilinmeyen Malzeme';
                
                // Malzeme stoÄŸunu geri yÃ¼kle (toplam miktar = birim miktar * Ã¼retim adedi)
                const totalQuantity = usage.quantity * entry.quantity;
                updateMaterialStock(usage.materialId, totalQuantity);
                console.log(`Malzeme stok geri yÃ¼klendi: ${usage.quantity} * ${entry.quantity} = ${totalQuantity}`);
                
                // KullanÄ±cÄ±ya bildirim gÃ¶ster
                if (totalQuantity > 0) {
                    showNotification(`ğŸ“¦ ${materialName}: ${totalQuantity} adet stok geri yÃ¼klendi`, 'success', 3000);
                }
            }
            
            entry.materialUsage.splice(index, 1);
            renderProductionLog();
            renderMaterials(); // Malzeme listesini gÃ¼ncelle
            saveData();
        }

        function updateMaterialStock(materialId, quantityChange) {
            const material = materials.find(m => m.id === materialId);
            if (material) {
                const oldQuantity = material.quantity;
                material.quantity = Math.max(0, material.quantity + quantityChange);
                const newQuantity = material.quantity;
                
                console.log(`Malzeme stok gÃ¼ncellendi: ${material.name} - ${oldQuantity} -> ${newQuantity} (deÄŸiÅŸim: ${quantityChange})`);
                
                // Malzemeler sekmesini gÃ¼ncelle
                renderMaterials();
                
                // Veriyi kaydet
                saveData();
            } else {
                console.error('Malzeme bulunamadÄ±:', materialId);
            }
        }
        function updateParameter(field, value) { parameters[field] = parseFloat(value) || 0; saveData(); renderProductionLog(); renderDashboard(); }
        function removeElement(button, type, parentId = null) {
            const element = button.closest('.removable'); if (!element) return; const id = element.dataset.id;
            
            // Check for dependencies before deleting
            if (type === 'product') {
                const isInProduction = productionLog.some(p => p.productId === id);
                const isInSales = salesLog.some(s => s.productId === id);
                if (isInProduction || isInSales) {
                    showMessageModal("Silme HatasÄ±", "Bu Ã¼rÃ¼n Ã¼retim veya satÄ±ÅŸ kayÄ±tlarÄ±nda kullanÄ±ldÄ±ÄŸÄ± iÃ§in silinemez. Ã–nce ilgili kayÄ±tlarÄ± silmelisiniz.");
                    return;
                }
            }
             if (type === 'rawMaterial') {
                const isInUse = productionLog.some(p => p.filamentOverrideId === id) || products.some(prod => prod.extraMaterials?.some(em => em.rawMaterialId === id));
                if (isInUse) {
                    showMessageModal("Silme HatasÄ±", "Bu hammadde Ã¼retim kayÄ±tlarÄ±nda veya Ã¼rÃ¼n reÃ§etelerinde kullanÄ±ldÄ±ÄŸÄ± iÃ§in silinemez.");
                    return;
                }
            }


            const actions = {
                supplier: () => { suppliers = suppliers.filter(s => s.id !== id); renderSuppliers(); },
                supplierMaterial: () => { const s = suppliers.find(s => s.id === parentId); if(s) s.materials = s.materials.filter(m => m.id !== id); renderSuppliers(); },
                customer: () => { customers = customers.filter(c => c.id !== id); renderCustomers(); },
                rawMaterial: () => { rawMaterials = rawMaterials.filter(m => m.id !== id); renderRawMaterials(); },
                product: () => { products = products.filter(p => p.id !== id); renderProducts(); },
                productVariant: () => { const p = products.find(p => p.id === parentId); if(p) p.variants = p.variants.filter(v => v.id !== id); renderProducts(); },
                productExtraMaterial: () => { const p = products.find(p => p.id === parentId); if(p) p.extraMaterials = p.extraMaterials.filter(m => m.id !== id); renderProducts(); },
                productionLog: () => { 
                    const entry = productionLog.find(p => p.id === id);
                    if (entry && entry.materialUsage) {
                        // Malzeme stoÄŸunu geri yÃ¼kle (toplam miktar = birim miktar * Ã¼retim adedi)
                        entry.materialUsage.forEach(usage => {
                            const totalQuantity = usage.quantity * entry.quantity;
                            updateMaterialStock(usage.materialId, totalQuantity);
                            console.log(`Ãœretim kaydÄ± silindi, malzeme stok geri yÃ¼klendi: ${usage.quantity} * ${entry.quantity} = ${totalQuantity}`);
                        });
                    }
                    productionLog = productionLog.filter(p => p.id !== id); 
                    renderProductionLog(); 
                    renderMaterials(); // Malzeme listesini gÃ¼ncelle
                },
                sale: () => { 
                    const sale = salesLog.find(s => s.id === id);
                    if (sale) {
                        // Hesap hareketini sil
                        if (sale.paymentAccountId && sale.paymentMethod !== 'cariye') {
                            const account = accounts.find(a => a.id === sale.paymentAccountId);
                            if (account && account.transactions) {
                                // SatÄ±ÅŸ ile ilgili transaction'Ä± bul ve sil
                                const transactionIndex = account.transactions.findIndex(tx => 
                                    tx.type === 'SatÄ±ÅŸ Geliri' && 
                                    tx.date === sale.date && 
                                    tx.amount === sale.totalAmount
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    console.log('SatÄ±ÅŸ hareketi hesaptan silindi');
                                }
                            }
                        }
                        
                        // Cariye satÄ±ÅŸsa mÃ¼ÅŸteri bakiyesini geri al
                        if (sale.paymentMethod === 'cariye' && sale.customerId) {
                            const customer = customers.find(c => c.id === sale.customerId);
                            if (customer) {
                                customer.balance += sale.totalAmount;
                                console.log('MÃ¼ÅŸteri bakiyesi gÃ¼ncellendi');
                            }
                        }
                    }
                    
                    salesLog = salesLog.filter(s => s.id !== id); 
                    renderSalesLog(); 
                    renderCustomers();
                    renderCashFlow();
                },
                failedPrint: () => { failedPrints = failedPrints.filter(f => f.id !== id); renderFailedPrints(); },
                account: () => { accounts = accounts.filter(a => a.id !== id); renderCashFlow(); },
                customParameter: () => { customParameters = customParameters.filter(p => p.id !== id); renderParameters(); },
                material: () => { 
                    const material = materials.find(m => m.id === id);
                    if (material) {
                        // Ä°lgili gideri sil
                        expenses = expenses.filter(e => !(e.category === 'Malzeme' && e.description.includes(material.name)));
                        
                        // Ä°lgili kasa hareketini sil
                        payments = payments.filter(p => !(p.type === 'Malzeme' && p.notes.includes(material.name)));
                    }
                    materials = materials.filter(m => m.id !== id); 
                    renderMaterials(); 
                    renderExpenses(); 
                    renderCashFlow(); 
                }
            };

            if(actions[type]) {
                actions[type]();
                saveData(true, true); // Sessiz ama zorla kaydet - Firebase'e gÃ¶nder
            }
        }
        function openAddMaterialFromSupplierModal() { const supplierSelect = document.getElementById('supplierSelect'); supplierSelect.innerHTML = '<option value="">TedarikÃ§i SeÃ§in</option>' + (suppliers || []).map(s => `<option value="${s.id}">${s.name}</option>`).join(''); document.getElementById('materialSelect').innerHTML = ''; document.getElementById('initialStock').value = 1; showModal('addMaterialModal'); }
        function populateSupplierMaterials(supplierId) { const materialSelect = document.getElementById('materialSelect'); const supplier = suppliers.find(s => s.id === supplierId); materialSelect.innerHTML = '<option value="">Malzeme SeÃ§in</option>'; if (supplier) materialSelect.innerHTML += (supplier.materials || []).map(m => `<option value="${m.id}">${m.name} - ${m.brand} (${m.color})</option>`).join(''); }
        function addRawMaterialFromSupplier() {
            const supplierId = document.getElementById('supplierSelect').value;
            const materialId = document.getElementById('materialSelect').value;
            const initialStock = parseFloat(document.getElementById('initialStock').value) || 0;
            const minStock = parseFloat(document.getElementById('minStock').value) || 0;
            const paymentAccountId = document.getElementById('addMaterialPaymentAccountId').value;
            const supplier = suppliers.find(s => s.id === supplierId);
            const materialTemplate = supplier?.materials.find(m => m.id === materialId);

            if (!materialTemplate || initialStock <= 0 || !paymentAccountId) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli bir ÅŸekilde doldurun.");
                return;
            }

            const cost = initialStock * materialTemplate.price;
            const date = new Date().toISOString().slice(0, 10);
            const newStockEntry = { id: crypto.randomUUID(), date: date, quantity: initialStock, price: materialTemplate.price, paymentAccountId, cost };

            // Check if this material from this supplier already exists in inventory
            let existingMaterial = rawMaterials.find(rm => rm.templateId === materialId && rm.supplierId === supplierId);

            if (existingMaterial) {
                // Update existing material's stock history
                if (!existingMaterial.stockHistory) existingMaterial.stockHistory = [];
                existingMaterial.stockHistory.push(newStockEntry);
            } else {
                // Create a new raw material entry
                rawMaterials.push({
                    id: crypto.randomUUID(),
                    templateId: materialId,
                    supplierId: supplierId,
                    name: materialTemplate.name,
                    brand: materialTemplate.brand,
                    color: materialTemplate.color,
                    type: materialTemplate.type,
                    unit: materialTemplate.unit,
                    minStock: minStock,
                    averageCost: materialTemplate.price, // Initial average cost
                    stockHistory: [newStockEntry]
                });
            }

            // Hesap transaction'Ä± da ekle
            const account = accounts.find(a => a.id === paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: date,
                    type: 'AlÄ±m',
                    description: `${materialTemplate.name} - ${materialTemplate.brand} (${initialStock} ${materialTemplate.unit || 'adet'})`,
                    amount: -cost // Negatif tutar (Ã§Ä±kÄ±ÅŸ)
                });
            }

            renderAllTabsAndModals();
            closeModal('addMaterialModal');
            saveData();
        }
        function openUpdateStockModal(materialId) { document.getElementById('updateStockMaterialId').value = materialId; document.getElementById('replenishDate').value = new Date().toISOString().slice(0, 10); document.getElementById('addedStock').value = ''; document.getElementById('newPrice').value = ''; showModal('updateStockModal'); }
        function handleStockUpdate() { 
            const materialId = document.getElementById('updateStockMaterialId').value; 
            const addedStock = parseFloat(document.getElementById('addedStock').value); 
            const newPrice = parseFloat(document.getElementById('newPrice').value); 
            const date = document.getElementById('replenishDate').value; 
            const paymentAccountId = document.getElementById('paymentAccountId').value; 
            
            const material = rawMaterials.find(m => m.id === materialId); 
            if (!material || isNaN(addedStock) || addedStock <= 0 || isNaN(newPrice) || newPrice < 0 || !paymentAccountId) { 
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli bir ÅŸekilde doldurun."); 
                return; 
            } 
            
            const cost = addedStock * newPrice; 
            if(!material.stockHistory) material.stockHistory = []; 
            material.stockHistory.push({ id: crypto.randomUUID(), date, quantity: addedStock, price: newPrice, paymentAccountId, cost }); 
            
            // Hesap transaction'Ä± da ekle
            const account = accounts.find(a => a.id === paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: date,
                    type: 'AlÄ±m',
                    description: `${material.name} (${addedStock} ${material.unit || 'adet'})`,
                    amount: -cost // Negatif tutar (Ã§Ä±kÄ±ÅŸ)
                });
            }
            
            const totalStock = material.stockHistory.reduce((sum, item) => sum + item.quantity, 0); 
            const totalCost = material.stockHistory.reduce((sum, item) => sum + (item.quantity * item.price), 0); 
            material.averageCost = totalStock > 0 ? totalCost / totalStock : 0; 
            renderAllTabsAndModals(); 
            closeModal('updateStockModal'); 
            saveData(); 
        }
        function openSaleModal() { 
            document.getElementById('saleForm').reset(); 
            document.getElementById('saleForm').saleProductSelect.innerHTML = '<option value="">ÃœrÃ¼n SeÃ§in</option>' + (products || []).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); 
            document.getElementById('saleForm').saleDate.value = new Date().toISOString().slice(0, 10);
            document.getElementById('variantSelectDiv').classList.add('hidden');
            handleSaleChannelChange({value: 'bireysel'}); 
            togglePaymentAccount('nakit'); 
            showModal('addSaleModal'); 
        }

        function openQuickSaleModal() {
            const form = document.getElementById('quickSaleForm');
            if (form) {
                form.reset();
                form.quickSaleDate.value = new Date().toISOString().slice(0, 10);
                document.getElementById('quickCustomerDiv').classList.add('hidden');
                document.getElementById('quickPlatformDiv').classList.add('hidden');
                document.getElementById('quickPaymentAccountDiv').classList.remove('hidden');
            }
            showModal('quickSaleModal');
        }

        function handleQuickSaleChannelChange(select) {
            const channel = select.value;
            const customerDiv = document.getElementById('quickCustomerDiv');
            const platformDiv = document.getElementById('quickPlatformDiv');
            
            customerDiv.classList.add('hidden');
            platformDiv.classList.add('hidden');
            
            if (channel === 'cari') {
                customerDiv.classList.remove('hidden');
                // MÃ¼ÅŸteri listesini doldur
                const customerSelect = document.querySelector('select[name="quickCustomerId"]');
                if (customerSelect) {
                    customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri seÃ§in...</option>' + 
                        customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } else if (channel === 'platform') {
                platformDiv.classList.remove('hidden');
            }
        }

        function toggleQuickPaymentAccount(paymentMethod) {
            const accountDiv = document.getElementById('quickPaymentAccountDiv');
            if (paymentMethod === 'cariye') {
                accountDiv.classList.add('hidden');
            } else {
                accountDiv.classList.remove('hidden');
            }
        }

        function addQuickSale() {
            const form = document.getElementById('quickSaleForm');
            const formData = new FormData(form);
            
            const date = formData.get('quickSaleDate');
            const productName = formData.get('quickProductName');
            const quantity = parseInt(formData.get('quickQuantity')) || 1;
            const gramage = parseFloat(formData.get('quickGramage')) || 0;
            const unitPrice = parseFloat(formData.get('quickUnitPrice')) || 0;
            const vatRate = parseFloat(formData.get('quickVatRate')) || 0;
            const channel = formData.get('quickChannel');
            const paymentMethod = formData.get('quickPaymentMethod');
            const paymentAccountId = formData.get('quickPaymentAccountId');
            const notes = formData.get('quickNotes') || '';
            
            if (!productName || unitPrice <= 0) {
                showMessageModal("Hata", "LÃ¼tfen Ã¼rÃ¼n adÄ± ve fiyat bilgilerini girin.");
                return;
            }
            
            // MÃ¼ÅŸteri/Platform bilgisi
            let customerInfo = 'Bireysel SatÄ±ÅŸ';
            let customerId = null;
            
            if (channel === 'cari') {
                const selectedCustomerId = formData.get('quickCustomerId');
                const newCustomerName = formData.get('quickCustomerName');
                
                let customer = null;
                
                if (selectedCustomerId) {
                    // Mevcut mÃ¼ÅŸteri seÃ§ildi
                    customer = customers.find(c => c.id === selectedCustomerId);
                    customerInfo = customer ? customer.name : 'Bilinmeyen MÃ¼ÅŸteri';
                    customerId = selectedCustomerId;
                } else if (newCustomerName && newCustomerName.trim()) {
                    // Yeni mÃ¼ÅŸteri eklendi
                    customer = {
                        id: crypto.randomUUID(),
                        name: newCustomerName.trim(),
                        balance: 0
                    };
                    customers.push(customer);
                    customerInfo = customer.name;
                    customerId = customer.id;
                } else {
                    showMessageModal("Hata", "LÃ¼tfen mevcut mÃ¼ÅŸteri seÃ§in veya yeni mÃ¼ÅŸteri adÄ± girin.");
                    return;
                }
            } else if (channel === 'platform') {
                const platformName = formData.get('quickPlatformName');
                if (platformName) {
                    customerInfo = `Platform: ${platformName}`;
                }
            }
            
            // Hesaplama
            const subtotal = quantity * unitPrice;
            const vatAmount = vatRate > 0 ? subtotal * (vatRate / 100) : 0;
            const totalAmount = subtotal + vatAmount;
            
            // Debug loglarÄ±
            console.log('ğŸ” HÄ±zlÄ± SatÄ±ÅŸ Hesaplama:');
            console.log('- KDV OranÄ±:', vatRate);
            console.log('- Birim Fiyat:', unitPrice);
            console.log('- Adet:', quantity);
            console.log('- Ara Toplam:', subtotal);
            console.log('- KDV TutarÄ±:', vatAmount);
            console.log('- Toplam Tutar:', totalAmount);
            
            // Maliyet hesaplama (gram baÅŸÄ±na 0.5 TL)
            const totalCost = gramage > 0 ? (gramage * quantity * 0.5) : 0;
            const realizedProfit = totalAmount - totalCost;
            
            // SatÄ±ÅŸ kaydÄ± oluÅŸtur
            const saleEntry = {
                id: crypto.randomUUID(),
                date: date,
                productName: productName + (gramage > 0 ? ` (${gramage}gr)` : ''),
                productId: null, // Sistem dÄ±ÅŸÄ± Ã¼rÃ¼n
                variantId: null,
                quantity: quantity,
                unitPrice: unitPrice,
                vatRate: vatRate,
                totalAmount: totalAmount,
                customerInfo: customerInfo,
                customerId: customerId,
                channel: channel, // Kanal bilgisini ekle
                paymentMethod: paymentMethod,
                paymentAccountId: paymentAccountId,
                totalCost: totalCost,
                realizedProfit: realizedProfit,
                notes: notes,
                isQuickSale: true // HÄ±zlÄ± satÄ±ÅŸ iÅŸareti
            };
            
            salesLog.push(saleEntry);
            
            // Ã–deme iÅŸlemleri - HÄ±zlÄ± satÄ±ÅŸta hesap transaction'Ä± ekleme, sadece cariye iÃ§in mÃ¼ÅŸteri bakiyesi gÃ¼ncelle
            if (paymentMethod === 'cariye' && customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.balance -= totalAmount;
                }
            }
            
            saveData();
            renderSalesLog();
            renderCustomers();
            renderCashFlow();
            closeModal('quickSaleModal');
            
            showNotification(`âš¡ HÄ±zlÄ± satÄ±ÅŸ baÅŸarÄ±yla kaydedildi! Toplam: ${totalAmount.toFixed(2)} TL`, 'success', 3000);
        }
        function addSale() { 
            const form = document.getElementById('saleForm'); 
            const variantId = form.saleVariantSelect?.value || null;
            const averageUnitCost = getAverageUnitCostForProduct(form.saleProductSelect.value, variantId); 
            const newSale = { 
                id: crypto.randomUUID(), 
                date: form.saleDate.value, 
                productId: form.saleProductSelect.value, 
                variantId: variantId, // Varyant ID'sini kaydet
                quantity: parseFloat(form.saleQuantity.value), 
                unitPrice: parseFloat(form.saleUnitPrice.value), 
                vatRate: parseFloat(form.saleVatRate.value), 
                channel: form.saleChannel.value, 
                paymentMethod: form.salePaymentMethod.value, 
                customerId: form.saleCustomerSelect.dataset.selectedValue || form.saleCustomerSelect.value, 
                platformName: form.salePlatformName.value, 
                paymentAccountId: form.paymentAccountId.value, 
                totalAmount: 0, 
                realizedProfit: 0 
            }; 
            if (newSale.paymentMethod === 'cariye') {
                newSale.paymentAccountId = null; // Cariye satÄ±ÅŸta kasaya para girmez.
            }
            if (!newSale.productId || !newSale.quantity || isNaN(newSale.unitPrice)) { showMessageModal("Hata", "LÃ¼tfen Ã¼rÃ¼n, adet ve fiyat bilgilerini girin."); return; } 
            if(newSale.paymentMethod !== 'cariye' && !newSale.paymentAccountId){ showMessageModal("Hata", "LÃ¼tfen Ã¶demenin alÄ±ndÄ±ÄŸÄ± hesabÄ± seÃ§in."); return; } 
            newSale.realizedProfit = (newSale.unitPrice - averageUnitCost) * newSale.quantity; 
            newSale.totalAmount = newSale.quantity * newSale.unitPrice * (1 + newSale.vatRate / 100); 
            salesLog.push(newSale); 
            renderAllTabsAndModals(); 
            closeModal('addSaleModal'); 
            saveData(true, true); // Zorla Firebase'e gÃ¶nder
        }
        function togglePaymentAccount(method) { const div = document.getElementById('paymentAccountDiv'); if(method === 'cariye') { div.classList.add('hidden'); } else { div.classList.remove('hidden'); } }
        function handleSaleChannelChange(select) { 
            const customerDiv = document.getElementById('customerSelectDiv'); 
            const platformDiv = document.getElementById('platformInputDiv'); 
            customerDiv.classList.add('hidden'); 
            platformDiv.classList.add('hidden'); 
            
            if (select.value === 'cari') { 
                customerDiv.classList.remove('hidden'); 
                // Otomatik tamamlama iÃ§in mÃ¼ÅŸteri input'u hazÄ±rla
                const customerInput = customerDiv.querySelector('input');
                if (customerInput && !customerInput.dataset.autocompleteInitialized) {
                    createAutocomplete(customerInput, customers || [], 'name', 'id');
                    customerInput.dataset.autocompleteInitialized = 'true';
                }
            } else if (select.value === 'platform') { 
                platformDiv.classList.remove('hidden'); 
            } 
        }

        // BaskÄ± hatalarÄ± fonksiyonlarÄ±
        function openAddFailedPrintModal() {
            showModal('addFailedPrintModal');
            // BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="failedPrintDate"]').value = today;
        }

        function handleProductChangeInFailedPrint(productId) {
            const product = products.find(p => p.id === productId);
            const variantDiv = document.getElementById('failedPrintVariantSelectDiv');
            const variantSelect = document.querySelector('[name="failedPrintVariantSelect"]');
            
            if (product && product.variants && product.variants.length > 0) {
                variantDiv.classList.remove('hidden');
                variantSelect.innerHTML = '<option value="">Varyant SeÃ§in</option>' + 
                    product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            } else {
                variantDiv.classList.add('hidden');
                variantSelect.innerHTML = '<option value="">Varyant SeÃ§in</option>';
            }
            calculateFailedPrintCost();
        }

        function calculateFailedPrintCost() {
            const form = document.getElementById('failedPrintForm');
            const productId = form.failedPrintProductSelect.value;
            const variantId = form.failedPrintVariantSelect.value;
            const quantity = parseFloat(form.failedPrintQuantity.value) || 0;
            
            if (!productId || !quantity) {
                document.getElementById('failedPrintCostInfo').classList.add('hidden');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product) return;
            
            let materialCost = 0;
            let materialLoss = '';
            
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentCost = filament ? (filament.averageCost || 0) : 0;
                    const colorCost = (colorGram / 1000) * filamentCost; // gram'Ä± kg'a Ã§evir
                    materialCost += colorCost;
                    materialLoss += `${color.name}: ${colorGram.toFixed(2)} gr (${filament?.brand || 'Bilinmeyen'})<br>`;
                });
            }
            
            // Toplam maliyet = hammadde maliyeti + iÅŸÃ§ilik + elektrik + amortisman
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const totalCost = averageUnitCost * quantity;
            
            document.getElementById('materialLossDisplay').innerHTML = materialCost.toFixed(2) + ' TL';
            document.getElementById('totalFailedCostDisplay').textContent = totalCost.toFixed(2) + ' TL';
            document.getElementById('failedPrintCostInfo').classList.remove('hidden');
        }

        function addFailedPrint() {
            const form = document.getElementById('failedPrintForm');
            const productId = form.failedPrintProductSelect.value;
            const variantId = form.failedPrintVariantSelect.value;
            const quantity = parseFloat(form.failedPrintQuantity.value);
            const reason = form.failedPrintReason.value;
            const description = form.failedPrintDescription.value;
            
            if (!productId || !quantity) {
                showMessageModal("Hata", "LÃ¼tfen Ã¼rÃ¼n ve adet bilgilerini girin.");
                return;
            }
            
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product) {
                showMessageModal("Hata", "ÃœrÃ¼n bulunamadÄ±.");
                return;
            }
            
            // GerÃ§ek stok kontrolÃ¼ - calculateAllStocks kullanarak
            const stockData = calculateAllStocks();
            const productStockData = stockData.productStock.find(p => p.id === productId);
            
            if (!productStockData) {
                showMessageModal("Hata", "ÃœrÃ¼n stok bilgisi bulunamadÄ±.");
                return;
            }
            
            let currentStock = 0;
            if (variant) {
                const variantStockData = productStockData.variants.find(v => v.id === variantId);
                if (!variantStockData) {
                    showMessageModal("Hata", "Varyant stok bilgisi bulunamadÄ±.");
                    return;
                }
                currentStock = variantStockData.stock;
            } else {
                currentStock = productStockData.stock;
            }
            
            if (currentStock < quantity) {
                showMessageModal("Hata", `Yeterli stok yok. Mevcut stok: ${currentStock} adet`);
                return;
            }
            
            console.log(`Stok kontrolÃ¼: Mevcut stok ${currentStock}, istenen miktar ${quantity}`);
            
            // BaskÄ± hatasÄ± kaydÄ± oluÅŸtur
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const newFailedPrint = {
                id: crypto.randomUUID(),
                date: form.failedPrintDate.value,
                productId: productId,
                variantId: variantId,
                quantity: quantity,
                reason: reason,
                description: description,
                totalCost: averageUnitCost * quantity
            };
            
            // Stoktan dÃ¼ÅŸ - GerÃ§ek stok deÄŸerlerini kullan
            console.log(`Stok gÃ¼ncelleme: Mevcut stok ${currentStock}, dÃ¼ÅŸÃ¼lecek miktar ${quantity}`);
            
            // Not: Stok gÃ¼ncellemesi artÄ±k calculateAllStocks fonksiyonu tarafÄ±ndan otomatik yapÄ±lÄ±yor
            // failedPrints array'ine eklenen kayÄ±t otomatik olarak stok hesaplamasÄ±nÄ± etkileyecek
            
            // Hammadde stoklarÄ±nÄ± gÃ¼ncelle
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    if (filament) {
                        const oldStock = filament.currentStock || 0;
                        const stockChange = colorGram / 1000; // gram'Ä± kg'a Ã§evir
                        filament.currentStock = Math.max(0, (filament.currentStock || 0) - stockChange);
                        console.log(`Hammadde stok gÃ¼ncellendi: ${filament.brand} ${filament.color} - ${oldStock} -> ${filament.currentStock} (${stockChange} kg dÃ¼ÅŸÃ¼ldÃ¼)`);
                    }
                });
            }
            
            failedPrints.push(newFailedPrint);
            
            // Ä°lgili sekmeleri gÃ¼ncelle
            renderFailedPrints();
            renderStockStatus();
            renderProducts();
            
            closeModal('addFailedPrintModal');
            saveData(true, true);
            
            showMessageModal("BaÅŸarÄ±lÄ±", `${quantity} adet ${product.name}${variant ? ' - ' + variant.name : ''} stoktan dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ ve baskÄ± hatasÄ± kaydÄ± oluÅŸturuldu.`);
        }
        function handleProductChangeInSale(productId) {
            const variantSelectDiv = document.getElementById('variantSelectDiv');
            const variantSelect = document.querySelector('[name=saleVariantSelect]');
            
            if (!productId) {
                variantSelectDiv.classList.add('hidden');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.variants || product.variants.length === 0) {
                variantSelectDiv.classList.add('hidden');
                return;
            }
            
            // AnahtarlÄ±k gibi tek tek satÄ±lan Ã¼rÃ¼nler iÃ§in varyant seÃ§imi gÃ¶ster
            // Oyun gibi toplam satÄ±lan Ã¼rÃ¼nler iÃ§in gizle
            const isVariantBasedSale = product.name.toLowerCase().includes('anahtarlÄ±k') || 
                                      product.name.toLowerCase().includes('anahtar');
            
            if (isVariantBasedSale) {
                variantSelectDiv.classList.remove('hidden');
                variantSelect.innerHTML = '<option value="">Varyant SeÃ§in</option>' + 
                    product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                variantSelect.required = true;
            } else {
                variantSelectDiv.classList.add('hidden');
                variantSelect.required = false;
                variantSelect.value = '';
            }
        }
        
        function updateSalePrice(productId) { 
            if (!productId) return; 
            
            const variantId = document.querySelector('[name=saleVariantSelect]')?.value;
            let averageUnitCost;
            
            if (variantId) {
                // Varyant bazlÄ± satÄ±ÅŸ - sadece o varyantÄ±n maliyetini hesapla
                averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            } else {
                // ÃœrÃ¼n bazlÄ± satÄ±ÅŸ - tÃ¼m Ã¼rÃ¼nÃ¼n ortalama maliyetini hesapla
                averageUnitCost = getAverageUnitCostForProduct(productId);
            }
            
            const recommendedPrice = averageUnitCost * (1 + (parameters.profitMargin || 0) / 100); 
            document.getElementById('saleForm').saleUnitPrice.value = recommendedPrice.toFixed(2); 
            
            // Maliyet bilgisini gÃ¼ncelle
            updateSaleCostAndProfit();
        }
        
        function updateSaleCostAndProfit() {
            const form = document.getElementById('saleForm');
            if (!form) return;
            
            const productId = form.saleProductSelect.value;
            const variantId = form.saleVariantSelect?.value || null;
            const quantity = parseFloat(form.saleQuantity.value) || 0;
            const unitPrice = parseFloat(form.saleUnitPrice.value) || 0;
            const vatRate = parseFloat(form.saleVatRate.value) || 0;
            
            if (!productId) {
                document.getElementById('saleCostInfo').classList.add('hidden');
                return;
            }
            
            // Maliyet hesapla
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const totalCost = averageUnitCost * quantity;
            const totalAmount = quantity * unitPrice * (1 + vatRate / 100);
            const profit = totalAmount - totalCost;
            
            // Debug iÃ§in console'a yazdÄ±r
            console.log('SatÄ±ÅŸ Maliyet Hesaplama:', {
                productId,
                variantId,
                averageUnitCost,
                quantity,
                totalCost,
                unitPrice,
                totalAmount,
                profit
            });
            
            // GÃ¶rÃ¼ntÃ¼le
            document.getElementById('unitCostDisplay').textContent = averageUnitCost.toFixed(2) + ' TL';
            document.getElementById('totalCostDisplay').textContent = totalCost.toFixed(2) + ' TL';
            document.getElementById('profitDisplay').textContent = profit.toFixed(2) + ' TL';
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2) + ' TL';
            
            // Bilgi panelini gÃ¶ster
            document.getElementById('saleCostInfo').classList.remove('hidden');
        }

        // --- CALCULATION HELPERS ---
        function calculateProductTotals(productOrProductId) { 
            const p = typeof productOrProductId === 'string' ? products.find(pr => pr.id === productOrProductId) : productOrProductId; 
            if (!p || !p.variants) return { totalPrintTime: 0, totalFilamentUsage: 0 }; 
            
            return p.variants.reduce((t, v) => { 
                t.totalPrintTime += parseFloat(v.printTime) || 0; 
                
                // Yeni renk sistemi iÃ§in filament kullanÄ±mÄ±nÄ± hesapla
                if (v.colors && v.colors.length > 0) {
                    v.colors.forEach(color => {
                        t.totalFilamentUsage += parseFloat(color.gram) || 0;
                    });
                } else {
                    // Eski sistem iÃ§in fallback
                    t.totalFilamentUsage += parseFloat(v.filamentUsage) || 0;
                }
                
                return t; 
            }, { totalPrintTime: 0, totalFilamentUsage: 0 }); 
        }
        
        function calculateAccountSummary(accountId = null) {
            if (accountId) {
                const acc = accounts.find(a => a.id === accountId);
                if (!acc) return { currentBalance: 0 };
                let currentBalance = acc.initialBalance || 0;
                // Sadece kasaya giren satÄ±ÅŸlarÄ± ekle (Cari hariÃ§)
                salesLog.forEach(sale => { if (sale.paymentAccountId === accountId && sale.paymentMethod !== 'cariye') currentBalance += sale.totalAmount; });
                // Payments'tan iÅŸlemleri ekle/dÃ¼ÅŸ
                payments.forEach(p => { 
                    if (p.paymentAccountId === accountId) {
                        if (p.type === 'Malzeme') {
                            currentBalance -= p.amount; // Malzeme alÄ±mÄ± hesaptan dÃ¼ÅŸer
                        } else if (p.customerId) {
                            // MÃ¼ÅŸteri tahsilatlarÄ± (eski kayÄ±tlar iÃ§in - yeni kayÄ±tlar transactions'ta)
                            // Ã‡ift saymayÄ± Ã¶nlemek iÃ§in transaction'da olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                            const existsInTransactions = acc.transactions?.some(t => 
                                t.paymentId === p.id || // PaymentId ile kontrol (yeni kayÄ±tlar iÃ§in)
                                (t.type === 'Tahsilat' && Math.abs(t.amount - p.amount) < 0.01 && t.date === p.date) // Tarih/tutar ile kontrol (eski kayÄ±tlar iÃ§in)
                            );
                            if (!existsInTransactions) {
                                currentBalance += p.amount;
                            }
                        }
                    }
                });
                
                // Hesap iÅŸlemlerini de kontrol et (hammadde alÄ±mlarÄ±, gider kayÄ±tlarÄ±, tahsilatlar dahil)
                if (acc.transactions) {
                    acc.transactions.forEach(transaction => {
                        currentBalance += transaction.amount; // Negatif deÄŸerler zaten hesaptan dÃ¼ÅŸer
                    });
                }
                
                return { currentBalance };
            }
            let cashBalance = 0, bankBalance = 0, creditCardDebt = 0;
            accounts.forEach(acc => {
                const { currentBalance } = calculateAccountSummary(acc.id);
                if (acc.type === 'nakit') cashBalance += currentBalance;
                if (acc.type === 'banka') bankBalance += currentBalance;
                if (acc.type === 'kredikarti') creditCardDebt += currentBalance * -1; // BorÃ§ olduÄŸu iÃ§in eksiye Ã§evir
            });
            return { cashBalance, bankBalance, creditCardDebt };
        }

        function calculateTotalReceivables() {
            let totalReceivables = 0;
            customers.forEach(customer => {
                const balance = calculateCustomerBalance(customer.id);
                 if (balance < 0) { // Sadece alacaklarÄ± topla
                    totalReceivables += Math.abs(balance);
                }
            });
            return totalReceivables;
        }

        function calculateCustomerBalance(customerId) {
            const totalSales = salesLog.filter(s => s.customerId === customerId && s.paymentMethod === 'cariye').reduce((sum, s) => sum + s.totalAmount, 0);
            const totalPayments = payments.filter(p => p.customerId === customerId).reduce((sum, p) => sum + p.amount, 0);
            return totalPayments - totalSales;
        }
        function getAverageUnitCostForProduct(productId, variantId = null) { 
            if (variantId) {
                // Varyant bazlÄ± satÄ±ÅŸ - sadece o varyantÄ±n Ã¼retim kayÄ±tlarÄ±nÄ± al
                const relevantProductions = (productionLog || []).filter(p => p.productId === productId && p.variantId === variantId);
                
            if (relevantProductions.length === 0) { 
                    // Ãœretim kaydÄ± yoksa hesaplama yap
                const defaultCustomValues = {}; 
                (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    return calculateProductUnitCost(productId, variantId, 0, defaultCustomValues, ''); 
            } 
                
            const allCosts = calculateAllProductionCosts(); 
            let totalProductionCost = 0; 
            let totalQuantityProduced = 0; 
                
            relevantProductions.forEach(p => { 
                const costs = allCosts[p.id]; 
                if (costs && costs.totalCost) { 
                    totalProductionCost += costs.totalCost; 
                    totalQuantityProduced += p.quantity; 
                } 
            }); 
                
            if (totalQuantityProduced === 0) { 
                    // Ãœretim var ama maliyet hesaplanamÄ±yor
                const defaultCustomValues = {}; 
                (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    return calculateProductUnitCost(productId, variantId, 0, defaultCustomValues, ''); 
            } 
                
            return totalProductionCost / totalQuantityProduced; 
            } else {
                // ÃœrÃ¼n bazlÄ± satÄ±ÅŸ - tÃ¼m varyantlarÄ±n maliyetini topla
                const product = products.find(p => p.id === productId);
                if (!product || !product.variants || product.variants.length === 0) {
                    return 0;
                }
                
                // TÃ¼m varyantlarÄ±n maliyetini topla
                let totalProductCost = 0;
                product.variants.forEach(variant => {
                    // Her varyant iÃ§in maliyet hesapla
                    const defaultCustomValues = {}; 
                    (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    const variantCost = calculateProductUnitCost(productId, variant.id, 0, defaultCustomValues, '');
                    totalProductCost += variantCost;
                });
                
                return totalProductCost;
            }
        }
        function getCalculatedRawMaterialStocks() { 
            const rawMaterialConsumption = {}; 
            (productionLog || []).forEach(entry => { 
                const product = products.find(p => p.id === entry.productId);
                if (!product) return;
                
                const variant = product.variants.find(v => v.id === entry.variantId);
                if (!variant) return;

                // Yeni renk sistemi - tÃ¼m renklerden hammadde dÃ¼ÅŸ
                if (variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        if (color.filamentId && color.gram > 0) {
                            const consumedQuantity = (color.gram || 0) * entry.quantity;
                            rawMaterialConsumption[color.filamentId] = (rawMaterialConsumption[color.filamentId] || 0) + consumedQuantity;
                        }
                    });
                } else {
                    // Eski sistem iÃ§in fallback
                const filamentUsage = variant.filamentUsage || 0;
                const filamentIdToConsume = entry.filamentOverrideId;
                if(filamentIdToConsume && filamentUsage > 0){
                    rawMaterialConsumption[filamentIdToConsume] = (rawMaterialConsumption[filamentIdToConsume] || 0) + (filamentUsage * entry.quantity);
                    }
                }
                (product.extraMaterials || []).forEach(mat => {
                    const consumedQuantity = mat.quantity * entry.quantity;
                    rawMaterialConsumption[mat.rawMaterialId] = (rawMaterialConsumption[mat.rawMaterialId] || 0) + consumedQuantity;
                }); 
            }); 
            return (rawMaterials || []).map(rm => { const consumed = rawMaterialConsumption[rm.id] || 0; const totalPurchased = (rm.stockHistory || []).reduce((sum, item) => sum + item.quantity, 0); return { ...rm, currentStock: totalPurchased - consumed, averageCost: rm.averageCost || 0 }; }); 
        }
        function calculateProductUnitCost(productId, variantId, laborCost, entryCustomValues, filamentOverrideId) { 
            const product = (products || []).find(p => p.id === productId); if (!product) return 0; 
            const variant = product.variants?.find(v => v.id === variantId); if (!variant) return 0;
            const customValues = entryCustomValues || {}; 
            let extraMaterialCost = 0; 
            if(product.extraMaterials) { (product.extraMaterials || []).forEach(mat => { const rawMat = (rawMaterials || []).find(rm => rm.id === mat.rawMaterialId); if (rawMat) extraMaterialCost += mat.quantity * (rawMat.averageCost || 0); }); } 
            
            const printTime = variant.printTime || 0;
            const filamentUsage = variant.filamentUsage || 0;
            
            let filamentCost = 0;
            
            // Yeni renk sistemi iÃ§in filament maliyetini hesapla
            if (variant.colors && variant.colors.length > 0) {
                // Yeni sistem: her rengin filament maliyetini topla
                variant.colors.forEach(color => {
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    if (filament && color.gram > 0) {
                        filamentCost += (color.gram || 0) * (filament.averageCost || 0);
                    }
                });
            } else {
                // Eski sistem iÃ§in fallback
                const filamentId = variant.filamentId || filamentOverrideId;
                const filament = rawMaterials.find(rm => rm.id === filamentId);
            if(filament && filamentUsage > 0){
                filamentCost = filamentUsage * (filament.averageCost || 0); 
            } else if (filamentUsage > 0 && !filament) {
                // Filament seÃ§ilmemiÅŸse maliyet hesaplanamaz.
                return 0; 
                }
            }

            const electricityCost = (parameters.machineKw || 0) * (parameters.electricityKwhPrice || 0) * printTime; 
            const laborCostValue = (laborCost || 0); 
            let baseCost = filamentCost + extraMaterialCost + electricityCost + laborCostValue;
            
            // Amortisman: Ã¼rÃ¼n maliyetine gÃ¶re %5
            const amortizationCost = baseCost * 0.05;
            baseCost += amortizationCost; 
            let totalCustomCost = 0; 
            customParameters.forEach(p => { const value = customValues[p.id] !== undefined ? customValues[p.id] : p.value; const numericValue = parseFloat(value); if(!isNaN(numericValue)) { if(p.type === 'parasal') totalCustomCost += numericValue; else if (p.type === 'saatlik') totalCustomCost += numericValue * printTime; else if (p.type === 'yuzdelik') totalCustomCost += baseCost * (numericValue / 100); } }); 
            baseCost += totalCustomCost; return baseCost * (1 + ((parameters.failedPrintRate || 0) / 100)); 
        }
        function calculateAllProductionCosts() { 
            const costMap = {}; 
            try {
            (productionLog || []).forEach(entry => { 
                    try {
                const product = (products || []).find(p => p.id === entry.productId); 
                        if (!product || !entry.quantity || !entry.variantId) { 
                            costMap[entry.id] = {
                                materialCost: 0,
                                electricityCost: 0,
                                amortizationCost: 0,
                                laborCost: 0,
                                failedPrintCost: 0,
                                customCosts: {},
                                totalCost: 0,
                                unitCost: 0,
                                recommendedUnitPrice: 0
                            }; 
                            return; 
                        } 
                        const variant = product?.variants?.find(v => v.id === entry.variantId);
                        if (!variant) { 
                            costMap[entry.id] = {
                                materialCost: 0,
                                electricityCost: 0,
                                amortizationCost: 0,
                                laborCost: 0,
                                failedPrintCost: 0,
                                customCosts: {},
                                totalCost: 0,
                                unitCost: 0,
                                recommendedUnitPrice: 0
                            }; 
                            return; 
                        }

                const entryLaborCost = entry.laborCost !== undefined ? entry.laborCost : 0; 
                const entryProfitMargin = entry.profitMargin !== undefined ? entry.profitMargin : 0; 
                const printTime = variant.printTime || 0; 
                
                // Malzeme maliyetleri
                let extraMaterialCost = 0; 
                if(product.extraMaterials) { 
                    (product.extraMaterials || []).forEach(mat => { 
                        const rawMat = (rawMaterials || []).find(rm => rm.id === mat.rawMaterialId); 
                        if (rawMat) extraMaterialCost += mat.quantity * (rawMat.averageCost || 0); 
                    }); 
                } 
                
                let filamentCost = 0; 
                
                // TÃ¼m renklerin maliyetini hesapla (birim maliyet olarak)
                if (variant && variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                        if (filament && color.gram > 0) {
                            const colorCostPerUnit = (color.gram || 0) * (filament.averageCost || 0);
                            filamentCost += colorCostPerUnit;
                        }
                    });
                } else {
                    // Eski sistem iÃ§in fallback
                    const filamentId = entry.selectedFilamentId || variant.filamentId || entry.filamentOverrideId;
                    const filament = rawMaterials.find(rm => rm.id === filamentId);
                    const filamentUsage = variant?.filamentUsage || 0;
                if(filament && filamentUsage > 0){ 
                    filamentCost = filamentUsage * (filament.averageCost || 0); 
                    }
                } 
                
                // Malzeme kullanÄ±mÄ±ndan maliyet hesapla (birim maliyet olarak)
                let materialUsageCostPerUnit = 0;
                if (entry.materialUsage && entry.materialUsage.length > 0) {
                    entry.materialUsage.forEach(usage => {
                        const material = materials.find(m => m.id === usage.materialId);
                        if (material) {
                            materialUsageCostPerUnit += usage.quantity * material.unitPrice;
                        }
                    });
                }
                
                const materialCostPerUnit = filamentCost + extraMaterialCost + materialUsageCostPerUnit; 
                
                // DiÄŸer maliyetler
                const electricity = (parameters.machineKw || 0) * (parameters.electricityKwhPrice || 0) * printTime; 
                const labor = (entryLaborCost || 0); 
                
                // Temel maliyet (birim maliyet) - amortisman sonradan eklenecek
                let baseCostPerUnit = materialCostPerUnit + electricity + labor;
                
                // Amortisman: Ã¼rÃ¼n maliyetine gÃ¶re %5
                const amortization = baseCostPerUnit * 0.05;
                baseCostPerUnit += amortization; 
                
                // Ã–zel maliyetler
                const customCostsBreakdown = {}; 
                let totalCustomCostPerUnit = 0; 
                customParameters.forEach(p => { 
                    const value = entry.customValues[p.id] !== undefined ? entry.customValues[p.id] : p.value; 
                    let customCost = 0; 
                    if(p.type === 'parasal') {
                        customCost = value; 
                    } else if (p.type === 'saatlik') {
                        customCost = value * printTime; 
                    } else if (p.type === 'yuzdelik') {
                        customCost = baseCostPerUnit * (value / 100); 
                    } 
                    customCostsBreakdown[p.id] = customCost * entry.quantity; 
                    totalCustomCostPerUnit += customCost; 
                }); 
                
                // Final maliyet hesaplama
                const finalBaseCostPerUnit = baseCostPerUnit + totalCustomCostPerUnit; 
                const failedPrintRate = (parameters.failedPrintRate || 0) / 100;
                const unitCost = finalBaseCostPerUnit * (1 + failedPrintRate); // BaÅŸarÄ±sÄ±z baskÄ± dahil birim maliyet
                const totalCost = unitCost * entry.quantity; 
                const recommendedUnitPrice = unitCost * (1 + (entryProfitMargin || 0) / 100); 
                
                // BaÅŸarÄ±sÄ±z baskÄ± maliyeti ayrÄ± hesapla
                const failedPrintCostPerUnit = finalBaseCostPerUnit * failedPrintRate;
                
                costMap[entry.id] = { 
                    materialCost: materialCostPerUnit * entry.quantity, 
                    electricityCost: electricity * entry.quantity, 
                    amortizationCost: amortization * entry.quantity, 
                    laborCost: labor * entry.quantity, 
                    failedPrintCost: failedPrintCostPerUnit * entry.quantity, 
                    customCosts: customCostsBreakdown, 
                    totalCost, 
                    unitCost, 
                    recommendedUnitPrice 
                }; 
                    } catch (error) {
                        console.error('Hata calculateAllProductionCosts entry:', entry.id, error);
                        costMap[entry.id] = {
                            materialCost: 0,
                            electricityCost: 0,
                            amortizationCost: 0,
                            laborCost: 0,
                            failedPrintCost: 0,
                            customCosts: {},
                            totalCost: 0,
                            unitCost: 0,
                            recommendedUnitPrice: 0
                        };
                    }
                }); 
            } catch (error) {
                console.error('Hata calculateAllProductionCosts:', error);
            }
            return costMap; 
        }
        function calculateAllStocks() { 
            // Varyant bazlÄ± Ã¼retim ve satÄ±ÅŸ hesaplama
            const productionTotals = {}; // productId -> variantId -> quantity
            const salesTotals = {}; // productId -> variantId -> quantity
            const failedPrintTotals = {}; // productId -> variantId -> quantity
            
            // Ãœretim kayÄ±tlarÄ±ndan varyant bazlÄ± stok hesapla
            (productionLog || []).forEach(entry => {
                if (!productionTotals[entry.productId]) productionTotals[entry.productId] = {};
                productionTotals[entry.productId][entry.variantId] = (productionTotals[entry.productId][entry.variantId] || 0) + entry.quantity;
            });
            
            // SatÄ±ÅŸ kayÄ±tlarÄ±ndan varyant bazlÄ± stok hesapla
            (salesLog || []).forEach(sale => {
                if (!salesTotals[sale.productId]) salesTotals[sale.productId] = {};
                
                if (sale.variantId) {
                    // Varyant bazlÄ± satÄ±ÅŸ
                    if (!salesTotals[sale.productId][sale.variantId]) {
                        salesTotals[sale.productId][sale.variantId] = 0;
                    }
                    salesTotals[sale.productId][sale.variantId] += sale.quantity;
                } else {
                    // ÃœrÃ¼n bazlÄ± satÄ±ÅŸ - tÃ¼m varyantlardan adet kadar dÃ¼ÅŸ
                    const product = products.find(p => p.id === sale.productId);
                    if (product && product.variants && product.variants.length > 0) {
                        product.variants.forEach(variant => {
                            if (!salesTotals[sale.productId][variant.id]) {
                                salesTotals[sale.productId][variant.id] = 0;
                            }
                            salesTotals[sale.productId][variant.id] += sale.quantity;
                        });
                    }
                }
            });
            
            // BaskÄ± hatalarÄ±ndan varyant bazlÄ± stok hesapla
            (failedPrints || []).forEach(failedPrint => {
                if (!failedPrintTotals[failedPrint.productId]) failedPrintTotals[failedPrint.productId] = {};
                if (!failedPrintTotals[failedPrint.productId][failedPrint.variantId]) {
                    failedPrintTotals[failedPrint.productId][failedPrint.variantId] = 0;
                }
                failedPrintTotals[failedPrint.productId][failedPrint.variantId] += failedPrint.quantity;
            });
            
            // ÃœrÃ¼n stoklarÄ± - varyant detaylarÄ± ile
            const productStock = (products || []).map(p => {
                const variants = (p.variants || []).map(v => {
                    const produced = productionTotals[p.id] ? (productionTotals[p.id][v.id] || 0) : 0;
                    const sold = salesTotals[p.id] ? (salesTotals[p.id][v.id] || 0) : 0;
                    const failed = failedPrintTotals[p.id] ? (failedPrintTotals[p.id][v.id] || 0) : 0;
                    const stock = Math.max(0, produced - sold - failed);
                    return { ...v, stock, produced, sold, failed };
                });
                
                const totalStock = variants.reduce((sum, v) => sum + v.stock, 0);
                return { ...p, variants, stock: totalStock };
            });
            
            const rawMaterialStock = getCalculatedRawMaterialStocks(); 
            const rawMaterialStockValue = rawMaterialStock.reduce((sum, rm) => { return sum + (rm.currentStock * (rm.averageCost || 0)); }, 0); 
            let productStockValue = 0; 
            productStock.forEach(p => { 
                if(p.stock > 0) { 
                    const avgCost = getAverageUnitCostForProduct(p.id); 
                    productStockValue += p.stock * avgCost; 
                } 
            }); 
            return { productStock, productStockValue, rawMaterialStock, rawMaterialStockValue }; 
        }
        
        function makeTablesResizable() { 
            document.querySelectorAll('.resizable-table').forEach(table => { 
                const headers = table.querySelectorAll('th'); 
                headers.forEach(header => { 
                    if(header.querySelector('.resizer')) return; 
                    const resizer = document.createElement('div'); 
                    resizer.className = 'resizer'; 
                    header.appendChild(resizer); 
                    addResizerEvents(resizer, header); 
                }); 
            }); 
        }

        function addResizerEvents(resizer, header) {
            let x = 0;
            let w = 0;

            const mouseDownHandler = function (e) {
                x = e.clientX;
                const styles = window.getComputedStyle(header);
                w = parseInt(styles.width, 10);
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                resizer.style.backgroundColor = '#cbd5e1';
            };

            const mouseMoveHandler = function (e) {
                const dx = e.clientX - x;
                header.style.width = `${w + dx}px`;
            };

            const mouseUpHandler = function () {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                resizer.style.backgroundColor = '';
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function toggleSupplierDetails(supplierId) {
            const detailsDiv = document.getElementById(`supplier-details-${supplierId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }
        
        function getCustomerSalesHTML(customerId) {
            const customerSales = salesLog.filter(s => s.customerId === customerId);
            if (customerSales.length === 0) return `<p class="text-sm text-gray-500">Bu mÃ¼ÅŸteriye henÃ¼z satÄ±ÅŸ yapÄ±lmamÄ±ÅŸ.</p>`;
            const salesByProduct = customerSales.reduce((acc, sale) => {
                let productName;
                
                if (sale.isQuickSale) {
                    // HÄ±zlÄ± satÄ±ÅŸ - direkt productName kullan
                    productName = sale.productName || 'HÄ±zlÄ± SatÄ±ÅŸ';
                } else {
                    // Normal satÄ±ÅŸ - sistem Ã¼rÃ¼nÃ¼nden al
                    productName = products.find(p => p.id === sale.productId)?.name || 'Bilinmeyen ÃœrÃ¼n';
                }
                
                acc[productName] = (acc[productName] || 0) + sale.quantity;
                return acc;
            }, {});
            let tableHTML = `<table class="w-full text-sm"><thead><tr><th>ÃœrÃ¼n AdÄ±</th><th>Toplam Adet</th></tr></thead><tbody>`;
            for (const [productName, quantity] of Object.entries(salesByProduct)) {
                tableHTML += `<tr><td>${productName}</td><td>${quantity}</td></tr>`;
            }
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        function openAddPaymentModal(customerId) {
            const form = document.getElementById('paymentForm');
            form.reset();
            form.paymentCustomerId.value = customerId;
            form.paymentDate.value = new Date().toISOString().slice(0, 10);
            showModal('addPaymentModal');
        }

        function addPayment() {
            const form = document.getElementById('paymentForm');
            const newPayment = {
                id: crypto.randomUUID(),
                customerId: form.paymentCustomerId.value,
                date: form.paymentDate.value,
                amount: parseFloat(form.paymentAmount.value),
                paymentAccountId: form.paymentAccountId.value,
                notes: form.paymentNotes.value
            };
            if (!newPayment.customerId || !newPayment.amount || !newPayment.paymentAccountId) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.");
                return;
            }
            
            // MÃ¼ÅŸteri bakiyesini gÃ¼ncelle
            const customer = customers.find(c => c.id === newPayment.customerId);
            if (customer) {
                customer.balance += newPayment.amount;
            }
            
            // Hesap hareketi oluÅŸtur
            const account = accounts.find(a => a.id === newPayment.paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: newPayment.date,
                    type: 'Tahsilat',
                    description: `MÃ¼ÅŸteri: ${customer?.name || 'Bilinmeyen'} - ${newPayment.notes || 'Ã–deme'}`,
                    amount: newPayment.amount,
                    paymentId: newPayment.id // Ã‡ift sayÄ±mÄ± Ã¶nlemek iÃ§in
                });
            }
            
            payments.push(newPayment);
            renderCustomers();
            renderCashFlow();
            saveData();
            closeModal('addPaymentModal');
            showNotification(`ğŸ’° ${newPayment.amount.toFixed(2)} TL tahsilat alÄ±ndÄ±`, 'success', 3000);
        }

        // --- HTML HELPER FUNCTIONS ---
        function getExpenseHTML(expense) {
            const account = accounts.find(a => a.id === expense.accountId);
            return `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td class="text-red-600 font-semibold">${expense.amount.toFixed(2)} TL</td>
                    <td>${account ? account.name : 'Bilinmeyen Hesap'}</td>
                    <td>
                        <button onclick="editExpense('${expense.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">DÃ¼zenle</button>
                        <button onclick="deleteExpense('${expense.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                    </td>
                </tr>
            `;
        }

        function getMaterialHTML(material) {
            const totalValue = material.quantity * material.unitPrice;
            return `
                <tr class="removable" data-id="${material.id}">
                    <td>${material.name}</td>
                    <td>${material.category}</td>
                    <td>${material.quantity}</td>
                    <td>${material.unit}</td>
                    <td>${material.unitPrice.toFixed(2)} TL</td>
                    <td class="font-semibold">${totalValue.toFixed(2)} TL</td>
                    <td>
                        <button onclick="editMaterial('${material.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">DÃ¼zenle</button>
                        <button onclick="removeElement(this, 'material')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                    </td>
                </tr>
            `;
        }

        function getAddExpenseModalHTML() {
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">Yeni Gider Ekle</h3>
                    <form id="addExpenseForm" onsubmit="addExpense(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                                <input type="date" id="expenseDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gider TÃ¼rÃ¼</label>
                                <select id="expenseCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Elektrik">Elektrik</option>
                                    <option value="Su">Su</option>
                                    <option value="Ä°nternet">Ä°nternet</option>
                                    <option value="Telefon">Telefon</option>
                                    <option value="Kira">Kira</option>
                                    <option value="YakÄ±t">YakÄ±t</option>
                                    <option value="BakÄ±m">BakÄ±m</option>
                                    <option value="Malzeme">Malzeme</option>
                                    <option value="DiÄŸer">DiÄŸer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tutar (TL)</label>
                                <input type="number" id="expenseAmount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap</label>
                                <select id="expenseAccountId" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">SeÃ§iniz</option>
                                    ${accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-600">*</span> AÃ§Ä±klama 
                                <span class="text-sm text-gray-500 font-normal">(Gider detayÄ± - Ã¶rn: "Elektrik faturasÄ± Ocak 2024")</span>
                            </label>
                            <textarea id="expenseDescription" rows="3" placeholder="Gider aÃ§Ä±klamasÄ±nÄ± buraya yazÄ±n..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-red-500 focus:ring-1 focus:ring-red-500" required></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addExpenseModal')" class="bg-gray-300 px-4 py-2 rounded-md">Ä°ptal</button>
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">Gider Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getAddMaterialItemModalHTML() {
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">Yeni Malzeme Ekle</h3>
                    <form id="addMaterialItemForm" onsubmit="addMaterialItem(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Malzeme AdÄ±</label>
                                <input type="text" id="materialName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                <select id="materialCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Elektronik">Elektronik</option>
                                    <option value="Mekanik">Mekanik</option>
                                    <option value="Yedek ParÃ§a">Yedek ParÃ§a</option>
                                    <option value="Alet">Alet</option>
                                    <option value="Temizlik">Temizlik</option>
                                    <option value="Ofis">Ofis</option>
                                    <option value="DiÄŸer">DiÄŸer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Miktar</label>
                                <input type="number" id="materialQuantity" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim</label>
                                <select id="materialUnit" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="adet">Adet</option>
                                    <option value="kg">Kilogram</option>
                                    <option value="gram">Gram</option>
                                    <option value="metre">Metre</option>
                                    <option value="cm">Santimetre</option>
                                    <option value="litre">Litre</option>
                                    <option value="paket">Paket</option>
                                    <option value="kutu">Kutu</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat (TL)</label>
                                <input type="number" id="materialUnitPrice" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Stok Seviyesi</label>
                                <input type="number" id="materialMinStock" step="0.01" value="0" placeholder="UyarÄ± iÃ§in minimum stok" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap</label>
                                <select id="materialAccountId" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">SeÃ§iniz</option>
                                    ${accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">AÃ§Ä±klama</label>
                            <textarea id="materialDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addMaterialItemModal')" class="bg-gray-300 px-4 py-2 rounded-md">Ä°ptal</button>
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md">Malzeme Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getProductionPlanMobileHTML(plan) {
            const statusColor = plan.status === 'active' ? 'bg-green-100 text-green-800' : 
                               plan.status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                               plan.status === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                               'bg-gray-100 text-gray-800';
            
            // ÃœrÃ¼n bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }
            
            // TÃ¼m varyantlarÄ±n toplam bilgilerini hesapla
            let totalPrintTime = 0;
            let allColors = {};
            let totalFilament = 0;
            
            if (product?.variants && product.variants.length > 0) {
                totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                
                product.variants.forEach(variant => {
                    if (variant.colors && variant.colors.length > 0) {
                        variant.colors.forEach(color => {
                            const key = `${color.name}_${color.filamentId}`;
                            if (!allColors[key]) {
                                allColors[key] = {
                                    name: color.name,
                                    filamentId: color.filamentId,
                                    gram: 0
                                };
                            }
                            allColors[key].gram += color.gram || 0;
                        });
                    }
                });
                
                totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
            }
            
            // Filament detaylarÄ±nÄ± hesapla
            let filamentDetails = '';
            if (Object.keys(allColors).length > 0) {
                const totalOrderFilament = totalFilament * plan.orderQuantity;
                
                filamentDetails = `
                    <div class="text-xs space-y-1">
                        <div class="font-semibold text-gray-800">Toplam: ${totalOrderFilament.toFixed(0)} gr</div>
                        <div class="text-gray-600">
                            ${Object.values(allColors).map(color => {
                                const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                const orderGram = color.gram * plan.orderQuantity;
                                return `<div>${color.name}: ${orderGram.toFixed(0)} gr (${filamentName})</div>`;
                            }).join('')}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            ğŸ“Š ${product.variants.length} varyantÄ±n toplamÄ±
                        </div>
                    </div>
                `;
            } else {
                filamentDetails = '<div class="text-xs text-gray-500">Filament bilgisi yok</div>';
            }
            
            const unitTime = plan.unitTime || totalPrintTime;
            const totalHours = unitTime * plan.orderQuantity;
            const totalDays = totalHours / (plan.machineCount * 24);
            
            return `
                <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">${plan.productName}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${plan.status === 'active' ? 'Aktif' : plan.status === 'completed' ? 'TamamlandÄ±' : plan.status === 'paused' ? 'DuraklatÄ±ldÄ±' : 'Beklemede'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <span class="text-xs text-gray-500">â±ï¸ Birim SÃ¼re</span>
                            <div class="text-sm font-medium">${unitTime.toFixed(2)} saat</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">ğŸ­ Makine SayÄ±sÄ±</span>
                            <div class="text-sm font-medium">${plan.machineCount}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">ğŸ“¦ SipariÅŸ Adedi</span>
                            <div class="text-sm font-medium text-blue-600">${plan.orderQuantity}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">ğŸ“… Toplam GÃ¼n</span>
                            <div class="text-sm font-medium">${totalDays.toFixed(1)}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">ğŸ’° SatÄ±ÅŸ FiyatÄ±</span>
                            <div class="text-sm font-medium text-green-600">${(plan.salePrice || 0).toFixed(2)} â‚º</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">ğŸ’µ Toplam SatÄ±ÅŸ</span>
                            <div class="text-sm font-medium text-emerald-600">${((plan.salePrice || 0) * plan.orderQuantity).toFixed(2)} â‚º</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="text-xs text-gray-500">ğŸ¨ Filament DetaylarÄ±</span>
                        <div class="mt-1">${filamentDetails}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3 text-xs text-gray-600">
                        <div>
                            <span class="text-gray-500">ğŸ“… BaÅŸlangÄ±Ã§:</span>
                            <div>${new Date(plan.startDate).toLocaleDateString('tr-TR')}</div>
                        </div>
                        <div>
                            <span class="text-gray-500">ğŸ BitiÅŸ:</span>
                            <div>${new Date(plan.expectedEndDate).toLocaleDateString('tr-TR')}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${plan.status === 'active' ? `
                            <button onclick="sendToProduction('${plan.id}')" 
                                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                ğŸš€ Ãœretime GÃ¶nder
                            </button>
                        ` : ''}
                        <button onclick="editProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button onclick="deleteProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                            ğŸ—‘ï¸ Sil
                        </button>
                    </div>
                </div>
            `;
        }

        function getProductionPlanHTML(plan) {
            const statusColor = plan.status === 'active' ? 'bg-green-100 text-green-800' : 
                               plan.status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                               plan.status === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                               'bg-gray-100 text-gray-800';
            
            // ÃœrÃ¼n bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            
            // EÄŸer productId ile bulunamazsa productName ile dene
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
                if (product) {
                    console.log('ÃœrÃ¼n ID ile bulunamadÄ±, productName ile bulundu:', product.name);
                }
            }
            
            // TÃ¼m varyantlarÄ±n toplam bilgilerini hesapla
            let totalPrintTime = 0;
            let allColors = {};
            let totalFilament = 0;
            
            if (product?.variants && product.variants.length > 0) {
                // TÃ¼m varyantlarÄ±n printTime'Ä±nÄ± topla
                totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                
                // TÃ¼m varyantlarÄ±n filament bilgilerini birleÅŸtir
                product.variants.forEach(variant => {
                    if (variant.colors && variant.colors.length > 0) {
                        variant.colors.forEach(color => {
                            const key = `${color.name}_${color.filamentId}`;
                            if (!allColors[key]) {
                                allColors[key] = {
                                    name: color.name,
                                    filamentId: color.filamentId,
                                    gram: 0
                                };
                            }
                            allColors[key].gram += color.gram || 0;
                        });
                    }
                });
                
                // Toplam filament miktarÄ±nÄ± hesapla
                totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
            }
            
            // Filament detaylarÄ±nÄ± hesapla
            let filamentDetails = '';
            if (Object.keys(allColors).length > 0) {
                const totalOrderFilament = totalFilament * plan.orderQuantity;
                
                filamentDetails = `
                    <div class="text-xs space-y-1">
                        <div class="font-semibold text-gray-800">Toplam: ${totalOrderFilament.toFixed(0)} gr</div>
                        <div class="text-gray-600">
                            ${Object.values(allColors).map(color => {
                                const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                const orderGram = color.gram * plan.orderQuantity;
                                return `<div>${color.name}: ${orderGram.toFixed(0)} gr (${filamentName})</div>`;
                            }).join('')}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            ğŸ“Š ${product.variants.length} varyantÄ±n toplamÄ±
                        </div>
                    </div>
                `;
            } else {
                filamentDetails = '<div class="text-xs text-gray-500">Filament bilgisi yok</div>';
            }
            
            // Otomatik saat hesaplamasÄ± (eÄŸer plan'da yoksa Ã¼rÃ¼n verilerinden al)
            const unitTime = plan.unitTime || totalPrintTime;
            const totalHours = unitTime * plan.orderQuantity;
            const totalDays = totalHours / (plan.machineCount * 24); // 24 saat Ã§alÄ±ÅŸma varsayÄ±mÄ±
            
            return `
                <tr class="hover:bg-gray-50 transition-colors duration-200 ${plan.status === 'active' ? 'bg-yellow-50' : ''}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${plan.productName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${unitTime.toFixed(2)} saat
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${plan.machineCount} makine
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${plan.dailyCapacity.toFixed(2)} adet/gÃ¼n
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-indigo-100 text-indigo-800">
                            ${plan.orderQuantity} adet
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                            ${totalDays.toFixed(1)} gÃ¼n
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            ${totalHours.toFixed(1)} saat
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${filamentDetails}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${(plan.salePrice || 0).toFixed(2)} â‚º
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                            ${((plan.salePrice || 0) * plan.orderQuantity).toFixed(2)} â‚º
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(plan.startDate).toLocaleDateString('tr-TR')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${new Date(plan.expectedEndDate).toLocaleDateString('tr-TR')}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${plan.contractDate ? new Date(plan.contractDate).toLocaleDateString('tr-TR') : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${plan.status === 'active' ? 'Aktif' : plan.status === 'completed' ? 'TamamlandÄ±' : plan.status === 'paused' ? 'DuraklatÄ±ldÄ±' : 'Beklemede'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${plan.status === 'active' ? `
                            <button onclick="sendToProduction('${plan.id}')" 
                                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 mr-2">
                                ğŸš€ Ãœretime GÃ¶nder
                            </button>
                        ` : ''}
                        <button onclick="editProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors duration-200 mr-2">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button onclick="deleteProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            ğŸ—‘ï¸ Sil
                        </button>
                    </td>
                </tr>
            `;
        }

        function getAddProductionPlanModalHTML() {
            return `
                <div class="modal max-w-4xl">
                    <h3 class="text-xl font-semibold mb-4">Yeni Ãœretim PlanÄ± Ekle</h3>
                    <form id="addProductionPlanForm" onsubmit="addProductionPlan(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÃœrÃ¼n AdÄ±</label>
                                <select id="planProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="loadProductDetails()">
                                    <option value="">ÃœrÃ¼n seÃ§in...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim SÃ¼re (saat)</label>
                                <input type="number" id="planUnitTime" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Makine SayÄ±sÄ±</label>
                                <input type="number" id="planMachineCount" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">GÃ¼nlÃ¼k Kapasite</label>
                                <input type="number" id="planDailyCapacity" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SipariÅŸ Adedi</label>
                                <input type="number" id="planOrderQuantity" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total GÃ¼n</label>
                                <input type="number" id="planTotalDays" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Saat</label>
                                <input type="number" id="planTotalHours" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Durum</label>
                                <select id="planStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="waiting">Beklemede</option>
                                    <option value="active">Aktif</option>
                                    <option value="paused">DuraklatÄ±ldÄ±</option>
                                    <option value="completed">TamamlandÄ±</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">BaÅŸlangÄ±Ã§ Tarihi</label>
                                <input type="date" id="planStartDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Beklenen BitiÅŸ Tarihi</label>
                                <input type="date" id="planExpectedEndDate" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SÃ¶zleÅŸme Tarihi</label>
                                <input type="date" id="planContractDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateContractQuantity()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SÃ¶zleÅŸme Sonu Adet</label>
                                <input type="number" id="planContractQuantity" step="1" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° Beklenen SatÄ±ÅŸ FiyatÄ± (â‚º)</label>
                                <input type="number" id="planSalePrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ Filament DetaylarÄ±</label>
                            <div id="planFilamentDetails" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-sm text-gray-600">
                                Ã–nce Ã¼rÃ¼n seÃ§in
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">AÃ§Ä±klama</label>
                            <textarea id="planDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addProductionPlanModal')" class="bg-gray-300 px-4 py-2 rounded-md">Ä°ptal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Plan Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getEditProductionPlanModalHTML() {
            return `
                <div class="modal max-w-4xl">
                    <h3 class="text-xl font-semibold mb-4">Ãœretim PlanÄ±nÄ± DÃ¼zenle</h3>
                    <form id="editProductionPlanForm" onsubmit="updateProductionPlan(event)">
                        <input type="hidden" id="editPlanId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÃœrÃ¼n AdÄ±</label>
                                <select id="editPlanProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="loadEditProductDetails()">
                                    <option value="">ÃœrÃ¼n seÃ§in...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim SÃ¼re (saat)</label>
                                <input type="number" id="editPlanUnitTime" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Makine SayÄ±sÄ±</label>
                                <input type="number" id="editPlanMachineCount" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">GÃ¼nlÃ¼k Kapasite</label>
                                <input type="number" id="editPlanDailyCapacity" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SipariÅŸ Adedi</label>
                                <input type="number" id="editPlanOrderQuantity" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° Beklenen SatÄ±ÅŸ FiyatÄ± (â‚º)</label>
                                <input type="number" id="editPlanSalePrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total GÃ¼n</label>
                                <input type="number" id="editPlanTotalDays" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Saat</label>
                                <input type="number" id="editPlanTotalHours" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Durum</label>
                                <select id="editPlanStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="waiting">Beklemede</option>
                                    <option value="active">Aktif</option>
                                    <option value="paused">DuraklatÄ±ldÄ±</option>
                                    <option value="completed">TamamlandÄ±</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">BaÅŸlangÄ±Ã§ Tarihi</label>
                                <input type="date" id="editPlanStartDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Beklenen BitiÅŸ Tarihi</label>
                                <input type="date" id="editPlanExpectedEndDate" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SÃ¶zleÅŸme Tarihi</label>
                                <input type="date" id="editPlanContractDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditContractQuantity()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SÃ¶zleÅŸme Sonu Adet</label>
                                <input type="number" id="editPlanContractQuantity" step="1" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">AÃ§Ä±klama</label>
                            <textarea id="editPlanDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('editProductionPlanModal')" class="bg-gray-300 px-4 py-2 rounded-md">Ä°ptal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">PlanÄ± GÃ¼ncelle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function generateDeliveryNote(customerId) {
            const customer = customers.find(c => c.id === customerId);
            const customerSales = salesLog.filter(s => s.customerId === customerId);
            if (!customer) return;
            const printWindow = window.open('', '_blank');
            let content = `
                <html><head><title>Ä°rsaliye - ${customer.name}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style> body { font-family: 'Inter', sans-serif; } </style>
                </head><body><div class="p-8" id="print-area">
                    <div class="flex justify-between items-center mb-8">
                        <div><h1 class="text-2xl font-bold">[Ä°ÅLETME ADINIZ]</h1><p>[Åehir/Adres]</p></div>
                        <div class="text-right"><h2 class="text-xl font-semibold">Ä°RSALÄ°YE</h2><p>Tarih: ${new Date().toLocaleDateString('tr-TR')}</p></div>
                    </div>
                    <div class="mb-8 border p-4 rounded-md">
                        <h3 class="font-semibold">MÃ¼ÅŸteri Bilgileri</h3>
                        <p><strong>Firma:</strong> ${customer.name}</p>
                        <p><strong>Adres:</strong> ${customer.address || ''}</p>
                        <p><strong>Telefon:</strong> ${customer.phone || ''}</p>
                    </div>
                    <table class="w-full text-left">
                        <thead><tr class="bg-gray-100">
                            <th class="p-2">Tarih</th><th class="p-2">ÃœrÃ¼n AdÄ±</th><th class="p-2">Adet</th><th class="p-2">Birim Fiyat</th><th class="p-2">Toplam</th>
                        </tr></thead>
                        <tbody>`;
            let grandTotal = 0;
            customerSales.forEach(sale => {
                let productName;
                
                if (sale.isQuickSale) {
                    // HÄ±zlÄ± satÄ±ÅŸ - direkt productName kullan
                    productName = sale.productName || 'HÄ±zlÄ± SatÄ±ÅŸ';
                } else {
                    // Normal satÄ±ÅŸ - sistem Ã¼rÃ¼nÃ¼nden al
                    const product = products.find(p => p.id === sale.productId);
                    productName = product ? product.name : 'SilinmiÅŸ ÃœrÃ¼n';
                }
                
                const total = sale.quantity * sale.unitPrice;
                grandTotal += sale.totalAmount; // Using totalAmount which includes VAT
                content += `<tr>
                    <td class="p-2 border-b">${new Date(sale.date).toLocaleDateString('tr-TR')}</td>
                    <td class="p-2 border-b">${productName}</td>
                    <td class="p-2 border-b">${sale.quantity}</td>
                    <td class="p-2 border-b">${sale.unitPrice.toFixed(2)} TL</td>
                    <td class="p-2 border-b">${total.toFixed(2)} TL</td>
                </tr>`;
            });
            content += `</tbody><tfoot>
                            <tr><td colspan="4" class="text-right font-bold p-2">Genel Toplam (KDV Dahil):</td><td class="font-bold p-2">${grandTotal.toFixed(2)} TL</td></tr>
                        </tfoot></table>
                    <div class="mt-16 text-center text-sm text-gray-500">Bu irsaliye elektronik olarak oluÅŸturulmuÅŸtur.</div>
                </div></body></html>`;
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function deleteAccountTransaction(accountId, txId, txType) {
            showConfirmModal(
                "Ä°ÅŸlemi Sil",
                "Bu iÅŸlemi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.",
                () => {
                    console.log('Silme iÅŸlemi baÅŸlatÄ±lÄ±yor:', { accountId, txId, txType });
                    
                    const account = accounts.find(a => a.id === accountId);
                    if (!account) {
                        console.error('Hesap bulunamadÄ±:', accountId);
                        return;
                    }
                    
                    // Debug: Mevcut transaction'larÄ± listele
                    console.log('Hesap transaction\'larÄ±:', account.transactions);
                    console.log('Aranan txId:', txId);
                    
                    let deleted = false;
                    
                    // Ä°ÅŸlem tÃ¼rÃ¼ne gÃ¶re sil
                    if (txType === 'Para Ekleme' || txType === 'SatÄ±ÅŸ Geliri') {
                        // Hesap transaction'Ä±ndan sil
                        if (account.transactions) {
                            const originalLength = account.transactions.length;
                            
                            // Ã–nce ID ile ara
                            let foundById = account.transactions.find(t => t.id === txId);
                            if (foundById) {
                                account.transactions = account.transactions.filter(t => t.id !== txId);
                                deleted = true;
                                console.log('Transaction ID ile silindi:', txId);
                            } else {
                                // ID bulunamazsa, description ve amount ile ara
                                console.log('ID bulunamadÄ±, description ile aranÄ±yor...');
                                const transactionIndex = account.transactions.findIndex(t => 
                                    t.type === txType && 
                                    t.description && 
                                    t.description.includes(txId)
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    deleted = true;
                                    console.log('Transaction description ile silindi');
                                }
                            }
                            
                            console.log('Hesap transaction silindi:', deleted);
                        }
                    } else if (txType === 'SatÄ±ÅŸ') {
                        // SatÄ±ÅŸ kaydÄ±ndan sil
                        const sale = salesLog.find(s => s.id === txId);
                        if (sale) {
                            // Ã–nce hesap hareketini sil
                            if (account.transactions) {
                                const transactionIndex = account.transactions.findIndex(t => 
                                    t.type === 'SatÄ±ÅŸ Geliri' && 
                                    t.date === sale.date && 
                                    Math.abs(t.amount - sale.totalAmount) < 0.01
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    console.log('SatÄ±ÅŸ hesap hareketi silindi');
                                }
                            }
                            
                            // Cariye satÄ±ÅŸsa mÃ¼ÅŸteri bakiyesini geri al
                            if (sale.paymentMethod === 'cariye' && sale.customerId) {
                                const customer = customers.find(c => c.id === sale.customerId);
                                if (customer) {
                                    customer.balance += sale.totalAmount;
                                    console.log('MÃ¼ÅŸteri bakiyesi geri alÄ±ndÄ±');
                                }
                            }
                            
                            // SatÄ±ÅŸ kaydÄ±nÄ± sil
                            salesLog = salesLog.filter(s => s.id !== txId);
                            deleted = true;
                            console.log('SatÄ±ÅŸ kaydÄ± silindi');
                        }
                    } else if (txType === 'Tahsilat') {
                        // Tahsilat kaydÄ±nÄ± sil
                        const payment = payments.find(p => p.id === txId);
                        if (payment) {
                            // MÃ¼ÅŸteri bakiyesini geri al
                            const customer = customers.find(c => c.id === payment.customerId);
                            if (customer) {
                                customer.balance -= payment.amount;
                                console.log('MÃ¼ÅŸteri bakiyesi geri alÄ±ndÄ±');
                            }
                            
                            // Tahsilat kaydÄ±nÄ± sil
                            payments = payments.filter(p => p.id !== txId);
                            deleted = true;
                            console.log('Tahsilat kaydÄ± silindi');
                        }
                    } else if (txType === 'AlÄ±m') {
                        // Hammadde alÄ±mÄ±nÄ± sil
                        rawMaterials.forEach(rm => {
                            if (rm.stockHistory) {
                                const originalLength = rm.stockHistory.length;
                                rm.stockHistory = rm.stockHistory.filter(h => h.id !== txId);
                                if (rm.stockHistory.length < originalLength) {
                                    deleted = true;
                                    console.log('Hammadde alÄ±mÄ± silindi');
                                }
                            }
                        });
                    }
                    
                    if (deleted) {
                        saveData();
                        renderCashFlow();
                        renderAccountDetails(accountId);
                        showNotification('Ä°ÅŸlem baÅŸarÄ±yla silindi', 'success', 3000);
                    } else {
                        // Son Ã§are: TÃ¼m transaction'larÄ± listele ve kullanÄ±cÄ±ya gÃ¶ster
                        console.error('Ä°ÅŸlem bulunamadÄ±! Mevcut transaction\'lar:');
                        if (account.transactions) {
                            account.transactions.forEach((t, index) => {
                                console.log(`${index}: ID=${t.id}, Type=${t.type}, Desc=${t.description}, Amount=${t.amount}`);
                            });
                        }
                        showNotification('Ä°ÅŸlem silinemedi - kayÄ±t bulunamadÄ±. Console\'u kontrol edin.', 'error', 5000);
                    }
                }
            );
        }

        function forceDeleteTransaction(accountId, txId, txType) {
            showConfirmModal(
                "Zorla Sil",
                "Bu iÅŸlemi zorla silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz ve tÃ¼m veriler temizlenecek.",
                () => {
                    console.log('Zorla silme iÅŸlemi baÅŸlatÄ±lÄ±yor:', { accountId, txId, txType });
                    
                    const account = accounts.find(a => a.id === accountId);
                    if (!account) {
                        console.error('Hesap bulunamadÄ±:', accountId);
                        return;
                    }
                    
                    let deleted = false;
                    
                    // TÃ¼m transaction'larÄ± listele
                    console.log('Mevcut transaction\'lar:');
                    if (account.transactions) {
                        account.transactions.forEach((t, index) => {
                            console.log(`${index}: ID=${t.id}, Type=${t.type}, Desc=${t.description}, Amount=${t.amount}`);
                        });
                        
                        // Ä°lk eÅŸleÅŸen transaction'Ä± sil
                        const transactionIndex = account.transactions.findIndex(t => 
                            t.type === txType || 
                            t.id === txId || 
                            (t.description && t.description.includes(txId))
                        );
                        
                        if (transactionIndex !== -1) {
                            const deletedTransaction = account.transactions.splice(transactionIndex, 1)[0];
                            deleted = true;
                            console.log('Transaction zorla silindi:', deletedTransaction);
                        }
                    }
                    
                    if (deleted) {
                        saveData();
                        renderCashFlow();
                        renderAccountDetails(accountId);
                        showNotification('Ä°ÅŸlem zorla silindi', 'success', 3000);
                    } else {
                        showNotification('HiÃ§bir iÅŸlem silinemedi', 'error', 3000);
                    }
                }
            );
        }

        function renderAccountDetails(accountId) {
            currentOpenAccountId = accountId; // Store the currently viewed account ID
            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            // Sadece hesap transaction'larÄ±nÄ± kullan (Ã§ift kayÄ±t Ã¶nlemek iÃ§in)
            const accountTransactions = (account.transactions || []).map(t => ({ 
                ...t, 
                type: t.type, 
                txId: t.id, 
                desc: t.description,
                date: t.date
            }));
            
            // Sadece hesap transaction'larÄ±nÄ± kullan (Ã§ift kayÄ±t Ã¶nlemek iÃ§in)
            // purchases array'ini kaldÄ±rdÄ±k Ã§Ã¼nkÃ¼ artÄ±k hesap transaction'larÄ±na ekleniyor
            
            // SatÄ±ÅŸ kayÄ±tlarÄ±nÄ± ekle (sadece kasaya giren satÄ±ÅŸlar - cariye hariÃ§)
            const sales = salesLog
                .filter(s => s.paymentAccountId === accountId && s.paymentMethod !== 'cariye') // Cariye satÄ±ÅŸlarÄ± hariÃ§ tut
                .map(s => ({ 
                    ...s, 
                    type: s.isQuickSale ? 'SatÄ±ÅŸ Geliri' : 'SatÄ±ÅŸ', // HÄ±zlÄ± satÄ±ÅŸ iÃ§in 'SatÄ±ÅŸ Geliri' tÃ¼rÃ¼
                    txId: s.id, 
                    desc: s.isQuickSale ? s.productName : (products.find(p=>p.id === s.productId)?.name || 'Bilinmeyen ÃœrÃ¼n')
                }));
            
            // Ã‡ift kayÄ±t Ã¶nlemek iÃ§in: zaten transaction'da olan tahsilatlarÄ± filtrele
            const customerPayments = payments
                .filter(p => {
                    if (!p.customerId || p.paymentAccountId !== accountId) return false;
                    // Bu Ã¶deme zaten account.transactions'da varsa ekleme
                    const existsInTransactions = accountTransactions.some(t => 
                        t.paymentId === p.id || // PaymentId ile kontrol
                        (t.type === 'Tahsilat' && Math.abs(t.amount - p.amount) < 0.01 && t.date === p.date)
                    );
                    return !existsInTransactions;
                })
                .map(p => ({ 
                    ...p, 
                    type: 'Tahsilat', 
                    txId: p.id, 
                    desc: `${customers.find(c=>c.id === p.customerId)?.name || 'Bilinmeyen MÃ¼ÅŸteri'} - ${p.notes || 'Ã–deme'}` 
                }));
            
            // Ã‡ift kayÄ±t Ã¶nlemek iÃ§in: zaten transaction'da olan malzeme Ã¶demelerini filtrele
            const materialPayments = payments
                .filter(p => {
                    if (p.type !== 'Malzeme' || p.paymentAccountId !== accountId) return false;
                    // Bu Ã¶deme zaten account.transactions'da varsa ekleme
                    const existsInTransactions = accountTransactions.some(t => 
                        t.paymentId === p.id || // PaymentId ile kontrol
                        (t.type === 'Malzeme' && Math.abs(Math.abs(t.amount) - p.amount) < 0.01 && t.date === p.date)
                    );
                    return !existsInTransactions;
                })
                .map(p => ({ ...p, type: 'Malzeme', txId: p.id, desc: p.notes }));
            
            const transactions = [...sales, ...customerPayments, ...materialPayments, ...accountTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Debug loglarÄ±
            console.log('ğŸ” Hesap Hareketleri Debug:');
            console.log('- Hesap ID:', accountId);
            console.log('- Hesap Bulundu mu?', !!account);
            console.log('- Hesap AdÄ±:', account?.name);
            console.log('- Hesap Transaction\'larÄ± var mÄ±?', !!account?.transactions);
            console.log('- Hesap Transaction SayÄ±sÄ±:', accountTransactions.length);
            console.log('- SatÄ±ÅŸ SayÄ±sÄ± (tÃ¼m satÄ±ÅŸlar):', sales.length);
            console.log('- Tahsilat SayÄ±sÄ±:', customerPayments.length);
            console.log('- Malzeme Ã–demesi SayÄ±sÄ±:', materialPayments.length);
            console.log('- Toplam Ä°ÅŸlem SayÄ±sÄ±:', transactions.length);
            console.log('- Hesap Transaction\'larÄ±:', accountTransactions);
            console.log('- SatÄ±ÅŸ KayÄ±tlarÄ±:', sales);
            console.log('- TÃ¼m Hesaplar:', accounts.map(a => ({ id: a.id, name: a.name, transactionCount: a.transactions?.length || 0 })));
            
            // Her transaction'Ä±n detaylarÄ±nÄ± logla
            transactions.forEach((tx, index) => {
                console.log(`ğŸ” Transaction ${index}:`, {
                    type: tx.type,
                    totalAmount: tx.totalAmount,
                    amount: tx.amount,
                    cost: tx.cost,
                    desc: tx.desc
                });
            });

            let modalContent = `<h3 class="text-xl font-semibold mb-4">${account.name} - Hesap Hareketleri</h3>
                                <table class="w-full text-sm"><thead><tr><th>Tarih</th><th>TÃ¼r</th><th>AÃ§Ä±klama</th><th>GiriÅŸ</th><th>Ã‡Ä±kÄ±ÅŸ</th><th>Eylem</th></tr></thead><tbody>`;
            transactions.forEach(tx => {
                let income = '';
                let expense = '';
                
                if (tx.type === 'SatÄ±ÅŸ' || tx.type === 'SatÄ±ÅŸ Geliri' || tx.type === 'Tahsilat' || tx.type === 'Para Ekleme') {
                    income = (tx.totalAmount || tx.amount || 0).toFixed(2);
                } else if (tx.type === 'AlÄ±m' || tx.type === 'Malzeme' || tx.type === 'Gider') {
                    expense = Math.abs(tx.cost || tx.amount || 0).toFixed(2);
                }
                
                // Debug: Her transaction iÃ§in tutar bilgilerini logla
                console.log(`ğŸ” Transaction Debug:`, {
                    type: tx.type,
                    totalAmount: tx.totalAmount,
                    amount: tx.amount,
                    income: income,
                    expense: expense
                });
                
                modalContent += `<tr>
                    <td>${new Date(tx.date).toLocaleDateString('tr-TR')}</td>
                    <td>${tx.type}</td>
                    <td>${tx.desc}</td>
                    <td class="text-green-600">${income}</td>
                    <td class="text-red-600">${expense}</td>
                    <td>
                        ${tx.type === 'Gider' ? '<span class="text-gray-400 text-xs">DÃ¼zenlenemez</span>' : `
                            <button onclick="openEditTransactionModal('${tx.txId}', '${tx.type}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">DÃ¼zenle</button>
                            <button onclick="deleteAccountTransaction('${accountId}', '${tx.txId}', '${tx.type}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md mr-1">Sil</button>
                            <button onclick="forceDeleteTransaction('${accountId}', '${tx.txId}', '${tx.type}')" class="bg-red-700 text-white px-2 py-1 text-xs rounded-md">Zorla Sil</button>
                        `}
                    </td>
                </tr>`;
            });
            modalContent += `</tbody></table><div class="mt-6 flex justify-end"><button onclick="closeModal('accountDetailModal')" class="bg-gray-200 px-4 py-2 rounded-md">Kapat</button></div>`;
            document.getElementById('accountDetailModalContent').innerHTML = modalContent;
            showModal('accountDetailModal');
        }
        
        function openEditTransactionModal(txId, txType) {
            const form = document.getElementById('editTransactionForm');
            form.reset();
            let tx;
            if (txType === 'AlÄ±m') {
                for(const rm of rawMaterials) {
                    tx = rm.stockHistory?.find(h => h.id === txId);
                    if(tx) break;
                }
            }
            else if (txType === 'SatÄ±ÅŸ') tx = salesLog.find(s => s.id === txId);
            else if (txType === 'Tahsilat') tx = payments.find(p => p.id === txId);
            else if (txType === 'Para Ekleme') {
                // Para ekleme iÅŸlemini hesap transactions'Ä±nda bul
                for(const account of accounts) {
                    if(account.transactions) {
                        tx = account.transactions.find(t => t.id === txId);
                        if(tx) break;
                    }
                }
            }

            if (!tx) { showMessageModal("Hata", "Ä°ÅŸlem bulunamadÄ±."); return; }

            form.txId.value = txId;
            form.txType.value = txType;
            form.txDate.value = tx.date;
            
            const amountDiv = document.getElementById('txAmountDiv');
            const purchaseDiv = document.getElementById('txPurchaseDiv');

            if(txType === 'AlÄ±m') {
                amountDiv.style.display = 'none';
                purchaseDiv.style.display = 'grid';
                form.txQuantity.value = tx.quantity;
                form.txPrice.value = tx.price;
            } else {
                amountDiv.style.display = 'block';
                purchaseDiv.style.display = 'none';
                form.txAmount.value = tx.totalAmount || tx.amount;
            }

            form.txAccountId.innerHTML = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}" ${acc.id === tx.paymentAccountId ? 'selected' : ''}>${acc.name}</option>`).join('');
            
            const notesDiv = document.getElementById('txNotesDiv');
            if (txType === 'Tahsilat' || txType === 'Para Ekleme') {
                notesDiv.style.display = 'block';
                form.txNotes.value = tx.notes || tx.description || '';
            } else {
                notesDiv.style.display = 'none';
            }

            showModal('editTransactionModal');
        }

        function handleTransactionUpdate() {
            const form = document.getElementById('editTransactionForm');
            const txId = form.txId.value;
            const txType = form.txType.value;
            const newDate = form.txDate.value;
            const newAccountId = form.txAccountId.value;

            let tx;
            if (txType === 'AlÄ±m') {
                let parentMaterial = null;
                for (const rm of rawMaterials) {
                    tx = rm.stockHistory?.find(h => h.id === txId);
                    if (tx) {
                        parentMaterial = rm;
                        break;
                    }
                }
                if (tx && parentMaterial) {
                    tx.quantity = parseFloat(form.txQuantity.value) || 0;
                    tx.price = parseFloat(form.txPrice.value) || 0;
                    tx.cost = tx.quantity * tx.price;
                    // Recalculate average cost for the parent material
                    const totalStock = parentMaterial.stockHistory.reduce((sum, item) => sum + item.quantity, 0);
                    const totalCost = parentMaterial.stockHistory.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    parentMaterial.averageCost = totalStock > 0 ? totalCost / totalStock : 0;
                }
            } else if (txType === 'SatÄ±ÅŸ') {
                tx = salesLog.find(s => s.id === txId);
                if(tx) tx.totalAmount = parseFloat(form.txAmount.value) || 0;
            } else if (txType === 'Tahsilat') {
                tx = payments.find(p => p.id === txId);
                if(tx) { 
                    tx.amount = parseFloat(form.txAmount.value) || 0; 
                    tx.notes = form.txNotes.value;
                }
            } else if (txType === 'Para Ekleme') {
                // Para ekleme iÅŸlemini hesap transactions'Ä±nda bul ve gÃ¼ncelle
                const account = accounts.find(a => a.transactions && a.transactions.some(t => t.id === txId));
                if (account) {
                    tx = account.transactions.find(t => t.id === txId);
                    if(tx) {
                        tx.amount = parseFloat(form.txAmount.value) || 0;
                        tx.description = form.txNotes.value || tx.description;
                        tx.date = newDate;
                    }
                }
                
                // Tahsilat kaydÄ±nÄ± da gÃ¼ncelle (payments array'inde)
                const paymentTx = payments.find(p => p.type === 'Para Ekleme' && p.notes === tx?.description);
                if (paymentTx) {
                    paymentTx.amount = parseFloat(form.txAmount.value) || 0;
                    paymentTx.notes = form.txNotes.value || paymentTx.notes;
                    paymentTx.date = newDate;
                }
            }

            if(tx) {
                tx.date = newDate;
                tx.paymentAccountId = newAccountId;
                saveData(true, true); // Zorla Firebase'e gÃ¶nder
                renderAllTabsAndModals();
                closeModal('editTransactionModal');
                if (document.getElementById('accountDetailModal').classList.contains('hidden') === false) {
                    renderAccountDetails(currentOpenAccountId); 
                }
                showNotification('âœ… Ä°ÅŸlem baÅŸarÄ±yla gÃ¼ncellendi', 'success', 3000);
            } else {
                showMessageModal("Hata", "Ä°ÅŸlem gÃ¼ncellenirken bir hata oluÅŸtu.");
            }
        }

        function openAddMoneyModal(accountId) {
            const form = document.getElementById('addMoneyForm');
            if (form) {
                form.reset();
                form.accountId.value = accountId;
                form.moneyDate.value = new Date().toISOString().split('T')[0];
                showModal('addMoneyModal');
            } else {
                console.error('addMoneyForm bulunamadÄ±');
                showMessageModal("Hata", "Para ekleme formu yÃ¼klenemedi. SayfayÄ± yenileyin.");
            }
        }

        function addMoneyToAccount() {
            const form = document.getElementById('addMoneyForm');
            const accountId = form.accountId.value;
            const amount = parseFloat(form.moneyAmount.value) || 0;
            const description = form.moneyDescription.value.trim();
            const date = form.moneyDate.value;

            if (!accountId || amount <= 0 || !description) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli bir ÅŸekilde doldurun.");
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                showMessageModal("Hata", "Hesap bulunamadÄ±.");
                return;
            }

            // Hesaba para ekleme iÅŸlemi
            if (!account.transactions) account.transactions = [];
            account.transactions.push({
                id: crypto.randomUUID(),
                date: date,
                type: 'Para Ekleme',
                description: description,
                amount: amount
            });

            saveData(true, true); // Zorla Firebase'e gÃ¶nder
            renderCashFlow();
            closeModal('addMoneyModal');
            showNotification(`ğŸ’° ${amount.toFixed(2)} TL hesaba eklendi`, 'success', 3000);
        }




        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // GiriÅŸ durumunu kontrol et
            if (!(await checkLoginStatus())) {
                showLoginScreen();
            }
            
            // GiriÅŸ formu event listener
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('loginPassword').value;
                
                if (authenticateUser(password)) {
                    isLoggedIn = true;
                    const session = {
                        loginTime: new Date().getTime(),
                        password: password
                    };
                    localStorage.setItem('appSession', JSON.stringify(session));
                    showMainApp();
                    showNotification('HoÅŸ geldiniz!', 'success', 3000);
                } else {
                    showNotification('HatalÄ± ÅŸifre!', 'error', 3000);
                }
            });
            
            // Firebase'i baÅŸlat
            const firebaseSuccess = initializeFirebase();
            if (!firebaseSuccess) {
                console.error('âŒ Firebase baÅŸlatÄ±lamadÄ±!');
                showNotification('Firebase baÄŸlantÄ± hatasÄ±! Veriler yerel olarak saklanacak.', 'warning', 5000);
            }
            
            // TarayÄ±cÄ± uyumluluÄŸunu kontrol et
            checkBrowserCompatibility();
            
            // Klavye kÄ±sayollarÄ±
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd tuÅŸu kontrolÃ¼
                const isCtrlOrCmd = e.ctrlKey || e.metaKey;
                
                // ESC tuÅŸu ile modal kapatma
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal:not(.hidden)');
                    if (openModal) {
                        closeModal(openModal.id);
                    }
                    return;
                }
                
                // Input alanÄ±nda deÄŸilse klavye kÄ±sayollarÄ±nÄ± aktif et
                const activeElement = document.activeElement;
                const isInputField = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'TEXTAREA' || 
                    activeElement.contentEditable === 'true'
                );
                
                if (isInputField) return;
                
                // Klavye kÄ±sayollarÄ±
                switch(e.key) {
                    case 'n':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            const activeTab = document.querySelector('.tab-button.active')?.dataset.tabId;
                            if (activeTab === 'products') {
                                addProduct();
                            } else if (activeTab === 'suppliers') {
                                addSupplier();
                            } else if (activeTab === 'sales') {
                                openSaleModal();
                            } else if (activeTab === 'productionLog') {
                                openAddProductionModal();
                            }
                            showNotification('âŒ¨ï¸ Yeni Ã¶ÄŸe eklendi', 'info', 2000);
                        }
                        break;
                    case 's':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            saveData();
                        }
                        break;
                    case 'e':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            exportData();
                        }
                        break;
                    case 'i':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            importData();
                        }
                        break;
                }
            });
            
            // Firebase'i baÅŸlat
            setTimeout(() => {
                initializeFirebase();
            }, 500);
            
            // Verileri yÃ¼kle
            loadData();
            
            // UI'yi render et
            renderAllTabsAndModals();
            
            // Otomatik yedeklemeyi baÅŸlat
            startAutoBackup();
            
            // Sayfa kapatÄ±lÄ±rken veri kaybÄ±nÄ± Ã¶nle
            window.addEventListener('beforeunload', (e) => {
                if (pendingChanges) {
                    e.preventDefault();
                    e.returnValue = 'KaydedilmemiÅŸ deÄŸiÅŸiklikler var. SayfayÄ± kapatmak istediÄŸinizden emin misiniz?';
                    return e.returnValue;
                }
            });
            
            // Veri yÃ¼kleme durumunu kontrol et (Edge iÃ§in)
            setTimeout(() => {
                checkDataLoadingStatus();
            }, 2000);
            
            // Sayfa kapatÄ±lÄ±rken otomatik yedekleme durdur
            window.addEventListener('beforeunload', () => {
                stopAutoBackup();
                createAutoBackup(); // Son yedekleme
            });
        });

        // --- EXPENSE MANAGEMENT FUNCTIONS ---
        function openAddExpenseModal() {
            const form = document.getElementById('addExpenseForm');
            if (form) form.reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            showModal('addExpenseModal');
        }

        function addExpense(event) {
            event.preventDefault();
            const form = event.target;
            const newExpense = {
                id: crypto.randomUUID(),
                date: form.expenseDate.value,
                category: form.expenseCategory.value,
                description: form.expenseDescription.value,
                amount: parseFloat(form.expenseAmount.value),
                accountId: form.expenseAccountId.value
            };

            if (!newExpense.category || !newExpense.amount || !newExpense.accountId || !newExpense.description.trim()) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun. AÃ§Ä±klama alanÄ± boÅŸ bÄ±rakÄ±lamaz.");
                return;
            }

            expenses.push(newExpense);

            // Hesaptan gideri dÃ¼ÅŸ
            const account = accounts.find(a => a.id === newExpense.accountId);
            if (account) {
                // Hesap geÃ§miÅŸine gider kaydÄ± ekle
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: newExpense.date,
                    type: 'Gider',
                    description: `${newExpense.category}: ${newExpense.description}`,
                    amount: -newExpense.amount,
                    expenseId: newExpense.id
                });
            }

            renderExpenses();
            renderCashFlow();
            saveData(true, true); // Zorla Firebase'e gÃ¶nder
            closeModal('addExpenseModal');
            showMessageModal("BaÅŸarÄ±lÄ±", "Gider baÅŸarÄ±yla eklendi ve hesaptan dÃ¼ÅŸÃ¼ldÃ¼.");
        }

        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Basit dÃ¼zenleme iÃ§in prompt kullanÄ±yoruz
            const newAmount = prompt("Yeni tutar:", expense.amount);
            if (newAmount !== null && !isNaN(newAmount)) {
                const oldAmount = expense.amount;
                const newAmountValue = parseFloat(newAmount);
                expense.amount = newAmountValue;
                
                // Hesaptaki gider kaydÄ±nÄ± gÃ¼ncelle
                const account = accounts.find(a => a.id === expense.accountId);
                if (account && account.transactions) {
                    const expenseTransaction = account.transactions.find(t => t.expenseId === expenseId);
                    if (expenseTransaction) {
                        // Eski tutarÄ± geri ekle, yeni tutarÄ± dÃ¼ÅŸ
                        expenseTransaction.amount = -newAmountValue;
                    }
                }
                
                renderExpenses();
                renderCashFlow();
                saveData(true, true); // Zorla Firebase'e gÃ¶nder
            }
        }

        function deleteExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            showConfirmModal(
                "Gideri Sil",
                "Bu gideri silmek istediÄŸinizden emin misiniz?",
                () => {
                    // Hesaptan gider kaydÄ±nÄ± da sil
                    const account = accounts.find(a => a.id === expense.accountId);
                    if (account && account.transactions) {
                        account.transactions = account.transactions.filter(t => t.expenseId !== expenseId);
                    }
                    
                    expenses = expenses.filter(e => e.id !== expenseId);
                    renderExpenses();
                    renderCashFlow();
                    saveData(true, true); // Zorla Firebase'e gÃ¶nder
                }
            );
        }

        // --- MATERIAL MANAGEMENT FUNCTIONS ---
        function openAddMaterialItemModal() {
            const form = document.getElementById('addMaterialItemForm');
            if (form) form.reset();
            showModal('addMaterialItemModal');
        }

        function addMaterialItem(event) {
            event.preventDefault();
            const form = event.target;
            const newMaterial = {
                id: crypto.randomUUID(),
                name: form.materialName.value,
                category: form.materialCategory.value,
                quantity: parseFloat(form.materialQuantity.value),
                unit: form.materialUnit.value,
                unitPrice: parseFloat(form.materialUnitPrice.value),
                minStock: parseFloat(document.getElementById('materialMinStock').value) || 0,
                description: form.materialDescription.value,
                accountId: form.materialAccountId.value
            };

            if (!newMaterial.name || !newMaterial.category || !newMaterial.quantity || !newMaterial.unit || !newMaterial.unitPrice || !newMaterial.accountId) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.");
                return;
            }

            materials.push(newMaterial);
            
            // Gider olarak kaydet
            const totalCost = newMaterial.quantity * newMaterial.unitPrice;
            const materialExpense = {
                id: crypto.randomUUID(),
                date: new Date().toISOString().split('T')[0],
                category: 'Malzeme',
                description: `${newMaterial.name} (${newMaterial.quantity} ${newMaterial.unit})`,
                amount: totalCost,
                accountId: newMaterial.accountId
            };
            
            expenses.push(materialExpense);

            // Kasa hareketi olarak da kaydet
            const payment = {
                id: crypto.randomUUID(),
                customerId: null, // Malzeme alÄ±mÄ± iÃ§in mÃ¼ÅŸteri yok
                date: new Date().toISOString().split('T')[0],
                amount: totalCost, // Pozitif miktar (Ã§Ä±kÄ±ÅŸ)
                paymentAccountId: newMaterial.accountId, // AynÄ± hesaptan dÃ¼ÅŸ
                notes: `Malzeme alÄ±mÄ±: ${newMaterial.name} (${newMaterial.quantity} ${newMaterial.unit})`,
                type: 'Malzeme' // TÃ¼rÃ¼ Malzeme olarak iÅŸaretle
            };
            payments.push(payment);

            renderMaterials();
            renderExpenses();
            renderCashFlow();
            saveData();
            closeModal('addMaterialItemModal');
            showMessageModal("BaÅŸarÄ±lÄ±", "Malzeme baÅŸarÄ±yla eklendi ve gider olarak kaydedildi.");
        }

        function editMaterial(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material) return;

            const newQuantity = prompt("Yeni miktar:", material.quantity);
            if (newQuantity !== null && !isNaN(newQuantity)) {
                const oldTotalValue = material.quantity * material.unitPrice;
                material.quantity = parseFloat(newQuantity);
                const newTotalValue = material.quantity * material.unitPrice;
                
                // Ä°lgili gideri gÃ¼ncelle
                const relatedExpense = expenses.find(e => e.description.includes(material.name) && e.category === 'Malzeme');
                if (relatedExpense) {
                    relatedExpense.amount = newTotalValue;
                }
                
                renderMaterials();
                renderExpenses();
                renderCashFlow();
                saveData();
            }
        }

        function deleteMaterial(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material) return;

            showConfirmModal(
                "Malzemeyi Sil",
                "Bu malzemeyi silmek istediÄŸinizden emin misiniz?",
                () => {
                    // Ä°lgili gideri sil
                    expenses = expenses.filter(e => !(e.description.includes(material.name) && e.category === 'Malzeme'));
                    
                    // Ä°lgili kasa hareketini sil
                    payments = payments.filter(p => !(p.type === 'Malzeme' && p.notes.includes(material.name)));
                    
                    materials = materials.filter(m => m.id !== materialId);
                    renderMaterials();
                    renderExpenses();
                    renderCashFlow();
                    saveData();
                }
            );
        }

        // --- PRODUCTION PLANNING FUNCTIONS ---
        function openAddProductionPlanModal() {
            const form = document.getElementById('addProductionPlanForm');
            if (form) form.reset();
            document.getElementById('planStartDate').value = new Date().toISOString().split('T')[0];
            populateProductDropdown('planProductName');
            showModal('addProductionPlanModal');
        }

        function populateProductDropdown(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">ÃœrÃ¼n seÃ§in...</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        function loadProductDetails() {
            const selectedProduct = document.getElementById('planProductName').value;
            const filamentDetails = document.getElementById('planFilamentDetails');
            
            if (selectedProduct) {
                const product = products.find(p => p.name === selectedProduct);
                if (product) {
                    // TÃ¼m varyantlarÄ±n toplam bilgilerini hesapla
                    let totalPrintTime = 0;
                    let allColors = {};
                    let totalFilament = 0;
                    
                    if (product.variants && product.variants.length > 0) {
                        // TÃ¼m varyantlarÄ±n printTime'Ä±nÄ± topla
                        totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                        
                        // TÃ¼m varyantlarÄ±n filament bilgilerini birleÅŸtir
                        product.variants.forEach(variant => {
                            if (variant.colors && variant.colors.length > 0) {
                                variant.colors.forEach(color => {
                                    const key = `${color.name}_${color.filamentId}`;
                                    if (!allColors[key]) {
                                        allColors[key] = {
                                            name: color.name,
                                            filamentId: color.filamentId,
                                            gram: 0
                                        };
                                    }
                                    allColors[key].gram += color.gram || 0;
                                });
                            }
                        });
                        
                        // Toplam filament miktarÄ±nÄ± hesapla
                        totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
                    }
                    
                    // ÃœrÃ¼n detaylarÄ±nÄ± otomatik doldur
                    document.getElementById('planUnitTime').value = totalPrintTime;
                    
                    // Filament detaylarÄ±nÄ± gÃ¶ster
                    if (Object.keys(allColors).length > 0) {
                        let filamentHTML = `
                            <div class="space-y-1">
                                <div class="font-semibold text-gray-800">Toplam: ${totalFilament.toFixed(0)} gr</div>
                                <div class="text-xs text-gray-600">
                                    ${Object.values(allColors).map(color => {
                                        const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                        const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                        return `<div>â€¢ ${color.name}: ${color.gram.toFixed(0)} gr (${filamentName})</div>`;
                                    }).join('')}
                                </div>
                                <div class="text-xs text-blue-600 mt-2">
                                    ğŸ“Š ${product.variants.length} varyantÄ±n toplamÄ±
                                </div>
                            </div>
                        `;
                        filamentDetails.innerHTML = filamentHTML;
                    } else {
                        filamentDetails.innerHTML = '<div class="text-gray-500">Bu Ã¼rÃ¼nÃ¼n filament bilgisi yok</div>';
                    }
                    
                    // HesaplamalarÄ± yap
                    calculatePlanValues();
                }
            } else {
                filamentDetails.innerHTML = 'Ã–nce Ã¼rÃ¼n seÃ§in';
                document.getElementById('planUnitTime').value = '';
            }
        }

        function loadEditProductDetails() {
            const selectedProduct = document.getElementById('editPlanProductName').value;
            if (selectedProduct) {
                const product = products.find(p => p.name === selectedProduct);
                if (product) {
                    // ÃœrÃ¼n detaylarÄ±nÄ± otomatik doldur
                    document.getElementById('editPlanUnitTime').value = product.unitTime || '';
                    calculateEditPlanValues();
                }
            }
        }

        function calculatePlanValues() {
            const unitTime = parseFloat(document.getElementById('planUnitTime').value) || 0;
            const machineCount = parseFloat(document.getElementById('planMachineCount').value) || 0;
            const orderQuantity = parseFloat(document.getElementById('planOrderQuantity').value) || 0;
            
            // GÃ¼nlÃ¼k kapasite = (24 saat / birim sÃ¼re) * makine sayÄ±sÄ±
            const dailyCapacity = (24 / unitTime) * machineCount;
            document.getElementById('planDailyCapacity').value = dailyCapacity.toFixed(2);
            
            // Total gÃ¼n = sipariÅŸ adedi / gÃ¼nlÃ¼k kapasite
            const totalDays = orderQuantity / dailyCapacity;
            document.getElementById('planTotalDays').value = totalDays.toFixed(2);
            
            // Total saat = total gÃ¼n * 24
            const totalHours = totalDays * 24;
            document.getElementById('planTotalHours').value = totalHours.toFixed(2);
            
            // BitiÅŸ tarihini hesapla
            calculateEndDate();
        }

        function calculateEndDate() {
            const startDate = document.getElementById('planStartDate').value;
            const totalDays = parseFloat(document.getElementById('planTotalDays').value) || 0;
            
            if (startDate && totalDays > 0) {
                const start = new Date(startDate);
                const endDate = new Date(start.getTime() + (totalDays * 24 * 60 * 60 * 1000));
                document.getElementById('planExpectedEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            // SÃ¶zleÅŸme sonu adetini hesapla
            calculateContractQuantity();
        }

        function calculateContractQuantity() {
            const startDate = document.getElementById('planStartDate').value;
            const contractDate = document.getElementById('planContractDate').value;
            const dailyCapacity = parseFloat(document.getElementById('planDailyCapacity').value) || 0;
            
            if (startDate && contractDate && dailyCapacity > 0) {
                const start = new Date(startDate);
                const contract = new Date(contractDate);
                
                // BaÅŸlangÄ±Ã§ ve sÃ¶zleÅŸme tarihi arasÄ±ndaki gÃ¼n sayÄ±sÄ±
                const timeDiff = contract.getTime() - start.getTime();
                const daysDiff = Math.max(0, timeDiff / (1000 * 60 * 60 * 24));
                
                // Bu sÃ¼rede Ã¼retilebilecek adet
                const contractQuantity = Math.floor(daysDiff * dailyCapacity);
                document.getElementById('planContractQuantity').value = contractQuantity;
            }
        }

        function addProductionPlan(event) {
            event.preventDefault();
            const form = event.target;
            // SeÃ§ilen Ã¼rÃ¼nÃ¼n ID'sini bul
            const selectedProduct = products.find(p => p.name === form.planProductName.value);
            
            const newPlan = {
                id: crypto.randomUUID(),
                productId: selectedProduct?.id || null,
                productName: form.planProductName.value,
                unitTime: parseFloat(form.planUnitTime.value),
                machineCount: parseInt(form.planMachineCount.value),
                dailyCapacity: parseFloat(form.planDailyCapacity.value),
                orderQuantity: parseInt(form.planOrderQuantity.value),
                totalDays: parseFloat(form.planTotalDays.value),
                totalHours: parseFloat(form.planTotalHours.value),
                salePrice: parseFloat(form.planSalePrice.value) || 0,
                startDate: form.planStartDate.value,
                expectedEndDate: form.planExpectedEndDate.value,
                contractDate: form.planContractDate.value || null,
                contractQuantity: parseInt(form.planContractQuantity.value) || null,
                status: form.planStatus.value,
                description: form.planDescription.value
            };

            if (!newPlan.productName || !newPlan.unitTime || !newPlan.machineCount || !newPlan.orderQuantity) {
                showMessageModal("Hata", "LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.");
                return;
            }

            productionPlans.push(newPlan);
            renderProductionPlanning();
            saveData();
            closeModal('addProductionPlanModal');
            showMessageModal("BaÅŸarÄ±lÄ±", "Ãœretim planÄ± baÅŸarÄ±yla eklendi.");
        }

        function editProductionPlan(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            // Dropdown'Ä± doldur
            populateProductDropdown('editPlanProductName');

            // Modal'Ä± doldur
            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanProductName').value = plan.productName;
            document.getElementById('editPlanUnitTime').value = plan.unitTime;
            document.getElementById('editPlanMachineCount').value = plan.machineCount;
            document.getElementById('editPlanOrderQuantity').value = plan.orderQuantity;
            document.getElementById('editPlanSalePrice').value = plan.salePrice || 0;
            document.getElementById('editPlanStatus').value = plan.status;
            document.getElementById('editPlanStartDate').value = plan.startDate;
            document.getElementById('editPlanContractDate').value = plan.contractDate || '';
            document.getElementById('editPlanDescription').value = plan.description || '';

            // HesaplamalarÄ± yap
            calculateEditPlanValues();
            
            showModal('editProductionPlanModal');
        }

        function calculateEditPlanValues() {
            const unitTime = parseFloat(document.getElementById('editPlanUnitTime').value) || 0;
            const machineCount = parseFloat(document.getElementById('editPlanMachineCount').value) || 0;
            const orderQuantity = parseFloat(document.getElementById('editPlanOrderQuantity').value) || 0;
            
            // GÃ¼nlÃ¼k kapasite = (24 saat / birim sÃ¼re) * makine sayÄ±sÄ±
            const dailyCapacity = (24 / unitTime) * machineCount;
            document.getElementById('editPlanDailyCapacity').value = dailyCapacity.toFixed(2);
            
            // Total gÃ¼n = sipariÅŸ adedi / gÃ¼nlÃ¼k kapasite
            const totalDays = orderQuantity / dailyCapacity;
            document.getElementById('editPlanTotalDays').value = totalDays.toFixed(2);
            
            // Total saat = total gÃ¼n * 24
            const totalHours = totalDays * 24;
            document.getElementById('editPlanTotalHours').value = totalHours.toFixed(2);
            
            // BitiÅŸ tarihini hesapla
            calculateEditEndDate();
        }

        function calculateEditEndDate() {
            const startDate = document.getElementById('editPlanStartDate').value;
            const totalDays = parseFloat(document.getElementById('editPlanTotalDays').value) || 0;
            
            if (startDate && totalDays > 0) {
                const start = new Date(startDate);
                const endDate = new Date(start.getTime() + (totalDays * 24 * 60 * 60 * 1000));
                document.getElementById('editPlanExpectedEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            // SÃ¶zleÅŸme sonu adetini hesapla
            calculateEditContractQuantity();
        }

        function calculateEditContractQuantity() {
            const startDate = document.getElementById('editPlanStartDate').value;
            const contractDate = document.getElementById('editPlanContractDate').value;
            const dailyCapacity = parseFloat(document.getElementById('editPlanDailyCapacity').value) || 0;
            
            if (startDate && contractDate && dailyCapacity > 0) {
                const start = new Date(startDate);
                const contract = new Date(contractDate);
                
                // BaÅŸlangÄ±Ã§ ve sÃ¶zleÅŸme tarihi arasÄ±ndaki gÃ¼n sayÄ±sÄ±
                const timeDiff = contract.getTime() - start.getTime();
                const daysDiff = Math.max(0, timeDiff / (1000 * 60 * 60 * 24));
                
                // Bu sÃ¼rede Ã¼retilebilecek adet
                const contractQuantity = Math.floor(daysDiff * dailyCapacity);
                document.getElementById('editPlanContractQuantity').value = contractQuantity;
            }
        }

        function updateProductionPlan(event) {
            event.preventDefault();
            const form = event.target;
            const planId = form.editPlanId.value;
            const plan = productionPlans.find(p => p.id === planId);
            
            if (!plan) return;

            // PlanÄ± gÃ¼ncelle
            plan.productName = form.editPlanProductName.value;
            plan.unitTime = parseFloat(form.editPlanUnitTime.value);
            plan.machineCount = parseInt(form.editPlanMachineCount.value);
            plan.dailyCapacity = parseFloat(form.editPlanDailyCapacity.value);
            plan.orderQuantity = parseInt(form.editPlanOrderQuantity.value);
            plan.salePrice = parseFloat(form.editPlanSalePrice.value) || 0;
            plan.totalDays = parseFloat(form.editPlanTotalDays.value);
            plan.totalHours = parseFloat(form.editPlanTotalHours.value);
            plan.startDate = form.editPlanStartDate.value;
            plan.expectedEndDate = form.editPlanExpectedEndDate.value;
            plan.contractDate = form.editPlanContractDate.value || null;
            plan.contractQuantity = parseInt(form.editPlanContractQuantity.value) || null;
            plan.status = form.editPlanStatus.value;
            plan.description = form.editPlanDescription.value;

            renderProductionPlanning();
            saveData();
            closeModal('editProductionPlanModal');
            showMessageModal("BaÅŸarÄ±lÄ±", "Ãœretim planÄ± baÅŸarÄ±yla gÃ¼ncellendi.");
        }

        function deleteProductionPlan(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            showConfirmModal(
                "PlanÄ± Sil",
                "Bu Ã¼retim planÄ±nÄ± silmek istediÄŸinizden emin misiniz?",
                () => {
                    productionPlans = productionPlans.filter(p => p.id !== planId);
                    renderProductionPlanning();
                    saveData();
                }
            );
        }

        function sendToProduction(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            // ÃœrÃ¼n bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }

            if (!product) {
                showMessageModal("Hata", "ÃœrÃ¼n bilgisi bulunamadÄ±.");
                return;
            }

            // Miktar sorma modal'Ä± oluÅŸtur
            const maxQuantity = plan.orderQuantity;
            const currentDate = new Date().toISOString().split('T')[0];
            
            const quantityModal = `
                <div class="modal max-w-md">
                    <h3 class="text-xl font-semibold mb-4">ğŸš€ Ãœretime GÃ¶nder</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800">${plan.productName}</h4>
                            <p class="text-sm text-blue-600">Maksimum: ${maxQuantity} adet</p>
                            <p class="text-sm text-blue-600">Varyant sayÄ±sÄ±: ${product.variants ? product.variants.length : 0}</p>
                            <p class="text-xs text-blue-500 mt-1">Her varyant iÃ§in ayrÄ± Ã¼retim kaydÄ± oluÅŸturulacak</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ãœretim MiktarÄ±</label>
                            <input type="number" id="productionQuantity" min="1" max="${maxQuantity}" 
                                   value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ãœretim Tarihi</label>
                            <input type="date" id="productionDate" value="${currentDate}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>Dikkat:</strong> Bu iÅŸlem Ã¼retim kaydÄ± oluÅŸturacak ve stoklarÄ± gÃ¼ncelleyecektir.
                            </p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeModal('sendToProductionModal')" 
                                class="bg-gray-300 px-4 py-2 rounded-md hover:bg-gray-400">
                            Ä°ptal
                        </button>
                        <button onclick="confirmSendToProduction('${planId}')" 
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            ğŸš€ Ãœretime GÃ¶nder
                        </button>
                    </div>
                </div>
            `;

            // Modal'Ä± gÃ¶ster
            document.getElementById('sendToProductionModal').innerHTML = quantityModal;
            showModal('sendToProductionModal');
        }

        function confirmSendToProduction(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            const quantity = parseInt(document.getElementById('productionQuantity').value);
            const productionDate = document.getElementById('productionDate').value;

            if (!quantity || quantity < 1) {
                showMessageModal("Hata", "LÃ¼tfen geÃ§erli bir miktar girin.");
                return;
            }

            if (quantity > plan.orderQuantity) {
                showMessageModal("Hata", `Miktar plan adedinden (${plan.orderQuantity}) fazla olamaz.`);
                return;
            }

            // ÃœrÃ¼n bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }

            if (!product) {
                showMessageModal("Hata", "ÃœrÃ¼n bilgisi bulunamadÄ±.");
                return;
            }

            // TÃ¼m varyantlar iÃ§in Ã¼retim kaydÄ± oluÅŸtur
            if (!product.variants || product.variants.length === 0) {
                showMessageModal("Hata", "ÃœrÃ¼nÃ¼n varyantÄ± bulunamadÄ±.");
                return;
            }

            const createdEntries = [];

            // Her varyant iÃ§in ayrÄ± Ã¼retim kaydÄ± oluÅŸtur
            product.variants.forEach(variant => {
                const productionEntry = {
                    id: crypto.randomUUID(),
                    date: productionDate,
                    productId: product.id,
                    productName: product.name,
                    variantId: variant.id,
                    variantName: variant.name,
                    quantity: quantity,
                    unitCost: 0, // Hesaplanacak
                    totalCost: 0, // Hesaplanacak
                    materialUsage: [],
                    notes: `Plan: ${plan.productName} - ${variant.name} - Otomatik oluÅŸturuldu`
                };

                // Malzeme kullanÄ±mÄ±nÄ± ekle (eÄŸer varyantta filament bilgisi varsa)
                if (variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        if (color.filamentId && color.gram > 0) {
                            productionEntry.materialUsage.push({
                                id: crypto.randomUUID(),
                                materialId: color.filamentId,
                                quantity: color.gram,
                                unitCost: 0 // Hesaplanacak
                            });
                        }
                    });
                }

                // Ãœretim kaydÄ±nÄ± ekle
                productionLog.push(productionEntry);
                createdEntries.push(productionEntry);
            });

            // Maliyetleri hesapla
            calculateAllProductionCosts();

            // Plan adedini gÃ¼ncelle
            plan.orderQuantity -= quantity;
            
            // EÄŸer plan tamamlandÄ±ysa durumunu gÃ¼ncelle
            if (plan.orderQuantity <= 0) {
                plan.status = 'completed';
            }

            // Verileri kaydet
            saveData();

            // SayfalarÄ± gÃ¼ncelle
            renderProductionPlanning();
            renderProductionLog();

            // Modal'Ä± kapat
            closeModal('sendToProductionModal');

            // BaÅŸarÄ± mesajÄ±
            const variantCount = product.variants.length;
            const totalQuantity = quantity * variantCount;
            showMessageModal("BaÅŸarÄ±lÄ±", `${quantity} adet Ã— ${variantCount} varyant = ${totalQuantity} adet ${product.name} Ã¼retim kaydÄ±na eklendi.`);
        }

    </script>
</body>
</html>
