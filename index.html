<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atölye Üretim & Finans Takibi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase v8 SDK - Tam uyumlu -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
    <script>
        // Firebase konfigürasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyChaqhVjyVBtqmhAX-CVlwyaTPKqS-t47E",
            authDomain: "dofistudios-3b1d4.firebaseapp.com",
            projectId: "dofistudios-3b1d4",
            storageBucket: "dofistudios-3b1d4.firebasestorage.app",
            messagingSenderId: "339459217344",
            appId: "1:339459217344:web:4c88d30186d4cc0df99a25",
            measurementId: "G-5VJGPYW0KK"
        };

        // Firebase başlatma fonksiyonu
        function initializeFirebase() {
            try {
                console.log('🔥 Firebase başlatılıyor...');
                console.log('Config:', firebaseConfig);
                
                // Firebase SDK'larının yüklenmesini bekle
                if (typeof firebase !== 'undefined') {
                    // Firebase zaten başlatılmış mı kontrol et
                    let app;
                    try {
                        app = firebase.app();
                        console.log('✅ Firebase zaten başlatılmış, mevcut app kullanılıyor');
                    } catch (error) {
                        // Firebase başlatılmamış, yeni başlat
                        app = firebase.initializeApp(firebaseConfig);
                        console.log('✅ Firebase yeni başlatıldı');
                    }
                    
                    const database = firebase.database();
                    const analytics = firebase.analytics();
                    
                    // Global olarak erişilebilir yap
                    window.firebaseApp = app;
                    window.firebaseDatabase = database;
                    window.firebaseRef = (path) => database.ref(path);
                    window.firebaseSet = (ref, data) => ref.set(data);
                    window.firebaseGet = (ref) => ref.once('value');
                    window.firebasePush = (ref, data) => ref.push(data);
                    window.firebaseRemove = (ref) => ref.remove();
                    window.firebaseUpdate = (ref, data) => ref.update(data);
                    window.firebaseOn = (ref, callback) => ref.on('value', callback);
                    window.firebaseOff = (ref, callback) => ref.off('value', callback);
                    window.firebaseAnalytics = analytics;
                    
                    console.log('✅ Firebase başarıyla hazırlandı');
                    console.log('✅ Database:', database);
                    console.log('✅ Analytics:', analytics);
                    
                    firebaseInitialized = true;
                    return true;
                } else {
                    console.error('❌ Firebase SDK yüklenemedi');
                    return false;
                }
            } catch (error) {
                console.error('❌ Firebase başlatma hatası:', error);
                console.error('Hata detayı:', error.message);
                console.error('Hata kodu:', error.code);
                return false;
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .tab-button { padding: 12px 24px; border-radius: 8px 8px 0 0; font-weight: 600; cursor: grab; transition: all 0.2s ease-in-out; background-color: #e5e7eb; color: #4b5563; }
        .tab-button.active { background-color: #ffffff; color: #1f2937; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .tab-button.dragging { opacity: 0.5; }
        .tab-button.drag-over { border-bottom: 2px solid #3B82F6; }
        .tab-content { background-color: #ffffff; padding: 24px; border-radius: 0 8px 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 600px; overflow-x: auto; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; min-width: 800px; }
        th, td { padding: 12px 8px; border: 1px solid #e5e7eb; text-align: left; word-wrap: break-word; position: relative; white-space: nowrap; font-size: 14px; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; position: sticky; top: 0; z-index: 5; }
        .resizer { position: absolute; top: 0; right: -3px; width: 6px; height: 100%; cursor: col-resize; user-select: none; z-index: 10; }
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .tab-content { padding: 16px; min-height: 400px; }
            .tab-button { padding: 8px 16px; font-size: 14px; }
            table { min-width: 600px; font-size: 12px; }
            th, td { padding: 8px 4px; }
            .grid { gap: 12px; }
            .p-6 { padding: 16px; }
            .text-3xl { font-size: 1.5rem; }
            .text-lg { font-size: 1rem; }
            .flex-wrap { flex-wrap: wrap; }
            .space-x-3 > * + * { margin-left: 8px; }
            .space-x-4 > * + * { margin-left: 12px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 8px; }
            .tab-content { padding: 12px; }
            .tab-button { padding: 6px 12px; font-size: 12px; }
            table { min-width: 500px; font-size: 11px; }
            th, td { padding: 6px 3px; }
            .grid { gap: 8px; }
            .p-6 { padding: 12px; }
            .text-3xl { font-size: 1.25rem; }
            .text-lg { font-size: 0.9rem; }
            .flex { flex-direction: column; }
            .space-x-3 > * + * { margin-left: 0; margin-top: 8px; }
            .space-x-4 > * + * { margin-left: 0; margin-top: 12px; }
        }
        tbody tr:hover { background-color: #f8fafc; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:nth-child(even):hover { background-color: #f1f5f9; }
        input, select, button { border-radius: 6px; }
        input, select { border: 1px solid #d1d5db; padding: 8px; width: 100%; box-sizing: border-box; background-color: #ffffff; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal { background-color: white; padding: 24px; border-radius: 8px; z-index: 50; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="max-w-md w-full space-y-8 p-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">🔐 Atölye Yönetim Sistemi</h1>
                <p class="text-gray-600">Güvenli erişim için şifrenizi girin</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">🔐 Şifre</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Şifrenizi girin">
                    </div>
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        🔓 Sisteme Giriş Yap
                    </button>
                </form>
                <div class="mt-6 text-center">
                    <div class="text-xs text-gray-500">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden by default) -->
    <div id="mainApp" class="hidden">
    <div class="container bg-white rounded-lg shadow-xl p-8">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 space-y-4 lg:space-y-0">
            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Atölye Üretim & Finans Takibi</h1>
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="saveData(true, true)" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-sm">💾 Veri Kaydet</button>
                <button onclick="importData()" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">📥 İçe Aktar</button>
                <button onclick="exportData()" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 text-sm">📤 Dışa Aktar</button>
                <button onclick="testFirebaseConnection()" class="bg-cyan-600 text-white px-3 py-2 rounded-md hover:bg-cyan-700 text-sm">🔥 Firebase</button>
                <button onclick="checkDataLoadingStatus()" class="bg-yellow-600 text-white px-3 py-2 rounded-md hover:bg-yellow-700 text-sm">🐛 Debug</button>
                <button onclick="handleClearAllData()" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 text-sm">🗑️ Temizle</button>
                <button onclick="logout()" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700 text-sm">🚪 Çıkış</button>
            </div>
        </div>

        <div id="tabContainer" class="flex flex-wrap border-b border-gray-200 mb-6">
            <!-- Tabs will be dynamically generated here -->
        </div>

        <!-- All Tab Contents -->
        <div id="dashboard" class="tab-content"></div>
        <div id="cashFlow" class="tab-content hidden"></div>
        <div id="expenses" class="tab-content hidden"></div>
        <div id="suppliers" class="tab-content hidden"></div>
        <div id="customers" class="tab-content hidden"></div>
        <div id="rawMaterials" class="tab-content hidden"></div>
        <div id="materials" class="tab-content hidden"></div>
        <div id="products" class="tab-content hidden"></div>
        <div id="productionLog" class="tab-content hidden"></div>
        <div id="productionPlanning" class="tab-content hidden"></div>
        <div id="stock" class="tab-content hidden"></div>
        <div id="failedPrints" class="tab-content hidden"></div>
        <div id="sales" class="tab-content hidden"></div>
        <div id="parameters" class="tab-content hidden"></div>
    </div>

    <!-- Modals -->
    <div id="addMaterialModal" class="modal-backdrop hidden"></div>
    <div id="updateStockModal" class="modal-backdrop hidden"></div>
    <div id="addSaleModal" class="modal-backdrop hidden"></div>
    <div id="quickSaleModal" class="modal-backdrop hidden"></div>
    <div id="addFailedPrintModal" class="modal-backdrop hidden"></div>
    <div id="accountModal" class="modal-backdrop hidden"></div>
    <div id="customParamModal" class="modal-backdrop hidden"></div>
    <div id="addPaymentModal" class="modal-backdrop hidden"></div>
    <div id="accountDetailModal" class="modal-backdrop hidden"></div>
    <div id="editTransactionModal" class="modal-backdrop hidden"></div>
    <div id="addExpenseModal" class="modal-backdrop hidden"></div>
    <div id="addMoneyModal" class="modal-backdrop hidden"></div>
    <div id="addMaterialItemModal" class="modal-backdrop hidden"></div>
    <div id="addProductionPlanModal" class="modal-backdrop hidden"></div>
    <div id="editProductionPlanModal" class="modal-backdrop hidden"></div>
    <div id="sendToProductionModal" class="modal-backdrop hidden"></div>
    </div> <!-- mainApp kapanış -->
    <div id="messageModal" class="modal-backdrop hidden">
        <div class="modal max-w-sm">
            <h3 id="messageModalTitle" class="text-xl font-semibold mb-4">Uyarı</h3>
            <p id="messageModalText" class="text-gray-700"></p>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('messageModal')" class="bg-blue-600 text-white px-4 py-2 rounded-md">Tamam</button>
            </div>
        </div>
    </div>
     <div id="confirmModal" class="modal-backdrop hidden">
        <div class="modal max-w-sm">
            <h3 id="confirmModalTitle" class="text-xl font-semibold mb-4">Onay</h3>
            <p id="confirmModalText" class="text-gray-700"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirmModalCancel" class="bg-gray-300 px-4 py-2 rounded-md">İptal</button>
                <button id="confirmModalConfirm" class="bg-red-600 text-white px-4 py-2 rounded-md">Onayla</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleFileSelect(event)">


    <script>
        // --- FIREBASE CONFIGURATION ---
        // Firebase konfigürasyonu yukarıda module olarak yüklendi
        
        // --- GLOBAL DATA STORES ---
        let suppliers = [], customers = [], rawMaterials = [], materials = [], products = [], recipes = [], productionLog = [], salesLog = [], accounts = [], payments = [], expenses = [], productionPlans = [], failedPrints = [];
        let parameters = {}; // Will hold core parameters and tabOrder
        let customParameters = []; // Will hold user-defined cost parameters
        
        // Security variables
        let isLoggedIn = false;
        const APP_PASSWORD = 'Dofi1234';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 saat
        
        // Firebase variables
        let firebaseInitialized = false;
        
        // --- SECURITY FUNCTIONS ---
        async function checkLoginStatus() {
            const sessionData = localStorage.getItem('appSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const now = new Date().getTime();
                
                if (now - session.loginTime < SESSION_DURATION) {
                    isLoggedIn = true;
                    showMainApp();
                    return true;
                } else {
                    logout();
                }
            }
            return false;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function logout() {
            isLoggedIn = false;
            localStorage.removeItem('appSession');
            showLoginScreen();
            showNotification('Oturum sonlandırıldı.', 'info', 3000);
        }

        function authenticateUser(password) {
            return password === APP_PASSWORD;
        }

        function requireLogin() {
            if (!isLoggedIn) {
                showLoginScreen();
                showNotification('Bu işlem için giriş yapmanız gerekiyor!', 'warning', 3000);
                return false;
            }
            return true;
        }

        // Firebase bağlantı fonksiyonu
        
        let charts = {}; // To hold chart instances
        let currentOpenAccountId = null; // To track which account detail modal is open
        let draggedTabId = null;
        let currentProductPage = 1; // Current page for product listing
        let productsPerPage = 10; // Products per page
        let expandedProductId = null; // Currently expanded product ID
        
        const LOCAL_DATA_KEY = 'atolyeTracker_local_v30'; // Version incremented
        const BACKUP_DATA_KEY = 'atolyeTracker_backup_v30';
        const AUTO_BACKUP_INTERVAL = 30 * 1000; // 30 saniyede bir otomatik yedekleme
        let lastSaveTime = 0;
        let pendingChanges = false;
        let autoBackupTimer = null;

        const ALL_TABS = [
            { id: 'dashboard', title: 'Gösterge Paneli', renderFunc: renderDashboard },
            { id: 'cashFlow', title: 'Kasa', renderFunc: renderCashFlow },
            { id: 'expenses', title: 'Giderler', renderFunc: renderExpenses },
            { id: 'suppliers', title: 'Tedarikçiler', renderFunc: renderSuppliers },
            { id: 'customers', title: 'Cariler', renderFunc: renderCustomers },
            { id: 'rawMaterials', title: 'Hammaddeler', renderFunc: renderRawMaterials },
            { id: 'materials', title: 'Malzemeler', renderFunc: renderMaterials },
            { id: 'products', title: 'Ürünler', renderFunc: renderProducts },
            { id: 'productionLog', title: 'Üretim Kaydı', renderFunc: renderProductionLog },
            { id: 'productionPlanning', title: 'Planlama Süreci', renderFunc: renderProductionPlanning },
            { id: 'stock', title: 'Stok Takip', renderFunc: renderStockStatus },
            { id: 'failedPrints', title: 'Baskı Hataları', renderFunc: renderFailedPrints },
            { id: 'sales', title: 'Satış Kaydı', renderFunc: renderSalesLog },
            { id: 'parameters', title: 'Parametreler', renderFunc: renderParameters }
        ];

        // --- DATA PERSISTENCE ---
        function saveData(silent = false, force = false) {
            if (!requireLogin()) return;
            const now = Date.now();
            
            // Son kaydetme üzerinden 30 saniye geçmemişse ve zorla kaydetme değilse atla
            if (!force && (now - lastSaveTime) < 30000) {
                pendingChanges = true;
                return;
            }
            
            try {
                const appData = { 
                    suppliers, 
                    customers, 
                    rawMaterials, 
                    products, 
                    recipes, 
                    productionLog, 
                    salesLog, 
                    accounts, 
                    parameters, 
                    customParameters, 
                    payments, 
                    expenses, 
                    materials, 
                    productionPlans, 
                    failedPrints,
                    // Veri bütünlüğü için export bilgisi
                    lastSaved: new Date().toISOString(),
                    version: "v30"
                };
                
                // Local storage'a kaydet
            localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify(appData));
            
            // Firebase'e kaydet
            saveDataToFirebase(appData);
            
            // Otomatik yedekleme
            createAutoBackup();
            
            lastSaveTime = now;
            pendingChanges = false;
            
            // Sessiz kaydetme değilse bildirim göster
            if (!silent) {
                showNotification('💾 Veriler kaydedildi', 'success', 2000);
                }
            } catch (error) {
                console.error('Veri kaydetme hatası:', error);
                if (!silent) {
                    showNotification('❌ Veri kaydetme hatası: ' + error.message, 'error', 5000);
                }
            }
        }
        
        // Akıllı kaydetme sistemi
        function smartSave() {
            if (pendingChanges) {
                saveData(true, true); // Sessiz ve zorla kaydet
            } else {
                // Her durumda Firebase'e gönder
                saveDataToFirebase({
                    suppliers, customers, rawMaterials, products, recipes, 
                    productionLog, salesLog, accounts, parameters, customParameters, 
                    payments, expenses, materials, productionPlans, failedPrints
                });
            }
        }

        // Firebase veri kaydetme
        function saveDataToFirebase(data) {
            try {
                if (window.firebaseDatabase) {
                    // Her zaman güncel timestamp ekle
                    const dataWithTimestamp = {
                        ...data,
                        lastSaved: new Date().toISOString(),
                        version: "v30"
                    };
                    
                    const dataRef = window.firebaseDatabase.ref('workshopData');
                    dataRef.set(dataWithTimestamp)
                        .then(() => {
                            console.log('Veriler Firebase\'e kaydedildi - Timestamp:', dataWithTimestamp.lastSaved);
                        })
                        .catch((error) => {
                            console.error('Firebase kaydetme hatası:', error);
                        });
                }
            } catch (error) {
                console.error('Firebase bağlantı hatası:', error);
            }
        }

        // Firebase'den veri yükleme
        function loadDataFromFirebase() {
            try {
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseDatabase.ref('workshopData');
                    dataRef.once('value').then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            console.log('Firebase\'den veri yüklendi:', data);
                            
                            // Local storage'daki veri ile karşılaştır
                            const localData = localStorage.getItem(LOCAL_DATA_KEY);
                            if (localData) {
                                try {
                                    const parsedLocalData = JSON.parse(localData);
                                    const localTimestamp = parsedLocalData.lastSaved ? new Date(parsedLocalData.lastSaved).getTime() : 0;
                                    const firebaseTimestamp = data.lastSaved ? new Date(data.lastSaved).getTime() : 0;
                                    
                                    console.log('Local timestamp:', localTimestamp, 'Firebase timestamp:', firebaseTimestamp);
                                    
                                    // Sadece Firebase verisi daha yeniyse yükle
                                    if (firebaseTimestamp > localTimestamp) {
                                        console.log('Firebase verisi daha güncel, yükleniyor');
                                        applyState(data);
                                        // Sadece aktif tab'ı render et
                                        const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId;
                                        if (activeTabId) {
                                            const tabInfo = ALL_TABS.find(t => t.id === activeTabId);
                                            if (tabInfo && tabInfo.renderFunc) {
                                                tabInfo.renderFunc();
                                            }
                                        }
                                        console.log('Veriler Firebase\'den başarıyla yüklendi');
                                    } else {
                                        console.log('Local veri daha güncel veya eşit, Firebase verisi yüklenmedi');
                                    }
                                } catch (e) {
                                    console.error('Local veri parse hatası:', e);
                                    // Hata varsa Firebase verisini yükle
                                    applyState(data);
                                }
                            } else {
                                // Local veri yoksa Firebase verisini yükle
                                applyState(data);
                                // Sadece aktif tab'ı render et
                                const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId;
                                if (activeTabId) {
                                    const tabInfo = ALL_TABS.find(t => t.id === activeTabId);
                                    if (tabInfo && tabInfo.renderFunc) {
                                        tabInfo.renderFunc();
                                    }
                                }
                                console.log('Veriler Firebase\'den başarıyla yüklendi');
                            }
                        } else {
                            console.log('Firebase\'de veri bulunamadı, local veri yükleniyor');
                            loadData();
                        }
                    }).catch((error) => {
                        console.error('Firebase veri yükleme hatası:', error);
                        loadData();
                    });
                } else {
                    console.log('Firebase bağlantısı yok, local veri yükleniyor');
                    loadData();
                }
            } catch (error) {
                console.error('Firebase yükleme hatası:', error);
                loadData();
            }
        }

        // Firebase'den veri çek
        function downloadFromFirebase() {
            if (!window.firebaseDatabase) {
                showMessageModal("Hata", "Firebase bağlantısı kurulamadı. Lütfen önce Firebase Test butonuna tıklayın.");
                return;
            }

            try {
                const dataRef = window.firebaseDatabase.ref('workshopData');
                dataRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // Veriyi local storage'a kaydet
                            localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify(data));
                            
                            // Veriyi uygulamaya yükle
                            applyState(data);
                            renderAllTabsAndModals();
                            
                            showMessageModal("Başarılı", "Veriler Firebase'den başarıyla çekildi ve uygulamaya yüklendi!");
                        } else {
                            showMessageModal("Bilgi", "Firebase'de veri bulunamadı.");
                        }
                    })
                    .catch((error) => {
                        console.error('Firebase veri çekme hatası:', error);
                        showMessageModal("Hata", "Firebase'den veri çekilemedi: " + error.message);
                    });
            } catch (error) {
                console.error('Firebase bağlantı hatası:', error);
                showMessageModal("Hata", "Firebase bağlantı hatası: " + error.message);
            }
        }

        // Firebase'e veri yükle
        function uploadToFirebase() {
            if (!window.firebaseDatabase) {
                showMessageModal("Hata", "Firebase bağlantısı kurulamadı. Lütfen önce Firebase Test butonuna tıklayın.");
                return;
            }

            try {
                const appData = { 
                    suppliers, 
                    customers, 
                    rawMaterials, 
                    products, 
                    recipes, 
                    productionLog, 
                    salesLog, 
                    accounts, 
                    parameters, 
                    customParameters, 
                    payments, 
                    expenses, 
                    materials, 
                    productionPlans,
                    failedPrints
                };
                
                const dataRef = window.firebaseDatabase.ref('workshopData');
                dataRef.set(appData)
                    .then(() => {
                        showMessageModal("Başarılı", "Veriler Firebase'e başarıyla yüklendi!");
                        console.log('Veriler Firebase\'e yüklendi');
                    })
                    .catch((error) => {
                        console.error('Firebase veri yükleme hatası:', error);
                        showMessageModal("Hata", "Firebase'e veri yüklenemedi: " + error.message);
                    });
            } catch (error) {
                console.error('Firebase bağlantı hatası:', error);
                showMessageModal("Hata", "Firebase bağlantı hatası: " + error.message);
            }
        }

        // Firebase bağlantısını test et
        function testFirebaseConnection() {
            // Önce Firebase'i başlatmayı dene
            if (!window.firebaseDatabase) {
                console.log('Firebase başlatılmamış, başlatılıyor...');
                initializeFirebase();
            }
            
            if (window.firebaseDatabase) {
                console.log('Firebase bağlantısı başarılı!');
                showMessageModal("Başarılı", "Firebase bağlantısı kuruldu! Verileriniz artık cloud'da saklanıyor.");
                return true;
            } else {
                console.log('Firebase bağlantısı kurulamadı!');
                showMessageModal("Hata", "Firebase bağlantısı kurulamadı. Lütfen sayfayı yenileyin.");
                return false;
            }
        }

        // Tarayıcı uyumluluğunu kontrol et
        function checkBrowserCompatibility() {
            const userAgent = navigator.userAgent;
            const isEdge = userAgent.includes('Edg/');
            const isChrome = userAgent.includes('Chrome/');
            const isFirefox = userAgent.includes('Firefox/');
            
            console.log('Tarayıcı:', userAgent);
            console.log('Edge:', isEdge);
            console.log('Chrome:', isChrome);
            console.log('Firefox:', isFirefox);
            
            if (isEdge) {
                console.log('Edge tarayıcısı tespit edildi - uyumluluk modu aktif');
            }
        }

        // Veri yükleme durumunu kontrol et
        function checkDataLoadingStatus() {
            console.log('Veri yükleme durumu:');
            console.log('- Suppliers:', suppliers.length);
            console.log('- Customers:', customers.length);
            console.log('- Products:', products.length);
            console.log('- Production Plans:', productionPlans.length);
            console.log('- Firebase Database:', window.firebaseDatabase ? 'Mevcut' : 'Yok');
        }

        function createAutoBackup() {
            const appData = { suppliers, customers, rawMaterials, products, recipes, productionLog, salesLog, accounts, parameters, customParameters, payments, expenses, materials, productionPlans, failedPrints };
            const backupData = {
                ...appData,
                backupDate: new Date().toISOString(),
                version: 'v30'
            };
            localStorage.setItem(BACKUP_DATA_KEY, JSON.stringify(backupData));
        }

        function startAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
            }
            autoBackupTimer = setInterval(() => {
                smartSave(); // Akıllı kaydetme
                createAutoBackup();
                console.log('Otomatik yedekleme tamamlandı:', new Date().toLocaleString('tr-TR'));
            }, AUTO_BACKUP_INTERVAL);
        }

        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
        }


        function loadData() {
            // Önce local veriyi yükle (Edge uyumluluğu için)
            const savedData = localStorage.getItem(LOCAL_DATA_KEY);
            if(savedData) {
                try {
                applyState(JSON.parse(savedData));
                    console.log('Local veriler yüklendi');
                } catch (error) {
                    console.error('Local veri yükleme hatası:', error);
                    loadDefaultData();
                }
            } else {
                loadDefaultData();
            }
            
            // Sonra Firebase'den yüklemeyi dene (eğer varsa)
            setTimeout(() => {
                loadDataFromFirebase();
            }, 1000);
        }

        function loadDefaultData() {
            const defaultData = { 
                "suppliers": [], 
                "customers": [], 
                "rawMaterials": [], 
                "products": [], 
                "recipes": [], 
                "productionLog": [], 
                "salesLog": [], 
                "payments": [], 
                "expenses": [], 
                "materials": [], 
                "productionPlans": [], 
                "failedPrints": [],
                "customParameters": [],
                "parameters": { 
                    "machineKw": 0.095, 
                    "electricityKwhPrice": 0.48, 
                    "machineInitialCost": 20000, 
                    "machineLifespanHours": 10000, 
                    "laborCostPerProduct": 0, 
                    "failedPrintRate": 3, 
                    "profitMargin": 0,
                    "tabOrder": ALL_TABS.map(t => t.id)
                } 
            };
                if (!defaultData.accounts || defaultData.accounts.length === 0) {
                    defaultData.accounts = [{ id: 'cash-default', type: 'nakit', name: 'Nakit Kasa', initialBalance: 0 }];
                }
                applyState(defaultData);
                saveData(); 
        }
        
        function applyState(appData) {
            console.log('Veri yükleniyor:', appData);
            
            suppliers = appData.suppliers || [];
            customers = appData.customers || [];
            rawMaterials = appData.rawMaterials || [];
            materials = appData.materials || [];
            products = appData.products || [];
            recipes = appData.recipes || []; // Kept for migration
            productionLog = appData.productionLog || [];
            salesLog = appData.salesLog || [];
            accounts = appData.accounts || [];
            payments = appData.payments || [];
            expenses = appData.expenses || [];
            productionPlans = appData.productionPlans || [];
            failedPrints = appData.failedPrints || [];
            parameters = appData.parameters || {};
            customParameters = appData.customParameters || [];
            
            // tabOrder için güvenli erişim
            if (!parameters.tabOrder || parameters.tabOrder.length === 0) {
                parameters.tabOrder = ALL_TABS.map(t => t.id);
            }
            
            console.log('Yeni renk sistemi ile products:', products);

            if (!parameters.tabOrder) {
                parameters.tabOrder = ALL_TABS.map(t => t.id);
            }
            
            // Başarısız baskı oranını %3 olarak güncelle
            if (parameters.failedPrintRate === 20) {
                parameters.failedPrintRate = 3;
            }
            
            // --- DATA MIGRATION from older versions ---
            products.forEach(p => {
                if (p.hasOwnProperty('printTime') || p.hasOwnProperty('filamentUsage')) { 
                    if (!p.variants || p.variants.length === 0) {
                        p.variants = [{ id: crypto.randomUUID(), name: 'Ana Parça', printTime: p.printTime || 0, filamentUsage: p.filamentUsage || 0 }];
                    }
                    delete p.printTime;
                    delete p.filamentUsage;
                }
                
                // Migrate variants to new color system
                if (p.variants) {
                    p.variants.forEach(variant => {
                        // Eğer variant'ta colors array'i yoksa oluştur
                        if (!variant.colors) {
                            variant.colors = [];
                        }
                        
                        // Eski filamentOption'ları colors'a migrate et
                        for (let i = 1; i <= 5; i++) {
                            const filamentOptionId = `filamentOption${i}`;
                            if (variant[filamentOptionId]) {
                                const filament = rawMaterials.find(rm => rm.id === variant[filamentOptionId]);
                                if (filament && !variant.colors.find(c => c.filamentId === variant[filamentOptionId])) {
                                    variant.colors.push({
                                        name: `Renk ${i}`,
                                        filamentId: variant[filamentOptionId],
                                        gram: 0 // Default gram değeri
                                    });
                                }
                                delete variant[filamentOptionId];
                            }
                        }
                    });
                }
                
                // Migrate recipes to product.extraMaterials
                const productRecipe = recipes.find(r => r.productId === p.id);
                if (productRecipe && !p.extraMaterials) {
                    p.extraMaterials = productRecipe.materials.map(m => ({...m}));
                }
            });
            
            console.log('Migration sonrası products:', products);
            // After migration, we can potentially clear the old recipes array
            // recipes = []; 

            productionLog.forEach(entry => { 
                // MIGRATION: Ensure older production logs have a variantId
                if (!entry.variantId) {
                    const product = products.find(p => p.id === entry.productId);
                    if (product && product.variants && product.variants.length > 0) {
                        entry.variantId = product.variants[0].id; // Default to the first variant
                    }
                }

                if (!entry.customValues) entry.customValues = {}; 
                // Migrate materialAssignments to filamentOverrideId
                if(entry.materialAssignments && !entry.filamentOverrideId){
                    const firstFilament = entry.materialAssignments[0];
                    if(firstFilament) entry.filamentOverrideId = firstFilament.rawMaterialId;
                    delete entry.materialAssignments;
                }
                 if (!entry.filamentOverrideId) entry.filamentOverrideId = '';
            });

            rawMaterials.forEach(rm => {
                if (rm.stockHistory) {
                    rm.stockHistory.forEach(h => {
                        if (!h.id) h.id = crypto.randomUUID();
                    });
                }
                // Fix minStock data type
                if (typeof rm.minStock === 'string') {
                    rm.minStock = parseFloat(rm.minStock) || 0;
                }
            });
            
            // Ensure accounts have transactions array
            accounts.forEach(account => {
                if (!account.transactions) {
                    account.transactions = [];
                    console.log('🔍 Hesap transaction array\'i oluşturuldu:', account.name);
                }
            });
            
            // Veri bütünlüğü kontrolü
            validateDataIntegrity();
        }

        // Veri bütünlüğü kontrolü
        function validateDataIntegrity() {
            console.log('🔍 Veri Bütünlüğü Kontrolü:');
            
            // Tüm gerekli array'lerin var olduğunu kontrol et
            const dataArrays = {
                suppliers, customers, rawMaterials, materials, 
                products, productionLog, salesLog, accounts, 
                payments, expenses, productionPlans, failedPrints
            };
            
            Object.entries(dataArrays).forEach(([arrayName, arrayValue]) => {
                if (!arrayValue) {
                    console.warn(`⚠️ ${arrayName} array'i bulunamadı!`);
                } else if (!Array.isArray(arrayValue)) {
                    console.warn(`⚠️ ${arrayName} array değil!`);
                } else {
                    console.log(`✅ ${arrayName}: ${arrayValue.length} kayıt`);
                }
            });
            
            // Hesap transaction'larını kontrol et
            if (accounts && Array.isArray(accounts)) {
                accounts.forEach(account => {
                    if (!account.transactions) {
                        console.warn(`⚠️ ${account.name} hesabında transaction array'i yok!`);
                        account.transactions = [];
                    }
                });
            }
            
            // Ürün varyantlarını kontrol et
            if (products && Array.isArray(products)) {
                products.forEach(product => {
                    if (!product.variants) {
                        console.warn(`⚠️ ${product.name} ürününde variants array'i yok!`);
                        product.variants = [];
                    }
                });
            }
            
            console.log('🔍 Veri bütünlüğü kontrolü tamamlandı.');
        }

        function handleClearAllData() {
            if (!requireLogin()) return;
            showConfirmModal(
                "Tüm Verileri Sil",
                "Emin misiniz? Bu tarayıcıdaki TÜM VERİLER kalıcı olarak silinecek. Bu işlem geri alınamaz.",
                () => {
                    localStorage.removeItem(LOCAL_DATA_KEY);
                    location.reload();
                }
            );
        }
        
        function showMessageModal(title, message) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalText').textContent = message;
            showModal('messageModal');
        }
        
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = message;
            
            const confirmBtn = document.getElementById('confirmModalConfirm');
            const cancelBtn = document.getElementById('confirmModalCancel');

            // Clone and replace to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };

            cancelBtn.onclick = () => closeModal('confirmModal');

            showModal('confirmModal');
        }



        // --- AUTOCOMPLETE SYSTEM ---
        function createAutocomplete(inputElement, dataSource, displayField = 'name', valueField = 'id') {
            let currentFocus = -1;
            let suggestions = [];
            
            // Autocomplete container
            const container = document.createElement('div');
            container.className = 'autocomplete-container relative';
            inputElement.parentNode.insertBefore(container, inputElement);
            container.appendChild(inputElement);
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'autocomplete-suggestions hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-y-auto';
            container.appendChild(suggestionsDiv);
            
            inputElement.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                suggestions = dataSource.filter(item => 
                    item[displayField].toLowerCase().includes(value)
                ).slice(0, 10); // Max 10 öneri
                
                currentFocus = -1;
                showSuggestions();
            });
            
            inputElement.addEventListener('keydown', function(e) {
                if (!suggestionsDiv.classList.contains('hidden')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        currentFocus = Math.min(currentFocus + 1, suggestions.length - 1);
                        updateActiveSuggestion();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        currentFocus = Math.max(currentFocus - 1, -1);
                        updateActiveSuggestion();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (currentFocus >= 0) {
                            selectSuggestion(suggestions[currentFocus]);
                        }
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                }
            });
            
            // Input dışına tıklandığında önerileri gizle
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    hideSuggestions();
                }
            });
            
            function showSuggestions() {
                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                suggestionsDiv.innerHTML = suggestions.map((item, index) => 
                    `<div class="suggestion-item px-3 py-2 cursor-pointer hover:bg-gray-100 ${index === currentFocus ? 'bg-blue-100' : ''}" 
                         data-index="${index}" data-value="${item[valueField]}">
                        ${item[displayField]}
                    </div>`
                ).join('');
                
                // Click events
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selectSuggestion(suggestions[index]);
                    });
                });
                
                suggestionsDiv.classList.remove('hidden');
            }
            
            function hideSuggestions() {
                suggestionsDiv.classList.add('hidden');
                currentFocus = -1;
            }
            
            function updateActiveSuggestion() {
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
                    item.classList.toggle('bg-blue-100', index === currentFocus);
                });
            }
            
            function selectSuggestion(item) {
                inputElement.value = item[displayField];
                inputElement.dataset.selectedValue = item[valueField];
                hideSuggestions();
                
                // Custom event dispatch
                inputElement.dispatchEvent(new CustomEvent('autocomplete-select', {
                    detail: { selectedItem: item }
                }));
            }
        }

        // --- NOTIFICATION SYSTEM ---
        function showNotification(message, type = 'info', duration = 4000) {
            // Mevcut bildirimleri kaldır
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm transition-all duration-300 transform translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-black',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-lg leading-none opacity-70 hover:opacity-100">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animasyon için timeout
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Otomatik kapatma
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        // --- IMPORT / EXPORT ---
        function exportData() {
            if (!requireLogin()) return;
            // Debug: Hesap bilgilerini kontrol et
            console.log('Export öncesi hesap bilgileri:');
            accounts.forEach(account => {
                console.log(`Hesap: ${account.name}, Transactions: ${account.transactions?.length || 0}`);
                if (account.transactions) {
                    account.transactions.forEach(tx => {
                        console.log(`  - ${tx.type}: ${tx.amount} TL (${tx.description})`);
                    });
                }
            });
            
            const appData = { 
                suppliers, 
                customers, 
                rawMaterials, 
                products, 
                recipes, // recipes eksikti!
                productionLog, 
                salesLog, 
                accounts, 
                parameters, 
                customParameters, 
                payments, 
                expenses, 
                materials, 
                productionPlans, 
                failedPrints, // Baskı hataları eklendi
                // Yeni eklenen veri türleri
                variants: products.flatMap(p => p.variants || []),
                colors: products.flatMap(p => p.variants?.flatMap(v => v.colors || []) || []),
                // Export tarihi ve versiyon bilgisi
                exportInfo: {
                    timestamp: new Date().toISOString(),
                    version: "v30",
                    totalProducts: products.length,
                    totalVariants: products.reduce((sum, p) => sum + (p.variants?.length || 0), 0),
                    totalColors: products.reduce((sum, p) => sum + (p.variants?.reduce((vSum, v) => vSum + (v.colors?.length || 0), 0) || 0), 0),
                    totalAccounts: accounts.length,
                    totalAccountTransactions: accounts.reduce((sum, a) => sum + (a.transactions?.length || 0), 0),
                    totalPayments: payments.length,
                    totalExpenses: expenses.length,
                    totalSales: salesLog.length,
                    totalProductionLog: productionLog.length,
                    totalFailedPrints: failedPrints.length // Baskı hataları sayısı eklendi
                }
            };
            const dataStr = JSON.stringify(appData, null, 2);
            const now = new Date();
            const timestamp = `${now.getFullYear().toString().padStart(4, '0')}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            const filename = `atolye_verileri_${timestamp}.json`;
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            // Başarılı export bildirimi
            showNotification(`Veriler başarıyla dışa aktarıldı!<br>
                📊 ${appData.exportInfo.totalProducts} ürün<br>
                🔧 ${appData.exportInfo.totalVariants} varyant<br>
                🎨 ${appData.exportInfo.totalColors} renk<br>
                💰 ${appData.exportInfo.totalAccounts} hesap<br>
                📋 ${appData.exportInfo.totalAccountTransactions} hesap hareketi<br>
                💸 ${appData.exportInfo.totalPayments} tahsilat<br>
                📉 ${appData.exportInfo.totalExpenses} gider<br>
                🛒 ${appData.exportInfo.totalSales} satış<br>
                🏭 ${appData.exportInfo.totalProductionLog} üretim kaydı<br>
                💾 Dosya: ${filename}`, 'success');
        }

        function importData() {
            if (!requireLogin()) return;
            document.getElementById('importFile').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object' && importedData.parameters) {
                        showConfirmModal(
                            "Verileri İçe Aktar",
                            "Mevcut veriler, yüklediğiniz dosyadaki verilerle değiştirilecektir. Onaylıyor musunuz?",
                            () => {
                                // Debug: Import öncesi hesap bilgilerini kontrol et
                                console.log('Import öncesi hesap bilgileri:');
                                if (importedData.accounts) {
                                    importedData.accounts.forEach(account => {
                                        console.log(`Import - Hesap: ${account.name}, Transactions: ${account.transactions?.length || 0}`);
                                        if (account.transactions) {
                                            account.transactions.forEach(tx => {
                                                console.log(`  - ${tx.type}: ${tx.amount} TL (${tx.description})`);
                                            });
                                        }
                                    });
                                }
                                
                                applyState(importedData);
                                saveData(true, true); // Zorla Firebase'e gönder
                                renderAllTabsAndModals();
                                
                                // Import bilgilerini göster
                                const importInfo = importedData.exportInfo || {};
                                showNotification(`Veriler başarıyla içe aktarıldı!<br>
                                    📊 ${importInfo.totalProducts || 'Bilinmiyor'} ürün<br>
                                    🔧 ${importInfo.totalVariants || 'Bilinmiyor'} varyant<br>
                                    🎨 ${importInfo.totalColors || 'Bilinmiyor'} renk<br>
                                    💰 ${importInfo.totalAccounts || 'Bilinmiyor'} hesap<br>
                                    📋 ${importInfo.totalAccountTransactions || 'Bilinmiyor'} hesap hareketi<br>
                                    💸 ${importInfo.totalPayments || 'Bilinmiyor'} tahsilat<br>
                                    📉 ${importInfo.totalExpenses || 'Bilinmiyor'} gider<br>
                                    🛒 ${importInfo.totalSales || 'Bilinmiyor'} satış<br>
                                    🏭 ${importInfo.totalProductionLog || 'Bilinmiyor'} üretim kaydı<br>
                                    📅 ${importInfo.timestamp ? new Date(importInfo.timestamp).toLocaleString('tr-TR') : 'Bilinmiyor'}`, 'success');
                            }
                        );
                    } else {
                        showMessageModal("Hata", "Geçersiz dosya formatı.");
                    }
                } catch (error) {
                    showMessageModal("Hata", "Dosya okunurken bir hata oluştu: " + error.message);
                } finally {
                    document.getElementById('importFile').value = '';
                }
            };
            reader.readAsText(file);
        }


        // --- RENDER FUNCTIONS ---
        function getAccountHTML(account) { return `<div class="card removable" data-id="${account.id}"><div class="card-header"><input type="text" value="${account.name}" onchange="updateAccountName('${account.id}', this.value)" class="text-lg font-semibold border-none w-1/2 p-0"><button onclick="openEditAccountModal('${account.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">Düzenle</button><button onclick="removeElement(this, 'account')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></div><p class="text-2xl font-bold">${calculateAccountSummary(account.id).currentBalance.toFixed(2)} TL</p><div class="flex space-x-2 mt-2"><button onclick="openAddMoneyModal('${account.id}')" class="bg-green-600 text-white px-3 py-1 text-xs rounded-md hover:bg-green-700">💰 Para Ekle</button><button onclick="renderAccountDetails('${account.id}')" class="bg-blue-500 text-white px-2 py-1 text-xs rounded-md">Detaylar</button></div></div>`; }
        function getSupplierHTML(supplier) {
            let materialsHTML = (supplier.materials || []).map(mat => {
                const filamentTypeOptions = ['PLA', 'PETG', 'ABS'].map(type => 
                    `<option value="${type}" ${mat.type === type ? 'selected' : ''}>${type}</option>`
                ).join('');
                
                return `
                <tr class="removable" data-id="${mat.id}">
                    <td><input type="text" value="${mat.name || 'Filament'}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'name', this.value)" tabindex="1"></td>
                    <td><input type="text" value="${mat.brand}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'brand', this.value)" tabindex="2"></td>
                    <td><input type="text" value="${mat.color}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'color', this.value)" tabindex="3"></td>
                    <td>
                        <select onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'type', this.value)" tabindex="4">
                            <option value="PLA" ${mat.type === 'PLA' ? 'selected' : ''}>PLA</option>
                            <option value="PETG" ${mat.type === 'PETG' ? 'selected' : ''}>PETG</option>
                            <option value="ABS" ${mat.type === 'ABS' ? 'selected' : ''}>ABS</option>
                        </select>
                    </td>
                    <td><input type="text" value="${mat.unit}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'unit', this.value)" tabindex="5"></td>
                    <td><input type="number" step="0.01" value="${mat.price}" onchange="updateSupplierMaterialField('${supplier.id}', '${mat.id}', 'price', this.value)" tabindex="6"></td>
                    <td><button onclick="removeElement(this, 'supplierMaterial', '${supplier.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="7">Sil</button></td>
                </tr>
            `;
            }).join('');
            
            return `
                <div class="card removable" data-id="${supplier.id}">
                    <div class="card-header">
                        <h3 class="text-xl font-bold">${supplier.name}</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleSupplierDetails('${supplier.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm" tabindex="15">Bilgiler</button>
                            <button onclick="removeElement(this.closest('.removable'), 'supplier')" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm" tabindex="16">Sil</button>
                        </div>
                    </div>
                    <div id="supplier-details-${supplier.id}" class="hidden space-y-2 text-sm mt-4 pt-4 border-t border-gray-200">
                        <input type="text" value="${supplier.name}" onchange="updateSupplierField('${supplier.id}', 'name', this.value)" placeholder="Tedarikçi Adı" tabindex="8">
                        <input type="text" value="${supplier.contactPerson || ''}" onchange="updateSupplierField('${supplier.id}', 'contactPerson', this.value)" placeholder="Muhatap Adı" tabindex="9">
                        <input type="text" value="${supplier.phone || ''}" onchange="updateSupplierField('${supplier.id}', 'phone', this.value)" placeholder="Telefon" tabindex="10">
                        <input type="text" value="${supplier.email || ''}" onchange="updateSupplierField('${supplier.id}', 'email', this.value)" placeholder="E-posta" tabindex="11">
                        <input type="text" value="${supplier.website || ''}" onchange="updateSupplierField('${supplier.id}', 'website', this.value)" placeholder="Web Sitesi" tabindex="12">
                        <input type="text" value="${supplier.city || ''}" onchange="updateSupplierField('${supplier.id}', 'city', this.value)" placeholder="Şehir" tabindex="13">
                        <input type="text" value="${supplier.iban || ''}" onchange="updateSupplierField('${supplier.id}', 'iban', this.value)" placeholder="IBAN" tabindex="14">
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Ürün Kataloğu</h4>
                        <table class="resizable-table w-full">
                            <thead>
                                <tr>
                                    <th>Adı</th>
                                    <th>Marka</th>
                                    <th>Renk</th>
                                    <th>Tür</th>
                                    <th>Birim</th>
                                    <th>Fiyat (TL)</th>
                                    <th>Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${materialsHTML}
                            </tbody>
                        </table>
                        <button onclick="addMaterialToSupplier('${supplier.id}')" class="mt-2 bg-green-600 text-white px-3 py-1 text-sm rounded-md">Ürün Ekle</button>
                    </div>
                </div>
            `;
        }
        function getCustomerHTML(customer) {
            const balance = calculateCustomerBalance(customer.id);
            const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-600';
            return `
                <div class="card removable" data-id="${customer.id}">
                    <details>
                        <summary class="cursor-pointer">
                            <div class="card-header">
                                <input type="text" value="${customer.name}" onchange="updateCustomerField('${customer.id}', 'name', this.value)" class="text-lg font-bold" placeholder="Firma / Müşteri Adı">
                                <button onclick="removeElement(this.closest('.removable'), 'customer')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                            </div>
                            <div class="space-y-2 text-sm">
                                <input type="text" value="${customer.contactPerson || ''}" onchange="updateCustomerField('${customer.id}', 'contactPerson', this.value)" placeholder="Muhatap Adı">
                                <input type="text" value="${customer.phone || ''}" onchange="updateCustomerField('${customer.id}', 'phone', this.value)" placeholder="Telefon">
                                <input type="text" value="${customer.address || ''}" onchange="updateCustomerField('${customer.id}', 'address', this.value)" placeholder="Adres">
                                <p class="font-semibold pt-2">Bakiye: <span class="${balanceColor}">${balance.toFixed(2)} TL</span></p>
                            </div>
                        </summary>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                             <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold">Satılan Ürünler</h4>
                                <div>
                                    <button onclick="openAddPaymentModal('${customer.id}')" class="bg-green-600 text-white px-3 py-1 text-sm rounded-md mr-2">Ödeme Al</button>
                                    <button onclick="generateDeliveryNote('${customer.id}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md">İrsaliye Yazdır</button>
                                </div>
                            </div>
                            ${getCustomerSalesHTML(customer.id)}
                        </div>
                    </details>
                </div>`;
        }
        function getRawMaterialHTML(mat) { 
            const currentStock = mat.currentStock || 0;
            const isLowStock = currentStock < 1000;
            const rowClass = isLowStock ? 'removable bg-red-50 border-l-4 border-red-400' : 'removable';
            const stockCellClass = isLowStock ? 'text-red-600 font-bold' : '';
            
            return `<tr class="${rowClass}" data-id="${mat.id}">
                <td>${mat.name}</td>
                <td>${mat.brand}</td>
                <td>${mat.color}</td>
                <td>${mat.type}</td>
                <td><input type="number" value="${mat.minStock}" onchange="updateRawMaterialField('${mat.id}', 'minStock', this.value)"></td>
                <td class="${stockCellClass}">${currentStock.toFixed(3)} ${isLowStock ? '⚠️' : ''}</td>
                <td>${mat.unit}</td>
                <td>${(mat.averageCost || 0).toFixed(2)}</td>
                <td class="flex space-x-2">
                    <button onclick="openUpdateStockModal('${mat.id}')" class="bg-green-500 text-white px-3 py-1 text-sm rounded-md">Stok Güncelle</button>
                    <button onclick="removeElement(this, 'rawMaterial')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-md">Sil</button>
                </td>
            </tr>`; 
        }
        function getSimpleProductHTML(product) {
            const totals = calculateProductTotals(product);
            const isExpanded = expandedProductId === product.id;
            
            // Ürünün toplam maliyetini hesapla
            let totalCost = 0;
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => {
                    const variantCost = calculateProductUnitCost(product.id, variant.id, 0, {}, '');
                    totalCost += variantCost;
                });
            }
            
            return `<div class="card hover:shadow-lg transition-shadow removable" data-id="${product.id}">
                <div class="card-header cursor-pointer" onclick="toggleProductExpansion('${product.id}')">
                    <div class="flex items-center justify-between">
                        <input type="text" value="${product.name}" 
                               onchange="updateProductField('${product.id}', 'name', this.value)" 
                               onclick="event.stopPropagation()"
                               class="text-lg font-semibold bg-transparent border-none p-0 focus:bg-white focus:border focus:border-gray-300 focus:px-2 focus:py-1 focus:rounded"
                               tabindex="1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${totals.totalPrintTime.toFixed(2)} saat</span>
                            <span class="text-sm text-gray-600">${totals.totalFilamentUsage.toFixed(2)} gr</span>
                            <span class="text-sm text-red-600 font-semibold">${totalCost.toFixed(2)} TL</span>
                            <span class="text-xs text-gray-500">${(product.variants || []).length} varyant</span>
                            ${isExpanded ? '<span class="text-xs">▼</span>' : '<span class="text-xs">▶</span>'}
                        </div>
                    </div>
                </div>
                ${isExpanded ? getProductDetailsHTML(product) : ''}
            </div>`;
        }
        
        function getProductDetailsHTML(product) {
            const totals = calculateProductTotals(product);
            
            // Get all filament materials for dropdown
            const filamentMaterials = (rawMaterials || []).filter(rm => rm.name && rm.name.toLowerCase().includes('filament'));
            const filamentOptions = filamentMaterials.map(fil => 
                `<option value="${fil.id}">${fil.brand} - ${fil.color} (${fil.type})</option>`
            ).join('');
            
            const variantRows = (product.variants || []).map(v => {
                // Renk seçenekleri için alanlar
                const colors = v.colors || [];
                const colorRows = colors.map((color, index) => {
                    const colorOptions = filamentMaterials.map(fil => 
                        `<option value="${fil.id}" ${color.filamentId === fil.id ? 'selected' : ''}>${fil.brand} - ${fil.color} (${fil.type})</option>`
                    ).join('');
                    
                    return `
                        <tr class="text-xs">
                            <td class="px-2 py-1">
                                <input type="text" value="${color.name}" placeholder="Renk adı" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'name', this.value)" 
                                       class="w-20 text-xs" tabindex="7">
                            </td>
                            <td class="px-2 py-1">
                                <select onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'filamentId', this.value)" class="text-xs" tabindex="8">
                                    <option value="">Filament Seçin</option>
                                    ${colorOptions}
                                </select>
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" step="0.01" value="${color.gram}" placeholder="Gram" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'gram', this.value)" 
                                       class="w-16 text-xs" tabindex="9">
                            </td>
                            <td class="px-2 py-1">
                                <button onclick="removeVariantColor('${product.id}', '${v.id}', ${index})" 
                                        class="bg-red-500 text-white px-1 py-0.5 text-xs rounded" tabindex="10">Sil</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                return `<tr class="removable" data-id="${v.id}">
                    <td><input type="text" value="${v.name}" onchange="updateProductVariant('${product.id}', '${v.id}', 'name', this.value)" tabindex="4"></td>
                    <td><input type="number" step="0.01" value="${v.printTime}" onchange="updateProductVariant('${product.id}', '${v.id}', 'printTime', this.value)" tabindex="5"></td>
                    <td colspan="3">
                        <div class="mb-2">
                            <button onclick="addVariantColor('${product.id}', '${v.id}')" 
                                    class="bg-blue-500 text-white px-2 py-1 text-xs rounded" tabindex="6">Renk Ekle</button>
                        </div>
                        <table class="w-full text-xs border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 py-1">Renk Adı</th>
                                    <th class="px-2 py-1">Filament</th>
                                    <th class="px-2 py-1">Gram</th>
                                    <th class="px-2 py-1">Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${colorRows}
                            </tbody>
                        </table>
                    </td>
                    <td><button onclick="removeElement(this, 'productVariant', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="11">Sil</button></td>
                </tr>`;
            }).join('');
            let extraMaterialsHTML = '';
            if (product.extraMaterials) {
                const extraMaterialRows = product.extraMaterials.map(mat => { const materialOptions = (rawMaterials || []).map(rm => `<option value="${rm.id}" ${mat.rawMaterialId === rm.id ? 'selected' : ''}>${rm.name} - ${rm.brand} (${rm.color})</option>`).join(''); return `<tr class="removable" data-id="${mat.id}"><td><select onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'rawMaterialId', this.value)">${materialOptions}</select></td><td><input type="number" step="0.01" value="${mat.quantity}" onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'quantity', this.value)"></td><td><button onclick="removeElement(this, 'productExtraMaterial', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td></tr>`; }).join('');
                extraMaterialsHTML = `<h4 class="text-md font-semibold text-gray-700 mt-6 mb-2">Ek Hammaddeler (Baskı Dışı)</h4><table class="resizable-table w-full text-sm"><thead><tr><th>Hammadde</th><th>Miktar</th><th>Eylem</th></tr></thead><tbody>${extraMaterialRows}</tbody></table><button onclick="addProductExtraMaterial('${product.id}')" class="mt-3 bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700">Ek Hammadde Ekle</button>`;
            } else {
                extraMaterialsHTML = `<div class="mt-4"><button onclick="enableExtraMaterials('${product.id}')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">Ek Hammadde Alanını Aktif Et</button></div>`;
            }
            return `<div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-end items-center mb-4">
                    <button onclick="removeElement(this, 'product')" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" tabindex="2">Ürünü Sil</button>
                </div>
                <h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Varyantlar (Basılan Parçalar)</h4>
                <table class="resizable-table w-full">
                    <thead>
                        <tr>
                            <th>Varyant Adı</th>
                            <th>Baskı Süresi (saat)</th>
                            <th>Renk Seçenekleri</th>
                            <th>Eylem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${variantRows}
                    </tbody>
                </table>
                <button onclick="addProductVariant('${product.id}')" class="mt-3 bg-green-600 text-white px-3 py-1 text-sm rounded-md hover:bg-green-700" tabindex="3">Varyant Ekle</button>
                ${extraMaterialsHTML}
            </div>`;
        }
        
        function getProductHTML(product) {
            const totals = calculateProductTotals(product);
            
            // Get all filament materials for dropdown
            const filamentMaterials = (rawMaterials || []).filter(rm => rm.name && rm.name.toLowerCase().includes('filament'));
            const filamentOptions = filamentMaterials.map(fil => 
                `<option value="${fil.id}">${fil.brand} - ${fil.color} (${fil.type})</option>`
            ).join('');
            
            const variantRows = (product.variants || []).map(v => {
                // Renk seçenekleri için alanlar
                const colors = v.colors || [];
                const colorRows = colors.map((color, index) => {
                    const colorOptions = filamentMaterials.map(fil => 
                        `<option value="${fil.id}" ${color.filamentId === fil.id ? 'selected' : ''}>${fil.brand} - ${fil.color} (${fil.type})</option>`
                    ).join('');
                    
                    return `
                        <tr class="text-xs">
                            <td class="px-2 py-1">
                                <input type="text" value="${color.name}" placeholder="Renk adı" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'name', this.value)" 
                                       class="w-20 text-xs" tabindex="7">
                            </td>
                            <td class="px-2 py-1">
                                <select onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'filamentId', this.value)" class="text-xs" tabindex="8">
                                    <option value="">Filament Seçin</option>
                                    ${colorOptions}
                                </select>
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" step="0.01" value="${color.gram}" placeholder="Gram" 
                                       onchange="updateVariantColor('${product.id}', '${v.id}', ${index}, 'gram', this.value)" 
                                       class="w-16 text-xs" tabindex="9">
                            </td>
                            <td class="px-2 py-1">
                                <button onclick="removeVariantColor('${product.id}', '${v.id}', ${index})" 
                                        class="bg-red-500 text-white px-1 py-0.5 text-xs rounded" tabindex="10">Sil</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                return `<tr class="removable" data-id="${v.id}">
                    <td><input type="text" value="${v.name}" onchange="updateProductVariant('${product.id}', '${v.id}', 'name', this.value)" tabindex="4"></td>
                    <td><input type="number" step="0.01" value="${v.printTime}" onchange="updateProductVariant('${product.id}', '${v.id}', 'printTime', this.value)" tabindex="5"></td>
                    <td colspan="3">
                        <div class="mb-2">
                            <button onclick="addVariantColor('${product.id}', '${v.id}')" 
                                    class="bg-blue-500 text-white px-2 py-1 text-xs rounded" tabindex="6">Renk Ekle</button>
                        </div>
                        <table class="w-full text-xs border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 py-1">Renk Adı</th>
                                    <th class="px-2 py-1">Filament</th>
                                    <th class="px-2 py-1">Gram</th>
                                    <th class="px-2 py-1">Eylem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${colorRows}
                            </tbody>
                        </table>
                    </td>
                    <td><button onclick="removeElement(this, 'productVariant', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md" tabindex="11">Sil</button></td>
                </tr>`;
            }).join('');
            let extraMaterialsHTML = '';
            if (product.extraMaterials) {
                const extraMaterialRows = product.extraMaterials.map(mat => { const materialOptions = (rawMaterials || []).map(rm => `<option value="${rm.id}" ${mat.rawMaterialId === rm.id ? 'selected' : ''}>${rm.name} - ${rm.brand} (${rm.color})</option>`).join(''); return `<tr class="removable" data-id="${mat.id}"><td><select onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'rawMaterialId', this.value)">${materialOptions}</select></td><td><input type="number" step="0.01" value="${mat.quantity}" onchange="updateProductExtraMaterial('${product.id}', '${mat.id}', 'quantity', this.value)"></td><td><button onclick="removeElement(this, 'productExtraMaterial', '${product.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td></tr>`; }).join('');
                extraMaterialsHTML = `<h4 class="text-md font-semibold text-gray-700 mt-6 mb-2">Ek Hammaddeler (Baskı Dışı)</h4><table class="resizable-table w-full text-sm"><thead><tr><th>Hammadde</th><th>Miktar</th><th>Eylem</th></tr></thead><tbody>${extraMaterialRows}</tbody></table><button onclick="addProductExtraMaterial('${product.id}')" class="mt-3 bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700">Ek Hammadde Ekle</button>`;
            } else {
                extraMaterialsHTML = `<div class="mt-4"><button onclick="enableExtraMaterials('${product.id}')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">Ek Hammadde Alanını Aktif Et</button></div>`;
            }
            return `<div class="card removable" data-id="${product.id}"><div class="card-header"><input type="text" value="${product.name}" onchange="updateProductField('${product.id}', 'name', this.value)" class="text-xl font-bold w-1/2 p-2 border-2 border-transparent focus:border-indigo-500 rounded-md" tabindex="1"><div class="flex items-center space-x-4 text-sm text-gray-600"><span><strong>Toplam Süre:</strong> ${totals.totalPrintTime.toFixed(2)} saat</span><span><strong>Toplam Baskı Hammaddesi:</strong> ${totals.totalFilamentUsage.toFixed(2)} gr</span><button onclick="removeElement(this, 'product')" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" tabindex="2">Ürünü Sil</button></div></div><h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Varyantlar (Basılan Parçalar)</h4><table class="resizable-table w-full"><thead><tr><th>Varyant Adı</th><th>Baskı Süresi (saat)</th><th>Renk Seçenekleri</th><th>Eylem</th></tr></thead><tbody>${variantRows}</tbody></table><button onclick="addProductVariant('${product.id}')" class="mt-3 bg-green-600 text-white px-3 py-1 text-sm rounded-md hover:bg-green-700" tabindex="3">Varyant Ekle</button>${extraMaterialsHTML}</div>`;
        }
        function getProductionLogHTML(entry, costs = {}) { 
            const customInputCells = customParameters.map((p, index) => `<td class="px-6 py-4 whitespace-nowrap"><input type="number" step="0.01" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="${entry.customValues[p.id] || 0}" onchange="updateProductionCustomValue('${entry.id}', '${p.id}', this.value)" tabindex="${8 + index}"></td>`).join(''); 
            const customCostHeaders = customParameters.map(p => `<th>${p.name} (Maliyet)</th>`).join('');
            const customCostCells = customParameters.map(p => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">${(costs.customCosts[p.id] || 0).toFixed(2)} ₺</span></td>`).join(''); 
            const productOptions = (products || []).map(p => `<option value="${p.id}" ${entry.productId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            const product = products.find(p => p.id === entry.productId);
            const variant = product?.variants?.find(v => v.id === entry.variantId);
            const variantOptions = (product?.variants || []).map(v => `<option value="${v.id}" ${entry.variantId === v.id ? 'selected' : ''}>${v.name}</option>`).join('');

            // Calculate total gramage - sum of all colors
            let totalGramage = 0;
            let colorBreakdown = '';
            
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * entry.quantity;
                    totalGramage += colorGram;
                    
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentName = filament ? `${filament.brand} - ${filament.color} (${filament.type})` : 'Filament bulunamadı';
                    
                    colorBreakdown += `<div class="text-xs">${color.name}: ${colorGram.toFixed(2)} gr (${filamentName})</div>`;
                });
            }
            
            // Toplam gramaj bilgisi
            const totalGramageHTML = `
                <div class="text-xs">
                    <div class="font-semibold text-gray-800">Toplam: ${totalGramage.toFixed(2)} gr</div>
                    <div class="text-gray-600 mt-1">${colorBreakdown}</div>
                </div>
            `;

            return `<tr class="removable hover:bg-gray-50 transition-colors duration-200" data-id="${entry.id}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" value="${entry.date}" onchange="updateProductionField('${entry.id}', 'date', this.value)" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" tabindex="1">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col space-y-2">
                        <select onchange="handleProductChangeInLog(this, '${entry.id}')" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" tabindex="2">
                            ${productOptions}
                        </select>
                        <select onchange="updateProductionField('${entry.id}', 'variantId', this.value)" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                                id="variant-select-${entry.id}" tabindex="3">
                            ${variantOptions}
                        </select>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" value="${entry.quantity}" onchange="updateProductionField('${entry.id}', 'quantity', this.value)" 
                           class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm text-center" tabindex="4">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${totalGramageHTML}
                </td>
                <td class="px-6 py-4 whitespace-nowrap" id="material-usage-${entry.id}">
                    <!-- Material usage will be rendered here -->
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" step="0.01" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                           value="${entry.laborCost}" onchange="updateProductionField('${entry.id}', 'laborCost', this.value)" tabindex="5">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" step="0.1" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                           value="${entry.profitMargin}" onchange="updateProductionField('${entry.id}', 'profitMargin', this.value)" tabindex="6">
                </td>
                ${customInputCells}
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${(costs.materialCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        ${(costs.electricityCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        ${(costs.amortizationCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ${(costs.laborCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        ${(costs.failedPrintCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                ${customCostCells}
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                        ${(costs.totalCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        ${(costs.unitCost || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-emerald-100 text-emerald-800">
                        ${(costs.recommendedUnitPrice || 0).toFixed(2)} ₺
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="removeElement(this, 'productionLog')" 
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200" 
                            tabindex="7">
                        🗑️ Sil
                    </button>
                </td>
            </tr>`; 
        }
        function getSaleHTML(sale) { 
            let channelInfo = ''; 
            if (sale.channel === 'cari') { 
                const customer = (customers || []).find(c => c.id === sale.customerId); 
                channelInfo = customer ? customer.name : 'Silinmiş Müşteri'; 
            } else if (sale.channel === 'platform') { 
                channelInfo = sale.platformName; 
            } else { 
                channelInfo = 'Bireysel Satış'; 
            } 
            
            // Hızlı satış mı kontrol et
            let productName, variantName = '';
            let totalCost;
            
            if (sale.isQuickSale) {
                // Hızlı satış - direkt productName kullan
                productName = sale.productName || 'Hızlı Satış';
                totalCost = sale.totalCost || 0;
            } else {
                // Normal satış - ürün sisteminden al
                const product = (products || []).find(p => p.id === sale.productId);
                productName = product?.name || 'Bilinmeyen Ürün';
                
                if (sale.variantId && product) {
                    const variant = product.variants?.find(v => v.id === sale.variantId);
                    variantName = variant ? ` - ${variant.name}` : '';
                }
                
                // Satışın toplam maliyetini hesapla
                const averageUnitCost = getAverageUnitCostForProduct(sale.productId, sale.variantId);
                totalCost = averageUnitCost * sale.quantity;
            }
            
            return `<tr class="removable" data-id="${sale.id}">
                <td>${sale.date}</td>
                <td>${productName}${variantName}</td>
                <td>${sale.quantity}</td>
                <td>${channelInfo}</td>
                <td>${sale.paymentMethod}</td>
                <td class="text-red-600 font-medium">${totalCost.toFixed(2)} TL</td>
                <td class="text-green-600 font-medium">${(sale.realizedProfit || 0).toFixed(2)} TL</td>
                <td class="text-blue-600 font-medium">${(sale.totalAmount || 0).toFixed(2)} TL</td>
                <td><button onclick="removeElement(this, 'sale')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button></td>
            </tr>`; 
        }
        function getAddMaterialModalHTML(){ 
            const accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); 
            return `<div class="modal">
                <h3 class="text-xl font-semibold mb-4">Tedarikçiden Malzeme Ekle</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Tedarikçi Seçin</label>
                        <select id="supplierSelect" onchange="populateSupplierMaterials(this.value)" class="mt-1 w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Malzeme Seçin</label>
                        <select id="materialSelect" class="mt-1 w-full"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Alınan Miktar</label>
                        <input type="number" id="initialStock" value="1" class="mt-1 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Minimum Stok Seviyesi</label>
                        <input type="number" id="minStock" value="0" placeholder="Uyarı için minimum stok" class="mt-1 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ödeme Yapılan Hesap</label>
                        <select id="addMaterialPaymentAccountId" class="mt-1 w-full">
                            <option value="">Hesap Seçin</option>
                            ${accountOptions}
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeModal('addMaterialModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button>
                    <button onclick="addRawMaterialFromSupplier()" class="bg-blue-600 text-white px-4 py-2 rounded-md">Envantere Ekle</button>
                </div>
            </div>`; 
        }
        function getUpdateStockModalHTML() { const accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><h3 class="text-xl font-semibold mb-4">Stok Güncelle</h3><input type="hidden" id="updateStockMaterialId"><div class="space-y-4"><div><label class="block text-sm font-medium">Yenileme Tarihi</label><input type="date" id="replenishDate" class="mt-1"></div><div><label class="block text-sm font-medium">Eklenen Stok Miktarı</label><input type="number" id="addedStock" placeholder="Örn: 2.5" class="mt-1"></div><div><label class="block text-sm font-medium">Yeni Birim Fiyat (TL)</label><input type="number" step="0.01" id="newPrice" placeholder="Örn: 550.75" class="mt-1"></div><div><label class="block text-sm font-medium">Ödeme Yapılan Hesap</label><select id="paymentAccountId" class="mt-1"><option value="">Hesap Seçin</option>${accountOptions}</select></div></div><div class="mt-6 flex justify-end space-x-3"><button onclick="closeModal('updateStockModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button onclick="handleStockUpdate()" class="bg-green-600 text-white px-4 py-2 rounded-md">Stoğu Güncelle</button></div></div>`; }
        function getAddSaleModalHTML() { 
            const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); 
            return `<div class="modal"><h3 class="text-xl font-semibold mb-4">Yeni Satış Kaydı</h3><form id="saleForm" onsubmit="event.preventDefault(); addSale();"><div class="grid grid-cols-2 gap-4"><input type="date" name="saleDate" required><select name="saleProductSelect" onchange="updateSalePrice(this.value); handleProductChangeInSale(this.value)" required></select><div id="variantSelectDiv" class="hidden col-span-2"><label class="block text-sm font-medium">Varyant Seçin (Anahtarlık gibi ürünler için)</label><select name="saleVariantSelect" onchange="updateSalePrice(document.querySelector('[name=saleProductSelect]').value)" required></select></div><input type="number" name="saleQuantity" placeholder="Adet" onchange="updateSaleCostAndProfit()" required><input type="number" step="0.01" name="saleUnitPrice" placeholder="Birim Fiyat (KDV Hariç)" onchange="updateSaleCostAndProfit()" required><input type="number" name="saleVatRate" value="20" placeholder="KDV Oranı (%)" onchange="updateSaleCostAndProfit()" required><select name="saleChannel" id="saleChannel" onchange="handleSaleChannelChange(this)"><option value="bireysel">Bireysel Satış</option><option value="platform">Platform</option><option value="cari">Cari Müşteri</option></select><div id="customerSelectDiv" class="hidden col-span-2"><input type="text" name="saleCustomerSelect" id="saleCustomerSelect" placeholder="Müşteri adı yazın..." autocomplete="off"></div><div id="platformInputDiv" class="hidden col-span-2"><input type="text" name="salePlatformName" id="salePlatformName" placeholder="Platform Adı"></div><select name="salePaymentMethod" onchange="togglePaymentAccount(this.value)" class="col-span-2"><option value="nakit">Nakit</option><option value="havale">EFT</option><option value="kredikarti">Kredi Kartı</option><option value="cariye">Cariye İşle</option></select><div id="paymentAccountDiv" class="col-span-2"><label class="block text-sm font-medium">Ödemenin Alındığı Hesap</label><select name="paymentAccountId">${accountOptions}</select></div></div><div id="saleCostInfo" class="mt-4 p-3 bg-gray-50 rounded-md hidden"><div class="grid grid-cols-2 gap-4 text-sm"><div><span class="font-medium text-gray-700">Birim Maliyet:</span> <span id="unitCostDisplay" class="text-red-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Toplam Maliyet:</span> <span id="totalCostDisplay" class="text-red-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Tahmini Kar:</span> <span id="profitDisplay" class="text-green-600 font-semibold">0.00 TL</span></div><div><span class="font-medium text-gray-700">Toplam Tutar:</span> <span id="totalAmountDisplay" class="text-blue-600 font-semibold">0.00 TL</span></div></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addSaleModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Kaydet</button></div></form></div>`; 
        }

        function getQuickSaleModalHTML() {
            const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">⚡ Hızlı Satış (Sistem Dışı Ürün)</h3>
                    <form id="quickSaleForm" onsubmit="event.preventDefault(); addQuickSale();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                                <input type="date" name="quickSaleDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
                                <input type="text" name="quickProductName" placeholder="Örn: Özel Tasarım Heykel" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Adet</label>
                                <input type="number" name="quickQuantity" placeholder="Adet" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gramaj (Opsiyonel)</label>
                                <input type="number" name="quickGramage" placeholder="Gram cinsinden" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat (KDV Hariç)</label>
                                <input type="number" step="0.01" name="quickUnitPrice" placeholder="Birim fiyat" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">KDV Oranı (%)</label>
                                <input type="number" name="quickVatRate" value="0" min="0" max="100" placeholder="KDV oranı" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Müşteri/Kanal</label>
                                <select name="quickChannel" onchange="handleQuickSaleChannelChange(this)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="bireysel">Bireysel Satış</option>
                                    <option value="platform">Platform</option>
                                    <option value="cari">Cari Müşteri</option>
                                </select>
                            </div>
                            <div id="quickCustomerDiv" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Müşteri Seçin</label>
                                <select name="quickCustomerId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Müşteri seçin...</option>
                                </select>
                                <div class="mt-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Yeni Müşteri Ekle</label>
                                    <input type="text" name="quickCustomerName" placeholder="Yeni müşteri adı" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <div id="quickPlatformDiv" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Platform Adı</label>
                                <input type="text" name="quickPlatformName" placeholder="Platform adı" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ödeme Yöntemi</label>
                                <select name="quickPaymentMethod" onchange="toggleQuickPaymentAccount(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="nakit">Nakit</option>
                                    <option value="havale">EFT</option>
                                    <option value="kredikarti">Kredi Kartı</option>
                                    <option value="cariye">Cariye İşle</option>
                                </select>
                            </div>
                            <div id="quickPaymentAccountDiv" class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ödemenin Alındığı Hesap</label>
                                <select name="quickPaymentAccountId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    ${accountOptions}
                                </select>
                            </div>
                            <div class="col-span-full">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notlar (Opsiyonel)</label>
                                <textarea name="quickNotes" rows="2" placeholder="Ek notlar..." class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                        <div id="quickSaleSummary" class="mt-4 p-4 bg-green-50 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">📊 Satış Özeti</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-700">Toplam Tutar (KDV Dahil):</span></div>
                                <div><span id="quickTotalAmount" class="font-bold text-green-700">0.00 TL</span></div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('quickSaleModal')" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">
                                İptal
                            </button>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                ⚡ Hızlı Satış Yap
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getAddFailedPrintModalHTML() {
            const productOptions = (products || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            return `<div class="modal">
                <h3 class="text-xl font-semibold mb-4">Yeni Baskı Hatası Kaydı</h3>
                <form id="failedPrintForm" onsubmit="event.preventDefault(); addFailedPrint();">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium">Tarih</label>
                            <input type="date" name="failedPrintDate" required class="mt-1 w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ürün Seçin</label>
                            <select name="failedPrintProductSelect" onchange="handleProductChangeInFailedPrint(this.value)" required class="mt-1 w-full">
                                <option value="">Ürün Seçin</option>
                                ${productOptions}
                            </select>
                        </div>
                        <div id="failedPrintVariantSelectDiv" class="hidden">
                            <label class="block text-sm font-medium">Varyant Seçin</label>
                            <select name="failedPrintVariantSelect" class="mt-1 w-full">
                                <option value="">Varyant Seçin</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Hatalı Adet</label>
                            <input type="number" name="failedPrintQuantity" placeholder="Adet" onchange="calculateFailedPrintCost()" required class="mt-1 w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Hata Sebebi</label>
                            <select name="failedPrintReason" class="mt-1 w-full">
                                <option value="Baskı Hatası">Baskı Hatası</option>
                                <option value="Malzeme Hatası">Malzeme Hatası</option>
                                <option value="Makine Arızası">Makine Arızası</option>
                                <option value="Kalite Kontrol">Kalite Kontrol</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Açıklama (İsteğe Bağlı)</label>
                            <textarea name="failedPrintDescription" placeholder="Hata detayları..." class="mt-1 w-full" rows="3"></textarea>
                        </div>
                    </div>
                    <div id="failedPrintCostInfo" class="mt-4 p-3 bg-red-50 rounded-md hidden">
                        <h4 class="font-medium text-red-700 mb-2">Maliyet Bilgileri</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Hammadde Kaybı:</span> 
                                <span id="materialLossDisplay" class="text-red-600 font-semibold">0.00 TL</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Toplam Maliyet:</span> 
                                <span id="totalFailedCostDisplay" class="text-red-600 font-semibold">0.00 TL</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('addFailedPrintModal')" class="bg-gray-200 px-4 py-2 rounded-md">
                            İptal
                        </button>
                        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">
                            Kaydet ve Stoktan Düş
                        </button>
                    </div>
                </form>
            </div>`;
        }
        function getAccountModalHTML() { const bankAccountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><form id="accountForm" onsubmit="event.preventDefault(); handleAccountFormSubmit();"><h3 id="accountModalTitle" class="text-xl font-semibold mb-4"></h3><input type="hidden" name="accountId"><input type="hidden" name="accountType"><div class="space-y-4"><div><label>Hesap Adı</label><input type="text" name="accountName" required></div><div id="initialBalanceDiv"><label>Başlangıç Bakiyesi</label><input type="number" step="0.01" name="initialBalance" value="0"></div><div id="bankDetailsDiv" class="hidden space-y-4"><div><label>Banka Adı</label><input type="text" name="bankName"></div><div><label>IBAN</label><input type="text" name="iban"></div></div><div id="creditCardDetailsDiv" class="hidden space-y-4"><div><label>Kart Limiti</label><input type="number" step="0.01" name="creditCardLimit"></div><div><label>Bağlı Banka Hesabı</label><select name="linkedAccountId">${bankAccountOptions}</select></div></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('accountModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button id="accountModalSubmitBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md"></button></div></form></div>`; }
        function getCustomParamModalHTML() { return `<div class="modal"><form id="customParamForm" onsubmit="event.preventDefault(); handleCustomParamFormSubmit();"><h3 id="customParamModalTitle" class="text-xl font-semibold mb-4"></h3><input type="hidden" name="paramId"><div class="space-y-4"><div><label>Parametre Adı</label><input type="text" name="paramName" required></div><div><label>Türü</label><select name="paramType" required><option value="parasal">Parasal Değer (TL)</option><option value="saatlik">Saatlik Ücret (TL)</option><option value="yuzdelik">Yüzdelik (%)</option></select></div><div><label>Varsayılan Değer</label><input type="number" step="0.01" name="paramValue" required></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('customParamModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button id="customParamModalSubmitBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md"></button></div></form></div>`; }
        function getAddPaymentModalHTML() { const accountOptions = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}">${acc.name}</option>`).join(''); return `<div class="modal"><form id="paymentForm" onsubmit="event.preventDefault(); addPayment();"><h3 class="text-xl font-semibold mb-4">Müşteri Ödemesi Al</h3><input type="hidden" name="paymentCustomerId"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="paymentDate" required></div><div><label>Tutar (TL)</label><input type="number" step="0.01" name="paymentAmount" required></div><div><label>Ödemenin Alındığı Hesap</label><select name="paymentAccountId" required>${accountOptions}</select></div><div><label>Açıklama</label><input type="text" name="paymentNotes"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addPaymentModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Ödemeyi Kaydet</button></div></form></div>`; }
        function getAccountDetailModalHTML() { return `<div class="modal" id="accountDetailModalContent"></div>`; }
        function getEditTransactionModalHTML() { return `<div class="modal"><form id="editTransactionForm" onsubmit="event.preventDefault(); handleTransactionUpdate();"><h3 class="text-xl font-semibold mb-4">İşlemi Düzenle</h3><input type="hidden" name="txId"><input type="hidden" name="txType"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="txDate" required></div><div id="txAmountDiv"><label>Tutar (TL)</label><input type="number" step="0.01" name="txAmount" required></div><div id="txPurchaseDiv" class="hidden grid grid-cols-2 gap-4"><div><label>Miktar</label><input type="number" step="0.01" name="txQuantity"></div><div><label>Birim Fiyat</label><input type="number" step="0.01" name="txPrice"></div></div><div><label>Hesap</label><select name="txAccountId" required></select></div><div id="txNotesDiv"><label>Açıklama</label><input type="text" name="txNotes"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('editTransactionModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Güncelle</button></div></form></div>`; }
        function getAddMoneyModalHTML() { return `<div class="modal"><form id="addMoneyForm" onsubmit="event.preventDefault(); addMoneyToAccount();"><h3 class="text-xl font-semibold mb-4">💰 Hesaba Para Ekle</h3><input type="hidden" name="accountId"><div class="space-y-4"><div><label>Tarih</label><input type="date" name="moneyDate" required></div><div><label>Tutar (TL)</label><input type="number" step="0.01" name="moneyAmount" placeholder="Eklenen tutar" required></div><div><label>Açıklama</label><input type="text" name="moneyDescription" placeholder="Örn: Dış kaynaktan gelen ödeme" required></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeModal('addMoneyModal')" class="bg-gray-200 px-4 py-2 rounded-md">İptal</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">💰 Para Ekle</button></div></form></div>`; }


        function renderDashboard() {
            const container = document.getElementById('dashboard');
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentSales = (salesLog || []).filter(s => new Date(s.date) >= thirtyDaysAgo);
            const recentProductions = (productionLog || []).filter(p => new Date(p.date) >= thirtyDaysAgo);
            const totalTurnover = recentSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const productionCosts = calculateAllProductionCosts();
            const totalCost = recentProductions.reduce((sum, p) => sum + (productionCosts[p.id]?.totalCost || 0), 0);
            const netProfit = recentSales.reduce((sum, s) => sum + (s.realizedProfit || 0), 0);
            const costSums = recentProductions.reduce((acc, p) => { const costs = productionCosts[p.id] || {}; acc.material += costs.materialCost || 0; acc.electricity += costs.electricityCost || 0; acc.amortization += costs.amortizationCost || 0; acc.labor += costs.laborCost || 0; acc.failedPrint += costs.failedPrintCost || 0; return acc; }, { material: 0, electricity: 0, amortization: 0, labor: 0, failedPrint: 0 });
            const totalProdCostSum = Object.values(costSums).reduce((a, b) => a + b, 0);
            
            const totalReceivables = calculateTotalReceivables();
            const { cashBalance, bankBalance, creditCardDebt } = calculateAccountSummary();
            const totalAssets = cashBalance + bankBalance + totalReceivables;
            
            // Gider hesaplamaları
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const thisMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                const now = new Date();
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            }).reduce((sum, exp) => sum + exp.amount, 0);
            
            // Yedekleme durumu
            const backupData = localStorage.getItem(BACKUP_DATA_KEY);
            const backupInfo = backupData ? JSON.parse(backupData) : null;
            const lastBackupTime = backupInfo ? new Date(backupInfo.backupDate) : null;
            const backupStatus = lastBackupTime ? 
                `Son yedekleme: ${lastBackupTime.toLocaleString('tr-TR')}` : 
                'Yedekleme bulunamadı';

            // Firebase bağlantı durumu
            const firebaseStatus = window.firebaseDatabase ? '🟢 Firebase Bağlı' : '🔴 Firebase Bağlantısı Yok';

            // Aktif üretim planları
            const activePlans = productionPlans.filter(plan => plan.status === 'active');
            const totalActivePlans = activePlans.length;
            const totalPlannedQuantity = activePlans.reduce((sum, plan) => sum + (plan.orderQuantity || 0), 0);
            const totalPlannedDays = activePlans.reduce((sum, plan) => sum + (plan.totalDays || 0), 0);

            // Aktif işler (üretim log'da devam eden işler)
            const activeJobs = productionLog.filter(job => {
                const jobDate = new Date(job.date);
                const today = new Date();
                const daysDiff = Math.floor((today - jobDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 7; // Son 7 gün içindeki işler
            });
            const totalActiveJobs = activeJobs.length;
            const activeJobsValue = activeJobs.reduce((sum, job) => {
                const costs = productionCosts[job.id] || {};
                return sum + (costs.totalCost || 0);
            }, 0);

            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gösterge Paneli</h2> 
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"> 
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-indigo-700">Toplam Ciro (Son 30 Gün)</h3><p class="text-3xl font-bold text-indigo-800 mt-2">${totalTurnover.toFixed(2)} TL</p></div> 
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-green-700">Net Kazanç (Son 30 Gün)</h3><p class="text-3xl font-bold text-green-800 mt-2">${netProfit.toFixed(2)} TL</p></div> 
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-red-700">Toplam Maliyet (Son 30 Gün)</h3><p class="text-3xl font-bold text-red-800 mt-2">${totalCost.toFixed(2)} TL</p></div> 
                    <div class="bg-cyan-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-cyan-700">Toplam Cari Alacak</h3><p class="text-3xl font-bold text-cyan-800 mt-2">${totalReceivables.toFixed(2)} TL</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-yellow-700">Toplam Varlıklar</h3><p class="text-3xl font-bold text-yellow-800 mt-2">${totalAssets.toFixed(2)} TL</p></div> 
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-orange-700">Toplam Giderler</h3><p class="text-3xl font-bold text-orange-800 mt-2">${totalExpenses.toFixed(2)} TL</p></div>
                    <div class="bg-pink-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-pink-700">Bu Ay Giderler</h3><p class="text-3xl font-bold text-pink-800 mt-2">${thisMonthExpenses.toFixed(2)} TL</p></div>
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-purple-700">Yedekleme Durumu</h3><p class="text-sm text-purple-800 mt-2">${backupStatus}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-emerald-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-emerald-700">Firebase Durumu</h3><p class="text-lg font-bold text-emerald-800 mt-2">${firebaseStatus}</p></div>
                    <div class="bg-slate-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-slate-700">Veri Senkronizasyonu</h3><p class="text-lg font-bold text-slate-800 mt-2">${window.firebaseDatabase ? 'Aktif' : 'Pasif'}</p></div>
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-indigo-700">Ortak Çalışma</h3><p class="text-lg font-bold text-indigo-800 mt-2">${window.firebaseDatabase ? 'Hazır' : 'Offline'}</p></div>
                    <div class="bg-cyan-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-cyan-700">Güvenlik</h3><p class="text-lg font-bold text-cyan-800 mt-2">${window.firebaseDatabase ? 'Güvenli' : 'Local'}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-blue-700">Aktif Üretim Planları</h3><p class="text-3xl font-bold text-blue-800 mt-2">${totalActivePlans}</p></div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-green-700">Planlanan Toplam Adet</h3><p class="text-3xl font-bold text-green-800 mt-2">${totalPlannedQuantity.toLocaleString()}</p></div>
                    <div class="bg-teal-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-teal-700">Toplam Planlanan Gün</h3><p class="text-3xl font-bold text-teal-800 mt-2">${totalPlannedDays.toFixed(1)}</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-amber-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-amber-700">Aktif İşler (Son 7 Gün)</h3><p class="text-3xl font-bold text-amber-800 mt-2">${totalActiveJobs}</p></div>
                    <div class="bg-rose-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-rose-700">Aktif İşler Değeri</h3><p class="text-3xl font-bold text-rose-800 mt-2">${activeJobsValue.toFixed(2)} TL</p></div>
                    <div class="bg-violet-50 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-medium text-violet-700">Ortalama İş Değeri</h3><p class="text-3xl font-bold text-violet-800 mt-2">${totalActiveJobs > 0 ? (activeJobsValue / totalActiveJobs).toFixed(2) : '0.00'} TL</p></div>
                </div> 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Maliyet Dağılımı</h3><div id="cost-breakdown-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="costChart"></canvas></div></div> 
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Kasa Durumu</h3><div id="cash-summary-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="cashChart"></canvas></div></div> 
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Gider Dağılımı</h3><div id="expense-breakdown-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="expenseChart"></canvas></div></div>
                    <div class="card flex"><div class="w-1/2 pr-4"><h3 class="text-xl font-semibold text-gray-700 mb-4">Aylık Gider Trendi</h3><div id="expense-trend-text" class="text-gray-600 text-sm"></div></div><div class="w-1/2 flex items-center justify-center"><canvas id="expenseTrendChart"></canvas></div></div>
                </div>`;
            if (charts.costChart) charts.costChart.destroy();
            if (totalProdCostSum > 0) { document.getElementById('cost-breakdown-text').innerHTML = `<p>Hammadde: <span>${(costSums.material / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Elektrik: <span>${(costSums.electricity / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Amortisman: <span>${(costSums.amortization / totalProdCostSum * 100).toFixed(1)}%</span></p><p>İşçilik: <span>${(costSums.labor / totalProdCostSum * 100).toFixed(1)}%</span></p><p>Başarısız Baskı: <span>${(costSums.failedPrint / totalProdCostSum * 100).toFixed(1)}%</span></p>`; const costCtx = document.getElementById('costChart').getContext('2d'); charts.costChart = new Chart(costCtx, { type: 'doughnut', data: { labels: ['Hammadde', 'Elektrik', 'Amortisman', 'İşçilik', 'Başarısız Baskı'], datasets: [{ data: [costSums.material, costSums.electricity, costSums.amortization, costSums.labor, costSums.failedPrint], backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            if (charts.cashChart) charts.cashChart.destroy();
            document.getElementById('cash-summary-text').innerHTML = `<p>Nakit: <span class="font-semibold">${cashBalance.toFixed(2)} TL</span></p><p>Banka: <span class="font-semibold">${bankBalance.toFixed(2)} TL</span></p><p>Kredi Kartı Borcu: <span class="font-semibold text-red-600">${creditCardDebt.toFixed(2)} TL</span></p>`;
            if (totalAssets > 0 || creditCardDebt > 0) { const cashCtx = document.getElementById('cashChart').getContext('2d'); charts.cashChart = new Chart(cashCtx, { type: 'doughnut', data: { labels: ['Nakit', 'Banka', 'K. Kartı Borcu'], datasets: [{ data: [cashBalance, bankBalance, creditCardDebt], backgroundColor: ['#10B981', '#3B82F6', '#EF4444'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            
            // Gider dağılımı grafiği
            if (charts.expenseChart) charts.expenseChart.destroy();
            if (totalExpenses > 0) {
                const expenseCategories = {};
                expenses.forEach(exp => {
                    expenseCategories[exp.category] = (expenseCategories[exp.category] || 0) + exp.amount;
                });
                const categoryLabels = Object.keys(expenseCategories);
                const categoryValues = Object.values(expenseCategories);
                const categoryColors = ['#EF4444', '#F97316', '#EAB308', '#22C55E', '#06B6D4', '#8B5CF6', '#EC4899', '#84CC16', '#F59E0B', '#6366F1'];
                
                document.getElementById('expense-breakdown-text').innerHTML = categoryLabels.map((cat, i) => 
                    `<p>${cat}: <span>${(categoryValues[i] / totalExpenses * 100).toFixed(1)}%</span></p>`
                ).join('');
                
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                charts.expenseChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryColors.slice(0, categoryLabels.length),
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // Aylık gider trendi grafiği
            if (charts.expenseTrendChart) charts.expenseTrendChart.destroy();
            const last6Months = [];
            const monthlyExpenses = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthName = date.toLocaleDateString('tr-TR', { month: 'short' });
                last6Months.push(monthName);
                
                const monthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() === date.getMonth() && expDate.getFullYear() === date.getFullYear();
                }).reduce((sum, exp) => sum + exp.amount, 0);
                monthlyExpenses.push(monthExpenses);
            }
            
            document.getElementById('expense-trend-text').innerHTML = `<p>Son 6 ay gider trendi</p><p>Bu ay: <span class="font-semibold">${thisMonthExpenses.toFixed(2)} TL</span></p>`;
            
            const trendCtx = document.getElementById('expenseTrendChart').getContext('2d');
            charts.expenseTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: 'Aylık Giderler',
                        data: monthlyExpenses,
                        borderColor: '#F97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' TL';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCashFlow() { const container = document.getElementById('cashFlow'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Kasa ve Hesap Yönetimi</h2><div class="mb-6"><button onclick="openAddAccountModal('nakit')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Nakit Hesap Ekle</button><button onclick="openAddAccountModal('banka')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 ml-2">Banka Hesabı Ekle</button><button onclick="openAddAccountModal('kredikarti')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 ml-2">Kredi Kartı Ekle</button></div><div id="accountsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${accounts.map(getAccountHTML).join('')}</div>`; }
        function renderStockStatus() {
            const container = document.getElementById('stock');
            const { productStock, rawMaterialStock, productStockValue, rawMaterialStockValue } = calculateAllStocks();
            const totalStockValue = productStockValue + rawMaterialStockValue;
            // Ürün stok durumu - ana ürün + varyantları
            const productStockHTML = productStock.map(p => {
                const variantHTML = p.variants.map(v => 
                    `<li class="ml-4 text-xs text-gray-500">└─ ${v.name}: <strong>${v.stock}</strong> adet</li>`
                ).join('');
                
                return `<li class="font-medium">${p.name}: <strong>${p.stock}</strong> adet
                    ${variantHTML}
                </li>`;
            }).join('');
            
            container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Stok Takip</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card"><h3 class="text-lg font-medium text-purple-700 mb-2">Stok Değeri</h3><p>Ürün Stoğu Değeri: <strong class="font-semibold">${productStockValue.toFixed(2)} TL</strong></p><p>Hammadde Stoğu Değeri: <strong class="font-semibold">${rawMaterialStockValue.toFixed(2)} TL</strong></p><p class="mt-2 text-xl">Toplam Stok Değeri: <strong class="font-bold">${totalStockValue.toFixed(2)} TL</strong></p></div><div class="card flex items-center justify-center" style="min-height: 250px;"><canvas id="stockChart"></canvas></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6"><div class="card"><h3 class="text-lg font-medium text-purple-700 mb-2">Ürün Stok Durumu</h3><ul class="list-disc pl-5 text-gray-600 text-sm">${productStockHTML || '<li>Ürün bilgisi yok</li>'}</ul></div><div class="card"><h3 class="text-lg font-medium text-blue-700 mb-2">Hammadde Stok Durumu</h3><ul class="list-disc pl-5 text-gray-600 text-sm">${rawMaterialStock.map(f => `<li>${f.name} (${f.brand}, ${f.color}): <strong>${f.currentStock.toFixed(3)}</strong> ${f.unit}</li>`).join('') || '<li>Hammadde bilgisi yok.</li>'}</ul></div></div>`;
            if (charts.stockChart) charts.stockChart.destroy();
            if (totalStockValue > 0) { const stockCtx = document.getElementById('stockChart').getContext('2d'); charts.stockChart = new Chart(stockCtx, { type: 'pie', data: { labels: ['Ürün Stoğu', 'Hammadde Stoğu'], datasets: [{ data: [productStockValue, rawMaterialStockValue], backgroundColor: ['#4338CA', '#16A34A'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }); }
        }

        function renderFailedPrints() {
            const container = document.getElementById('failedPrints');
            const totalFailedValue = failedPrints.reduce((sum, fp) => sum + (fp.totalCost || 0), 0);
            const totalFailedQuantity = failedPrints.reduce((sum, fp) => sum + fp.quantity, 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Baskı Hataları Yönetimi</h2>
                <p class="text-gray-600 mb-4">Baskı hatalı olan ürünleri stoktan düşürün ve maliyetlerini takip edin.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">Toplam Hatalı Ürün</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${totalFailedQuantity} adet</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Toplam Kayıp Maliyet</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${totalFailedValue.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Hata Kaydı Sayısı</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${failedPrints.length}</p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Baskı Hataları</h3>
                    <button onclick="openAddFailedPrintModal()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        Yeni Baskı Hatası Ekle
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Ürün / Varyant</th>
                                <th>Hatalı Adet</th>
                                <th>Hata Sebebi</th>
                                <th>Hammadde Kaybı</th>
                                <th>Toplam Maliyet</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(failedPrints || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map(getFailedPrintHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function getFailedPrintHTML(failedPrint) {
            const product = products.find(p => p.id === failedPrint.productId);
            const variant = product?.variants?.find(v => v.id === failedPrint.variantId);
            const productName = product?.name || 'Bilinmeyen Ürün';
            const variantName = variant ? ` - ${variant.name}` : '';
            
            // Hammadde kaybı hesaplama
            let materialLoss = '';
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * failedPrint.quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentName = filament ? `${filament.brand} - ${filament.color}` : 'Bilinmeyen';
                    materialLoss += `<div class="text-xs">${color.name}: ${colorGram.toFixed(2)} gr (${filamentName})</div>`;
                });
            }
            
            return `<tr class="removable" data-id="${failedPrint.id}">
                <td>${failedPrint.date}</td>
                <td>${productName}${variantName}</td>
                <td class="text-red-600 font-semibold">${failedPrint.quantity} adet</td>
                <td>${failedPrint.reason || 'Belirtilmemiş'}</td>
                <td>
                    <div class="text-xs">
                        ${materialLoss || 'Hammadde bilgisi yok'}
                    </div>
                </td>
                <td class="text-red-600 font-semibold">${(failedPrint.totalCost || 0).toFixed(2)} TL</td>
                <td>
                    <button onclick="removeElement(this, 'failedPrint')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">
                        Sil
                    </button>
                </td>
            </tr>`;
        }

        function renderSuppliers() { const container = document.getElementById('suppliers'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Tedarikçi ve Ürün Yönetimi</h2><p class="text-gray-600 mb-4">Hammaddelerinizi aldığınız tedarikçileri ve onların ürün kataloglarını buraya ekleyin.</p><button onclick="addSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni Tedarikçi Ekle</button><div id="suppliersContainer" class="mt-4 space-y-6">${(suppliers || []).map(getSupplierHTML).join('')}</div>`; makeTablesResizable();}
        function renderCustomers() { const container = document.getElementById('customers'); container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Cari Müşteri Yönetimi</h2><p class="text-gray-600 mb-4">Sabit müşterilerinizi ve bakiyelerini buradan takip edin.</p><button onclick="addCustomer()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni Müşteri Ekle</button><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${(customers || []).map(getCustomerHTML).join('')}</div>`; }
        function renderRawMaterials() { 
            const container = document.getElementById('rawMaterials'); 
            const calculatedMaterials = getCalculatedRawMaterialStocks(); 
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Hammadde Envanteri</h2>
                <p class="text-gray-600 mb-4">Tedarikçilerden gelen ürünleri envanterinize ekleyin ve mevcut stokları güncelleyin.</p>
                <button onclick="openAddMaterialFromSupplierModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Tedarikçiden Yeni Malzeme Ekle</button>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Malzeme Adı</th>
                                <th>Marka</th>
                                <th>Renk</th>
                                <th>Tür</th>
                                <th>Min Stok (Birim)</th>
                                <th>Mevcut Stok (Birim)</th>
                                <th>Birim</th>
                                <th>Ortalama Maliyet (TL/Birim)</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody id="rawMaterialsTableBody">
                            ${calculatedMaterials.map(getRawMaterialHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `; 
            makeTablesResizable();
        }
        function toggleProductExpansion(productId) {
            expandedProductId = expandedProductId === productId ? null : productId;
            renderProducts();
        }
        
        function renderProducts() { 
            const container = document.getElementById('products'); 
            const startIndex = (currentProductPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const currentProducts = (products || []).slice(startIndex, endIndex);
            const totalPages = Math.ceil((products || []).length / productsPerPage);
            
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="flex justify-center items-center space-x-2 mt-6">
                        <button onclick="changeProductPage(${currentProductPage - 1})" 
                                ${currentProductPage <= 1 ? 'disabled' : ''} 
                                class="px-3 py-1 bg-gray-300 text-gray-700 rounded-md ${currentProductPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-400'}">Önceki</button>
                        <span class="px-3 py-1 bg-blue-500 text-white rounded-md">${currentProductPage} / ${totalPages}</span>
                        <button onclick="changeProductPage(${currentProductPage + 1})" 
                                ${currentProductPage >= totalPages ? 'disabled' : ''} 
                                class="px-3 py-1 bg-gray-300 text-gray-700 rounded-md ${currentProductPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-400'}">Sonraki</button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Ürün Tanımları ve Varyantları</h2>
                <p class="text-gray-600 mb-4">Ürünlerinizi ve bu ürünleri oluşturan parçaları (varyantları) buradan yönetin. Bir ürünün toplam maliyeti, içerdiği varyantların toplamından hesaplanır.</p>
                <button onclick="addProduct()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mb-4">Yeni Ürün Ekle</button>
                <div id="productsContainer" class="space-y-4">${currentProducts.map(getSimpleProductHTML).join('')}</div>
                ${paginationHTML}
            `; 
            makeTablesResizable();
        }
        
        function changeProductPage(page) {
            const totalPages = Math.ceil((products || []).length / productsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentProductPage = page;
                renderProducts();
            }
        }
        function renderProductionLog() { 
            try {
            const container = document.getElementById('productionLog'); 
                if (!container) {
                    console.error('productionLog container bulunamadı');
                    return;
                }
                
            const costData = calculateAllProductionCosts(); 
                const customHeaders = (customParameters || []).map(p => `<th>${p.name} (Girdi)</th>`).join('');
                const customCostHeaders = (customParameters || []).map(p => `<th>${p.name} (Maliyet)</th>`).join('');
                
                const productionLogData = (productionLog || []).slice(); // Array'in kopyasını al
                // Tarihe göre sırala (en yeni en başta)
                productionLogData.sort((a, b) => new Date(b.date) - new Date(a.date));
                const productionLogHTML = productionLogData.map(entry => {
                    try {
                        return getProductionLogHTML(entry, costData[entry.id] || {});
                    } catch (error) {
                        console.error('Hata getProductionLogHTML:', entry.id, error);
                        return `<tr><td colspan="17">Hata: ${entry.id}</td></tr>`;
                    }
                }).join('');
                
                // İstatistikler
                const totalEntries = productionLogData.length;
                const totalQuantity = productionLogData.reduce((sum, entry) => sum + entry.quantity, 0);
                const totalCost = productionLogData.reduce((sum, entry) => sum + (costData[entry.id]?.totalCost || 0), 0);
                const avgUnitCost = totalQuantity > 0 ? totalCost / totalQuantity : 0;
                
                container.innerHTML = `
                    <!-- Header Section -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-lg mb-6">
                        <div class="px-6 py-8">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-2">🏭 Üretim Kaydı</h2>
                                    <p class="text-indigo-100">Üretim süreçlerinizi takip edin ve maliyetlerinizi analiz edin</p>
                                </div>
                                <button class="bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-indigo-50 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1" 
                                        id="addProductionBtn">
                                    ➕ Yeni Üretim Kaydı
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam Kayıt</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalEntries}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam Üretim</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalQuantity.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-full">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Toplam Maliyet</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalCost.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ortalama Birim Maliyet</p>
                                    <p class="text-2xl font-bold text-gray-900">${avgUnitCost.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="bg-white rounded-xl shadow-lg mb-6">
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">🔍 Arama ve Filtreleme</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🏷️ Ürün Adı</label>
                                    <input type="text" id="productionSearchProduct" placeholder="Ürün adı ara..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🔧 Varyant Adı</label>
                                    <input type="text" id="productionSearchVariant" placeholder="Varyant adı ara..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">📅 Tarih Aralığı</label>
                                    <div class="flex space-x-2">
                                        <input type="date" id="productionSearchDateFrom" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <input type="date" id="productionSearchDateTo" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">📦 Miktar Aralığı</label>
                                    <div class="flex space-x-2">
                                        <input type="number" id="productionSearchQuantityMin" placeholder="Min" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <input type="number" id="productionSearchQuantityMax" placeholder="Max" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button onclick="filterProductionLog()" 
                                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200">
                                    🔍 Filtrele
                                </button>
                                <button onclick="clearProductionFilters()" 
                                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200">
                                    🗑️ Temizle
                                </button>
                                <button onclick="exportProductionLog()" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors duration-200">
                                    📊 Excel'e Aktar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Production Log Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">📊 Üretim Kayıtları</h3>
                            <p class="text-sm text-gray-600">Tüm üretim kayıtlarınızı detaylı olarak görüntüleyin</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📅 Tarih</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🏷️ Ürün / Varyant</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📦 Adet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⚖️ Toplam Gramaj</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🔧 Malzeme Kullanımı</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">👷 İşçilik Ücreti</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📈 Kazanç Oranı</th>
                                        ${customHeaders}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🧱 Hammadde</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⚡ Elektrik</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🏭 Amortisman</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">💰 Toplam İşçilik</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">❌ Başarısız Baskı</th>
                                        ${customCostHeaders}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">💸 Toplam Maliyet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📊 Birim Maliyet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">💡 Önerilen Fiyat</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⚙️ Eylemler</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${productionLogHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Buton event listener'ını manuel olarak ekle
                const addBtn = document.getElementById('addProductionBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Buton tıklandı');
                        addProductionEntry();
                    });
                } 
                
                productionLogData.forEach(entry => {
                    try {
                renderMaterialUsageForEntry(entry.id);
                    } catch (error) {
                        console.error('Hata renderMaterialUsageForEntry:', entry.id, error);
                    }
            }); 
                
            makeTablesResizable();
                
                // Arama input'larına event listener ekle
                const searchProduct = document.getElementById('productionSearchProduct');
                const searchVariant = document.getElementById('productionSearchVariant');
                const searchDateFrom = document.getElementById('productionSearchDateFrom');
                const searchDateTo = document.getElementById('productionSearchDateTo');
                const searchQuantityMin = document.getElementById('productionSearchQuantityMin');
                const searchQuantityMax = document.getElementById('productionSearchQuantityMax');
                
                if (searchProduct) {
                    searchProduct.addEventListener('input', filterProductionLog);
                }
                if (searchVariant) {
                    searchVariant.addEventListener('input', filterProductionLog);
                }
                if (searchDateFrom) {
                    searchDateFrom.addEventListener('change', filterProductionLog);
                }
                if (searchDateTo) {
                    searchDateTo.addEventListener('change', filterProductionLog);
                }
                if (searchQuantityMin) {
                    searchQuantityMin.addEventListener('input', filterProductionLog);
                }
                if (searchQuantityMax) {
                    searchQuantityMax.addEventListener('input', filterProductionLog);
                }
                
            } catch (error) {
                console.error('Hata renderProductionLog:', error);
                const container = document.getElementById('productionLog');
                if (container) {
                    container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Üretim Kaydı</h2><p class="text-red-600">Hata: ${error.message}</p>`;
                }
            }
        }

        // Üretim kaydı arama ve filtreleme fonksiyonları
        function filterProductionLog() {
            const searchProduct = document.getElementById('productionSearchProduct')?.value.toLowerCase() || '';
            const searchVariant = document.getElementById('productionSearchVariant')?.value.toLowerCase() || '';
            const searchDateFrom = document.getElementById('productionSearchDateFrom')?.value || '';
            const searchDateTo = document.getElementById('productionSearchDateTo')?.value || '';
            const searchQuantityMin = parseFloat(document.getElementById('productionSearchQuantityMin')?.value) || 0;
            const searchQuantityMax = parseFloat(document.getElementById('productionSearchQuantityMax')?.value) || Infinity;
            
            const costData = calculateAllProductionCosts();
            const customHeaders = (customParameters || []).map(p => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${p.name} (Girdi)</th>`).join('');
            const customCostHeaders = (customParameters || []).map(p => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${p.name} (Maliyet)</th>`).join('');
            
            // Filtreleme
            let filteredData = (productionLog || []).slice();
            
            if (searchProduct) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    return product && product.name.toLowerCase().includes(searchProduct);
                });
            }
            
            if (searchVariant) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    const variant = product?.variants?.find(v => v.id === entry.variantId);
                    return variant && variant.name.toLowerCase().includes(searchVariant);
                });
            }
            
            if (searchDateFrom) {
                filteredData = filteredData.filter(entry => entry.date >= searchDateFrom);
            }
            
            if (searchDateTo) {
                filteredData = filteredData.filter(entry => entry.date <= searchDateTo);
            }
            
            if (searchQuantityMin > 0) {
                filteredData = filteredData.filter(entry => entry.quantity >= searchQuantityMin);
            }
            
            if (searchQuantityMax < Infinity) {
                filteredData = filteredData.filter(entry => entry.quantity <= searchQuantityMax);
            }
            
            // Tarihe göre sırala (en yeni en başta)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const productionLogHTML = filteredData.map(entry => {
                try {
                    return getProductionLogHTML(entry, costData[entry.id] || {});
                } catch (error) {
                    console.error('Hata getProductionLogHTML:', entry.id, error);
                    return `<tr class="bg-red-50"><td colspan="17" class="px-6 py-4 text-center text-red-600">Hata: ${entry.id}</td></tr>`;
                }
            }).join('');
            
            // Tabloyu güncelle
            const tbody = document.querySelector('#productionLog tbody');
            if (tbody) {
                tbody.innerHTML = productionLogHTML;
                
                // Material usage'ları render et
                filteredData.forEach(entry => {
                    try {
                        renderMaterialUsageForEntry(entry.id);
                    } catch (error) {
                        console.error('Hata renderMaterialUsageForEntry:', entry.id, error);
                    }
                });
            }
            
            // Sonuç sayısını göster
            const resultCount = document.getElementById('productionResultCount');
            if (resultCount) {
                resultCount.textContent = `${filteredData.length} kayıt bulundu`;
            } else {
                // Sonuç sayısını göster
                const tableHeader = document.querySelector('#productionLog .px-6.py-4.bg-gray-50');
                if (tableHeader) {
                    const existingCount = tableHeader.querySelector('#productionResultCount');
                    if (existingCount) {
                        existingCount.remove();
                    }
                    const countElement = document.createElement('div');
                    countElement.id = 'productionResultCount';
                    countElement.className = 'text-sm text-indigo-600 font-medium';
                    countElement.textContent = `${filteredData.length} kayıt bulundu`;
                    tableHeader.appendChild(countElement);
                }
            }
        }

        function clearProductionFilters() {
            document.getElementById('productionSearchProduct').value = '';
            document.getElementById('productionSearchVariant').value = '';
            document.getElementById('productionSearchDateFrom').value = '';
            document.getElementById('productionSearchDateTo').value = '';
            document.getElementById('productionSearchQuantityMin').value = '';
            document.getElementById('productionSearchQuantityMax').value = '';
            
            // Tüm kayıtları göster
            renderProductionLog();
        }

        function exportProductionLog() {
            const searchProduct = document.getElementById('productionSearchProduct')?.value.toLowerCase() || '';
            const searchVariant = document.getElementById('productionSearchVariant')?.value.toLowerCase() || '';
            const searchDateFrom = document.getElementById('productionSearchDateFrom')?.value || '';
            const searchDateTo = document.getElementById('productionSearchDateTo')?.value || '';
            const searchQuantityMin = parseFloat(document.getElementById('productionSearchQuantityMin')?.value) || 0;
            const searchQuantityMax = parseFloat(document.getElementById('productionSearchQuantityMax')?.value) || Infinity;
            
            // Filtreleme (filterProductionLog ile aynı mantık)
            let filteredData = (productionLog || []).slice();
            
            if (searchProduct) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    return product && product.name.toLowerCase().includes(searchProduct);
                });
            }
            
            if (searchVariant) {
                filteredData = filteredData.filter(entry => {
                    const product = products.find(p => p.id === entry.productId);
                    const variant = product?.variants?.find(v => v.id === entry.variantId);
                    return variant && variant.name.toLowerCase().includes(searchVariant);
                });
            }
            
            if (searchDateFrom) {
                filteredData = filteredData.filter(entry => entry.date >= searchDateFrom);
            }
            
            if (searchDateTo) {
                filteredData = filteredData.filter(entry => entry.date <= searchDateTo);
            }
            
            if (searchQuantityMin > 0) {
                filteredData = filteredData.filter(entry => entry.quantity >= searchQuantityMin);
            }
            
            if (searchQuantityMax < Infinity) {
                filteredData = filteredData.filter(entry => entry.quantity <= searchQuantityMax);
            }
            
            // CSV oluştur
            const costData = calculateAllProductionCosts();
            const headers = ['Tarih', 'Ürün', 'Varyant', 'Adet', 'İşçilik Ücreti', 'Kazanç Oranı', 'Toplam Maliyet', 'Birim Maliyet', 'Önerilen Fiyat'];
            const rows = filteredData.map(entry => {
                const product = products.find(p => p.id === entry.productId);
                const variant = product?.variants?.find(v => v.id === entry.variantId);
                const costs = costData[entry.id] || {};
                
                return [
                    entry.date,
                    product?.name || '',
                    variant?.name || '',
                    entry.quantity,
                    entry.laborCost,
                    entry.profitMargin,
                    costs.totalCost || 0,
                    costs.unitCost || 0,
                    costs.recommendedUnitPrice || 0
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            // Dosyayı indir
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `uretim_kayitlari_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('📊 Üretim kayıtları Excel formatında indirildi!', 'success', 3000);
        }

        function renderSalesLog() { 
            const salesData = (salesLog || []).slice(); // Array'in kopyasını al
            // Tarihe göre sırala (en yeni en başta)
            salesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('sales'); 
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Satış Kaydı</h2>
                <p class="text-gray-600 mb-4">Yapılan satışları ve ödeme durumlarını buradan yönetin.</p>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button onclick="openSaleModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        📦 Sistemdeki Ürünlerden Satış
                    </button>
                    <button onclick="openQuickSaleModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        ⚡ Hızlı Satış (Sistem Dışı Ürün)
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Ürün Adı</th>
                                <th>Adet</th>
                                <th>Müşteri/Kanal</th>
                                <th>Ödeme Yöntemi</th>
                                <th>Toplam Maliyet</th>
                                <th>Gerçekleşen Kar</th>
                                <th>Toplam Tutar (KDV Dahil)</th>
                                <th>Eylem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesData.map(getSaleHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `; 
            makeTablesResizable();
        }
        function renderParameters() { const container = document.getElementById('parameters'); const coreParamsHTML = `<h3 class="text-xl font-semibold text-gray-700 mt-6 mb-2">Çekirdek Parametreler</h3><div class="table-container"><table id="parametersTable" class="resizable-table"><thead><tr><th>Parametre Adı</th><th>Değer</th><th>Birim</th></tr></thead><tbody><tr><td>Makine Ortalama kW</td><td><input type="number" step="0.01" value="${parameters.machineKw || 0}" onchange="updateParameter('machineKw', this.value)"></td><td>kW/saat</td></tr><tr><td>Elektrik kWh Fiyatı</td><td><input type="number" step="0.01" value="${parameters.electricityKwhPrice || 0}" onchange="updateParameter('electricityKwhPrice', this.value)"></td><td>TL/kWh</td></tr><tr><td>Makine İlk Maliyeti</td><td><input type="number" value="${parameters.machineInitialCost || 0}" onchange="updateParameter('machineInitialCost', this.value)"></td><td>TL</td></tr><tr><td>Makine Tahmini Ömrü</td><td><input type="number" value="${parameters.machineLifespanHours || 1}" onchange="updateParameter('machineLifespanHours', this.value)"></td><td>saat</td></tr></tbody></table></div>`; const customParamsHTML = `<div class="flex justify-between items-center mt-8 mb-2"><h3 class="text-xl font-semibold text-gray-700">Özel Maliyet Parametreleri</h3><button onclick="openCustomParamModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Yeni Özel Parametre Ekle</button></div><div class="table-container"><table id="customParametersTable" class="resizable-table"><thead><tr><th>Parametre Adı</th><th>Türü</th><th>Varsayılan Değer</th><th>Eylemler</th></tr></thead><tbody>${customParameters.map(p => `<tr class="removable" data-id="${p.id}"><td>${p.name}</td><td>${p.type === 'parasal' ? 'Parasal Değer (TL)' : p.type === 'saatlik' ? 'Saatlik Ücret (TL)' : 'Yüzdelik (%)'}</td><td>${p.value}</td><td><button onclick="openCustomParamModal('${p.id}')" class="bg-yellow-500 text-white px-3 py-1 text-sm rounded-md mr-2">Düzenle</button><button onclick="removeElement(this, 'customParameter')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-md">Sil</button></td></tr>`).join('')}</tbody></table></div>`; container.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">Parametre Yönetimi</h2><p class="text-gray-600 mb-4">Üretim ve satış hesaplamalarında kullanılacak temel ve özel değerleri buradan yönetin.</p>${coreParamsHTML}${customParamsHTML}`; makeTablesResizable();}
        function renderExpenses() {
            const container = document.getElementById('expenses');
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const thisMonthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                const now = new Date();
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            }).reduce((sum, exp) => sum + exp.amount, 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gider Yönetimi</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">Toplam Giderler</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${totalExpenses.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Bu Ay Giderler</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${thisMonthExpenses.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Gider Sayısı</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${expenses.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Gider Listesi</h3>
                    <button onclick="openAddExpenseModal()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        Yeni Gider Ekle
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Gider Türü</th>
                                <th>Açıklama</th>
                                <th>Tutar</th>
                                <th>Hesap</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(expenses || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map(getExpenseHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function renderMaterials() {
            const container = document.getElementById('materials');
            const totalValue = materials.reduce((sum, mat) => sum + (mat.quantity * mat.unitPrice), 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Malzeme Envanteri</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-700">Toplam Malzeme Değeri</h3>
                        <p class="text-3xl font-bold text-purple-800 mt-2">${totalValue.toFixed(2)} TL</p>
                    </div>
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-indigo-700">Malzeme Çeşidi</h3>
                        <p class="text-3xl font-bold text-indigo-800 mt-2">${materials.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Malzeme Listesi</h3>
                    <button onclick="openAddMaterialItemModal()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        Yeni Malzeme Ekle
                    </button>
                </div>
                <div class="table-container">
                    <table class="resizable-table">
                        <thead>
                            <tr>
                                <th>Malzeme Adı</th>
                                <th>Kategori</th>
                                <th>Miktar</th>
                                <th>Birim</th>
                                <th>Birim Fiyat</th>
                                <th>Toplam Değer</th>
                                <th>Eylemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materials.map(getMaterialHTML).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            makeTablesResizable();
        }

        function calculateTotalExpectedSales() {
            return productionPlans.reduce((sum, plan) => {
                const salePrice = plan.salePrice || 0;
                return sum + (salePrice * plan.orderQuantity);
            }, 0);
        }

        function calculateTotalExpectedCost() {
            return productionPlans.reduce((sum, plan) => {
                // Plan için maliyet hesaplama (basit yaklaşım)
                const unitTime = plan.unitTime || 0;
                const orderQuantity = plan.orderQuantity || 0;
                const machineCount = plan.machineCount || 1;
                
                // Elektrik maliyeti
                const electricityCost = unitTime * orderQuantity * parameters.machineKw * parameters.electricityKwhPrice;
                
                // Amortisman maliyeti
                const amortizationCost = (unitTime * orderQuantity * parameters.machineInitialCost) / parameters.machineLifespanHours;
                
                // İşçilik maliyeti
                const laborCost = unitTime * orderQuantity * parameters.laborCostPerProduct;
                
                return sum + electricityCost + amortizationCost + laborCost;
            }, 0);
        }

        function calculateTotalExpectedProfit() {
            const totalSales = calculateTotalExpectedSales();
            const totalCost = calculateTotalExpectedCost();
            return totalSales - totalCost;
        }

        function renderProductionPlanning() {
            const container = document.getElementById('productionPlanning');
            const totalPlannedItems = productionPlans.reduce((sum, plan) => sum + plan.orderQuantity, 0);
            const totalPlannedDays = productionPlans.reduce((sum, plan) => sum + plan.totalDays, 0);
            const activePlans = productionPlans.filter(plan => plan.status === 'active').length;
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Üretim Planlama Süreci</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-blue-700">Toplam Planlanan Adet</h3>
                        <p class="text-3xl font-bold text-blue-800 mt-2">${totalPlannedItems}</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-green-700">Toplam Planlanan Gün</h3>
                        <p class="text-3xl font-bold text-green-800 mt-2">${totalPlannedDays.toFixed(1)}</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-orange-700">Aktif Planlar</h3>
                        <p class="text-3xl font-bold text-orange-800 mt-2">${activePlans}</p>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-purple-700">Toplam Plan Sayısı</h3>
                        <p class="text-3xl font-bold text-purple-800 mt-2">${productionPlans.length}</p>
                    </div>
                    <div class="bg-emerald-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-emerald-700">💰 Beklenen Satış</h3>
                        <p class="text-3xl font-bold text-emerald-800 mt-2">${calculateTotalExpectedSales().toFixed(0)} ₺</p>
                    </div>
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-red-700">💸 Toplam Maliyet</h3>
                        <p class="text-3xl font-bold text-red-800 mt-2">${calculateTotalExpectedCost().toFixed(0)} ₺</p>
                    </div>
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-yellow-700">📈 Beklenen Kar</h3>
                        <p class="text-3xl font-bold text-yellow-800 mt-2">${calculateTotalExpectedProfit().toFixed(0)} ₺</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Üretim Planları</h3>
                    <button onclick="openAddProductionPlanModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Yeni Plan Ekle
                    </button>
                </div>
                <!-- Desktop Table View -->
                <div class="hidden lg:block bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🏷️ Ürün Adı</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⏱️ Birim Süre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🏭 Makine Sayısı</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📊 Günlük Kapasite</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📦 Sipariş Adedi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📅 Toplam Gün</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⏰ Toplam Saat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🎨 Filament Detayları</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">💰 Satış Fiyatı</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">💵 Toplam Satış</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📅 Başlangıç Tarihi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">🏁 Beklenen Bitiş</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📋 Sözleşme Tarihi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">📊 Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">⚙️ Eylemler</th>
                            </tr>
                        </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            ${productionPlans.map(getProductionPlanHTML).join('')}
                        </tbody>
                    </table>
                    </div>
                </div>

                <!-- Mobile Card View -->
                <div class="lg:hidden space-y-4">
                    ${productionPlans.map(getProductionPlanMobileHTML).join('')}
                </div>
            `;
            makeTablesResizable();
        }

        function renderModals() { 
            document.getElementById('addMaterialModal').innerHTML = getAddMaterialModalHTML(); 
            document.getElementById('updateStockModal').innerHTML = getUpdateStockModalHTML(); 
            document.getElementById('addSaleModal').innerHTML = getAddSaleModalHTML(); 
            document.getElementById('quickSaleModal').innerHTML = getQuickSaleModalHTML();
            document.getElementById('addFailedPrintModal').innerHTML = getAddFailedPrintModalHTML();
            document.getElementById('accountModal').innerHTML = getAccountModalHTML(); 
            document.getElementById('customParamModal').innerHTML = getCustomParamModalHTML(); 
            document.getElementById('addPaymentModal').innerHTML = getAddPaymentModalHTML(); 
            document.getElementById('accountDetailModal').innerHTML = getAccountDetailModalHTML(); 
            document.getElementById('editTransactionModal').innerHTML = getEditTransactionModalHTML();
            document.getElementById('addExpenseModal').innerHTML = getAddExpenseModalHTML();
            document.getElementById('addMoneyModal').innerHTML = getAddMoneyModalHTML();
            document.getElementById('addMaterialItemModal').innerHTML = getAddMaterialItemModalHTML();
            document.getElementById('addProductionPlanModal').innerHTML = getAddProductionPlanModalHTML();
            document.getElementById('editProductionPlanModal').innerHTML = getEditProductionPlanModalHTML();
        }


        // --- TAB & MODAL VISIBILITY ---
        function renderAllTabsAndModals() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            renderTabs();
            renderModals();
            const activeTabId = document.querySelector('.tab-button.active')?.dataset.tabId || parameters.tabOrder[0];
            showTab(activeTabId, false); // don't re-render tabs
            
            // İlk sekmenin otomatik açık olmasını sağla
            setTimeout(() => {
                const firstTab = document.querySelector('.tab-button');
                if (firstTab && !document.querySelector('.tab-button.active')) {
                    firstTab.click();
                }
            }, 100);
        }
        
        function showTab(tabId, shouldRenderTabs = true) {
            if (shouldRenderTabs) renderTabs();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const activeContent = document.getElementById(tabId);
            if(activeContent) activeContent.classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => button.classList.toggle('active', button.dataset.tabId === tabId));
            
            // Call the specific render function for the active tab
            const tabInfo = ALL_TABS.find(t => t.id === tabId);
            if (tabInfo && tabInfo.renderFunc) {
                tabInfo.renderFunc();
            }
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        
        let draggedTabElement = null;

        function renderTabs() {
            const tabContainer = document.getElementById('tabContainer'); tabContainer.innerHTML = '';
            parameters.tabOrder = parameters.tabOrder.filter(id => ALL_TABS.some(t => t.id === id));
            ALL_TABS.forEach(tabInfo => {
                 if (!parameters.tabOrder.includes(tabInfo.id)) {
                    parameters.tabOrder.push(tabInfo.id);
                }
            });

            parameters.tabOrder.forEach(tabId => {
                const tabInfo = ALL_TABS.find(t => t.id === tabId);
                if (tabInfo) {
                    const button = document.createElement('button');
                    button.className = 'tab-button'; button.textContent = tabInfo.title; button.dataset.tabId = tabId; button.draggable = true;
                    button.addEventListener('click', () => showTab(tabId));
                    button.addEventListener('dragstart', (e) => { draggedTabElement = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
                    button.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                    button.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('drag-over'); });
                    button.addEventListener('dragleave', (e) => e.target.classList.remove('drag-over'));
                    button.addEventListener('drop', (e) => {
                        e.preventDefault(); e.target.classList.remove('drag-over');
                        if (!draggedTabElement) return;
                        const draggedTabId = draggedTabElement.dataset.tabId;
                        const targetTabId = e.target.dataset.tabId;
                        if (draggedTabId && draggedTabId !== targetTabId) {
                            const oldIndex = parameters.tabOrder.indexOf(draggedTabId); const newIndex = parameters.tabOrder.indexOf(targetTabId);
                            parameters.tabOrder.splice(oldIndex, 1); parameters.tabOrder.splice(newIndex, 0, draggedTabId);
                            saveData(); renderTabs();
                        }
                    });
                    tabContainer.appendChild(button);
                }
            });
            const activeTab = document.querySelector('.tab-content:not(.hidden)');
            if (activeTab) { const activeBtn = tabContainer.querySelector(`[data-tab-id="${activeTab.id}"]`); if (activeBtn) activeBtn.classList.add('active'); } 
            else if (parameters.tabOrder.length > 0) { tabContainer.querySelector(`[data-tab-id="${parameters.tabOrder[0]}"]`)?.classList.add('active'); document.getElementById(parameters.tabOrder[0]).classList.remove('hidden'); }
        }


        // --- LOGIC FUNCTIONS ---
        function addSupplier() { suppliers.push({ id: crypto.randomUUID(), name: "Yeni Tedarikçi", materials: [] }); renderSuppliers(); saveData(); }
        function addMaterialToSupplier(supplierId) { const s = suppliers.find(s => s.id === supplierId); if(s) { if(!s.materials) s.materials = []; s.materials.push({ id: crypto.randomUUID(), name: "Filament", brand: "", color: "", type: "PLA", unit: "1000", price: 0 });} renderSuppliers(); saveData(); }
        function addCustomer() { customers.push({ id: crypto.randomUUID(), name: "Yeni Müşteri", contactPerson: "", phone: "", address: "", balance: 0 }); renderCustomers(); saveData(); }
        function addProduct() { 
            const newProduct = { id: crypto.randomUUID(), name: "Yeni Ürün", variants: [] };
            products.push(newProduct); 
            expandedProductId = newProduct.id; // Yeni ürünü otomatik genişlet
            renderProducts(); 
            saveData(); 
        }
        function addProductVariant(productId) { const p = products.find(p => p.id === productId); if (p) { if (!p.variants) p.variants = []; p.variants.push({ id: crypto.randomUUID(), name: "Yeni Parça", printTime: 0, colors: [] }); renderProducts(); saveData(); } }
        function enableExtraMaterials(productId) { const p = products.find(p => p.id === productId); if (p && !p.extraMaterials) { p.extraMaterials = []; renderProducts(); saveData(); } }
        function addProductExtraMaterial(productId) { if((rawMaterials || []).length === 0) { showMessageModal("Hata", "Önce hammadde eklemelisiniz."); return; } const p = products.find(p => p.id === productId); if(p) { if(!p.extraMaterials) p.extraMaterials = []; p.extraMaterials.push({ id: crypto.randomUUID(), rawMaterialId: rawMaterials[0].id, quantity: 1 });} renderProducts(); saveData(); }
        function addProductionEntry() { 
            try {
                console.log('addProductionEntry çağrıldı');
                
            if((products || []).length === 0) { 
                showMessageModal("Hata", "Üretim kaydı eklemek için önce 'Ürünler' sekmesinden bir ürün eklemelisiniz."); 
                return; 
            }
                
            const firstProduct = products[0];
                console.log('İlk ürün:', firstProduct);
                
            if(!firstProduct.variants || firstProduct.variants.length === 0) {
                 showMessageModal("Hata", "Üretim kaydı eklemek için önce 'Ürünler' sekmesindeki ürüne en az bir varyant (parça) eklemelisiniz.");
                 return;
            }

            const firstVariant = firstProduct.variants[0];
                console.log('İlk varyant:', firstVariant);

            const newEntry = { 
                id: crypto.randomUUID(), 
                date: new Date().toISOString().slice(0, 10), 
                productId: firstProduct.id, 
                variantId: firstVariant.id,
                quantity: 1, 
                laborCost: 0, 
                profitMargin: 0, 
                customValues: {}, 
                filamentOverrideId: '',
                materialUsage: [] // Malzeme kullanımı için
            }; 
                
                console.log('Yeni entry oluşturuldu:', newEntry);
                
                // Custom parameters'ları ekle
                (customParameters || []).forEach(p => { 
                    newEntry.customValues[p.id] = p.value; 
                }); 
                
            productionLog.push(newEntry); 
                console.log('Entry productionLog\'a eklendi. Toplam entry sayısı:', productionLog.length);
                
            renderProductionLog(); 
            saveData(true, true); // Zorla Firebase'e gönder 
                
                console.log('addProductionEntry tamamlandı');
            } catch (error) {
                console.error('addProductionEntry hatası:', error);
                showMessageModal("Hata", "Üretim kaydı eklenirken bir hata oluştu: " + error.message);
            }
        }
        function openAddAccountModal(type) { document.getElementById('accountModal').innerHTML = getAccountModalHTML(); const form = document.getElementById('accountForm'); form.reset(); document.getElementById('accountModalTitle').textContent = 'Yeni Hesap Ekle'; document.getElementById('accountModalSubmitBtn').textContent = 'Hesap Oluştur'; form.accountId.value = ''; form.accountType.value = type; document.getElementById('bankDetailsDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.add('hidden'); document.getElementById('initialBalanceDiv').classList.remove('hidden'); if (type === 'banka') { document.getElementById('bankDetailsDiv').classList.remove('hidden'); } else if (type === 'kredikarti') { document.getElementById('initialBalanceDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.remove('hidden'); } showModal('accountModal'); }
        function openEditAccountModal(accountId) { document.getElementById('accountModal').innerHTML = getAccountModalHTML(); const account = accounts.find(a => a.id === accountId); if (!account) return; const form = document.getElementById('accountForm'); form.reset(); document.getElementById('accountModalTitle').textContent = 'Hesabı Düzenle'; document.getElementById('accountModalSubmitBtn').textContent = 'Güncelle'; form.accountId.value = account.id; form.accountType.value = account.type; form.accountName.value = account.name; document.getElementById('bankDetailsDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.add('hidden'); document.getElementById('initialBalanceDiv').classList.remove('hidden'); if (account.type === 'nakit' || account.type === 'banka') { form.initialBalance.value = account.initialBalance || 0; } if (account.type === 'banka') { document.getElementById('bankDetailsDiv').classList.remove('hidden'); form.bankName.value = account.bankName || ''; form.iban.value = account.iban || ''; } else if (account.type === 'kredikarti') { document.getElementById('initialBalanceDiv').classList.add('hidden'); document.getElementById('creditCardDetailsDiv').classList.remove('hidden'); form.creditCardLimit.value = account.limit || 0; form.linkedAccountId.value = account.linkedAccountId || ''; } showModal('accountModal'); }
        function handleAccountFormSubmit() { 
            const form = document.getElementById('accountForm'); 
            const accountId = form.accountId.value; 
            
            if (accountId) { 
                // Hesap düzenleme
                const account = accounts.find(a => a.id === accountId); 
                if(account) { 
                    account.name = form.accountName.value; 
                    if (account.type === 'nakit' || account.type === 'banka') { 
                        account.initialBalance = parseFloat(form.initialBalance.value) || 0; 
                    } 
                    if (account.type === 'banka') { 
                        account.bankName = form.bankName.value; 
                        account.iban = form.iban.value; 
                    } else if (account.type === 'kredikarti') { 
                        account.limit = parseFloat(form.creditCardLimit.value) || 0; 
                        account.linkedAccountId = form.linkedAccountId.value; 
                    } 
                } 
            } else { 
                // Yeni hesap oluşturma
                const newAccount = { 
                    id: crypto.randomUUID(), 
                    type: form.accountType.value, 
                    name: form.accountName.value, 
                    initialBalance: parseFloat(form.initialBalance.value) || 0,
                    transactions: [] // Transaction array'ini başlat
                }; 
                
                if (newAccount.type === 'banka') { 
                    newAccount.bankName = form.bankName.value; 
                    newAccount.iban = form.iban.value; 
                } else if (newAccount.type === 'kredikarti') { 
                    newAccount.limit = parseFloat(form.creditCardLimit.value) || 0; 
                    newAccount.linkedAccountId = form.linkedAccountId.value; 
                } 
                
                accounts.push(newAccount);
                console.log('🔍 Yeni Hesap Oluşturuldu:', newAccount);
            } 
            
            renderCashFlow(); 
            saveData(); 
            closeModal('accountModal'); 
        }
        function openCustomParamModal(paramId = null) { const form = document.getElementById('customParamForm'); form.reset(); if(paramId) { const param = customParameters.find(p => p.id === paramId); if(param) { document.getElementById('customParamModalTitle').textContent = 'Parametreyi Düzenle'; document.getElementById('customParamModalSubmitBtn').textContent = 'Güncelle'; form.paramId.value = param.id; form.paramName.value = param.name; form.paramType.value = param.type; form.paramValue.value = param.value; } } else { document.getElementById('customParamModalTitle').textContent = 'Yeni Özel Parametre Ekle'; document.getElementById('customParamModalSubmitBtn').textContent = 'Ekle'; form.paramId.value = ''; } showModal('customParamModal'); }
        function handleCustomParamFormSubmit() { const form = document.getElementById('customParamForm'); const paramId = form.paramId.value; const paramData = { name: form.paramName.value, type: form.paramType.value, value: parseFloat(form.paramValue.value) || 0 }; if(paramId) { const index = customParameters.findIndex(p => p.id === paramId); if(index > -1) { customParameters[index] = {...customParameters[index], ...paramData}; } } else { customParameters.push({ id: crypto.randomUUID(), ...paramData}); } renderParameters(); saveData(); closeModal('customParamModal'); }
        function updateSupplierField(id, field, value) { const s = suppliers.find(s => s.id === id); if(s) s[field] = value; saveData(); }
        function updateSupplierMaterialField(supplierId, matId, field, value) { const s = suppliers.find(s => s.id === supplierId); const m = s?.materials.find(m => m.id === matId); if(m) m[field] = (field === 'price') ? (parseFloat(value) || 0) : value; saveData(); }
        function updateCustomerField(id, field, value) { const c = customers.find(c => c.id === id); if (c) c[field] = value; saveData(); }
        function updateRawMaterialField(id, field, value) { const m = rawMaterials.find(m => m.id === id); if (m) m[field] = parseFloat(value) || 0; saveData(); renderRawMaterials(); }
        function updateProductField(id, field, value) { const p = products.find(p => p.id === id); if (p && field === 'name') p[field] = value; saveData(); }
        function updateProductVariant(productId, variantId, field, value) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v) { v[field] = ['printTime', 'filamentUsage'].includes(field) ? (parseFloat(value) || 0) : value; } renderProducts(); renderProductionLog(); saveData(); }
        function addVariantColor(productId, variantId) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v) { if (!v.colors) v.colors = []; v.colors.push({ name: '', filamentId: '', gram: 0 }); renderProducts(); saveData(); } }
        function updateVariantColor(productId, variantId, colorIndex, field, value) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v && v.colors && v.colors[colorIndex]) { v.colors[colorIndex][field] = field === 'gram' ? (parseFloat(value) || 0) : value; } renderProducts(); renderProductionLog(); saveData(); }
        function removeVariantColor(productId, variantId, colorIndex) { const p = products.find(p => p.id === productId); const v = p?.variants.find(v => v.id === variantId); if (v && v.colors && v.colors[colorIndex]) { v.colors.splice(colorIndex, 1); renderProducts(); saveData(); } }
        function updateProductExtraMaterial(productId, matId, field, value) { const p = products.find(p => p.id === productId); const m = p?.extraMaterials.find(m => m.id === matId); if(m) m[field] = field === 'quantity' ? (parseFloat(value) || 0) : value; renderProducts(); saveData(); }
        function handleProductChangeInLog(selectElement, entryId) {
            const newProductId = selectElement.value;
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;

            const product = products.find(p => p.id === newProductId);
            // Update the variant dropdown with new options
            const variantSelect = document.getElementById(`variant-select-${entryId}`);
            if (product && product.variants) {
                variantSelect.innerHTML = product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                const firstVariantId = product.variants[0]?.id || null;
                entry.variantId = firstVariantId;
            } else {
                variantSelect.innerHTML = '';
                entry.variantId = null;
            }

            entry.productId = newProductId;
            
            // Rerender the material selector for the new variant and update costs
            renderProductionLog();
            saveData();
        }
        function updateProductionField(id, field, value) { 
            const p = productionLog.find(p => p.id === id); 
            if(p) { 
                if (['quantity', 'laborCost', 'profitMargin'].includes(field)) { 
                    p[field] = parseFloat(value) || 0; 
                } else { 
                    p[field] = value; 
                } 
            } 
            renderProductionLog(); 
            saveData(); 
        }
        function updateProductionFilamentOverride(entryId, selectedFilamentId) { const entry = productionLog.find(e => e.id === entryId); if (entry) { entry.filamentOverrideId = selectedFilamentId; renderProductionLog(); saveData(); } }
        function updateProductionCustomValue(entryId, paramId, value) { const entry = productionLog.find(e => e.id === entryId); if(entry && entry.customValues) { entry.customValues[paramId] = parseFloat(value) || 0; } renderProductionLog(); saveData(); }

        // Malzeme kullanımı için fonksiyonlar
        function renderMaterialUsageForEntry(entryId) {
            const container = document.getElementById(`material-usage-${entryId}`);
            if (!container) return;
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;
            
            const materialUsage = entry.materialUsage || [];
            const materialOptions = materials.map(m => 
                `<option value="${m.id}">${m.name} (Stok: ${m.quantity} ${m.unit})</option>`
            ).join('');
            
            let html = '<div class="space-y-1">';
            
            // Mevcut malzeme kullanımlarını göster
            materialUsage.forEach((usage, index) => {
                const material = materials.find(m => m.id === usage.materialId);
                if (material) {
                    html += `
                        <div class="flex items-center space-x-1 text-xs">
                            <span>${material.name}:</span>
                            <input type="number" step="0.01" value="${usage.quantity}" 
                                   onchange="updateMaterialUsage('${entryId}', ${index}, 'quantity', this.value)" 
                                   class="w-16 text-xs">
                            <span>${material.unit}</span>
                            <button onclick="removeMaterialUsage('${entryId}', ${index})" 
                                    class="bg-red-500 text-white px-1 py-0.5 text-xs rounded">×</button>
                        </div>
                    `;
                }
            });
            
            // Yeni malzeme ekleme
            html += `
                <div class="flex items-center space-x-1 text-xs">
                    <select onchange="addMaterialUsage('${entryId}', this.value)" class="text-xs">
                        <option value="">Malzeme Seç</option>
                        ${materialOptions}
                    </select>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function addMaterialUsage(entryId, materialId) {
            if (!materialId) return;
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry) return;
            
            if (!entry.materialUsage) {
                entry.materialUsage = [];
            }
            
            // Zaten eklenmiş mi kontrol et
            if (entry.materialUsage.find(u => u.materialId === materialId)) {
                return;
            }
            
            entry.materialUsage.push({
                materialId: materialId,
                quantity: 0
            });
            
            renderProductionLog();
            saveData();
        }

        function updateMaterialUsage(entryId, index, field, value) {
            console.log('updateMaterialUsage çağrıldı:', entryId, index, field, value);
            
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry || !entry.materialUsage) {
                console.error('Entry veya materialUsage bulunamadı:', entryId);
                return;
            }
            
            if (entry.materialUsage[index]) {
                const oldQuantity = entry.materialUsage[index].quantity;
                const newQuantity = parseFloat(value) || 0;
                
                console.log('Malzeme kullanımı güncelleniyor:');
                console.log('- Entry ID:', entryId);
                console.log('- Index:', index);
                console.log('- Old Quantity:', oldQuantity);
                console.log('- New Quantity:', newQuantity);
                console.log('- Entry Quantity:', entry.quantity);
                
                // Eski miktarı geri yükle, yeni miktarı çıkar
                // Malzeme kullanımı = birim miktar * üretim adedi
                const totalOldQuantity = oldQuantity * entry.quantity;
                const totalNewQuantity = newQuantity * entry.quantity;
                
                console.log('- Total Old Quantity:', totalOldQuantity);
                console.log('- Total New Quantity:', totalNewQuantity);
                console.log('- Quantity Change:', totalOldQuantity - totalNewQuantity);
                
                // Malzeme bilgisini al
                const material = materials.find(m => m.id === entry.materialUsage[index].materialId);
                const materialName = material ? material.name : 'Bilinmeyen Malzeme';
                
                console.log('- Material ID:', entry.materialUsage[index].materialId);
                console.log('- Material Name:', materialName);
                
                updateMaterialStock(entry.materialUsage[index].materialId, totalOldQuantity - totalNewQuantity);
                
                entry.materialUsage[index][field] = newQuantity;
                
                console.log(`Malzeme kullanımı güncellendi: ${materialName} - ${oldQuantity} -> ${newQuantity} (${entry.quantity} adet için toplam: ${totalNewQuantity})`);
                
                // Kullanıcıya bildirim göster
                if (totalNewQuantity > 0) {
                    showNotification(`📦 ${materialName}: ${totalNewQuantity} adet stoktan düşüldü`, 'info', 3000);
                } else if (totalOldQuantity > 0) {
                    showNotification(`📦 ${materialName}: ${totalOldQuantity} adet stok geri yüklendi`, 'success', 3000);
                }
                
                renderProductionLog();
                renderMaterials(); // Malzeme listesini güncelle
                saveData();
            }
        }

        function removeMaterialUsage(entryId, index) {
            const entry = productionLog.find(e => e.id === entryId);
            if (!entry || !entry.materialUsage) return;
            
            const usage = entry.materialUsage[index];
            if (usage) {
                // Malzeme bilgisini al
                const material = materials.find(m => m.id === usage.materialId);
                const materialName = material ? material.name : 'Bilinmeyen Malzeme';
                
                // Malzeme stoğunu geri yükle (toplam miktar = birim miktar * üretim adedi)
                const totalQuantity = usage.quantity * entry.quantity;
                updateMaterialStock(usage.materialId, totalQuantity);
                console.log(`Malzeme stok geri yüklendi: ${usage.quantity} * ${entry.quantity} = ${totalQuantity}`);
                
                // Kullanıcıya bildirim göster
                if (totalQuantity > 0) {
                    showNotification(`📦 ${materialName}: ${totalQuantity} adet stok geri yüklendi`, 'success', 3000);
                }
            }
            
            entry.materialUsage.splice(index, 1);
            renderProductionLog();
            renderMaterials(); // Malzeme listesini güncelle
            saveData();
        }

        function updateMaterialStock(materialId, quantityChange) {
            const material = materials.find(m => m.id === materialId);
            if (material) {
                const oldQuantity = material.quantity;
                material.quantity = Math.max(0, material.quantity + quantityChange);
                const newQuantity = material.quantity;
                
                console.log(`Malzeme stok güncellendi: ${material.name} - ${oldQuantity} -> ${newQuantity} (değişim: ${quantityChange})`);
                
                // Malzemeler sekmesini güncelle
                renderMaterials();
                
                // Veriyi kaydet
                saveData();
            } else {
                console.error('Malzeme bulunamadı:', materialId);
            }
        }
        function updateParameter(field, value) { parameters[field] = parseFloat(value) || 0; saveData(); renderProductionLog(); renderDashboard(); }
        function removeElement(button, type, parentId = null) {
            const element = button.closest('.removable'); if (!element) return; const id = element.dataset.id;
            
            // Check for dependencies before deleting
            if (type === 'product') {
                const isInProduction = productionLog.some(p => p.productId === id);
                const isInSales = salesLog.some(s => s.productId === id);
                if (isInProduction || isInSales) {
                    showMessageModal("Silme Hatası", "Bu ürün üretim veya satış kayıtlarında kullanıldığı için silinemez. Önce ilgili kayıtları silmelisiniz.");
                    return;
                }
            }
             if (type === 'rawMaterial') {
                const isInUse = productionLog.some(p => p.filamentOverrideId === id) || products.some(prod => prod.extraMaterials?.some(em => em.rawMaterialId === id));
                if (isInUse) {
                    showMessageModal("Silme Hatası", "Bu hammadde üretim kayıtlarında veya ürün reçetelerinde kullanıldığı için silinemez.");
                    return;
                }
            }


            const actions = {
                supplier: () => { suppliers = suppliers.filter(s => s.id !== id); renderSuppliers(); },
                supplierMaterial: () => { const s = suppliers.find(s => s.id === parentId); if(s) s.materials = s.materials.filter(m => m.id !== id); renderSuppliers(); },
                customer: () => { customers = customers.filter(c => c.id !== id); renderCustomers(); },
                rawMaterial: () => { rawMaterials = rawMaterials.filter(m => m.id !== id); renderRawMaterials(); },
                product: () => { products = products.filter(p => p.id !== id); renderProducts(); },
                productVariant: () => { const p = products.find(p => p.id === parentId); if(p) p.variants = p.variants.filter(v => v.id !== id); renderProducts(); },
                productExtraMaterial: () => { const p = products.find(p => p.id === parentId); if(p) p.extraMaterials = p.extraMaterials.filter(m => m.id !== id); renderProducts(); },
                productionLog: () => { 
                    const entry = productionLog.find(p => p.id === id);
                    if (entry && entry.materialUsage) {
                        // Malzeme stoğunu geri yükle (toplam miktar = birim miktar * üretim adedi)
                        entry.materialUsage.forEach(usage => {
                            const totalQuantity = usage.quantity * entry.quantity;
                            updateMaterialStock(usage.materialId, totalQuantity);
                            console.log(`Üretim kaydı silindi, malzeme stok geri yüklendi: ${usage.quantity} * ${entry.quantity} = ${totalQuantity}`);
                        });
                    }
                    productionLog = productionLog.filter(p => p.id !== id); 
                    renderProductionLog(); 
                    renderMaterials(); // Malzeme listesini güncelle
                },
                sale: () => { 
                    const sale = salesLog.find(s => s.id === id);
                    if (sale) {
                        // Hesap hareketini sil
                        if (sale.paymentAccountId && sale.paymentMethod !== 'cariye') {
                            const account = accounts.find(a => a.id === sale.paymentAccountId);
                            if (account && account.transactions) {
                                // Satış ile ilgili transaction'ı bul ve sil
                                const transactionIndex = account.transactions.findIndex(tx => 
                                    tx.type === 'Satış Geliri' && 
                                    tx.date === sale.date && 
                                    tx.amount === sale.totalAmount
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    console.log('Satış hareketi hesaptan silindi');
                                }
                            }
                        }
                        
                        // Cariye satışsa müşteri bakiyesini geri al
                        if (sale.paymentMethod === 'cariye' && sale.customerId) {
                            const customer = customers.find(c => c.id === sale.customerId);
                            if (customer) {
                                customer.balance += sale.totalAmount;
                                console.log('Müşteri bakiyesi güncellendi');
                            }
                        }
                    }
                    
                    salesLog = salesLog.filter(s => s.id !== id); 
                    renderSalesLog(); 
                    renderCustomers();
                    renderCashFlow();
                },
                failedPrint: () => { failedPrints = failedPrints.filter(f => f.id !== id); renderFailedPrints(); },
                account: () => { accounts = accounts.filter(a => a.id !== id); renderCashFlow(); },
                customParameter: () => { customParameters = customParameters.filter(p => p.id !== id); renderParameters(); },
                material: () => { 
                    const material = materials.find(m => m.id === id);
                    if (material) {
                        // İlgili gideri sil
                        expenses = expenses.filter(e => !(e.category === 'Malzeme' && e.description.includes(material.name)));
                        
                        // İlgili kasa hareketini sil
                        payments = payments.filter(p => !(p.type === 'Malzeme' && p.notes.includes(material.name)));
                    }
                    materials = materials.filter(m => m.id !== id); 
                    renderMaterials(); 
                    renderExpenses(); 
                    renderCashFlow(); 
                }
            };

            if(actions[type]) {
                actions[type]();
                saveData(true, true); // Sessiz ama zorla kaydet - Firebase'e gönder
            }
        }
        function openAddMaterialFromSupplierModal() { const supplierSelect = document.getElementById('supplierSelect'); supplierSelect.innerHTML = '<option value="">Tedarikçi Seçin</option>' + (suppliers || []).map(s => `<option value="${s.id}">${s.name}</option>`).join(''); document.getElementById('materialSelect').innerHTML = ''; document.getElementById('initialStock').value = 1; showModal('addMaterialModal'); }
        function populateSupplierMaterials(supplierId) { const materialSelect = document.getElementById('materialSelect'); const supplier = suppliers.find(s => s.id === supplierId); materialSelect.innerHTML = '<option value="">Malzeme Seçin</option>'; if (supplier) materialSelect.innerHTML += (supplier.materials || []).map(m => `<option value="${m.id}">${m.name} - ${m.brand} (${m.color})</option>`).join(''); }
        function addRawMaterialFromSupplier() {
            const supplierId = document.getElementById('supplierSelect').value;
            const materialId = document.getElementById('materialSelect').value;
            const initialStock = parseFloat(document.getElementById('initialStock').value) || 0;
            const minStock = parseFloat(document.getElementById('minStock').value) || 0;
            const paymentAccountId = document.getElementById('addMaterialPaymentAccountId').value;
            const supplier = suppliers.find(s => s.id === supplierId);
            const materialTemplate = supplier?.materials.find(m => m.id === materialId);

            if (!materialTemplate || initialStock <= 0 || !paymentAccountId) {
                showMessageModal("Hata", "Lütfen tüm alanları geçerli bir şekilde doldurun.");
                return;
            }

            const cost = initialStock * materialTemplate.price;
            const date = new Date().toISOString().slice(0, 10);
            const newStockEntry = { id: crypto.randomUUID(), date: date, quantity: initialStock, price: materialTemplate.price, paymentAccountId, cost };

            // Check if this material from this supplier already exists in inventory
            let existingMaterial = rawMaterials.find(rm => rm.templateId === materialId && rm.supplierId === supplierId);

            if (existingMaterial) {
                // Update existing material's stock history
                if (!existingMaterial.stockHistory) existingMaterial.stockHistory = [];
                existingMaterial.stockHistory.push(newStockEntry);
            } else {
                // Create a new raw material entry
                rawMaterials.push({
                    id: crypto.randomUUID(),
                    templateId: materialId,
                    supplierId: supplierId,
                    name: materialTemplate.name,
                    brand: materialTemplate.brand,
                    color: materialTemplate.color,
                    type: materialTemplate.type,
                    unit: materialTemplate.unit,
                    minStock: minStock,
                    averageCost: materialTemplate.price, // Initial average cost
                    stockHistory: [newStockEntry]
                });
            }

            // Hesap transaction'ı da ekle
            const account = accounts.find(a => a.id === paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: date,
                    type: 'Alım',
                    description: `${materialTemplate.name} - ${materialTemplate.brand} (${initialStock} ${materialTemplate.unit || 'adet'})`,
                    amount: -cost // Negatif tutar (çıkış)
                });
            }

            renderAllTabsAndModals();
            closeModal('addMaterialModal');
            saveData();
        }
        function openUpdateStockModal(materialId) { document.getElementById('updateStockMaterialId').value = materialId; document.getElementById('replenishDate').value = new Date().toISOString().slice(0, 10); document.getElementById('addedStock').value = ''; document.getElementById('newPrice').value = ''; showModal('updateStockModal'); }
        function handleStockUpdate() { 
            const materialId = document.getElementById('updateStockMaterialId').value; 
            const addedStock = parseFloat(document.getElementById('addedStock').value); 
            const newPrice = parseFloat(document.getElementById('newPrice').value); 
            const date = document.getElementById('replenishDate').value; 
            const paymentAccountId = document.getElementById('paymentAccountId').value; 
            
            const material = rawMaterials.find(m => m.id === materialId); 
            if (!material || isNaN(addedStock) || addedStock <= 0 || isNaN(newPrice) || newPrice < 0 || !paymentAccountId) { 
                showMessageModal("Hata", "Lütfen tüm alanları geçerli bir şekilde doldurun."); 
                return; 
            } 
            
            const cost = addedStock * newPrice; 
            if(!material.stockHistory) material.stockHistory = []; 
            material.stockHistory.push({ id: crypto.randomUUID(), date, quantity: addedStock, price: newPrice, paymentAccountId, cost }); 
            
            // Hesap transaction'ı da ekle
            const account = accounts.find(a => a.id === paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: date,
                    type: 'Alım',
                    description: `${material.name} (${addedStock} ${material.unit || 'adet'})`,
                    amount: -cost // Negatif tutar (çıkış)
                });
            }
            
            const totalStock = material.stockHistory.reduce((sum, item) => sum + item.quantity, 0); 
            const totalCost = material.stockHistory.reduce((sum, item) => sum + (item.quantity * item.price), 0); 
            material.averageCost = totalStock > 0 ? totalCost / totalStock : 0; 
            renderAllTabsAndModals(); 
            closeModal('updateStockModal'); 
            saveData(); 
        }
        function openSaleModal() { 
            document.getElementById('saleForm').reset(); 
            document.getElementById('saleForm').saleProductSelect.innerHTML = '<option value="">Ürün Seçin</option>' + (products || []).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); 
            document.getElementById('saleForm').saleDate.value = new Date().toISOString().slice(0, 10);
            document.getElementById('variantSelectDiv').classList.add('hidden');
            handleSaleChannelChange({value: 'bireysel'}); 
            togglePaymentAccount('nakit'); 
            showModal('addSaleModal'); 
        }

        function openQuickSaleModal() {
            const form = document.getElementById('quickSaleForm');
            if (form) {
                form.reset();
                form.quickSaleDate.value = new Date().toISOString().slice(0, 10);
                document.getElementById('quickCustomerDiv').classList.add('hidden');
                document.getElementById('quickPlatformDiv').classList.add('hidden');
                document.getElementById('quickPaymentAccountDiv').classList.remove('hidden');
            }
            showModal('quickSaleModal');
        }

        function handleQuickSaleChannelChange(select) {
            const channel = select.value;
            const customerDiv = document.getElementById('quickCustomerDiv');
            const platformDiv = document.getElementById('quickPlatformDiv');
            
            customerDiv.classList.add('hidden');
            platformDiv.classList.add('hidden');
            
            if (channel === 'cari') {
                customerDiv.classList.remove('hidden');
                // Müşteri listesini doldur
                const customerSelect = document.querySelector('select[name="quickCustomerId"]');
                if (customerSelect) {
                    customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>' + 
                        customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } else if (channel === 'platform') {
                platformDiv.classList.remove('hidden');
            }
        }

        function toggleQuickPaymentAccount(paymentMethod) {
            const accountDiv = document.getElementById('quickPaymentAccountDiv');
            if (paymentMethod === 'cariye') {
                accountDiv.classList.add('hidden');
            } else {
                accountDiv.classList.remove('hidden');
            }
        }

        function addQuickSale() {
            const form = document.getElementById('quickSaleForm');
            const formData = new FormData(form);
            
            const date = formData.get('quickSaleDate');
            const productName = formData.get('quickProductName');
            const quantity = parseInt(formData.get('quickQuantity')) || 1;
            const gramage = parseFloat(formData.get('quickGramage')) || 0;
            const unitPrice = parseFloat(formData.get('quickUnitPrice')) || 0;
            const vatRate = parseFloat(formData.get('quickVatRate')) || 0;
            const channel = formData.get('quickChannel');
            const paymentMethod = formData.get('quickPaymentMethod');
            const paymentAccountId = formData.get('quickPaymentAccountId');
            const notes = formData.get('quickNotes') || '';
            
            if (!productName || unitPrice <= 0) {
                showMessageModal("Hata", "Lütfen ürün adı ve fiyat bilgilerini girin.");
                return;
            }
            
            // Müşteri/Platform bilgisi
            let customerInfo = 'Bireysel Satış';
            let customerId = null;
            
            if (channel === 'cari') {
                const selectedCustomerId = formData.get('quickCustomerId');
                const newCustomerName = formData.get('quickCustomerName');
                
                let customer = null;
                
                if (selectedCustomerId) {
                    // Mevcut müşteri seçildi
                    customer = customers.find(c => c.id === selectedCustomerId);
                    customerInfo = customer ? customer.name : 'Bilinmeyen Müşteri';
                    customerId = selectedCustomerId;
                } else if (newCustomerName && newCustomerName.trim()) {
                    // Yeni müşteri eklendi
                    customer = {
                        id: crypto.randomUUID(),
                        name: newCustomerName.trim(),
                        balance: 0
                    };
                    customers.push(customer);
                    customerInfo = customer.name;
                    customerId = customer.id;
                } else {
                    showMessageModal("Hata", "Lütfen mevcut müşteri seçin veya yeni müşteri adı girin.");
                    return;
                }
            } else if (channel === 'platform') {
                const platformName = formData.get('quickPlatformName');
                if (platformName) {
                    customerInfo = `Platform: ${platformName}`;
                }
            }
            
            // Hesaplama
            const subtotal = quantity * unitPrice;
            const vatAmount = vatRate > 0 ? subtotal * (vatRate / 100) : 0;
            const totalAmount = subtotal + vatAmount;
            
            // Debug logları
            console.log('🔍 Hızlı Satış Hesaplama:');
            console.log('- KDV Oranı:', vatRate);
            console.log('- Birim Fiyat:', unitPrice);
            console.log('- Adet:', quantity);
            console.log('- Ara Toplam:', subtotal);
            console.log('- KDV Tutarı:', vatAmount);
            console.log('- Toplam Tutar:', totalAmount);
            
            // Maliyet hesaplama (gram başına 0.5 TL)
            const totalCost = gramage > 0 ? (gramage * quantity * 0.5) : 0;
            const realizedProfit = totalAmount - totalCost;
            
            // Satış kaydı oluştur
            const saleEntry = {
                id: crypto.randomUUID(),
                date: date,
                productName: productName + (gramage > 0 ? ` (${gramage}gr)` : ''),
                productId: null, // Sistem dışı ürün
                variantId: null,
                quantity: quantity,
                unitPrice: unitPrice,
                vatRate: vatRate,
                totalAmount: totalAmount,
                customerInfo: customerInfo,
                customerId: customerId,
                channel: channel, // Kanal bilgisini ekle
                paymentMethod: paymentMethod,
                paymentAccountId: paymentAccountId,
                totalCost: totalCost,
                realizedProfit: realizedProfit,
                notes: notes,
                isQuickSale: true // Hızlı satış işareti
            };
            
            salesLog.push(saleEntry);
            
            // Ödeme işlemleri - Hızlı satışta hesap transaction'ı ekleme, sadece cariye için müşteri bakiyesi güncelle
            if (paymentMethod === 'cariye' && customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.balance -= totalAmount;
                }
            }
            
            saveData();
            renderSalesLog();
            renderCustomers();
            renderCashFlow();
            closeModal('quickSaleModal');
            
            showNotification(`⚡ Hızlı satış başarıyla kaydedildi! Toplam: ${totalAmount.toFixed(2)} TL`, 'success', 3000);
        }
        function addSale() { 
            const form = document.getElementById('saleForm'); 
            const variantId = form.saleVariantSelect?.value || null;
            const averageUnitCost = getAverageUnitCostForProduct(form.saleProductSelect.value, variantId); 
            const newSale = { 
                id: crypto.randomUUID(), 
                date: form.saleDate.value, 
                productId: form.saleProductSelect.value, 
                variantId: variantId, // Varyant ID'sini kaydet
                quantity: parseFloat(form.saleQuantity.value), 
                unitPrice: parseFloat(form.saleUnitPrice.value), 
                vatRate: parseFloat(form.saleVatRate.value), 
                channel: form.saleChannel.value, 
                paymentMethod: form.salePaymentMethod.value, 
                customerId: form.saleCustomerSelect.dataset.selectedValue || form.saleCustomerSelect.value, 
                platformName: form.salePlatformName.value, 
                paymentAccountId: form.paymentAccountId.value, 
                totalAmount: 0, 
                realizedProfit: 0 
            }; 
            if (newSale.paymentMethod === 'cariye') {
                newSale.paymentAccountId = null; // Cariye satışta kasaya para girmez.
            }
            if (!newSale.productId || !newSale.quantity || isNaN(newSale.unitPrice)) { showMessageModal("Hata", "Lütfen ürün, adet ve fiyat bilgilerini girin."); return; } 
            if(newSale.paymentMethod !== 'cariye' && !newSale.paymentAccountId){ showMessageModal("Hata", "Lütfen ödemenin alındığı hesabı seçin."); return; } 
            newSale.realizedProfit = (newSale.unitPrice - averageUnitCost) * newSale.quantity; 
            newSale.totalAmount = newSale.quantity * newSale.unitPrice * (1 + newSale.vatRate / 100); 
            salesLog.push(newSale); 
            renderAllTabsAndModals(); 
            closeModal('addSaleModal'); 
            saveData(true, true); // Zorla Firebase'e gönder
        }
        function togglePaymentAccount(method) { const div = document.getElementById('paymentAccountDiv'); if(method === 'cariye') { div.classList.add('hidden'); } else { div.classList.remove('hidden'); } }
        function handleSaleChannelChange(select) { 
            const customerDiv = document.getElementById('customerSelectDiv'); 
            const platformDiv = document.getElementById('platformInputDiv'); 
            customerDiv.classList.add('hidden'); 
            platformDiv.classList.add('hidden'); 
            
            if (select.value === 'cari') { 
                customerDiv.classList.remove('hidden'); 
                // Otomatik tamamlama için müşteri input'u hazırla
                const customerInput = customerDiv.querySelector('input');
                if (customerInput && !customerInput.dataset.autocompleteInitialized) {
                    createAutocomplete(customerInput, customers || [], 'name', 'id');
                    customerInput.dataset.autocompleteInitialized = 'true';
                }
            } else if (select.value === 'platform') { 
                platformDiv.classList.remove('hidden'); 
            } 
        }

        // Baskı hataları fonksiyonları
        function openAddFailedPrintModal() {
            showModal('addFailedPrintModal');
            // Bugünün tarihini varsayılan olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="failedPrintDate"]').value = today;
        }

        function handleProductChangeInFailedPrint(productId) {
            const product = products.find(p => p.id === productId);
            const variantDiv = document.getElementById('failedPrintVariantSelectDiv');
            const variantSelect = document.querySelector('[name="failedPrintVariantSelect"]');
            
            if (product && product.variants && product.variants.length > 0) {
                variantDiv.classList.remove('hidden');
                variantSelect.innerHTML = '<option value="">Varyant Seçin</option>' + 
                    product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            } else {
                variantDiv.classList.add('hidden');
                variantSelect.innerHTML = '<option value="">Varyant Seçin</option>';
            }
            calculateFailedPrintCost();
        }

        function calculateFailedPrintCost() {
            const form = document.getElementById('failedPrintForm');
            const productId = form.failedPrintProductSelect.value;
            const variantId = form.failedPrintVariantSelect.value;
            const quantity = parseFloat(form.failedPrintQuantity.value) || 0;
            
            if (!productId || !quantity) {
                document.getElementById('failedPrintCostInfo').classList.add('hidden');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product) return;
            
            let materialCost = 0;
            let materialLoss = '';
            
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    const filamentCost = filament ? (filament.averageCost || 0) : 0;
                    const colorCost = (colorGram / 1000) * filamentCost; // gram'ı kg'a çevir
                    materialCost += colorCost;
                    materialLoss += `${color.name}: ${colorGram.toFixed(2)} gr (${filament?.brand || 'Bilinmeyen'})<br>`;
                });
            }
            
            // Toplam maliyet = hammadde maliyeti + işçilik + elektrik + amortisman
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const totalCost = averageUnitCost * quantity;
            
            document.getElementById('materialLossDisplay').innerHTML = materialCost.toFixed(2) + ' TL';
            document.getElementById('totalFailedCostDisplay').textContent = totalCost.toFixed(2) + ' TL';
            document.getElementById('failedPrintCostInfo').classList.remove('hidden');
        }

        function addFailedPrint() {
            const form = document.getElementById('failedPrintForm');
            const productId = form.failedPrintProductSelect.value;
            const variantId = form.failedPrintVariantSelect.value;
            const quantity = parseFloat(form.failedPrintQuantity.value);
            const reason = form.failedPrintReason.value;
            const description = form.failedPrintDescription.value;
            
            if (!productId || !quantity) {
                showMessageModal("Hata", "Lütfen ürün ve adet bilgilerini girin.");
                return;
            }
            
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product) {
                showMessageModal("Hata", "Ürün bulunamadı.");
                return;
            }
            
            // Gerçek stok kontrolü - calculateAllStocks kullanarak
            const stockData = calculateAllStocks();
            const productStockData = stockData.productStock.find(p => p.id === productId);
            
            if (!productStockData) {
                showMessageModal("Hata", "Ürün stok bilgisi bulunamadı.");
                return;
            }
            
            let currentStock = 0;
            if (variant) {
                const variantStockData = productStockData.variants.find(v => v.id === variantId);
                if (!variantStockData) {
                    showMessageModal("Hata", "Varyant stok bilgisi bulunamadı.");
                    return;
                }
                currentStock = variantStockData.stock;
            } else {
                currentStock = productStockData.stock;
            }
            
            if (currentStock < quantity) {
                showMessageModal("Hata", `Yeterli stok yok. Mevcut stok: ${currentStock} adet`);
                return;
            }
            
            console.log(`Stok kontrolü: Mevcut stok ${currentStock}, istenen miktar ${quantity}`);
            
            // Baskı hatası kaydı oluştur
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const newFailedPrint = {
                id: crypto.randomUUID(),
                date: form.failedPrintDate.value,
                productId: productId,
                variantId: variantId,
                quantity: quantity,
                reason: reason,
                description: description,
                totalCost: averageUnitCost * quantity
            };
            
            // Stoktan düş - Gerçek stok değerlerini kullan
            console.log(`Stok güncelleme: Mevcut stok ${currentStock}, düşülecek miktar ${quantity}`);
            
            // Not: Stok güncellemesi artık calculateAllStocks fonksiyonu tarafından otomatik yapılıyor
            // failedPrints array'ine eklenen kayıt otomatik olarak stok hesaplamasını etkileyecek
            
            // Hammadde stoklarını güncelle
            if (variant && variant.colors && variant.colors.length > 0) {
                variant.colors.forEach(color => {
                    const colorGram = (color.gram || 0) * quantity;
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    if (filament) {
                        const oldStock = filament.currentStock || 0;
                        const stockChange = colorGram / 1000; // gram'ı kg'a çevir
                        filament.currentStock = Math.max(0, (filament.currentStock || 0) - stockChange);
                        console.log(`Hammadde stok güncellendi: ${filament.brand} ${filament.color} - ${oldStock} -> ${filament.currentStock} (${stockChange} kg düşüldü)`);
                    }
                });
            }
            
            failedPrints.push(newFailedPrint);
            
            // İlgili sekmeleri güncelle
            renderFailedPrints();
            renderStockStatus();
            renderProducts();
            
            closeModal('addFailedPrintModal');
            saveData(true, true);
            
            showMessageModal("Başarılı", `${quantity} adet ${product.name}${variant ? ' - ' + variant.name : ''} stoktan düşürüldü ve baskı hatası kaydı oluşturuldu.`);
        }
        function handleProductChangeInSale(productId) {
            const variantSelectDiv = document.getElementById('variantSelectDiv');
            const variantSelect = document.querySelector('[name=saleVariantSelect]');
            
            if (!productId) {
                variantSelectDiv.classList.add('hidden');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.variants || product.variants.length === 0) {
                variantSelectDiv.classList.add('hidden');
                return;
            }
            
            // Anahtarlık gibi tek tek satılan ürünler için varyant seçimi göster
            // Oyun gibi toplam satılan ürünler için gizle
            const isVariantBasedSale = product.name.toLowerCase().includes('anahtarlık') || 
                                      product.name.toLowerCase().includes('anahtar');
            
            if (isVariantBasedSale) {
                variantSelectDiv.classList.remove('hidden');
                variantSelect.innerHTML = '<option value="">Varyant Seçin</option>' + 
                    product.variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                variantSelect.required = true;
            } else {
                variantSelectDiv.classList.add('hidden');
                variantSelect.required = false;
                variantSelect.value = '';
            }
        }
        
        function updateSalePrice(productId) { 
            if (!productId) return; 
            
            const variantId = document.querySelector('[name=saleVariantSelect]')?.value;
            let averageUnitCost;
            
            if (variantId) {
                // Varyant bazlı satış - sadece o varyantın maliyetini hesapla
                averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            } else {
                // Ürün bazlı satış - tüm ürünün ortalama maliyetini hesapla
                averageUnitCost = getAverageUnitCostForProduct(productId);
            }
            
            const recommendedPrice = averageUnitCost * (1 + (parameters.profitMargin || 0) / 100); 
            document.getElementById('saleForm').saleUnitPrice.value = recommendedPrice.toFixed(2); 
            
            // Maliyet bilgisini güncelle
            updateSaleCostAndProfit();
        }
        
        function updateSaleCostAndProfit() {
            const form = document.getElementById('saleForm');
            if (!form) return;
            
            const productId = form.saleProductSelect.value;
            const variantId = form.saleVariantSelect?.value || null;
            const quantity = parseFloat(form.saleQuantity.value) || 0;
            const unitPrice = parseFloat(form.saleUnitPrice.value) || 0;
            const vatRate = parseFloat(form.saleVatRate.value) || 0;
            
            if (!productId) {
                document.getElementById('saleCostInfo').classList.add('hidden');
                return;
            }
            
            // Maliyet hesapla
            const averageUnitCost = getAverageUnitCostForProduct(productId, variantId);
            const totalCost = averageUnitCost * quantity;
            const totalAmount = quantity * unitPrice * (1 + vatRate / 100);
            const profit = totalAmount - totalCost;
            
            // Debug için console'a yazdır
            console.log('Satış Maliyet Hesaplama:', {
                productId,
                variantId,
                averageUnitCost,
                quantity,
                totalCost,
                unitPrice,
                totalAmount,
                profit
            });
            
            // Görüntüle
            document.getElementById('unitCostDisplay').textContent = averageUnitCost.toFixed(2) + ' TL';
            document.getElementById('totalCostDisplay').textContent = totalCost.toFixed(2) + ' TL';
            document.getElementById('profitDisplay').textContent = profit.toFixed(2) + ' TL';
            document.getElementById('totalAmountDisplay').textContent = totalAmount.toFixed(2) + ' TL';
            
            // Bilgi panelini göster
            document.getElementById('saleCostInfo').classList.remove('hidden');
        }

        // --- CALCULATION HELPERS ---
        function calculateProductTotals(productOrProductId) { 
            const p = typeof productOrProductId === 'string' ? products.find(pr => pr.id === productOrProductId) : productOrProductId; 
            if (!p || !p.variants) return { totalPrintTime: 0, totalFilamentUsage: 0 }; 
            
            return p.variants.reduce((t, v) => { 
                t.totalPrintTime += parseFloat(v.printTime) || 0; 
                
                // Yeni renk sistemi için filament kullanımını hesapla
                if (v.colors && v.colors.length > 0) {
                    v.colors.forEach(color => {
                        t.totalFilamentUsage += parseFloat(color.gram) || 0;
                    });
                } else {
                    // Eski sistem için fallback
                    t.totalFilamentUsage += parseFloat(v.filamentUsage) || 0;
                }
                
                return t; 
            }, { totalPrintTime: 0, totalFilamentUsage: 0 }); 
        }
        
        function calculateAccountSummary(accountId = null) {
            if (accountId) {
                const acc = accounts.find(a => a.id === accountId);
                if (!acc) return { currentBalance: 0 };
                let currentBalance = acc.initialBalance || 0;
                // Sadece kasaya giren satışları ekle (Cari hariç)
                salesLog.forEach(sale => { if (sale.paymentAccountId === accountId && sale.paymentMethod !== 'cariye') currentBalance += sale.totalAmount; });
                // Payments'tan işlemleri ekle/düş
                payments.forEach(p => { 
                    if (p.paymentAccountId === accountId) {
                        if (p.type === 'Malzeme') {
                            currentBalance -= p.amount; // Malzeme alımı hesaptan düşer
                        } else if (p.customerId) {
                            // Müşteri tahsilatları (eski kayıtlar için - yeni kayıtlar transactions'ta)
                            // Çift saymayı önlemek için transaction'da olup olmadığını kontrol et
                            const existsInTransactions = acc.transactions?.some(t => 
                                t.paymentId === p.id || // PaymentId ile kontrol (yeni kayıtlar için)
                                (t.type === 'Tahsilat' && Math.abs(t.amount - p.amount) < 0.01 && t.date === p.date) // Tarih/tutar ile kontrol (eski kayıtlar için)
                            );
                            if (!existsInTransactions) {
                                currentBalance += p.amount;
                            }
                        }
                    }
                });
                
                // Hesap işlemlerini de kontrol et (hammadde alımları, gider kayıtları, tahsilatlar dahil)
                if (acc.transactions) {
                    acc.transactions.forEach(transaction => {
                        currentBalance += transaction.amount; // Negatif değerler zaten hesaptan düşer
                    });
                }
                
                return { currentBalance };
            }
            let cashBalance = 0, bankBalance = 0, creditCardDebt = 0;
            accounts.forEach(acc => {
                const { currentBalance } = calculateAccountSummary(acc.id);
                if (acc.type === 'nakit') cashBalance += currentBalance;
                if (acc.type === 'banka') bankBalance += currentBalance;
                if (acc.type === 'kredikarti') creditCardDebt += currentBalance * -1; // Borç olduğu için eksiye çevir
            });
            return { cashBalance, bankBalance, creditCardDebt };
        }

        function calculateTotalReceivables() {
            let totalReceivables = 0;
            customers.forEach(customer => {
                const balance = calculateCustomerBalance(customer.id);
                 if (balance < 0) { // Sadece alacakları topla
                    totalReceivables += Math.abs(balance);
                }
            });
            return totalReceivables;
        }

        function calculateCustomerBalance(customerId) {
            const totalSales = salesLog.filter(s => s.customerId === customerId && s.paymentMethod === 'cariye').reduce((sum, s) => sum + s.totalAmount, 0);
            const totalPayments = payments.filter(p => p.customerId === customerId).reduce((sum, p) => sum + p.amount, 0);
            return totalPayments - totalSales;
        }
        function getAverageUnitCostForProduct(productId, variantId = null) { 
            if (variantId) {
                // Varyant bazlı satış - sadece o varyantın üretim kayıtlarını al
                const relevantProductions = (productionLog || []).filter(p => p.productId === productId && p.variantId === variantId);
                
            if (relevantProductions.length === 0) { 
                    // Üretim kaydı yoksa hesaplama yap
                const defaultCustomValues = {}; 
                (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    return calculateProductUnitCost(productId, variantId, 0, defaultCustomValues, ''); 
            } 
                
            const allCosts = calculateAllProductionCosts(); 
            let totalProductionCost = 0; 
            let totalQuantityProduced = 0; 
                
            relevantProductions.forEach(p => { 
                const costs = allCosts[p.id]; 
                if (costs && costs.totalCost) { 
                    totalProductionCost += costs.totalCost; 
                    totalQuantityProduced += p.quantity; 
                } 
            }); 
                
            if (totalQuantityProduced === 0) { 
                    // Üretim var ama maliyet hesaplanamıyor
                const defaultCustomValues = {}; 
                (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    return calculateProductUnitCost(productId, variantId, 0, defaultCustomValues, ''); 
            } 
                
            return totalProductionCost / totalQuantityProduced; 
            } else {
                // Ürün bazlı satış - tüm varyantların maliyetini topla
                const product = products.find(p => p.id === productId);
                if (!product || !product.variants || product.variants.length === 0) {
                    return 0;
                }
                
                // Tüm varyantların maliyetini topla
                let totalProductCost = 0;
                product.variants.forEach(variant => {
                    // Her varyant için maliyet hesapla
                    const defaultCustomValues = {}; 
                    (customParameters || []).forEach(p => { defaultCustomValues[p.id] = p.value; }); 
                    const variantCost = calculateProductUnitCost(productId, variant.id, 0, defaultCustomValues, '');
                    totalProductCost += variantCost;
                });
                
                return totalProductCost;
            }
        }
        function getCalculatedRawMaterialStocks() { 
            const rawMaterialConsumption = {}; 
            (productionLog || []).forEach(entry => { 
                const product = products.find(p => p.id === entry.productId);
                if (!product) return;
                
                const variant = product.variants.find(v => v.id === entry.variantId);
                if (!variant) return;

                // Yeni renk sistemi - tüm renklerden hammadde düş
                if (variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        if (color.filamentId && color.gram > 0) {
                            const consumedQuantity = (color.gram || 0) * entry.quantity;
                            rawMaterialConsumption[color.filamentId] = (rawMaterialConsumption[color.filamentId] || 0) + consumedQuantity;
                        }
                    });
                } else {
                    // Eski sistem için fallback
                const filamentUsage = variant.filamentUsage || 0;
                const filamentIdToConsume = entry.filamentOverrideId;
                if(filamentIdToConsume && filamentUsage > 0){
                    rawMaterialConsumption[filamentIdToConsume] = (rawMaterialConsumption[filamentIdToConsume] || 0) + (filamentUsage * entry.quantity);
                    }
                }
                (product.extraMaterials || []).forEach(mat => {
                    const consumedQuantity = mat.quantity * entry.quantity;
                    rawMaterialConsumption[mat.rawMaterialId] = (rawMaterialConsumption[mat.rawMaterialId] || 0) + consumedQuantity;
                }); 
            }); 
            return (rawMaterials || []).map(rm => { const consumed = rawMaterialConsumption[rm.id] || 0; const totalPurchased = (rm.stockHistory || []).reduce((sum, item) => sum + item.quantity, 0); return { ...rm, currentStock: totalPurchased - consumed, averageCost: rm.averageCost || 0 }; }); 
        }
        function calculateProductUnitCost(productId, variantId, laborCost, entryCustomValues, filamentOverrideId) { 
            const product = (products || []).find(p => p.id === productId); if (!product) return 0; 
            const variant = product.variants?.find(v => v.id === variantId); if (!variant) return 0;
            const customValues = entryCustomValues || {}; 
            let extraMaterialCost = 0; 
            if(product.extraMaterials) { (product.extraMaterials || []).forEach(mat => { const rawMat = (rawMaterials || []).find(rm => rm.id === mat.rawMaterialId); if (rawMat) extraMaterialCost += mat.quantity * (rawMat.averageCost || 0); }); } 
            
            const printTime = variant.printTime || 0;
            const filamentUsage = variant.filamentUsage || 0;
            
            let filamentCost = 0;
            
            // Yeni renk sistemi için filament maliyetini hesapla
            if (variant.colors && variant.colors.length > 0) {
                // Yeni sistem: her rengin filament maliyetini topla
                variant.colors.forEach(color => {
                    const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                    if (filament && color.gram > 0) {
                        filamentCost += (color.gram || 0) * (filament.averageCost || 0);
                    }
                });
            } else {
                // Eski sistem için fallback
                const filamentId = variant.filamentId || filamentOverrideId;
                const filament = rawMaterials.find(rm => rm.id === filamentId);
            if(filament && filamentUsage > 0){
                filamentCost = filamentUsage * (filament.averageCost || 0); 
            } else if (filamentUsage > 0 && !filament) {
                // Filament seçilmemişse maliyet hesaplanamaz.
                return 0; 
                }
            }

            const electricityCost = (parameters.machineKw || 0) * (parameters.electricityKwhPrice || 0) * printTime; 
            const laborCostValue = (laborCost || 0); 
            let baseCost = filamentCost + extraMaterialCost + electricityCost + laborCostValue;
            
            // Amortisman: ürün maliyetine göre %5
            const amortizationCost = baseCost * 0.05;
            baseCost += amortizationCost; 
            let totalCustomCost = 0; 
            customParameters.forEach(p => { const value = customValues[p.id] !== undefined ? customValues[p.id] : p.value; const numericValue = parseFloat(value); if(!isNaN(numericValue)) { if(p.type === 'parasal') totalCustomCost += numericValue; else if (p.type === 'saatlik') totalCustomCost += numericValue * printTime; else if (p.type === 'yuzdelik') totalCustomCost += baseCost * (numericValue / 100); } }); 
            baseCost += totalCustomCost; return baseCost * (1 + ((parameters.failedPrintRate || 0) / 100)); 
        }
        function calculateAllProductionCosts() { 
            const costMap = {}; 
            try {
            (productionLog || []).forEach(entry => { 
                    try {
                const product = (products || []).find(p => p.id === entry.productId); 
                        if (!product || !entry.quantity || !entry.variantId) { 
                            costMap[entry.id] = {
                                materialCost: 0,
                                electricityCost: 0,
                                amortizationCost: 0,
                                laborCost: 0,
                                failedPrintCost: 0,
                                customCosts: {},
                                totalCost: 0,
                                unitCost: 0,
                                recommendedUnitPrice: 0
                            }; 
                            return; 
                        } 
                        const variant = product?.variants?.find(v => v.id === entry.variantId);
                        if (!variant) { 
                            costMap[entry.id] = {
                                materialCost: 0,
                                electricityCost: 0,
                                amortizationCost: 0,
                                laborCost: 0,
                                failedPrintCost: 0,
                                customCosts: {},
                                totalCost: 0,
                                unitCost: 0,
                                recommendedUnitPrice: 0
                            }; 
                            return; 
                        }

                const entryLaborCost = entry.laborCost !== undefined ? entry.laborCost : 0; 
                const entryProfitMargin = entry.profitMargin !== undefined ? entry.profitMargin : 0; 
                const printTime = variant.printTime || 0; 
                
                // Malzeme maliyetleri
                let extraMaterialCost = 0; 
                if(product.extraMaterials) { 
                    (product.extraMaterials || []).forEach(mat => { 
                        const rawMat = (rawMaterials || []).find(rm => rm.id === mat.rawMaterialId); 
                        if (rawMat) extraMaterialCost += mat.quantity * (rawMat.averageCost || 0); 
                    }); 
                } 
                
                let filamentCost = 0; 
                
                // Tüm renklerin maliyetini hesapla (birim maliyet olarak)
                if (variant && variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                        if (filament && color.gram > 0) {
                            const colorCostPerUnit = (color.gram || 0) * (filament.averageCost || 0);
                            filamentCost += colorCostPerUnit;
                        }
                    });
                } else {
                    // Eski sistem için fallback
                    const filamentId = entry.selectedFilamentId || variant.filamentId || entry.filamentOverrideId;
                    const filament = rawMaterials.find(rm => rm.id === filamentId);
                    const filamentUsage = variant?.filamentUsage || 0;
                if(filament && filamentUsage > 0){ 
                    filamentCost = filamentUsage * (filament.averageCost || 0); 
                    }
                } 
                
                // Malzeme kullanımından maliyet hesapla (birim maliyet olarak)
                let materialUsageCostPerUnit = 0;
                if (entry.materialUsage && entry.materialUsage.length > 0) {
                    entry.materialUsage.forEach(usage => {
                        const material = materials.find(m => m.id === usage.materialId);
                        if (material) {
                            materialUsageCostPerUnit += usage.quantity * material.unitPrice;
                        }
                    });
                }
                
                const materialCostPerUnit = filamentCost + extraMaterialCost + materialUsageCostPerUnit; 
                
                // Diğer maliyetler
                const electricity = (parameters.machineKw || 0) * (parameters.electricityKwhPrice || 0) * printTime; 
                const labor = (entryLaborCost || 0); 
                
                // Temel maliyet (birim maliyet) - amortisman sonradan eklenecek
                let baseCostPerUnit = materialCostPerUnit + electricity + labor;
                
                // Amortisman: ürün maliyetine göre %5
                const amortization = baseCostPerUnit * 0.05;
                baseCostPerUnit += amortization; 
                
                // Özel maliyetler
                const customCostsBreakdown = {}; 
                let totalCustomCostPerUnit = 0; 
                customParameters.forEach(p => { 
                    const value = entry.customValues[p.id] !== undefined ? entry.customValues[p.id] : p.value; 
                    let customCost = 0; 
                    if(p.type === 'parasal') {
                        customCost = value; 
                    } else if (p.type === 'saatlik') {
                        customCost = value * printTime; 
                    } else if (p.type === 'yuzdelik') {
                        customCost = baseCostPerUnit * (value / 100); 
                    } 
                    customCostsBreakdown[p.id] = customCost * entry.quantity; 
                    totalCustomCostPerUnit += customCost; 
                }); 
                
                // Final maliyet hesaplama
                const finalBaseCostPerUnit = baseCostPerUnit + totalCustomCostPerUnit; 
                const failedPrintRate = (parameters.failedPrintRate || 0) / 100;
                const unitCost = finalBaseCostPerUnit * (1 + failedPrintRate); // Başarısız baskı dahil birim maliyet
                const totalCost = unitCost * entry.quantity; 
                const recommendedUnitPrice = unitCost * (1 + (entryProfitMargin || 0) / 100); 
                
                // Başarısız baskı maliyeti ayrı hesapla
                const failedPrintCostPerUnit = finalBaseCostPerUnit * failedPrintRate;
                
                costMap[entry.id] = { 
                    materialCost: materialCostPerUnit * entry.quantity, 
                    electricityCost: electricity * entry.quantity, 
                    amortizationCost: amortization * entry.quantity, 
                    laborCost: labor * entry.quantity, 
                    failedPrintCost: failedPrintCostPerUnit * entry.quantity, 
                    customCosts: customCostsBreakdown, 
                    totalCost, 
                    unitCost, 
                    recommendedUnitPrice 
                }; 
                    } catch (error) {
                        console.error('Hata calculateAllProductionCosts entry:', entry.id, error);
                        costMap[entry.id] = {
                            materialCost: 0,
                            electricityCost: 0,
                            amortizationCost: 0,
                            laborCost: 0,
                            failedPrintCost: 0,
                            customCosts: {},
                            totalCost: 0,
                            unitCost: 0,
                            recommendedUnitPrice: 0
                        };
                    }
                }); 
            } catch (error) {
                console.error('Hata calculateAllProductionCosts:', error);
            }
            return costMap; 
        }
        function calculateAllStocks() { 
            // Varyant bazlı üretim ve satış hesaplama
            const productionTotals = {}; // productId -> variantId -> quantity
            const salesTotals = {}; // productId -> variantId -> quantity
            const failedPrintTotals = {}; // productId -> variantId -> quantity
            
            // Üretim kayıtlarından varyant bazlı stok hesapla
            (productionLog || []).forEach(entry => {
                if (!productionTotals[entry.productId]) productionTotals[entry.productId] = {};
                productionTotals[entry.productId][entry.variantId] = (productionTotals[entry.productId][entry.variantId] || 0) + entry.quantity;
            });
            
            // Satış kayıtlarından varyant bazlı stok hesapla
            (salesLog || []).forEach(sale => {
                if (!salesTotals[sale.productId]) salesTotals[sale.productId] = {};
                
                if (sale.variantId) {
                    // Varyant bazlı satış
                    if (!salesTotals[sale.productId][sale.variantId]) {
                        salesTotals[sale.productId][sale.variantId] = 0;
                    }
                    salesTotals[sale.productId][sale.variantId] += sale.quantity;
                } else {
                    // Ürün bazlı satış - tüm varyantlardan adet kadar düş
                    const product = products.find(p => p.id === sale.productId);
                    if (product && product.variants && product.variants.length > 0) {
                        product.variants.forEach(variant => {
                            if (!salesTotals[sale.productId][variant.id]) {
                                salesTotals[sale.productId][variant.id] = 0;
                            }
                            salesTotals[sale.productId][variant.id] += sale.quantity;
                        });
                    }
                }
            });
            
            // Baskı hatalarından varyant bazlı stok hesapla
            (failedPrints || []).forEach(failedPrint => {
                if (!failedPrintTotals[failedPrint.productId]) failedPrintTotals[failedPrint.productId] = {};
                if (!failedPrintTotals[failedPrint.productId][failedPrint.variantId]) {
                    failedPrintTotals[failedPrint.productId][failedPrint.variantId] = 0;
                }
                failedPrintTotals[failedPrint.productId][failedPrint.variantId] += failedPrint.quantity;
            });
            
            // Ürün stokları - varyant detayları ile
            const productStock = (products || []).map(p => {
                const variants = (p.variants || []).map(v => {
                    const produced = productionTotals[p.id] ? (productionTotals[p.id][v.id] || 0) : 0;
                    const sold = salesTotals[p.id] ? (salesTotals[p.id][v.id] || 0) : 0;
                    const failed = failedPrintTotals[p.id] ? (failedPrintTotals[p.id][v.id] || 0) : 0;
                    const stock = Math.max(0, produced - sold - failed);
                    return { ...v, stock, produced, sold, failed };
                });
                
                const totalStock = variants.reduce((sum, v) => sum + v.stock, 0);
                return { ...p, variants, stock: totalStock };
            });
            
            const rawMaterialStock = getCalculatedRawMaterialStocks(); 
            const rawMaterialStockValue = rawMaterialStock.reduce((sum, rm) => { return sum + (rm.currentStock * (rm.averageCost || 0)); }, 0); 
            let productStockValue = 0; 
            productStock.forEach(p => { 
                if(p.stock > 0) { 
                    const avgCost = getAverageUnitCostForProduct(p.id); 
                    productStockValue += p.stock * avgCost; 
                } 
            }); 
            return { productStock, productStockValue, rawMaterialStock, rawMaterialStockValue }; 
        }
        
        function makeTablesResizable() { 
            document.querySelectorAll('.resizable-table').forEach(table => { 
                const headers = table.querySelectorAll('th'); 
                headers.forEach(header => { 
                    if(header.querySelector('.resizer')) return; 
                    const resizer = document.createElement('div'); 
                    resizer.className = 'resizer'; 
                    header.appendChild(resizer); 
                    addResizerEvents(resizer, header); 
                }); 
            }); 
        }

        function addResizerEvents(resizer, header) {
            let x = 0;
            let w = 0;

            const mouseDownHandler = function (e) {
                x = e.clientX;
                const styles = window.getComputedStyle(header);
                w = parseInt(styles.width, 10);
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                resizer.style.backgroundColor = '#cbd5e1';
            };

            const mouseMoveHandler = function (e) {
                const dx = e.clientX - x;
                header.style.width = `${w + dx}px`;
            };

            const mouseUpHandler = function () {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                resizer.style.backgroundColor = '';
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function toggleSupplierDetails(supplierId) {
            const detailsDiv = document.getElementById(`supplier-details-${supplierId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }
        
        function getCustomerSalesHTML(customerId) {
            const customerSales = salesLog.filter(s => s.customerId === customerId);
            if (customerSales.length === 0) return `<p class="text-sm text-gray-500">Bu müşteriye henüz satış yapılmamış.</p>`;
            const salesByProduct = customerSales.reduce((acc, sale) => {
                let productName;
                
                if (sale.isQuickSale) {
                    // Hızlı satış - direkt productName kullan
                    productName = sale.productName || 'Hızlı Satış';
                } else {
                    // Normal satış - sistem ürününden al
                    productName = products.find(p => p.id === sale.productId)?.name || 'Bilinmeyen Ürün';
                }
                
                acc[productName] = (acc[productName] || 0) + sale.quantity;
                return acc;
            }, {});
            let tableHTML = `<table class="w-full text-sm"><thead><tr><th>Ürün Adı</th><th>Toplam Adet</th></tr></thead><tbody>`;
            for (const [productName, quantity] of Object.entries(salesByProduct)) {
                tableHTML += `<tr><td>${productName}</td><td>${quantity}</td></tr>`;
            }
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        function openAddPaymentModal(customerId) {
            const form = document.getElementById('paymentForm');
            form.reset();
            form.paymentCustomerId.value = customerId;
            form.paymentDate.value = new Date().toISOString().slice(0, 10);
            showModal('addPaymentModal');
        }

        function addPayment() {
            const form = document.getElementById('paymentForm');
            const newPayment = {
                id: crypto.randomUUID(),
                customerId: form.paymentCustomerId.value,
                date: form.paymentDate.value,
                amount: parseFloat(form.paymentAmount.value),
                paymentAccountId: form.paymentAccountId.value,
                notes: form.paymentNotes.value
            };
            if (!newPayment.customerId || !newPayment.amount || !newPayment.paymentAccountId) {
                showMessageModal("Hata", "Lütfen tüm zorunlu alanları doldurun.");
                return;
            }
            
            // Müşteri bakiyesini güncelle
            const customer = customers.find(c => c.id === newPayment.customerId);
            if (customer) {
                customer.balance += newPayment.amount;
            }
            
            // Hesap hareketi oluştur
            const account = accounts.find(a => a.id === newPayment.paymentAccountId);
            if (account) {
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: newPayment.date,
                    type: 'Tahsilat',
                    description: `Müşteri: ${customer?.name || 'Bilinmeyen'} - ${newPayment.notes || 'Ödeme'}`,
                    amount: newPayment.amount,
                    paymentId: newPayment.id // Çift sayımı önlemek için
                });
            }
            
            payments.push(newPayment);
            renderCustomers();
            renderCashFlow();
            saveData();
            closeModal('addPaymentModal');
            showNotification(`💰 ${newPayment.amount.toFixed(2)} TL tahsilat alındı`, 'success', 3000);
        }

        // --- HTML HELPER FUNCTIONS ---
        function getExpenseHTML(expense) {
            const account = accounts.find(a => a.id === expense.accountId);
            return `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td class="text-red-600 font-semibold">${expense.amount.toFixed(2)} TL</td>
                    <td>${account ? account.name : 'Bilinmeyen Hesap'}</td>
                    <td>
                        <button onclick="editExpense('${expense.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">Düzenle</button>
                        <button onclick="deleteExpense('${expense.id}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                    </td>
                </tr>
            `;
        }

        function getMaterialHTML(material) {
            const totalValue = material.quantity * material.unitPrice;
            return `
                <tr class="removable" data-id="${material.id}">
                    <td>${material.name}</td>
                    <td>${material.category}</td>
                    <td>${material.quantity}</td>
                    <td>${material.unit}</td>
                    <td>${material.unitPrice.toFixed(2)} TL</td>
                    <td class="font-semibold">${totalValue.toFixed(2)} TL</td>
                    <td>
                        <button onclick="editMaterial('${material.id}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">Düzenle</button>
                        <button onclick="removeElement(this, 'material')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md">Sil</button>
                    </td>
                </tr>
            `;
        }

        function getAddExpenseModalHTML() {
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">Yeni Gider Ekle</h3>
                    <form id="addExpenseForm" onsubmit="addExpense(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tarih</label>
                                <input type="date" id="expenseDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gider Türü</label>
                                <select id="expenseCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Seçiniz</option>
                                    <option value="Elektrik">Elektrik</option>
                                    <option value="Su">Su</option>
                                    <option value="İnternet">İnternet</option>
                                    <option value="Telefon">Telefon</option>
                                    <option value="Kira">Kira</option>
                                    <option value="Yakıt">Yakıt</option>
                                    <option value="Bakım">Bakım</option>
                                    <option value="Malzeme">Malzeme</option>
                                    <option value="Diğer">Diğer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tutar (TL)</label>
                                <input type="number" id="expenseAmount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap</label>
                                <select id="expenseAccountId" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Seçiniz</option>
                                    ${accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-600">*</span> Açıklama 
                                <span class="text-sm text-gray-500 font-normal">(Gider detayı - örn: "Elektrik faturası Ocak 2024")</span>
                            </label>
                            <textarea id="expenseDescription" rows="3" placeholder="Gider açıklamasını buraya yazın..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-red-500 focus:ring-1 focus:ring-red-500" required></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addExpenseModal')" class="bg-gray-300 px-4 py-2 rounded-md">İptal</button>
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">Gider Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getAddMaterialItemModalHTML() {
            return `
                <div class="modal">
                    <h3 class="text-xl font-semibold mb-4">Yeni Malzeme Ekle</h3>
                    <form id="addMaterialItemForm" onsubmit="addMaterialItem(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Malzeme Adı</label>
                                <input type="text" id="materialName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                <select id="materialCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Seçiniz</option>
                                    <option value="Elektronik">Elektronik</option>
                                    <option value="Mekanik">Mekanik</option>
                                    <option value="Yedek Parça">Yedek Parça</option>
                                    <option value="Alet">Alet</option>
                                    <option value="Temizlik">Temizlik</option>
                                    <option value="Ofis">Ofis</option>
                                    <option value="Diğer">Diğer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Miktar</label>
                                <input type="number" id="materialQuantity" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim</label>
                                <select id="materialUnit" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Seçiniz</option>
                                    <option value="adet">Adet</option>
                                    <option value="kg">Kilogram</option>
                                    <option value="gram">Gram</option>
                                    <option value="metre">Metre</option>
                                    <option value="cm">Santimetre</option>
                                    <option value="litre">Litre</option>
                                    <option value="paket">Paket</option>
                                    <option value="kutu">Kutu</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat (TL)</label>
                                <input type="number" id="materialUnitPrice" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Stok Seviyesi</label>
                                <input type="number" id="materialMinStock" step="0.01" value="0" placeholder="Uyarı için minimum stok" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap</label>
                                <select id="materialAccountId" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Seçiniz</option>
                                    ${accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Açıklama</label>
                            <textarea id="materialDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addMaterialItemModal')" class="bg-gray-300 px-4 py-2 rounded-md">İptal</button>
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md">Malzeme Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getProductionPlanMobileHTML(plan) {
            const statusColor = plan.status === 'active' ? 'bg-green-100 text-green-800' : 
                               plan.status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                               plan.status === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                               'bg-gray-100 text-gray-800';
            
            // Ürün bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }
            
            // Tüm varyantların toplam bilgilerini hesapla
            let totalPrintTime = 0;
            let allColors = {};
            let totalFilament = 0;
            
            if (product?.variants && product.variants.length > 0) {
                totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                
                product.variants.forEach(variant => {
                    if (variant.colors && variant.colors.length > 0) {
                        variant.colors.forEach(color => {
                            const key = `${color.name}_${color.filamentId}`;
                            if (!allColors[key]) {
                                allColors[key] = {
                                    name: color.name,
                                    filamentId: color.filamentId,
                                    gram: 0
                                };
                            }
                            allColors[key].gram += color.gram || 0;
                        });
                    }
                });
                
                totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
            }
            
            // Filament detaylarını hesapla
            let filamentDetails = '';
            if (Object.keys(allColors).length > 0) {
                const totalOrderFilament = totalFilament * plan.orderQuantity;
                
                filamentDetails = `
                    <div class="text-xs space-y-1">
                        <div class="font-semibold text-gray-800">Toplam: ${totalOrderFilament.toFixed(0)} gr</div>
                        <div class="text-gray-600">
                            ${Object.values(allColors).map(color => {
                                const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                const orderGram = color.gram * plan.orderQuantity;
                                return `<div>${color.name}: ${orderGram.toFixed(0)} gr (${filamentName})</div>`;
                            }).join('')}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            📊 ${product.variants.length} varyantın toplamı
                        </div>
                    </div>
                `;
            } else {
                filamentDetails = '<div class="text-xs text-gray-500">Filament bilgisi yok</div>';
            }
            
            const unitTime = plan.unitTime || totalPrintTime;
            const totalHours = unitTime * plan.orderQuantity;
            const totalDays = totalHours / (plan.machineCount * 24);
            
            return `
                <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">${plan.productName}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${plan.status === 'active' ? 'Aktif' : plan.status === 'completed' ? 'Tamamlandı' : plan.status === 'paused' ? 'Duraklatıldı' : 'Beklemede'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <span class="text-xs text-gray-500">⏱️ Birim Süre</span>
                            <div class="text-sm font-medium">${unitTime.toFixed(2)} saat</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">🏭 Makine Sayısı</span>
                            <div class="text-sm font-medium">${plan.machineCount}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">📦 Sipariş Adedi</span>
                            <div class="text-sm font-medium text-blue-600">${plan.orderQuantity}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">📅 Toplam Gün</span>
                            <div class="text-sm font-medium">${totalDays.toFixed(1)}</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">💰 Satış Fiyatı</span>
                            <div class="text-sm font-medium text-green-600">${(plan.salePrice || 0).toFixed(2)} ₺</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">💵 Toplam Satış</span>
                            <div class="text-sm font-medium text-emerald-600">${((plan.salePrice || 0) * plan.orderQuantity).toFixed(2)} ₺</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="text-xs text-gray-500">🎨 Filament Detayları</span>
                        <div class="mt-1">${filamentDetails}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3 text-xs text-gray-600">
                        <div>
                            <span class="text-gray-500">📅 Başlangıç:</span>
                            <div>${new Date(plan.startDate).toLocaleDateString('tr-TR')}</div>
                        </div>
                        <div>
                            <span class="text-gray-500">🏁 Bitiş:</span>
                            <div>${new Date(plan.expectedEndDate).toLocaleDateString('tr-TR')}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${plan.status === 'active' ? `
                            <button onclick="sendToProduction('${plan.id}')" 
                                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                🚀 Üretime Gönder
                            </button>
                        ` : ''}
                        <button onclick="editProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
                            ✏️ Düzenle
                        </button>
                        <button onclick="deleteProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                            🗑️ Sil
                        </button>
                    </div>
                </div>
            `;
        }

        function getProductionPlanHTML(plan) {
            const statusColor = plan.status === 'active' ? 'bg-green-100 text-green-800' : 
                               plan.status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                               plan.status === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                               'bg-gray-100 text-gray-800';
            
            // Ürün bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            
            // Eğer productId ile bulunamazsa productName ile dene
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
                if (product) {
                    console.log('Ürün ID ile bulunamadı, productName ile bulundu:', product.name);
                }
            }
            
            // Tüm varyantların toplam bilgilerini hesapla
            let totalPrintTime = 0;
            let allColors = {};
            let totalFilament = 0;
            
            if (product?.variants && product.variants.length > 0) {
                // Tüm varyantların printTime'ını topla
                totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                
                // Tüm varyantların filament bilgilerini birleştir
                product.variants.forEach(variant => {
                    if (variant.colors && variant.colors.length > 0) {
                        variant.colors.forEach(color => {
                            const key = `${color.name}_${color.filamentId}`;
                            if (!allColors[key]) {
                                allColors[key] = {
                                    name: color.name,
                                    filamentId: color.filamentId,
                                    gram: 0
                                };
                            }
                            allColors[key].gram += color.gram || 0;
                        });
                    }
                });
                
                // Toplam filament miktarını hesapla
                totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
            }
            
            // Filament detaylarını hesapla
            let filamentDetails = '';
            if (Object.keys(allColors).length > 0) {
                const totalOrderFilament = totalFilament * plan.orderQuantity;
                
                filamentDetails = `
                    <div class="text-xs space-y-1">
                        <div class="font-semibold text-gray-800">Toplam: ${totalOrderFilament.toFixed(0)} gr</div>
                        <div class="text-gray-600">
                            ${Object.values(allColors).map(color => {
                                const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                const orderGram = color.gram * plan.orderQuantity;
                                return `<div>${color.name}: ${orderGram.toFixed(0)} gr (${filamentName})</div>`;
                            }).join('')}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            📊 ${product.variants.length} varyantın toplamı
                        </div>
                    </div>
                `;
            } else {
                filamentDetails = '<div class="text-xs text-gray-500">Filament bilgisi yok</div>';
            }
            
            // Otomatik saat hesaplaması (eğer plan'da yoksa ürün verilerinden al)
            const unitTime = plan.unitTime || totalPrintTime;
            const totalHours = unitTime * plan.orderQuantity;
            const totalDays = totalHours / (plan.machineCount * 24); // 24 saat çalışma varsayımı
            
            return `
                <tr class="hover:bg-gray-50 transition-colors duration-200 ${plan.status === 'active' ? 'bg-yellow-50' : ''}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${plan.productName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${unitTime.toFixed(2)} saat
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${plan.machineCount} makine
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${plan.dailyCapacity.toFixed(2)} adet/gün
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-indigo-100 text-indigo-800">
                            ${plan.orderQuantity} adet
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                            ${totalDays.toFixed(1)} gün
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            ${totalHours.toFixed(1)} saat
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${filamentDetails}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${(plan.salePrice || 0).toFixed(2)} ₺
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                            ${((plan.salePrice || 0) * plan.orderQuantity).toFixed(2)} ₺
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(plan.startDate).toLocaleDateString('tr-TR')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${new Date(plan.expectedEndDate).toLocaleDateString('tr-TR')}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${plan.contractDate ? new Date(plan.contractDate).toLocaleDateString('tr-TR') : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${plan.status === 'active' ? 'Aktif' : plan.status === 'completed' ? 'Tamamlandı' : plan.status === 'paused' ? 'Duraklatıldı' : 'Beklemede'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${plan.status === 'active' ? `
                            <button onclick="sendToProduction('${plan.id}')" 
                                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 mr-2">
                                🚀 Üretime Gönder
                            </button>
                        ` : ''}
                        <button onclick="editProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors duration-200 mr-2">
                            ✏️ Düzenle
                        </button>
                        <button onclick="deleteProductionPlan('${plan.id}')" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            🗑️ Sil
                        </button>
                    </td>
                </tr>
            `;
        }

        function getAddProductionPlanModalHTML() {
            return `
                <div class="modal max-w-4xl">
                    <h3 class="text-xl font-semibold mb-4">Yeni Üretim Planı Ekle</h3>
                    <form id="addProductionPlanForm" onsubmit="addProductionPlan(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
                                <select id="planProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="loadProductDetails()">
                                    <option value="">Ürün seçin...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Süre (saat)</label>
                                <input type="number" id="planUnitTime" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Makine Sayısı</label>
                                <input type="number" id="planMachineCount" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Günlük Kapasite</label>
                                <input type="number" id="planDailyCapacity" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sipariş Adedi</label>
                                <input type="number" id="planOrderQuantity" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Gün</label>
                                <input type="number" id="planTotalDays" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Saat</label>
                                <input type="number" id="planTotalHours" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Durum</label>
                                <select id="planStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="waiting">Beklemede</option>
                                    <option value="active">Aktif</option>
                                    <option value="paused">Duraklatıldı</option>
                                    <option value="completed">Tamamlandı</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Başlangıç Tarihi</label>
                                <input type="date" id="planStartDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Beklenen Bitiş Tarihi</label>
                                <input type="date" id="planExpectedEndDate" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sözleşme Tarihi</label>
                                <input type="date" id="planContractDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateContractQuantity()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sözleşme Sonu Adet</label>
                                <input type="number" id="planContractQuantity" step="1" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">💰 Beklenen Satış Fiyatı (₺)</label>
                                <input type="number" id="planSalePrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculatePlanValues()">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">🎨 Filament Detayları</label>
                            <div id="planFilamentDetails" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-sm text-gray-600">
                                Önce ürün seçin
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Açıklama</label>
                            <textarea id="planDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addProductionPlanModal')" class="bg-gray-300 px-4 py-2 rounded-md">İptal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Plan Ekle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getEditProductionPlanModalHTML() {
            return `
                <div class="modal max-w-4xl">
                    <h3 class="text-xl font-semibold mb-4">Üretim Planını Düzenle</h3>
                    <form id="editProductionPlanForm" onsubmit="updateProductionPlan(event)">
                        <input type="hidden" id="editPlanId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
                                <select id="editPlanProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="loadEditProductDetails()">
                                    <option value="">Ürün seçin...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Birim Süre (saat)</label>
                                <input type="number" id="editPlanUnitTime" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Makine Sayısı</label>
                                <input type="number" id="editPlanMachineCount" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Günlük Kapasite</label>
                                <input type="number" id="editPlanDailyCapacity" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sipariş Adedi</label>
                                <input type="number" id="editPlanOrderQuantity" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">💰 Beklenen Satış Fiyatı (₺)</label>
                                <input type="number" id="editPlanSalePrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditPlanValues()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Gün</label>
                                <input type="number" id="editPlanTotalDays" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Saat</label>
                                <input type="number" id="editPlanTotalHours" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Durum</label>
                                <select id="editPlanStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="waiting">Beklemede</option>
                                    <option value="active">Aktif</option>
                                    <option value="paused">Duraklatıldı</option>
                                    <option value="completed">Tamamlandı</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Başlangıç Tarihi</label>
                                <input type="date" id="editPlanStartDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Beklenen Bitiş Tarihi</label>
                                <input type="date" id="editPlanExpectedEndDate" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sözleşme Tarihi</label>
                                <input type="date" id="editPlanContractDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="calculateEditContractQuantity()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sözleşme Sonu Adet</label>
                                <input type="number" id="editPlanContractQuantity" step="1" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Açıklama</label>
                            <textarea id="editPlanDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('editProductionPlanModal')" class="bg-gray-300 px-4 py-2 rounded-md">İptal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Planı Güncelle</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function generateDeliveryNote(customerId) {
            const customer = customers.find(c => c.id === customerId);
            const customerSales = salesLog.filter(s => s.customerId === customerId);
            if (!customer) return;
            const printWindow = window.open('', '_blank');
            let content = `
                <html><head><title>İrsaliye - ${customer.name}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style> body { font-family: 'Inter', sans-serif; } </style>
                </head><body><div class="p-8" id="print-area">
                    <div class="flex justify-between items-center mb-8">
                        <div><h1 class="text-2xl font-bold">[İŞLETME ADINIZ]</h1><p>[Şehir/Adres]</p></div>
                        <div class="text-right"><h2 class="text-xl font-semibold">İRSALİYE</h2><p>Tarih: ${new Date().toLocaleDateString('tr-TR')}</p></div>
                    </div>
                    <div class="mb-8 border p-4 rounded-md">
                        <h3 class="font-semibold">Müşteri Bilgileri</h3>
                        <p><strong>Firma:</strong> ${customer.name}</p>
                        <p><strong>Adres:</strong> ${customer.address || ''}</p>
                        <p><strong>Telefon:</strong> ${customer.phone || ''}</p>
                    </div>
                    <table class="w-full text-left">
                        <thead><tr class="bg-gray-100">
                            <th class="p-2">Tarih</th><th class="p-2">Ürün Adı</th><th class="p-2">Adet</th><th class="p-2">Birim Fiyat</th><th class="p-2">Toplam</th>
                        </tr></thead>
                        <tbody>`;
            let grandTotal = 0;
            customerSales.forEach(sale => {
                let productName;
                
                if (sale.isQuickSale) {
                    // Hızlı satış - direkt productName kullan
                    productName = sale.productName || 'Hızlı Satış';
                } else {
                    // Normal satış - sistem ürününden al
                    const product = products.find(p => p.id === sale.productId);
                    productName = product ? product.name : 'Silinmiş Ürün';
                }
                
                const total = sale.quantity * sale.unitPrice;
                grandTotal += sale.totalAmount; // Using totalAmount which includes VAT
                content += `<tr>
                    <td class="p-2 border-b">${new Date(sale.date).toLocaleDateString('tr-TR')}</td>
                    <td class="p-2 border-b">${productName}</td>
                    <td class="p-2 border-b">${sale.quantity}</td>
                    <td class="p-2 border-b">${sale.unitPrice.toFixed(2)} TL</td>
                    <td class="p-2 border-b">${total.toFixed(2)} TL</td>
                </tr>`;
            });
            content += `</tbody><tfoot>
                            <tr><td colspan="4" class="text-right font-bold p-2">Genel Toplam (KDV Dahil):</td><td class="font-bold p-2">${grandTotal.toFixed(2)} TL</td></tr>
                        </tfoot></table>
                    <div class="mt-16 text-center text-sm text-gray-500">Bu irsaliye elektronik olarak oluşturulmuştur.</div>
                </div></body></html>`;
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function deleteAccountTransaction(accountId, txId, txType) {
            showConfirmModal(
                "İşlemi Sil",
                "Bu işlemi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.",
                () => {
                    console.log('Silme işlemi başlatılıyor:', { accountId, txId, txType });
                    
                    const account = accounts.find(a => a.id === accountId);
                    if (!account) {
                        console.error('Hesap bulunamadı:', accountId);
                        return;
                    }
                    
                    // Debug: Mevcut transaction'ları listele
                    console.log('Hesap transaction\'ları:', account.transactions);
                    console.log('Aranan txId:', txId);
                    
                    let deleted = false;
                    
                    // İşlem türüne göre sil
                    if (txType === 'Para Ekleme' || txType === 'Satış Geliri') {
                        // Hesap transaction'ından sil
                        if (account.transactions) {
                            const originalLength = account.transactions.length;
                            
                            // Önce ID ile ara
                            let foundById = account.transactions.find(t => t.id === txId);
                            if (foundById) {
                                account.transactions = account.transactions.filter(t => t.id !== txId);
                                deleted = true;
                                console.log('Transaction ID ile silindi:', txId);
                            } else {
                                // ID bulunamazsa, description ve amount ile ara
                                console.log('ID bulunamadı, description ile aranıyor...');
                                const transactionIndex = account.transactions.findIndex(t => 
                                    t.type === txType && 
                                    t.description && 
                                    t.description.includes(txId)
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    deleted = true;
                                    console.log('Transaction description ile silindi');
                                }
                            }
                            
                            console.log('Hesap transaction silindi:', deleted);
                        }
                    } else if (txType === 'Satış') {
                        // Satış kaydından sil
                        const sale = salesLog.find(s => s.id === txId);
                        if (sale) {
                            // Önce hesap hareketini sil
                            if (account.transactions) {
                                const transactionIndex = account.transactions.findIndex(t => 
                                    t.type === 'Satış Geliri' && 
                                    t.date === sale.date && 
                                    Math.abs(t.amount - sale.totalAmount) < 0.01
                                );
                                if (transactionIndex !== -1) {
                                    account.transactions.splice(transactionIndex, 1);
                                    console.log('Satış hesap hareketi silindi');
                                }
                            }
                            
                            // Cariye satışsa müşteri bakiyesini geri al
                            if (sale.paymentMethod === 'cariye' && sale.customerId) {
                                const customer = customers.find(c => c.id === sale.customerId);
                                if (customer) {
                                    customer.balance += sale.totalAmount;
                                    console.log('Müşteri bakiyesi geri alındı');
                                }
                            }
                            
                            // Satış kaydını sil
                            salesLog = salesLog.filter(s => s.id !== txId);
                            deleted = true;
                            console.log('Satış kaydı silindi');
                        }
                    } else if (txType === 'Tahsilat') {
                        // Tahsilat kaydını sil
                        const payment = payments.find(p => p.id === txId);
                        if (payment) {
                            // Müşteri bakiyesini geri al
                            const customer = customers.find(c => c.id === payment.customerId);
                            if (customer) {
                                customer.balance -= payment.amount;
                                console.log('Müşteri bakiyesi geri alındı');
                            }
                            
                            // Tahsilat kaydını sil
                            payments = payments.filter(p => p.id !== txId);
                            deleted = true;
                            console.log('Tahsilat kaydı silindi');
                        }
                    } else if (txType === 'Alım') {
                        // Hammadde alımını sil
                        rawMaterials.forEach(rm => {
                            if (rm.stockHistory) {
                                const originalLength = rm.stockHistory.length;
                                rm.stockHistory = rm.stockHistory.filter(h => h.id !== txId);
                                if (rm.stockHistory.length < originalLength) {
                                    deleted = true;
                                    console.log('Hammadde alımı silindi');
                                }
                            }
                        });
                    }
                    
                    if (deleted) {
                        saveData();
                        renderCashFlow();
                        renderAccountDetails(accountId);
                        showNotification('İşlem başarıyla silindi', 'success', 3000);
                    } else {
                        // Son çare: Tüm transaction'ları listele ve kullanıcıya göster
                        console.error('İşlem bulunamadı! Mevcut transaction\'lar:');
                        if (account.transactions) {
                            account.transactions.forEach((t, index) => {
                                console.log(`${index}: ID=${t.id}, Type=${t.type}, Desc=${t.description}, Amount=${t.amount}`);
                            });
                        }
                        showNotification('İşlem silinemedi - kayıt bulunamadı. Console\'u kontrol edin.', 'error', 5000);
                    }
                }
            );
        }

        function forceDeleteTransaction(accountId, txId, txType) {
            showConfirmModal(
                "Zorla Sil",
                "Bu işlemi zorla silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve tüm veriler temizlenecek.",
                () => {
                    console.log('Zorla silme işlemi başlatılıyor:', { accountId, txId, txType });
                    
                    const account = accounts.find(a => a.id === accountId);
                    if (!account) {
                        console.error('Hesap bulunamadı:', accountId);
                        return;
                    }
                    
                    let deleted = false;
                    
                    // Tüm transaction'ları listele
                    console.log('Mevcut transaction\'lar:');
                    if (account.transactions) {
                        account.transactions.forEach((t, index) => {
                            console.log(`${index}: ID=${t.id}, Type=${t.type}, Desc=${t.description}, Amount=${t.amount}`);
                        });
                        
                        // İlk eşleşen transaction'ı sil
                        const transactionIndex = account.transactions.findIndex(t => 
                            t.type === txType || 
                            t.id === txId || 
                            (t.description && t.description.includes(txId))
                        );
                        
                        if (transactionIndex !== -1) {
                            const deletedTransaction = account.transactions.splice(transactionIndex, 1)[0];
                            deleted = true;
                            console.log('Transaction zorla silindi:', deletedTransaction);
                        }
                    }
                    
                    if (deleted) {
                        saveData();
                        renderCashFlow();
                        renderAccountDetails(accountId);
                        showNotification('İşlem zorla silindi', 'success', 3000);
                    } else {
                        showNotification('Hiçbir işlem silinemedi', 'error', 3000);
                    }
                }
            );
        }

        function renderAccountDetails(accountId) {
            currentOpenAccountId = accountId; // Store the currently viewed account ID
            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            // Sadece hesap transaction'larını kullan (çift kayıt önlemek için)
            const accountTransactions = (account.transactions || []).map(t => ({ 
                ...t, 
                type: t.type, 
                txId: t.id, 
                desc: t.description,
                date: t.date
            }));
            
            // Sadece hesap transaction'larını kullan (çift kayıt önlemek için)
            // purchases array'ini kaldırdık çünkü artık hesap transaction'larına ekleniyor
            
            // Satış kayıtlarını ekle (sadece kasaya giren satışlar - cariye hariç)
            const sales = salesLog
                .filter(s => s.paymentAccountId === accountId && s.paymentMethod !== 'cariye') // Cariye satışları hariç tut
                .map(s => ({ 
                    ...s, 
                    type: s.isQuickSale ? 'Satış Geliri' : 'Satış', // Hızlı satış için 'Satış Geliri' türü
                    txId: s.id, 
                    desc: s.isQuickSale ? s.productName : (products.find(p=>p.id === s.productId)?.name || 'Bilinmeyen Ürün')
                }));
            
            // Çift kayıt önlemek için: zaten transaction'da olan tahsilatları filtrele
            const customerPayments = payments
                .filter(p => {
                    if (!p.customerId || p.paymentAccountId !== accountId) return false;
                    // Bu ödeme zaten account.transactions'da varsa ekleme
                    const existsInTransactions = accountTransactions.some(t => 
                        t.paymentId === p.id || // PaymentId ile kontrol
                        (t.type === 'Tahsilat' && Math.abs(t.amount - p.amount) < 0.01 && t.date === p.date)
                    );
                    return !existsInTransactions;
                })
                .map(p => ({ 
                    ...p, 
                    type: 'Tahsilat', 
                    txId: p.id, 
                    desc: `${customers.find(c=>c.id === p.customerId)?.name || 'Bilinmeyen Müşteri'} - ${p.notes || 'Ödeme'}` 
                }));
            
            // Çift kayıt önlemek için: zaten transaction'da olan malzeme ödemelerini filtrele
            const materialPayments = payments
                .filter(p => {
                    if (p.type !== 'Malzeme' || p.paymentAccountId !== accountId) return false;
                    // Bu ödeme zaten account.transactions'da varsa ekleme
                    const existsInTransactions = accountTransactions.some(t => 
                        t.paymentId === p.id || // PaymentId ile kontrol
                        (t.type === 'Malzeme' && Math.abs(Math.abs(t.amount) - p.amount) < 0.01 && t.date === p.date)
                    );
                    return !existsInTransactions;
                })
                .map(p => ({ ...p, type: 'Malzeme', txId: p.id, desc: p.notes }));
            
            const transactions = [...sales, ...customerPayments, ...materialPayments, ...accountTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Debug logları
            console.log('🔍 Hesap Hareketleri Debug:');
            console.log('- Hesap ID:', accountId);
            console.log('- Hesap Bulundu mu?', !!account);
            console.log('- Hesap Adı:', account?.name);
            console.log('- Hesap Transaction\'ları var mı?', !!account?.transactions);
            console.log('- Hesap Transaction Sayısı:', accountTransactions.length);
            console.log('- Satış Sayısı (tüm satışlar):', sales.length);
            console.log('- Tahsilat Sayısı:', customerPayments.length);
            console.log('- Malzeme Ödemesi Sayısı:', materialPayments.length);
            console.log('- Toplam İşlem Sayısı:', transactions.length);
            console.log('- Hesap Transaction\'ları:', accountTransactions);
            console.log('- Satış Kayıtları:', sales);
            console.log('- Tüm Hesaplar:', accounts.map(a => ({ id: a.id, name: a.name, transactionCount: a.transactions?.length || 0 })));
            
            // Her transaction'ın detaylarını logla
            transactions.forEach((tx, index) => {
                console.log(`🔍 Transaction ${index}:`, {
                    type: tx.type,
                    totalAmount: tx.totalAmount,
                    amount: tx.amount,
                    cost: tx.cost,
                    desc: tx.desc
                });
            });

            let modalContent = `<h3 class="text-xl font-semibold mb-4">${account.name} - Hesap Hareketleri</h3>
                                <table class="w-full text-sm"><thead><tr><th>Tarih</th><th>Tür</th><th>Açıklama</th><th>Giriş</th><th>Çıkış</th><th>Eylem</th></tr></thead><tbody>`;
            transactions.forEach(tx => {
                let income = '';
                let expense = '';
                
                if (tx.type === 'Satış' || tx.type === 'Satış Geliri' || tx.type === 'Tahsilat' || tx.type === 'Para Ekleme') {
                    income = (tx.totalAmount || tx.amount || 0).toFixed(2);
                } else if (tx.type === 'Alım' || tx.type === 'Malzeme' || tx.type === 'Gider') {
                    expense = Math.abs(tx.cost || tx.amount || 0).toFixed(2);
                }
                
                // Debug: Her transaction için tutar bilgilerini logla
                console.log(`🔍 Transaction Debug:`, {
                    type: tx.type,
                    totalAmount: tx.totalAmount,
                    amount: tx.amount,
                    income: income,
                    expense: expense
                });
                
                modalContent += `<tr>
                    <td>${new Date(tx.date).toLocaleDateString('tr-TR')}</td>
                    <td>${tx.type}</td>
                    <td>${tx.desc}</td>
                    <td class="text-green-600">${income}</td>
                    <td class="text-red-600">${expense}</td>
                    <td>
                        ${tx.type === 'Gider' ? '<span class="text-gray-400 text-xs">Düzenlenemez</span>' : `
                            <button onclick="openEditTransactionModal('${tx.txId}', '${tx.type}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-md mr-1">Düzenle</button>
                            <button onclick="deleteAccountTransaction('${accountId}', '${tx.txId}', '${tx.type}')" class="bg-red-500 text-white px-2 py-1 text-xs rounded-md mr-1">Sil</button>
                            <button onclick="forceDeleteTransaction('${accountId}', '${tx.txId}', '${tx.type}')" class="bg-red-700 text-white px-2 py-1 text-xs rounded-md">Zorla Sil</button>
                        `}
                    </td>
                </tr>`;
            });
            modalContent += `</tbody></table><div class="mt-6 flex justify-end"><button onclick="closeModal('accountDetailModal')" class="bg-gray-200 px-4 py-2 rounded-md">Kapat</button></div>`;
            document.getElementById('accountDetailModalContent').innerHTML = modalContent;
            showModal('accountDetailModal');
        }
        
        function openEditTransactionModal(txId, txType) {
            const form = document.getElementById('editTransactionForm');
            form.reset();
            let tx;
            if (txType === 'Alım') {
                for(const rm of rawMaterials) {
                    tx = rm.stockHistory?.find(h => h.id === txId);
                    if(tx) break;
                }
            }
            else if (txType === 'Satış') tx = salesLog.find(s => s.id === txId);
            else if (txType === 'Tahsilat') tx = payments.find(p => p.id === txId);
            else if (txType === 'Para Ekleme') {
                // Para ekleme işlemini hesap transactions'ında bul
                for(const account of accounts) {
                    if(account.transactions) {
                        tx = account.transactions.find(t => t.id === txId);
                        if(tx) break;
                    }
                }
            }

            if (!tx) { showMessageModal("Hata", "İşlem bulunamadı."); return; }

            form.txId.value = txId;
            form.txType.value = txType;
            form.txDate.value = tx.date;
            
            const amountDiv = document.getElementById('txAmountDiv');
            const purchaseDiv = document.getElementById('txPurchaseDiv');

            if(txType === 'Alım') {
                amountDiv.style.display = 'none';
                purchaseDiv.style.display = 'grid';
                form.txQuantity.value = tx.quantity;
                form.txPrice.value = tx.price;
            } else {
                amountDiv.style.display = 'block';
                purchaseDiv.style.display = 'none';
                form.txAmount.value = tx.totalAmount || tx.amount;
            }

            form.txAccountId.innerHTML = accounts.filter(a => a.type !== 'kredikarti').map(acc => `<option value="${acc.id}" ${acc.id === tx.paymentAccountId ? 'selected' : ''}>${acc.name}</option>`).join('');
            
            const notesDiv = document.getElementById('txNotesDiv');
            if (txType === 'Tahsilat' || txType === 'Para Ekleme') {
                notesDiv.style.display = 'block';
                form.txNotes.value = tx.notes || tx.description || '';
            } else {
                notesDiv.style.display = 'none';
            }

            showModal('editTransactionModal');
        }

        function handleTransactionUpdate() {
            const form = document.getElementById('editTransactionForm');
            const txId = form.txId.value;
            const txType = form.txType.value;
            const newDate = form.txDate.value;
            const newAccountId = form.txAccountId.value;

            let tx;
            if (txType === 'Alım') {
                let parentMaterial = null;
                for (const rm of rawMaterials) {
                    tx = rm.stockHistory?.find(h => h.id === txId);
                    if (tx) {
                        parentMaterial = rm;
                        break;
                    }
                }
                if (tx && parentMaterial) {
                    tx.quantity = parseFloat(form.txQuantity.value) || 0;
                    tx.price = parseFloat(form.txPrice.value) || 0;
                    tx.cost = tx.quantity * tx.price;
                    // Recalculate average cost for the parent material
                    const totalStock = parentMaterial.stockHistory.reduce((sum, item) => sum + item.quantity, 0);
                    const totalCost = parentMaterial.stockHistory.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    parentMaterial.averageCost = totalStock > 0 ? totalCost / totalStock : 0;
                }
            } else if (txType === 'Satış') {
                tx = salesLog.find(s => s.id === txId);
                if(tx) tx.totalAmount = parseFloat(form.txAmount.value) || 0;
            } else if (txType === 'Tahsilat') {
                tx = payments.find(p => p.id === txId);
                if(tx) { 
                    tx.amount = parseFloat(form.txAmount.value) || 0; 
                    tx.notes = form.txNotes.value;
                }
            } else if (txType === 'Para Ekleme') {
                // Para ekleme işlemini hesap transactions'ında bul ve güncelle
                const account = accounts.find(a => a.transactions && a.transactions.some(t => t.id === txId));
                if (account) {
                    tx = account.transactions.find(t => t.id === txId);
                    if(tx) {
                        tx.amount = parseFloat(form.txAmount.value) || 0;
                        tx.description = form.txNotes.value || tx.description;
                        tx.date = newDate;
                    }
                }
                
                // Tahsilat kaydını da güncelle (payments array'inde)
                const paymentTx = payments.find(p => p.type === 'Para Ekleme' && p.notes === tx?.description);
                if (paymentTx) {
                    paymentTx.amount = parseFloat(form.txAmount.value) || 0;
                    paymentTx.notes = form.txNotes.value || paymentTx.notes;
                    paymentTx.date = newDate;
                }
            }

            if(tx) {
                tx.date = newDate;
                tx.paymentAccountId = newAccountId;
                saveData(true, true); // Zorla Firebase'e gönder
                renderAllTabsAndModals();
                closeModal('editTransactionModal');
                if (document.getElementById('accountDetailModal').classList.contains('hidden') === false) {
                    renderAccountDetails(currentOpenAccountId); 
                }
                showNotification('✅ İşlem başarıyla güncellendi', 'success', 3000);
            } else {
                showMessageModal("Hata", "İşlem güncellenirken bir hata oluştu.");
            }
        }

        function openAddMoneyModal(accountId) {
            const form = document.getElementById('addMoneyForm');
            if (form) {
                form.reset();
                form.accountId.value = accountId;
                form.moneyDate.value = new Date().toISOString().split('T')[0];
                showModal('addMoneyModal');
            } else {
                console.error('addMoneyForm bulunamadı');
                showMessageModal("Hata", "Para ekleme formu yüklenemedi. Sayfayı yenileyin.");
            }
        }

        function addMoneyToAccount() {
            const form = document.getElementById('addMoneyForm');
            const accountId = form.accountId.value;
            const amount = parseFloat(form.moneyAmount.value) || 0;
            const description = form.moneyDescription.value.trim();
            const date = form.moneyDate.value;

            if (!accountId || amount <= 0 || !description) {
                showMessageModal("Hata", "Lütfen tüm alanları geçerli bir şekilde doldurun.");
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                showMessageModal("Hata", "Hesap bulunamadı.");
                return;
            }

            // Hesaba para ekleme işlemi
            if (!account.transactions) account.transactions = [];
            account.transactions.push({
                id: crypto.randomUUID(),
                date: date,
                type: 'Para Ekleme',
                description: description,
                amount: amount
            });

            saveData(true, true); // Zorla Firebase'e gönder
            renderCashFlow();
            closeModal('addMoneyModal');
            showNotification(`💰 ${amount.toFixed(2)} TL hesaba eklendi`, 'success', 3000);
        }




        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Giriş durumunu kontrol et
            if (!(await checkLoginStatus())) {
                showLoginScreen();
            }
            
            // Giriş formu event listener
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('loginPassword').value;
                
                if (authenticateUser(password)) {
                    isLoggedIn = true;
                    const session = {
                        loginTime: new Date().getTime(),
                        password: password
                    };
                    localStorage.setItem('appSession', JSON.stringify(session));
                    showMainApp();
                    showNotification('Hoş geldiniz!', 'success', 3000);
                } else {
                    showNotification('Hatalı şifre!', 'error', 3000);
                }
            });
            
            // Firebase'i başlat
            const firebaseSuccess = initializeFirebase();
            if (!firebaseSuccess) {
                console.error('❌ Firebase başlatılamadı!');
                showNotification('Firebase bağlantı hatası! Veriler yerel olarak saklanacak.', 'warning', 5000);
            }
            
            // Tarayıcı uyumluluğunu kontrol et
            checkBrowserCompatibility();
            
            // Klavye kısayolları
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd tuşu kontrolü
                const isCtrlOrCmd = e.ctrlKey || e.metaKey;
                
                // ESC tuşu ile modal kapatma
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal:not(.hidden)');
                    if (openModal) {
                        closeModal(openModal.id);
                    }
                    return;
                }
                
                // Input alanında değilse klavye kısayollarını aktif et
                const activeElement = document.activeElement;
                const isInputField = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'TEXTAREA' || 
                    activeElement.contentEditable === 'true'
                );
                
                if (isInputField) return;
                
                // Klavye kısayolları
                switch(e.key) {
                    case 'n':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            const activeTab = document.querySelector('.tab-button.active')?.dataset.tabId;
                            if (activeTab === 'products') {
                                addProduct();
                            } else if (activeTab === 'suppliers') {
                                addSupplier();
                            } else if (activeTab === 'sales') {
                                openSaleModal();
                            } else if (activeTab === 'productionLog') {
                                openAddProductionModal();
                            }
                            showNotification('⌨️ Yeni öğe eklendi', 'info', 2000);
                        }
                        break;
                    case 's':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            saveData();
                        }
                        break;
                    case 'e':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            exportData();
                        }
                        break;
                    case 'i':
                        if (isCtrlOrCmd) {
                            e.preventDefault();
                            importData();
                        }
                        break;
                }
            });
            
            // Firebase'i başlat
            setTimeout(() => {
                initializeFirebase();
            }, 500);
            
            // Verileri yükle
            loadData();
            
            // UI'yi render et
            renderAllTabsAndModals();
            
            // Otomatik yedeklemeyi başlat
            startAutoBackup();
            
            // Sayfa kapatılırken veri kaybını önle
            window.addEventListener('beforeunload', (e) => {
                if (pendingChanges) {
                    e.preventDefault();
                    e.returnValue = 'Kaydedilmemiş değişiklikler var. Sayfayı kapatmak istediğinizden emin misiniz?';
                    return e.returnValue;
                }
            });
            
            // Veri yükleme durumunu kontrol et (Edge için)
            setTimeout(() => {
                checkDataLoadingStatus();
            }, 2000);
            
            // Sayfa kapatılırken otomatik yedekleme durdur
            window.addEventListener('beforeunload', () => {
                stopAutoBackup();
                createAutoBackup(); // Son yedekleme
            });
        });

        // --- EXPENSE MANAGEMENT FUNCTIONS ---
        function openAddExpenseModal() {
            const form = document.getElementById('addExpenseForm');
            if (form) form.reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            showModal('addExpenseModal');
        }

        function addExpense(event) {
            event.preventDefault();
            const form = event.target;
            const newExpense = {
                id: crypto.randomUUID(),
                date: form.expenseDate.value,
                category: form.expenseCategory.value,
                description: form.expenseDescription.value,
                amount: parseFloat(form.expenseAmount.value),
                accountId: form.expenseAccountId.value
            };

            if (!newExpense.category || !newExpense.amount || !newExpense.accountId || !newExpense.description.trim()) {
                showMessageModal("Hata", "Lütfen tüm zorunlu alanları doldurun. Açıklama alanı boş bırakılamaz.");
                return;
            }

            expenses.push(newExpense);

            // Hesaptan gideri düş
            const account = accounts.find(a => a.id === newExpense.accountId);
            if (account) {
                // Hesap geçmişine gider kaydı ekle
                if (!account.transactions) account.transactions = [];
                account.transactions.push({
                    id: crypto.randomUUID(),
                    date: newExpense.date,
                    type: 'Gider',
                    description: `${newExpense.category}: ${newExpense.description}`,
                    amount: -newExpense.amount,
                    expenseId: newExpense.id
                });
            }

            renderExpenses();
            renderCashFlow();
            saveData(true, true); // Zorla Firebase'e gönder
            closeModal('addExpenseModal');
            showMessageModal("Başarılı", "Gider başarıyla eklendi ve hesaptan düşüldü.");
        }

        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Basit düzenleme için prompt kullanıyoruz
            const newAmount = prompt("Yeni tutar:", expense.amount);
            if (newAmount !== null && !isNaN(newAmount)) {
                const oldAmount = expense.amount;
                const newAmountValue = parseFloat(newAmount);
                expense.amount = newAmountValue;
                
                // Hesaptaki gider kaydını güncelle
                const account = accounts.find(a => a.id === expense.accountId);
                if (account && account.transactions) {
                    const expenseTransaction = account.transactions.find(t => t.expenseId === expenseId);
                    if (expenseTransaction) {
                        // Eski tutarı geri ekle, yeni tutarı düş
                        expenseTransaction.amount = -newAmountValue;
                    }
                }
                
                renderExpenses();
                renderCashFlow();
                saveData(true, true); // Zorla Firebase'e gönder
            }
        }

        function deleteExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            showConfirmModal(
                "Gideri Sil",
                "Bu gideri silmek istediğinizden emin misiniz?",
                () => {
                    // Hesaptan gider kaydını da sil
                    const account = accounts.find(a => a.id === expense.accountId);
                    if (account && account.transactions) {
                        account.transactions = account.transactions.filter(t => t.expenseId !== expenseId);
                    }
                    
                    expenses = expenses.filter(e => e.id !== expenseId);
                    renderExpenses();
                    renderCashFlow();
                    saveData(true, true); // Zorla Firebase'e gönder
                }
            );
        }

        // --- MATERIAL MANAGEMENT FUNCTIONS ---
        function openAddMaterialItemModal() {
            const form = document.getElementById('addMaterialItemForm');
            if (form) form.reset();
            showModal('addMaterialItemModal');
        }

        function addMaterialItem(event) {
            event.preventDefault();
            const form = event.target;
            const newMaterial = {
                id: crypto.randomUUID(),
                name: form.materialName.value,
                category: form.materialCategory.value,
                quantity: parseFloat(form.materialQuantity.value),
                unit: form.materialUnit.value,
                unitPrice: parseFloat(form.materialUnitPrice.value),
                minStock: parseFloat(document.getElementById('materialMinStock').value) || 0,
                description: form.materialDescription.value,
                accountId: form.materialAccountId.value
            };

            if (!newMaterial.name || !newMaterial.category || !newMaterial.quantity || !newMaterial.unit || !newMaterial.unitPrice || !newMaterial.accountId) {
                showMessageModal("Hata", "Lütfen tüm zorunlu alanları doldurun.");
                return;
            }

            materials.push(newMaterial);
            
            // Gider olarak kaydet
            const totalCost = newMaterial.quantity * newMaterial.unitPrice;
            const materialExpense = {
                id: crypto.randomUUID(),
                date: new Date().toISOString().split('T')[0],
                category: 'Malzeme',
                description: `${newMaterial.name} (${newMaterial.quantity} ${newMaterial.unit})`,
                amount: totalCost,
                accountId: newMaterial.accountId
            };
            
            expenses.push(materialExpense);

            // Kasa hareketi olarak da kaydet
            const payment = {
                id: crypto.randomUUID(),
                customerId: null, // Malzeme alımı için müşteri yok
                date: new Date().toISOString().split('T')[0],
                amount: totalCost, // Pozitif miktar (çıkış)
                paymentAccountId: newMaterial.accountId, // Aynı hesaptan düş
                notes: `Malzeme alımı: ${newMaterial.name} (${newMaterial.quantity} ${newMaterial.unit})`,
                type: 'Malzeme' // Türü Malzeme olarak işaretle
            };
            payments.push(payment);

            renderMaterials();
            renderExpenses();
            renderCashFlow();
            saveData();
            closeModal('addMaterialItemModal');
            showMessageModal("Başarılı", "Malzeme başarıyla eklendi ve gider olarak kaydedildi.");
        }

        function editMaterial(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material) return;

            const newQuantity = prompt("Yeni miktar:", material.quantity);
            if (newQuantity !== null && !isNaN(newQuantity)) {
                const oldTotalValue = material.quantity * material.unitPrice;
                material.quantity = parseFloat(newQuantity);
                const newTotalValue = material.quantity * material.unitPrice;
                
                // İlgili gideri güncelle
                const relatedExpense = expenses.find(e => e.description.includes(material.name) && e.category === 'Malzeme');
                if (relatedExpense) {
                    relatedExpense.amount = newTotalValue;
                }
                
                renderMaterials();
                renderExpenses();
                renderCashFlow();
                saveData();
            }
        }

        function deleteMaterial(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material) return;

            showConfirmModal(
                "Malzemeyi Sil",
                "Bu malzemeyi silmek istediğinizden emin misiniz?",
                () => {
                    // İlgili gideri sil
                    expenses = expenses.filter(e => !(e.description.includes(material.name) && e.category === 'Malzeme'));
                    
                    // İlgili kasa hareketini sil
                    payments = payments.filter(p => !(p.type === 'Malzeme' && p.notes.includes(material.name)));
                    
                    materials = materials.filter(m => m.id !== materialId);
                    renderMaterials();
                    renderExpenses();
                    renderCashFlow();
                    saveData();
                }
            );
        }

        // --- PRODUCTION PLANNING FUNCTIONS ---
        function openAddProductionPlanModal() {
            const form = document.getElementById('addProductionPlanForm');
            if (form) form.reset();
            document.getElementById('planStartDate').value = new Date().toISOString().split('T')[0];
            populateProductDropdown('planProductName');
            showModal('addProductionPlanModal');
        }

        function populateProductDropdown(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Ürün seçin...</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        function loadProductDetails() {
            const selectedProduct = document.getElementById('planProductName').value;
            const filamentDetails = document.getElementById('planFilamentDetails');
            
            if (selectedProduct) {
                const product = products.find(p => p.name === selectedProduct);
                if (product) {
                    // Tüm varyantların toplam bilgilerini hesapla
                    let totalPrintTime = 0;
                    let allColors = {};
                    let totalFilament = 0;
                    
                    if (product.variants && product.variants.length > 0) {
                        // Tüm varyantların printTime'ını topla
                        totalPrintTime = product.variants.reduce((sum, variant) => sum + (variant.printTime || 0), 0);
                        
                        // Tüm varyantların filament bilgilerini birleştir
                        product.variants.forEach(variant => {
                            if (variant.colors && variant.colors.length > 0) {
                                variant.colors.forEach(color => {
                                    const key = `${color.name}_${color.filamentId}`;
                                    if (!allColors[key]) {
                                        allColors[key] = {
                                            name: color.name,
                                            filamentId: color.filamentId,
                                            gram: 0
                                        };
                                    }
                                    allColors[key].gram += color.gram || 0;
                                });
                            }
                        });
                        
                        // Toplam filament miktarını hesapla
                        totalFilament = Object.values(allColors).reduce((sum, color) => sum + color.gram, 0);
                    }
                    
                    // Ürün detaylarını otomatik doldur
                    document.getElementById('planUnitTime').value = totalPrintTime;
                    
                    // Filament detaylarını göster
                    if (Object.keys(allColors).length > 0) {
                        let filamentHTML = `
                            <div class="space-y-1">
                                <div class="font-semibold text-gray-800">Toplam: ${totalFilament.toFixed(0)} gr</div>
                                <div class="text-xs text-gray-600">
                                    ${Object.values(allColors).map(color => {
                                        const filament = rawMaterials.find(rm => rm.id === color.filamentId);
                                        const filamentName = filament ? `${filament.brand} ${filament.color}` : 'Bilinmeyen';
                                        return `<div>• ${color.name}: ${color.gram.toFixed(0)} gr (${filamentName})</div>`;
                                    }).join('')}
                                </div>
                                <div class="text-xs text-blue-600 mt-2">
                                    📊 ${product.variants.length} varyantın toplamı
                                </div>
                            </div>
                        `;
                        filamentDetails.innerHTML = filamentHTML;
                    } else {
                        filamentDetails.innerHTML = '<div class="text-gray-500">Bu ürünün filament bilgisi yok</div>';
                    }
                    
                    // Hesaplamaları yap
                    calculatePlanValues();
                }
            } else {
                filamentDetails.innerHTML = 'Önce ürün seçin';
                document.getElementById('planUnitTime').value = '';
            }
        }

        function loadEditProductDetails() {
            const selectedProduct = document.getElementById('editPlanProductName').value;
            if (selectedProduct) {
                const product = products.find(p => p.name === selectedProduct);
                if (product) {
                    // Ürün detaylarını otomatik doldur
                    document.getElementById('editPlanUnitTime').value = product.unitTime || '';
                    calculateEditPlanValues();
                }
            }
        }

        function calculatePlanValues() {
            const unitTime = parseFloat(document.getElementById('planUnitTime').value) || 0;
            const machineCount = parseFloat(document.getElementById('planMachineCount').value) || 0;
            const orderQuantity = parseFloat(document.getElementById('planOrderQuantity').value) || 0;
            
            // Günlük kapasite = (24 saat / birim süre) * makine sayısı
            const dailyCapacity = (24 / unitTime) * machineCount;
            document.getElementById('planDailyCapacity').value = dailyCapacity.toFixed(2);
            
            // Total gün = sipariş adedi / günlük kapasite
            const totalDays = orderQuantity / dailyCapacity;
            document.getElementById('planTotalDays').value = totalDays.toFixed(2);
            
            // Total saat = total gün * 24
            const totalHours = totalDays * 24;
            document.getElementById('planTotalHours').value = totalHours.toFixed(2);
            
            // Bitiş tarihini hesapla
            calculateEndDate();
        }

        function calculateEndDate() {
            const startDate = document.getElementById('planStartDate').value;
            const totalDays = parseFloat(document.getElementById('planTotalDays').value) || 0;
            
            if (startDate && totalDays > 0) {
                const start = new Date(startDate);
                const endDate = new Date(start.getTime() + (totalDays * 24 * 60 * 60 * 1000));
                document.getElementById('planExpectedEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            // Sözleşme sonu adetini hesapla
            calculateContractQuantity();
        }

        function calculateContractQuantity() {
            const startDate = document.getElementById('planStartDate').value;
            const contractDate = document.getElementById('planContractDate').value;
            const dailyCapacity = parseFloat(document.getElementById('planDailyCapacity').value) || 0;
            
            if (startDate && contractDate && dailyCapacity > 0) {
                const start = new Date(startDate);
                const contract = new Date(contractDate);
                
                // Başlangıç ve sözleşme tarihi arasındaki gün sayısı
                const timeDiff = contract.getTime() - start.getTime();
                const daysDiff = Math.max(0, timeDiff / (1000 * 60 * 60 * 24));
                
                // Bu sürede üretilebilecek adet
                const contractQuantity = Math.floor(daysDiff * dailyCapacity);
                document.getElementById('planContractQuantity').value = contractQuantity;
            }
        }

        function addProductionPlan(event) {
            event.preventDefault();
            const form = event.target;
            // Seçilen ürünün ID'sini bul
            const selectedProduct = products.find(p => p.name === form.planProductName.value);
            
            const newPlan = {
                id: crypto.randomUUID(),
                productId: selectedProduct?.id || null,
                productName: form.planProductName.value,
                unitTime: parseFloat(form.planUnitTime.value),
                machineCount: parseInt(form.planMachineCount.value),
                dailyCapacity: parseFloat(form.planDailyCapacity.value),
                orderQuantity: parseInt(form.planOrderQuantity.value),
                totalDays: parseFloat(form.planTotalDays.value),
                totalHours: parseFloat(form.planTotalHours.value),
                salePrice: parseFloat(form.planSalePrice.value) || 0,
                startDate: form.planStartDate.value,
                expectedEndDate: form.planExpectedEndDate.value,
                contractDate: form.planContractDate.value || null,
                contractQuantity: parseInt(form.planContractQuantity.value) || null,
                status: form.planStatus.value,
                description: form.planDescription.value
            };

            if (!newPlan.productName || !newPlan.unitTime || !newPlan.machineCount || !newPlan.orderQuantity) {
                showMessageModal("Hata", "Lütfen tüm zorunlu alanları doldurun.");
                return;
            }

            productionPlans.push(newPlan);
            renderProductionPlanning();
            saveData();
            closeModal('addProductionPlanModal');
            showMessageModal("Başarılı", "Üretim planı başarıyla eklendi.");
        }

        function editProductionPlan(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            // Dropdown'ı doldur
            populateProductDropdown('editPlanProductName');

            // Modal'ı doldur
            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanProductName').value = plan.productName;
            document.getElementById('editPlanUnitTime').value = plan.unitTime;
            document.getElementById('editPlanMachineCount').value = plan.machineCount;
            document.getElementById('editPlanOrderQuantity').value = plan.orderQuantity;
            document.getElementById('editPlanSalePrice').value = plan.salePrice || 0;
            document.getElementById('editPlanStatus').value = plan.status;
            document.getElementById('editPlanStartDate').value = plan.startDate;
            document.getElementById('editPlanContractDate').value = plan.contractDate || '';
            document.getElementById('editPlanDescription').value = plan.description || '';

            // Hesaplamaları yap
            calculateEditPlanValues();
            
            showModal('editProductionPlanModal');
        }

        function calculateEditPlanValues() {
            const unitTime = parseFloat(document.getElementById('editPlanUnitTime').value) || 0;
            const machineCount = parseFloat(document.getElementById('editPlanMachineCount').value) || 0;
            const orderQuantity = parseFloat(document.getElementById('editPlanOrderQuantity').value) || 0;
            
            // Günlük kapasite = (24 saat / birim süre) * makine sayısı
            const dailyCapacity = (24 / unitTime) * machineCount;
            document.getElementById('editPlanDailyCapacity').value = dailyCapacity.toFixed(2);
            
            // Total gün = sipariş adedi / günlük kapasite
            const totalDays = orderQuantity / dailyCapacity;
            document.getElementById('editPlanTotalDays').value = totalDays.toFixed(2);
            
            // Total saat = total gün * 24
            const totalHours = totalDays * 24;
            document.getElementById('editPlanTotalHours').value = totalHours.toFixed(2);
            
            // Bitiş tarihini hesapla
            calculateEditEndDate();
        }

        function calculateEditEndDate() {
            const startDate = document.getElementById('editPlanStartDate').value;
            const totalDays = parseFloat(document.getElementById('editPlanTotalDays').value) || 0;
            
            if (startDate && totalDays > 0) {
                const start = new Date(startDate);
                const endDate = new Date(start.getTime() + (totalDays * 24 * 60 * 60 * 1000));
                document.getElementById('editPlanExpectedEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            // Sözleşme sonu adetini hesapla
            calculateEditContractQuantity();
        }

        function calculateEditContractQuantity() {
            const startDate = document.getElementById('editPlanStartDate').value;
            const contractDate = document.getElementById('editPlanContractDate').value;
            const dailyCapacity = parseFloat(document.getElementById('editPlanDailyCapacity').value) || 0;
            
            if (startDate && contractDate && dailyCapacity > 0) {
                const start = new Date(startDate);
                const contract = new Date(contractDate);
                
                // Başlangıç ve sözleşme tarihi arasındaki gün sayısı
                const timeDiff = contract.getTime() - start.getTime();
                const daysDiff = Math.max(0, timeDiff / (1000 * 60 * 60 * 24));
                
                // Bu sürede üretilebilecek adet
                const contractQuantity = Math.floor(daysDiff * dailyCapacity);
                document.getElementById('editPlanContractQuantity').value = contractQuantity;
            }
        }

        function updateProductionPlan(event) {
            event.preventDefault();
            const form = event.target;
            const planId = form.editPlanId.value;
            const plan = productionPlans.find(p => p.id === planId);
            
            if (!plan) return;

            // Planı güncelle
            plan.productName = form.editPlanProductName.value;
            plan.unitTime = parseFloat(form.editPlanUnitTime.value);
            plan.machineCount = parseInt(form.editPlanMachineCount.value);
            plan.dailyCapacity = parseFloat(form.editPlanDailyCapacity.value);
            plan.orderQuantity = parseInt(form.editPlanOrderQuantity.value);
            plan.salePrice = parseFloat(form.editPlanSalePrice.value) || 0;
            plan.totalDays = parseFloat(form.editPlanTotalDays.value);
            plan.totalHours = parseFloat(form.editPlanTotalHours.value);
            plan.startDate = form.editPlanStartDate.value;
            plan.expectedEndDate = form.editPlanExpectedEndDate.value;
            plan.contractDate = form.editPlanContractDate.value || null;
            plan.contractQuantity = parseInt(form.editPlanContractQuantity.value) || null;
            plan.status = form.editPlanStatus.value;
            plan.description = form.editPlanDescription.value;

            renderProductionPlanning();
            saveData();
            closeModal('editProductionPlanModal');
            showMessageModal("Başarılı", "Üretim planı başarıyla güncellendi.");
        }

        function deleteProductionPlan(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            showConfirmModal(
                "Planı Sil",
                "Bu üretim planını silmek istediğinizden emin misiniz?",
                () => {
                    productionPlans = productionPlans.filter(p => p.id !== planId);
                    renderProductionPlanning();
                    saveData();
                }
            );
        }

        function sendToProduction(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            // Ürün bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }

            if (!product) {
                showMessageModal("Hata", "Ürün bilgisi bulunamadı.");
                return;
            }

            // Miktar sorma modal'ı oluştur
            const maxQuantity = plan.orderQuantity;
            const currentDate = new Date().toISOString().split('T')[0];
            
            const quantityModal = `
                <div class="modal max-w-md">
                    <h3 class="text-xl font-semibold mb-4">🚀 Üretime Gönder</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800">${plan.productName}</h4>
                            <p class="text-sm text-blue-600">Maksimum: ${maxQuantity} adet</p>
                            <p class="text-sm text-blue-600">Varyant sayısı: ${product.variants ? product.variants.length : 0}</p>
                            <p class="text-xs text-blue-500 mt-1">Her varyant için ayrı üretim kaydı oluşturulacak</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Üretim Miktarı</label>
                            <input type="number" id="productionQuantity" min="1" max="${maxQuantity}" 
                                   value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Üretim Tarihi</label>
                            <input type="date" id="productionDate" value="${currentDate}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>Dikkat:</strong> Bu işlem üretim kaydı oluşturacak ve stokları güncelleyecektir.
                            </p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeModal('sendToProductionModal')" 
                                class="bg-gray-300 px-4 py-2 rounded-md hover:bg-gray-400">
                            İptal
                        </button>
                        <button onclick="confirmSendToProduction('${planId}')" 
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            🚀 Üretime Gönder
                        </button>
                    </div>
                </div>
            `;

            // Modal'ı göster
            document.getElementById('sendToProductionModal').innerHTML = quantityModal;
            showModal('sendToProductionModal');
        }

        function confirmSendToProduction(planId) {
            const plan = productionPlans.find(p => p.id === planId);
            if (!plan) return;

            const quantity = parseInt(document.getElementById('productionQuantity').value);
            const productionDate = document.getElementById('productionDate').value;

            if (!quantity || quantity < 1) {
                showMessageModal("Hata", "Lütfen geçerli bir miktar girin.");
                return;
            }

            if (quantity > plan.orderQuantity) {
                showMessageModal("Hata", `Miktar plan adedinden (${plan.orderQuantity}) fazla olamaz.`);
                return;
            }

            // Ürün bilgilerini al
            let product = products.find(p => p.id === plan.productId);
            if (!product && plan.productName) {
                product = products.find(p => p.name === plan.productName);
            }

            if (!product) {
                showMessageModal("Hata", "Ürün bilgisi bulunamadı.");
                return;
            }

            // Tüm varyantlar için üretim kaydı oluştur
            if (!product.variants || product.variants.length === 0) {
                showMessageModal("Hata", "Ürünün varyantı bulunamadı.");
                return;
            }

            const createdEntries = [];

            // Her varyant için ayrı üretim kaydı oluştur
            product.variants.forEach(variant => {
                const productionEntry = {
                    id: crypto.randomUUID(),
                    date: productionDate,
                    productId: product.id,
                    productName: product.name,
                    variantId: variant.id,
                    variantName: variant.name,
                    quantity: quantity,
                    unitCost: 0, // Hesaplanacak
                    totalCost: 0, // Hesaplanacak
                    materialUsage: [],
                    notes: `Plan: ${plan.productName} - ${variant.name} - Otomatik oluşturuldu`
                };

                // Malzeme kullanımını ekle (eğer varyantta filament bilgisi varsa)
                if (variant.colors && variant.colors.length > 0) {
                    variant.colors.forEach(color => {
                        if (color.filamentId && color.gram > 0) {
                            productionEntry.materialUsage.push({
                                id: crypto.randomUUID(),
                                materialId: color.filamentId,
                                quantity: color.gram,
                                unitCost: 0 // Hesaplanacak
                            });
                        }
                    });
                }

                // Üretim kaydını ekle
                productionLog.push(productionEntry);
                createdEntries.push(productionEntry);
            });

            // Maliyetleri hesapla
            calculateAllProductionCosts();

            // Plan adedini güncelle
            plan.orderQuantity -= quantity;
            
            // Eğer plan tamamlandıysa durumunu güncelle
            if (plan.orderQuantity <= 0) {
                plan.status = 'completed';
            }

            // Verileri kaydet
            saveData();

            // Sayfaları güncelle
            renderProductionPlanning();
            renderProductionLog();

            // Modal'ı kapat
            closeModal('sendToProductionModal');

            // Başarı mesajı
            const variantCount = product.variants.length;
            const totalQuantity = quantity * variantCount;
            showMessageModal("Başarılı", `${quantity} adet × ${variantCount} varyant = ${totalQuantity} adet ${product.name} üretim kaydına eklendi.`);
        }

    </script>
</body>
</html>
